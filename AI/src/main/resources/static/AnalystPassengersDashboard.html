<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAS - Analyst Passengers Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-blue: #1E40AF;
            --secondary-red: #DC2626;
            --light-blue: #3B82F6;
            --light-red: #EF4444;
            --gold: #F59E0B;
            --green: #10B981;
            --purple: #8B5CF6;
            --gray-dark: #1F2937;
            --gray-medium: #6B7280;
            --gray-light: #F3F4F6;
            --white: #FFFFFF;
            --sidebar-width: 280px;
            --header-height: 70px;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --white: #1F2937;
            --gray-light: #374151;
            --gray-medium: #9CA3AF;
            --gray-dark: #F9FAFB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-light);
            color: var(--gray-dark);
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: var(--white);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 2rem;
            transition: var(--transition);
        }

        .header.expanded {
            left: 80px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background: var(--gray-light);
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-dark);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .notification-btn:hover {
            background: var(--gray-light);
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--secondary-red);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--gray-light);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--gray-light);
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-profile:hover {
            background: var(--light-blue);
            color: var(--white);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--white);
            border-right: 1px solid rgba(0,0,0,0.1);
            box-shadow: var(--shadow);
            z-index: 1100;
            transition: var(--transition);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            transition: var(--transition);
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            transform: translateX(-10px);
        }

        .sidebar-menu {
            flex: 1;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
        }

        .sidebar-menu li {
            margin: 0.25rem 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.5rem;
            color: var(--gray-medium);
            text-decoration: none;
            transition: var(--transition);
            border-radius: 0 25px 25px 0;
            margin-right: 1rem;
            font-weight: 500;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: linear-gradient(90deg, rgba(30,64,175,0.1) 0%, rgba(30,64,175,0.05) 100%);
            color: var(--primary-blue);
            transform: translateX(5px);
        }

        .sidebar-menu a.active {
            border-right: 3px solid var(--primary-blue);
        }

        .sidebar-menu i {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar-menu .menu-text {
            transition: var(--transition);
        }

        .sidebar.collapsed .menu-text {
            opacity: 0;
            transform: translateX(-10px);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 2rem;
            min-height: calc(100vh - var(--header-height));
            transition: var(--transition);
        }

        .main-content.expanded {
            margin-left: 80px;
        }

        .section {
            display: block;
        }

        .section.hidden {
            display: none;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-dark);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: var(--white);
            flex-shrink: 0;
        }

        .stat-icon.passengers {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        }

        .stat-icon.revenue {
            background: linear-gradient(135deg, var(--green), #22C55E);
        }

        .stat-icon.trips {
            background: linear-gradient(135deg, var(--gold), #F59E0B);
        }

        .stat-icon.buses {
            background: linear-gradient(135deg, var(--purple), #A855F7);
        }

        .stat-info h3 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .stat-info p {
            color: var(--gray-medium);
            font-weight: 500;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }

        /* Filters */
        .filters-container {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .filter-control {
            padding: 0.75rem;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
            color: var(--gray-dark);
        }

        .filter-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
        }

        /* Buttons */
        .btn {
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: var(--light-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30,64,175,0.3);
        }

        .btn-success {
            background: var(--green);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--gold);
            color: var(--gray-dark);
        }

        .btn-warning:hover {
            background: #F59E0B;
        }

        .btn-danger {
            background: var(--secondary-red);
        }

        .btn-danger:hover {
            background: var(--light-red);
        }

        .btn-secondary {
            background: var(--gray-medium);
        }

        .btn-secondary:hover {
            background: var(--gray-dark);
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .data-table th {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
            color: var(--white);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--gray-dark);
        }

        .data-table tr:hover {
            background: rgba(30, 64, 175, 0.05);
        }

        .data-table .number {
            text-align: right;
            font-weight: 600;
        }

        .data-table .status {
            display: inline-flex;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.paid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green);
        }

        .status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--gold);
        }

        .status.cancelled {
            background: rgba(220, 38, 38, 0.1);
            color: var(--secondary-red);
        }

        /* Analytics Cards */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .analytics-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-dark);
        }

        .analytics-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-blue);
        }

        .analytics-change {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .analytics-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green);
        }

        .analytics-change.negative {
            background: rgba(220, 38, 38, 0.1);
            color: var(--secondary-red);
        }

        /* Performance Indicators */
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .performance-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border-left: 4px solid;
        }

        .performance-card.excellent {
            border-left-color: var(--green);
        }

        .performance-card.good {
            border-left-color: var(--primary-blue);
        }

        .performance-card.average {
            border-left-color: var(--gold);
        }

        .performance-card.poor {
            border-left-color: var(--secondary-red);
        }

        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .performance-title {
            font-weight: 600;
            color: var(--gray-dark);
        }

        .performance-score {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .performance-card.excellent .performance-score {
            color: var(--green);
        }

        .performance-card.good .performance-score {
            color: var(--primary-blue);
        }

        .performance-card.average .performance-score {
            color: var(--gold);
        }

        .performance-card.poor .performance-score {
            color: var(--secondary-red);
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--gray-medium);
        }

        /* Progress Bars */
        .progress-container {
            margin: 1rem 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--light-blue));
            transition: width 1s ease;
            border-radius: 4px;
        }

        .progress-fill.success {
            background: linear-gradient(90deg, var(--green), #22C55E);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--gold), #F59E0B);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--secondary-red), var(--light-red));
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            width: 100%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-medium);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-btn:hover {
            background: var(--gray-light);
            color: var(--gray-dark);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s linear infinite;
        }

        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }

        .notification-toast.success {
            background: var(--green);
        }

        .notification-toast.error {
            background: var(--secondary-red);
        }

        .notification-toast.warning {
            background: var(--gold);
        }

        .notification-toast.info {
            background: var(--primary-blue);
        }

        /* Search and Pagination */
        .search-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .search-input {
            flex: 1;
            max-width: 400px;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
            color: var(--gray-dark);
            position: relative;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-medium);
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-light);
            background: var(--white);
            color: var(--gray-dark);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination button:hover {
            background: var(--primary-blue);
            color: var(--white);
        }

        .pagination button.active {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: var(--header-height);
            right: -400px;
            width: 400px;
            height: calc(100vh - var(--header-height));
            background: var(--white);
            box-shadow: var(--shadow);
            transition: var(--transition);
            z-index: 1500;
            display: flex;
            flex-direction: column;
        }

        .notifications-panel.open {
            right: 0;
        }

        .notifications-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-item:hover {
            background: var(--gray-light);
        }

        .notification-item.unread {
            background: rgba(30, 64, 175, 0.05);
            border-left: 4px solid var(--primary-blue);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }

            .sidebar .menu-text,
            .sidebar .logo-text {
                opacity: 0;
                transform: translateX(-10px);
            }

            .main-content {
                margin-left: 80px;
            }

            .header {
                left: 80px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters-row {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .search-container {
                flex-direction: column;
                align-items: stretch;
            }

            .data-table {
                font-size: 0.9rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .hidden {
            display: none !important;
        }

        /* Print Styles */
        @media print {
            .sidebar,
            .header,
            .btn,
            .filters-container {
                display: none !important;
            }

            .main-content {
                margin: 0 !important;
                padding: 1rem !important;
            }

            .card {
                break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
    </style>
</head>

<body data-theme="light">
<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <span class="logo-text">IMAS Analytics</span>
    </div>
    <div class="sidebar-menu">
        <ul>
            <li>
                <a href="#" class="active" onclick="showSection('dashboard', event)">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="menu-text">Dashboard Overview</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('passenger-analysis', event)">
                    <i class="fas fa-users-cog"></i>
                    <span class="menu-text">Passenger Analysis</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('spending-analytics', event)">
                    <i class="fas fa-dollar-sign"></i>
                    <span class="menu-text">Spending Analytics</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('bus-performance', event)">
                    <i class="fas fa-bus"></i>
                    <span class="menu-text">Bus Performance</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('revenue-analysis', event)">
                    <i class="fas fa-chart-area"></i>
                    <span class="menu-text">Revenue Analysis</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('comparison-charts', event)">
                    <i class="fas fa-chart-bar"></i>
                    <span class="menu-text">Comparison Charts</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('performance-metrics', event)">
                    <i class="fas fa-trophy"></i>
                    <span class="menu-text">Performance Metrics</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('reports-export', event)">
                    <i class="fas fa-file-export"></i>
                    <span class="menu-text">Reports & Export</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('time-analysis', event)">
                    <i class="fas fa-clock"></i>
                    <span class="menu-text">Time Analysis</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('geographic-analysis', event)">
                    <i class="fas fa-map"></i>
                    <span class="menu-text">Geographic Analysis</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('customer-insights', event)">
                    <i class="fas fa-user-tie"></i>
                    <span class="menu-text">Customer Insights</span>
                </a>
            </li>
            <li>
                <a href="WhatsApp.html">
                    <i class="fab fa-whatsapp"></i>
                    <span class="menu-text">WhatsApp</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="menu-text">Logout</span>
                </a>
            </li>
        </ul>
    </div>
</nav>
</body>

<!-- Header -->
<header class="header" id="header">
    <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    <div class="header-center">
        <h1 class="header-title">IMAS - Advanced Analyst Dashboard</h1>
    </div>
    <div class="header-right">
        <button class="notification-btn" id="notificationBtn" onclick="toggleNotifications()">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationBadge">0</span>
        </button>
        <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
        <div class="user-profile" id="userProfile">
            <div class="user-avatar" id="userAvatar">A</div>
            <span id="userName">Analyst</span>
        </div>
    </div>
</header>

<!-- Notifications Panel -->
<div class="notifications-panel" id="notificationsPanel">
    <div class="notifications-header">
        <h3>Notifications</h3>
        <button class="close-btn" onclick="toggleNotifications()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="notifications-list" id="notificationsList">
        <!-- Notifications will be populated here -->
    </div>
</div>

<!-- Main Content -->
<main class="main-content" id="mainContent">
    <!-- Dashboard Overview Section -->
    <section id="dashboard-section" class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="color: var(--gray-dark);" id="welcomeMessage">Welcome to Advanced Analytics Dashboard</h1>
            <div class="btn-group">
                <button class="btn" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Data
                </button>
                <button class="btn btn-success" onclick="exportDashboardData()">
                    <i class="fas fa-download"></i>
                    Export Dashboard
                </button>
            </div>
        </div>

        <!-- Overview Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon passengers">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalPassengers">0</h3>
                    <p>Total Passengers</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon revenue">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalRevenue">0 FC</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon trips">
                    <i class="fas fa-route"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalTrips">0</h3>
                    <p>Total Trips</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon buses">
                    <i class="fas fa-bus"></i>
                </div>
                <div class="stat-info">
                    <h3 id="activeBuses">0</h3>
                    <p>Active Buses</p>
                </div>
            </div>
        </div>

        <!-- Quick Analytics -->
        <div class="analytics-grid">
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Average Revenue per Trip</h3>
                    <span class="analytics-change positive" id="revenueChange">+12.5%</span>
                </div>
                <div class="analytics-value" id="avgRevenuePerTrip">2,500 FC</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Passenger Satisfaction</h3>
                    <span class="analytics-change positive" id="satisfactionChange">+3.2%</span>
                </div>
                <div class="analytics-value" id="avgSatisfaction">4.6/5</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Monthly Growth</h3>
                    <span class="analytics-change positive" id="monthlyGrowth">+18.7%</span>
                </div>
                <div class="analytics-value" id="growthRate">18.7%</div>
            </div>
        </div>

        <!-- Dashboard Charts -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Revenue Trends (Last 6 Months)</h3>
                </div>
                <div class="chart-container">
                    <canvas id="dashboardRevenueChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Top Performing Routes</h3>
                </div>
                <div class="chart-container">
                    <canvas id="topRoutesChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Passenger Analysis Section -->
    <section id="passenger-analysis-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Comprehensive Passenger Analysis</h1>
            <div class="btn-group">
                <button class="btn" onclick="refreshPassengerData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="btn btn-success" onclick="exportPassengerReport()">
                    <i class="fas fa-file-export"></i>
                    Export Report
                </button>
            </div>
        </div>

        <!-- Passenger Filters -->
        <div class="filters-container">
            <div class="filters-row">
                <div class="filter-group">
                    <label>Search Passengers</label>
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="passengerSearch"
                               placeholder="Search by name, email, or phone..."
                               onkeyup="filterPassengers()">
                    </div>
                </div>
                <div class="filter-group">
                    <label>Trip Count Range</label>
                    <select class="filter-control" id="tripCountFilter" onchange="filterPassengers()">
                        <option value="">All Passengers</option>
                        <option value="1-5">1-5 Trips</option>
                        <option value="6-10">6-10 Trips</option>
                        <option value="11-20">11-20 Trips</option>
                        <option value="21+">21+ Trips</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Spending Range</label>
                    <select class="filter-control" id="spendingFilter" onchange="filterPassengers()">
                        <option value="">All Ranges</option>
                        <option value="0-10000">0 - 10,000 FC</option>
                        <option value="10001-50000">10,001 - 50,000 FC</option>
                        <option value="50001-100000">50,001 - 100,000 FC</option>
                        <option value="100001+">100,001+ FC</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date Range</label>
                    <input type="date" class="filter-control" id="startDateFilter" onchange="filterPassengers()">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <input type="date" class="filter-control" id="endDateFilter" onchange="filterPassengers()">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="clearPassengerFilters()">
                        <i class="fas fa-times"></i>
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Passenger Statistics -->
        <div class="performance-grid">
            <div class="performance-card excellent">
                <div class="performance-header">
                    <span class="performance-title">High-Value Passengers</span>
                    <span class="performance-score" id="highValueCount">0</span>
                </div>
                <div class="performance-metrics">
                    <span>Spending > 50,000 FC</span>
                    <span id="highValuePercentage">0%</span>
                </div>
            </div>
            <div class="performance-card good">
                <div class="performance-header">
                    <span class="performance-title">Regular Passengers</span>
                    <span class="performance-score" id="regularCount">0</span>
                </div>
                <div class="performance-metrics">
                    <span>5+ Trips</span>
                    <span id="regularPercentage">0%</span>
                </div>
            </div>
            <div class="performance-card average">
                <div class="performance-header">
                    <span class="performance-title">Occasional Passengers</span>
                    <span class="performance-score" id="occasionalCount">0</span>
                </div>
                <div class="performance-metrics">
                    <span>2-4 Trips</span>
                    <span id="occasionalPercentage">0%</span>
                </div>
            </div>
            <div class="performance-card poor">
                <div class="performance-header">
                    <span class="performance-title">New Passengers</span>
                    <span class="performance-score" id="newCount">0</span>
                </div>
                <div class="performance-metrics">
                    <span>1 Trip Only</span>
                    <span id="newPercentage">0%</span>
                </div>
            </div>
        </div>

        <!-- Passenger Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Detailed Passenger Analysis</h3>
                <span id="passengerCount">Loading passengers...</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table" id="passengerTable">
                    <thead>
                    <tr>
                        <th>Passenger</th>
                        <th>Contact</th>
                        <th>Total Trips</th>
                        <th>Total Spent</th>
                        <th>Avg per Trip</th>
                        <th>Last Trip</th>
                        <th>Favorite Route</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="passengerTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem;">
                            <div class="loading"></div>
                            <p>Loading passenger data...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="passengerPagination">
                <!-- Pagination will be generated here -->
            </div>
        </div>
    </section>

    <!-- Spending Analytics Section -->
    <section id="spending-analytics-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Advanced Spending Analytics</h1>
            <div class="btn-group">
                <button class="btn" onclick="refreshSpendingData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="btn btn-success" onclick="exportSpendingReport()">
                    <i class="fas fa-file-export"></i>
                    Export Report
                </button>
            </div>
        </div>

        <!-- Spending Filters -->
        <div class="filters-container">
            <div class="filters-row">
                <div class="filter-group">
                    <label>Analysis Period</label>
                    <select class="filter-control" id="spendingPeriod" onchange="updateSpendingAnalysis()">
                        <option value="daily">Daily Analysis</option>
                        <option value="weekly">Weekly Analysis</option>
                        <option value="monthly" selected>Monthly Analysis</option>
                        <option value="yearly">Yearly Analysis</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Start Date</label>
                    <input type="date" class="filter-control" id="spendingStartDate" onchange="updateSpendingAnalysis()">
                </div>
                <div class="filter-group">
                    <label>End Date</label>
                    <input type="date" class="filter-control" id="spendingEndDate" onchange="updateSpendingAnalysis()">
                </div>
                <div class="filter-group">
                    <label>Route Filter</label>
                    <select class="filter-control" id="routeFilter" onchange="updateSpendingAnalysis()">
                        <option value="">All Routes</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Spending Charts Grid -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Spending by Time Period</h3>
                </div>
                <div class="chart-container">
                    <canvas id="spendingByTimeChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Spending by Passenger Category</h3>
                </div>
                <div class="chart-container">
                    <canvas id="spendingByCategoryChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Top 10 Spending Passengers</h3>
                </div>
                <div class="chart-container">
                    <canvas id="topSpendersChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Spending Distribution</h3>
                </div>
                <div class="chart-container">
                    <canvas id="spendingDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Spending Analysis Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Detailed Spending Analysis</h3>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table" id="spendingAnalysisTable">
                    <thead>
                    <tr>
                        <th>Period</th>
                        <th>Total Spending</th>
                        <th>Passenger Count</th>
                        <th>Avg per Passenger</th>
                        <th>Trip Count</th>
                        <th>Avg per Trip</th>
                        <th>Growth %</th>
                    </tr>
                    </thead>
                    <tbody id="spendingAnalysisBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            <div class="loading"></div>
                            <p>Loading spending analysis...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Bus Performance Section -->
    <section id="bus-performance-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Comprehensive Bus Performance Analysis</h1>
            <div class="btn-group">
                <button class="btn" onclick="refreshBusPerformanceData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="btn btn-success" onclick="exportBusPerformanceReport()">
                    <i class="fas fa-file-export"></i>
                    Export Report
                </button>
            </div>
        </div>

        <!-- Bus Performance Filters -->
        <div class="filters-container">
            <div class="filters-row">
                <div class="filter-group">
                    <label>Performance Period</label>
                    <select class="filter-control" id="performancePeriod" onchange="updateBusPerformanceAnalysis()">
                        <option value="daily">Daily Performance</option>
                        <option value="weekly">Weekly Performance</option>
                        <option value="monthly" selected>Monthly Performance</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Bus Filter</label>
                    <select class="filter-control" id="busFilter" onchange="updateBusPerformanceAnalysis()">
                        <option value="">All Buses</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Metric Type</label>
                    <select class="filter-control" id="metricType" onchange="updateBusPerformanceAnalysis()">
                        <option value="revenue">Revenue Performance</option>
                        <option value="tickets">Ticket Sales</option>
                        <option value="utilization">Utilization Rate</option>
                        <option value="efficiency">Efficiency Score</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Bus Performance Stats -->
        <div class="performance-grid">
            <div class="performance-card excellent">
                <div class="performance-header">
                    <span class="performance-title">Top Performing Bus</span>
                    <span class="performance-score" id="topBusName">-</span>
                </div>
                <div class="performance-metrics">
                    <span>Revenue</span>
                    <span id="topBusRevenue">0 FC</span>
                    <span>Tickets Sold</span>
                    <span id="topBusTickets">0</span>
                </div>
            </div>
            <div class="performance-card good">
                <div class="performance-header">
                    <span class="performance-title">Fleet Average</span>
                    <span class="performance-score" id="fleetAvgRevenue">0 FC</span>
                </div>
                <div class="performance-metrics">
                    <span>Avg Tickets/Bus</span>
                    <span id="avgTicketsPerBus">0</span>
                    <span>Utilization Rate</span>
                    <span id="avgUtilization">0%</span>
                </div>
            </div>
            <div class="performance-card average">
                <div class="performance-header">
                    <span class="performance-title">Most Popular Route</span>
                    <span class="performance-score" id="popularRoute">-</span>
                </div>
                <div class="performance-metrics">
                    <span>Total Passengers</span>
                    <span id="routePassengers">0</span>
                </div>
            </div>
            <div class="performance-card poor">
                <div class="performance-header">
                    <span class="performance-title">Underperforming</span>
                    <span class="performance-score" id="underperformingCount">0</span>
                </div>
                <div class="performance-metrics">
                    <span>Below 50% Capacity</span>
                    <span id="underperformingPercentage">0%</span>
                </div>
            </div>
        </div>

        <!-- Bus Performance Charts -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Bus Revenue Comparison</h3>
                </div>
                <div class="chart-container">
                    <canvas id="busRevenueChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Ticket Sales by Bus</h3>
                </div>
                <div class="chart-container">
                    <canvas id="busTicketSalesChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Bus Utilization Rates</h3>
                </div>
                <div class="chart-container">
                    <canvas id="busUtilizationChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance Trends</h3>
                </div>
                <div class="chart-container">
                    <canvas id="performanceTrendsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Bus Performance Table -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Detailed Bus Performance Metrics</h3>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table" id="busPerformanceTable">
                    <thead>
                    <tr>
                        <th>Bus</th>
                        <th>Route</th>
                        <th>Total Revenue</th>
                        <th>Tickets Sold</th>
                        <th>Avg Revenue/Trip</th>
                        <th>Utilization %</th>
                        <th>Performance Score</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="busPerformanceBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem;">
                            <div class="loading"></div>
                            <p>Loading bus performance data...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Revenue Analysis Section -->
    <section id="revenue-analysis-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Advanced Revenue Analysis</h1>
            <div class="btn-group">
                <button class="btn" onclick="refreshRevenueData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="btn btn-success" onclick="exportRevenueReport()">
                    <i class="fas fa-file-export"></i>
                    Export Report
                </button>
            </div>
        </div>

        <!-- Revenue Analytics Grid -->
        <div class="analytics-grid">
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Today's Revenue</h3>
                    <span class="analytics-change positive" id="todayRevenueChange">+5.2%</span>
                </div>
                <div class="analytics-value" id="todayRevenue">0 FC</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">This Week</h3>
                    <span class="analytics-change positive" id="weekRevenueChange">+12.8%</span>
                </div>
                <div class="analytics-value" id="weekRevenue">0 FC</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">This Month</h3>
                    <span class="analytics-change positive" id="monthRevenueChange">+18.3%</span>
                </div>
                <div class="analytics-value" id="monthRevenue">0 FC</div>
            </div>
        </div>

        <!-- Revenue Charts -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Revenue Trends (Last 12 Months)</h3>
                </div>
                <div class="chart-container">
                    <canvas id="revenueTrendsChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Revenue by Route</h3>
                </div>
                <div class="chart-container">
                    <canvas id="revenueByRouteChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Daily Revenue Pattern</h3>
                </div>
                <div class="chart-container">
                    <canvas id="dailyRevenuePatternChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Revenue Sources Breakdown</h3>
                </div>
                <div class="chart-container">
                    <canvas id="revenueSourcesChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Comparison Charts Section -->
    <section id="comparison-charts-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Advanced Comparison Analytics</h1>
            <div class="btn-group">
                <button class="btn" onclick="refreshComparisonData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="btn btn-success" onclick="exportComparisonReport()">
                    <i class="fas fa-file-export"></i>
                    Export Report
                </button>
            </div>
        </div>

        <!-- Comparison Filters -->
        <div class="filters-container">
            <div class="filters-row">
                <div class="filter-group">
                    <label>Comparison Type</label>
                    <select class="filter-control" id="comparisonType" onchange="updateComparisonCharts()">
                        <option value="bus-vs-bus">Bus vs Bus</option>
                        <option value="route-vs-route">Route vs Route</option>
                        <option value="month-vs-month">Month vs Month</option>
                        <option value="passenger-segments">Passenger Segments</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Primary Selection</label>
                    <select class="filter-control" id="primarySelection" onchange="updateComparisonCharts()">
                        <option value="">Select Primary</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Secondary Selection</label>
                    <select class="filter-control" id="secondarySelection" onchange="updateComparisonCharts()">
                        <option value="">Select Secondary</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Comparison Charts -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Revenue Comparison</h3>
                </div>
                <div class="chart-container">
                    <canvas id="revenueComparisonChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Passenger Count Comparison</h3>
                </div>
                <div class="chart-container">
                    <canvas id="passengerComparisonChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance Metrics Radar</h3>
                </div>
                <div class="chart-container">
                    <canvas id="performanceRadarChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Efficiency Comparison</h3>
                </div>
                <div class="chart-container">
                    <canvas id="efficiencyComparisonChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Performance Metrics Section -->
    <section id="performance-metrics-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Key Performance Indicators</h1>
        </div>

        <!-- KPI Grid -->
        <div class="performance-grid">
            <div class="performance-card excellent">
                <div class="performance-header">
                    <span class="performance-title">Customer Retention Rate</span>
                    <span class="performance-score" id="retentionRate">0%</span>
                </div>
                <div class="performance-metrics">
                    <span>Target: 80%</span>
                    <span id="retentionStatus">Above Target</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill success" id="retentionProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="performance-card good">
                <div class="performance-header">
                    <span class="performance-title">Average Load Factor</span>
                    <span class="performance-score" id="loadFactor">0%</span>
                </div>
                <div class="performance-metrics">
                    <span>Target: 75%</span>
                    <span id="loadFactorStatus">On Target</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="loadFactorProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="performance-card average">
                <div class="performance-header">
                    <span class="performance-title">Revenue per Kilometer</span>
                    <span class="performance-score" id="revenuePerKm">0 FC</span>
                </div>
                <div class="performance-metrics">
                    <span>Target: 150 FC/km</span>
                    <span id="revenuePerKmStatus">Needs Improvement</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill warning" id="revenuePerKmProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="performance-card poor">
                <div class="performance-header">
                    <span class="performance-title">On-Time Performance</span>
                    <span class="performance-score" id="onTimePerformance">0%</span>
                </div>
                <div class="performance-metrics">
                    <span>Target: 90%</span>
                    <span id="onTimeStatus">Below Target</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill danger" id="onTimeProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Trends -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">KPI Trends Over Time</h3>
                </div>
                <div class="chart-container">
                    <canvas id="kpiTrendsChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance Benchmarking</h3>
                </div>
                <div class="chart-container">
                    <canvas id="benchmarkingChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Reports & Export Section -->
    <section id="reports-export-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Reports & Data Export</h1>
        </div>

        <!-- Export Options -->
        <div class="analytics-grid">
            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Passenger Reports</h3>
                </div>
                <div style="margin-top: 1rem;">
                    <div class="btn-group" style="flex-direction: column; align-items: stretch; gap: 1rem;">
                        <button class="btn" onclick="exportPassengerDetailReport()">
                            <i class="fas fa-users"></i>
                            Detailed Passenger Report
                        </button>
                        <button class="btn" onclick="exportPassengerSpendingReport()">
                            <i class="fas fa-money-bill-wave"></i>
                            Spending Analysis Report
                        </button>
                        <button class="btn" onclick="exportPassengerBehaviorReport()">
                            <i class="fas fa-chart-line"></i>
                            Behavior Analysis Report
                        </button>
                    </div>
                </div>
            </div>

            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Bus Performance Reports</h3>
                </div>
                <div style="margin-top: 1rem;">
                    <div class="btn-group" style="flex-direction: column; align-items: stretch; gap: 1rem;">
                        <button class="btn" onclick="exportBusPerformanceDetailReport()">
                            <i class="fas fa-bus"></i>
                            Bus Performance Report
                        </button>
                        <button class="btn" onclick="exportRouteAnalysisReport()">
                            <i class="fas fa-route"></i>
                            Route Analysis Report
                        </button>
                        <button class="btn" onclick="exportUtilizationReport()">
                            <i class="fas fa-chart-pie"></i>
                            Utilization Report
                        </button>
                    </div>
                </div>
            </div>

            <div class="analytics-card">
                <div class="analytics-header">
                    <h3 class="analytics-title">Financial Reports</h3>
                </div>
                <div style="margin-top: 1rem;">
                    <div class="btn-group" style="flex-direction: column; align-items: stretch; gap: 1rem;">
                        <button class="btn" onclick="exportRevenueDetailReport()">
                            <i class="fas fa-chart-area"></i>
                            Revenue Analysis Report
                        </button>
                        <button class="btn" onclick="exportProfitabilityReport()">
                            <i class="fas fa-coins"></i>
                            Profitability Report
                        </button>
                        <button class="btn" onclick="exportFinancialSummaryReport()">
                            <i class="fas fa-file-invoice-dollar"></i>
                            Financial Summary
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Report Builder -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Custom Report Builder</h3>
            </div>
            <div class="filters-row">
                <div class="filter-group">
                    <label>Report Type</label>
                    <select class="filter-control" id="customReportType">
                        <option value="passenger">Passenger Analysis</option>
                        <option value="revenue">Revenue Analysis</option>
                        <option value="performance">Performance Metrics</option>
                        <option value="comparison">Comparison Report</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date Range</label>
                    <input type="date" class="filter-control" id="customStartDate">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <input type="date" class="filter-control" id="customEndDate">
                </div>
                <div class="filter-group">
                    <label>Export Format</label>
                    <select class="filter-control" id="exportFormat">
                        <option value="pdf">PDF Report</option>
                        <option value="excel">Excel Spreadsheet</option>
                        <option value="csv">CSV Data</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-success" onclick="generateCustomReport()">
                        <i class="fas fa-file-export"></i>
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Time Analysis Section -->
    <section id="time-analysis-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Time-based Analysis</h1>
        </div>

        <!-- Time Analysis Charts -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Peak Hours Analysis</h3>
                </div>
                <div class="chart-container">
                    <canvas id="peakHoursAnalysisChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Weekly Patterns</h3>
                </div>
                <div class="chart-container">
                    <canvas id="weeklyPatternsChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Seasonal Trends</h3>
                </div>
                <div class="chart-container">
                    <canvas id="seasonalTrendsChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Time-based Revenue Distribution</h3>
                </div>
                <div class="chart-container">
                    <canvas id="timeRevenueChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Geographic Analysis Section -->
    <section id="geographic-analysis-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Geographic Analysis</h1>
        </div>

        <!-- Route Performance Map -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Route Performance Map</h3>
                </div>
                <div class="chart-container">
                    <canvas id="routePerformanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Origin-Destination Analysis</h3>
                </div>
                <div class="chart-container">
                    <canvas id="originDestinationChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Customer Insights Section -->
    <section id="customer-insights-section" class="section hidden">
        <div class="card-header">
            <h1 class="card-title">Advanced Customer Insights</h1>
        </div>

        <!-- Customer Segmentation -->
        <div class="charts-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Customer Segmentation</h3>
                </div>
                <div class="chart-container">
                    <canvas id="customerSegmentationChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Customer Lifetime Value</h3>
                </div>
                <div class="chart-container">
                    <canvas id="customerLifetimeValueChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Customer Journey Analysis</h3>
                </div>
                <div class="chart-container">
                    <canvas id="customerJourneyChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Loyalty Analysis</h3>
                </div>
                <div class="chart-container">
                    <canvas id="loyaltyAnalysisChart"></canvas>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Passenger Detail Modal -->
<div id="passengerDetailModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2 class="modal-title">Passenger Detailed Analysis</h2>
            <button class="close-btn" onclick="closeModal('passengerDetailModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="passengerDetailContent">
            <!-- Content will be populated dynamically -->
        </div>
    </div>
</div>

<!-- Bus Detail Modal -->
<div id="busDetailModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2 class="modal-title">Bus Performance Details</h2>
            <button class="close-btn" onclick="closeModal('busDetailModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="busDetailContent">
            <!-- Content will be populated dynamically -->
        </div>
    </div>
</div>

<script>
    // Global Variables
    let currentUser = null;
    let dashboardData = {
        passengers: [],
        tickets: [],
        buses: [],
        routes: [],
        analytics: {}
    };
    let charts = {};
    let currentPage = 1;
    let itemsPerPage = 10;
    let filteredData = [];
    let notifications = [];

    const API_BASE = 'http://localhost:8080/api';

    // Initialize Dashboard
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Initializing IMAS Analyst Passengers Dashboard...');

        initializeUser();
        initializeEventListeners();
        loadNotifications();
        loadDashboardData();
        setDefaultDates();
        showSection('dashboard');
    });

    // Initialize User
    function initializeUser() {
        const userSession = localStorage.getItem('userSession');
        if (userSession) {
            currentUser = JSON.parse(userSession);
        } else {
            currentUser = {
                id: 1,
                firstName: 'System',
                lastName: 'Analyst',
                email: 'analyst@imas.com',
                role: 'ANALYST'
            };
            localStorage.setItem('userSession', JSON.stringify(currentUser));
        }

        document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
        document.getElementById('userAvatar').textContent = currentUser.firstName.charAt(0);
    }

    // Initialize Event Listeners
    function initializeEventListeners() {
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // Close notifications panel when clicking outside
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('notificationsPanel');
            const btn = document.getElementById('notificationBtn');

            if (panel.classList.contains('open') &&
                !panel.contains(event.target) &&
                !btn.contains(event.target)) {
                panel.classList.remove('open');
            }
        });
    }

    // Notifications System
    function loadNotifications() {
        // Simulate real notifications from the system
        notifications = [
            {
                id: 1,
                title: "New passenger registered",
                message: "John Doe has completed registration",
                timestamp: new Date(),
                read: false,
                type: 'info'
            },
            {
                id: 2,
                title: "High revenue alert",
                message: "Today's revenue exceeded target by 15%",
                timestamp: new Date(Date.now() - 3600000),
                read: false,
                type: 'success'
            },
            {
                id: 3,
                title: "Bus capacity warning",
                message: "Bus B001 is at 95% capacity for next trip",
                timestamp: new Date(Date.now() - 7200000),
                read: true,
                type: 'warning'
            }
        ];

        updateNotificationBadge();
        renderNotifications();
    }

    function updateNotificationBadge() {
        const unreadCount = notifications.filter(n => !n.read).length;
        const badge = document.getElementById('notificationBadge');
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? 'flex' : 'none';
    }

    function renderNotifications() {
        const list = document.getElementById('notificationsList');
        if (!list) return;

        list.innerHTML = notifications.map(notification => `
            <div class="notification-item ${notification.read ? '' : 'unread'}"
                 onclick="markAsRead(${notification.id})">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <strong style="color: var(--gray-dark); font-size: 0.9rem;">${notification.title}</strong>
                    <small style="color: var(--gray-medium); font-size: 0.75rem;">
                        ${formatTimeAgo(notification.timestamp)}
                    </small>
                </div>
                <p style="color: var(--gray-medium); font-size: 0.85rem; margin: 0;">
                    ${notification.message}
                </p>
            </div>
        `).join('');
    }

    function markAsRead(notificationId) {
        const notification = notifications.find(n => n.id === notificationId);
        if (notification && !notification.read) {
            notification.read = true;
            updateNotificationBadge();
            renderNotifications();
        }
    }

    function toggleNotifications() {
        const panel = document.getElementById('notificationsPanel');
        panel.classList.toggle('open');
    }

    function formatTimeAgo(timestamp) {
        const now = new Date();
        const diffInMinutes = Math.floor((now - timestamp) / (1000 * 60));

        if (diffInMinutes < 1) return 'Just now';
        if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
        if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
        return `${Math.floor(diffInMinutes / 1440)}d ago`;
    }

    // Set Default Dates
    function setDefaultDates() {
        const today = new Date();
        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

        // Set default date ranges
        const startDateInputs = ['spendingStartDate', 'customStartDate'];
        const endDateInputs = ['spendingEndDate', 'customEndDate'];

        startDateInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = lastMonth.toISOString().split('T')[0];
        });

        endDateInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = today.toISOString().split('T')[0];
        });
    }

    // Load Dashboard Data
    async function loadDashboardData() {
        try {
            console.log('📊 Loading dashboard data...');
            showNotification('Loading dashboard data...', 'info');

            // Load all data in parallel - using correct endpoints
            const [passengers, tickets, buses, routes] = await Promise.all([
                fetchData('/staff?role=PASSENGER'), // Use staff endpoint for passengers
                fetchData('/tickets'),
                fetchData('/buses'),
                fetchData('/routes')
            ]);

            dashboardData = {
                passengers: passengers,
                tickets: tickets,
                buses: buses,
                routes: routes,
                analytics: {}
            };

            console.log('✅ Dashboard data loaded:', {
                passengers: passengers.length,
                tickets: tickets.length,
                buses: buses.length,
                routes: routes.length
            });

            // Update dashboard statistics
            updateDashboardStats();

            // Create initial charts
            createDashboardCharts();

            // Populate filter options
            populateFilterOptions();

            showNotification('Dashboard data loaded successfully!', 'success');

        } catch (error) {
            console.error('❌ Error loading dashboard data:', error);
            showNotification('Error loading dashboard data: ' + error.message, 'error');

            // Load sample data as fallback
            loadSampleData();
        }
    }

    // Load sample data as fallback
    function loadSampleData() {
        console.log('Loading sample data as fallback...');

        // Generate sample data
        dashboardData = {
            passengers: generateSamplePassengers(100),
            tickets: generateSampleTickets(500),
            buses: generateSampleBuses(20),
            routes: generateSampleRoutes(10),
            analytics: {}
        };

        updateDashboardStats();
        createDashboardCharts();
        populateFilterOptions();

        showNotification('Sample data loaded for demonstration', 'warning');
    }

    function generateSamplePassengers(count) {
        const passengers = [];
        const firstNames = ['John', 'Mary', 'David', 'Sarah', 'Michael', 'Lisa', 'James', 'Emma', 'Robert', 'Anna'];
        const lastNames = ['Smith', 'Johnson', 'Brown', 'Davis', 'Wilson', 'Miller', 'Taylor', 'Anderson', 'Thomas', 'Jackson'];

        for (let i = 1; i <= count; i++) {
            passengers.push({
                id: i,
                firstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                lastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                email: `passenger${i}@email.com`,
                phoneNumber: `+243${Math.floor(Math.random() * 1000000000).toString().padStart(9, '0')}`,
                role: 'PASSENGER',
                active: true,
                createdAt: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000)
            });
        }
        return passengers;
    }

    function generateSampleTickets(count) {
        const tickets = [];
        const origins = ['GARE_CENTRALE', 'MATETE', 'LIMETE', 'BANDALUNGWA'];
        const destinations = ['NDJILI', 'MASINA', 'KIMBANSEKE', 'NSELE'];
        const statuses = ['PAID', 'BOARDED', 'CANCELLED'];

        for (let i = 1; i <= count; i++) {
            const createdDate = new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000);
            tickets.push({
                id: i,
                ticketNumber: `TKT${i.toString().padStart(6, '0')}`,
                passengerId: Math.floor(Math.random() * 100) + 1,
                busId: Math.floor(Math.random() * 20) + 1,
                firstName: 'Passenger',
                lastName: `${i}`,
                origin: origins[Math.floor(Math.random() * origins.length)],
                destination: destinations[Math.floor(Math.random() * destinations.length)],
                status: statuses[Math.floor(Math.random() * statuses.length)],
                seatNumber: (Math.floor(Math.random() * 50) + 1).toString(),
                departureTime: new Date(createdDate.getTime() + Math.random() * 30 * 24 * 60 * 60 * 1000),
                issuedAt: createdDate,
                createdAt: createdDate
            });
        }
        return tickets;
    }

    function generateSampleBuses(count) {
        const buses = [];
        for (let i = 1; i <= count; i++) {
            buses.push({
                id: i,
                name: `Bus B${i.toString().padStart(3, '0')}`,
                busLine: `Line ${Math.floor(Math.random() * 10) + 1}`,
                capacity: 50,
                passengers: Math.floor(Math.random() * 50),
                hasAccident: Math.random() < 0.1,
                departureTime: new Date(Date.now() + Math.random() * 24 * 60 * 60 * 1000),
                driver: {
                    id: i,
                    firstName: 'Driver',
                    lastName: `${i}`
                }
            });
        }
        return buses;
    }

    function generateSampleRoutes(count) {
        const routes = [];
        const stations = ['GARE_CENTRALE', 'MATETE', 'LIMETE', 'BANDALUNGWA', 'NDJILI', 'MASINA', 'KIMBANSEKE'];

        for (let i = 1; i <= count; i++) {
            const start = stations[Math.floor(Math.random() * stations.length)];
            let end = stations[Math.floor(Math.random() * stations.length)];
            while (end === start) {
                end = stations[Math.floor(Math.random() * stations.length)];
            }

            routes.push({
                id: i,
                routeName: `Route ${i}`,
                startStation: start,
                endStation: end,
                distance: Math.floor(Math.random() * 50) + 10,
                duration: Math.floor(Math.random() * 120) + 30
            });
        }
        return routes;
    }

    // Fetch Data from API
    async function fetchData(endpoint) {
        try {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (error) {
            console.error(`❌ Fetch error for ${endpoint}:`, error);
            return [];
        }
    }

    // Update Dashboard Statistics
    function updateDashboardStats() {
        const { passengers, tickets, buses } = dashboardData;

        // Calculate basic stats
        const totalPassengers = passengers.length;
        const totalRevenue = tickets.reduce((sum, ticket) =>
            sum + (ticket.status === 'PAID' ? 2500 : 0), 0);
        const totalTrips = tickets.filter(ticket => ticket.status === 'PAID' || ticket.status === 'BOARDED').length;
        const activeBuses = buses.filter(bus => !bus.hasAccident).length;

        // Update DOM
        document.getElementById('totalPassengers').textContent = totalPassengers.toLocaleString();
        document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' FC';
        document.getElementById('totalTrips').textContent = totalTrips.toLocaleString();
        document.getElementById('activeBuses').textContent = activeBuses.toLocaleString();

        // Update analytics
        const avgRevenuePerTrip = totalTrips > 0 ? totalRevenue / totalTrips : 0;
        document.getElementById('avgRevenuePerTrip').textContent = Math.round(avgRevenuePerTrip).toLocaleString() + ' FC';

        // Update revenue analytics
        updateRevenueAnalytics();
    }

    // Update Revenue Analytics
    function updateRevenueAnalytics() {
        const { tickets } = dashboardData;
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const startOfWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

        // Calculate today's revenue
        const todayRevenue = tickets.filter(ticket => {
            const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
            return ticketDate >= startOfDay && ticket.status === 'PAID';
        }).length * 2500;

        // Calculate week revenue
        const weekRevenue = tickets.filter(ticket => {
            const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
            return ticketDate >= startOfWeek && ticket.status === 'PAID';
        }).length * 2500;

        // Calculate month revenue
        const monthRevenue = tickets.filter(ticket => {
            const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
            return ticketDate >= startOfMonth && ticket.status === 'PAID';
        }).length * 2500;

        // Update DOM
        document.getElementById('todayRevenue').textContent = todayRevenue.toLocaleString() + ' FC';
        document.getElementById('weekRevenue').textContent = weekRevenue.toLocaleString() + ' FC';
        document.getElementById('monthRevenue').textContent = monthRevenue.toLocaleString() + ' FC';
    }

    // Populate Filter Options
    function populateFilterOptions() {
        const { buses, routes } = dashboardData;

        // Populate route filters
        const routeSelects = ['routeFilter'];
        routeSelects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">All Routes</option>';
                routes.forEach(route => {
                    select.innerHTML += `<option value="${route.id}">${route.routeName || route.startStation + ' - ' + route.endStation}</option>`;
                });
            }
        });

        // Populate bus filters
        const busSelects = ['busFilter'];
        busSelects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">All Buses</option>';
                buses.forEach(bus => {
                    select.innerHTML += `<option value="${bus.id}">${bus.name || 'Bus ' + bus.id}</option>`;
                });
            }
        });

        // Populate comparison filters
        populateComparisonFilters();
    }

    // Populate Comparison Filters
    function populateComparisonFilters() {
        const { buses, routes } = dashboardData;
        const primarySelect = document.getElementById('primarySelection');
        const secondarySelect = document.getElementById('secondarySelection');

        if (!primarySelect || !secondarySelect) return;

        const comparisonType = document.getElementById('comparisonType').value;

        let options = [];
        switch (comparisonType) {
            case 'bus-vs-bus':
                options = buses.map(bus => ({
                    value: bus.id,
                    text: bus.name || `Bus ${bus.id}`
                }));
                break;
            case 'route-vs-route':
                options = routes.map(route => ({
                    value: route.id,
                    text: route.routeName || `${route.startStation} - ${route.endStation}`
                }));
                break;
            case 'month-vs-month':
                options = Array.from({length: 12}, (_, i) => {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    return {
                        value: date.toISOString().substr(0, 7),
                        text: date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })
                    };
                });
                break;
            case 'passenger-segments':
                options = [
                    { value: 'high-value', text: 'High-Value Passengers' },
                    { value: 'regular', text: 'Regular Passengers' },
                    { value: 'occasional', text: 'Occasional Passengers' },
                    { value: 'new', text: 'New Passengers' }
                ];
                break;
        }

        const optionHTML = options.map(opt =>
            `<option value="${opt.value}">${opt.text}</option>`
        ).join('');

        primarySelect.innerHTML = '<option value="">Select Primary</option>' + optionHTML;
        secondarySelect.innerHTML = '<option value="">Select Secondary</option>' + optionHTML;
    }

    // Create Dashboard Charts
    function createDashboardCharts() {
        createDashboardRevenueChart();
        createTopRoutesChart();
    }

    // Create Dashboard Revenue Chart
    function createDashboardRevenueChart() {
        const ctx = document.getElementById('dashboardRevenueChart');
        if (!ctx) return;

        destroyChart('dashboardRevenue');

        const { tickets } = dashboardData;
        const last6Months = [];
        const revenueData = [];

        // Generate last 6 months data
        for (let i = 5; i >= 0; i--) {
            const date = new Date();
            date.setMonth(date.getMonth() - i);
            last6Months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));

            const monthRevenue = tickets.filter(ticket => {
                const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                return ticketDate.getMonth() === date.getMonth() &&
                    ticketDate.getFullYear() === date.getFullYear() &&
                    (ticket.status === 'PAID' || ticket.status === 'BOARDED');
            }).reduce((sum, ticket) => sum + 2500, 0);

            revenueData.push(monthRevenue);
        }

        charts.dashboardRevenue = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last6Months,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: revenueData,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    // Create Top Routes Chart
    function createTopRoutesChart() {
        const ctx = document.getElementById('topRoutesChart');
        if (!ctx) return;

        destroyChart('topRoutes');

        const { tickets } = dashboardData;
        const routeCount = {};

        // Count tickets by route
        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const route = `${ticket.origin} → ${ticket.destination}`;
                routeCount[route] = (routeCount[route] || 0) + 1;
            }
        });

        // Get top 5 routes
        const sortedRoutes = Object.entries(routeCount)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        const labels = sortedRoutes.map(item => item[0]);
        const data = sortedRoutes.map(item => item[1]);

        charts.topRoutes = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#1E40AF',
                        '#DC2626',
                        '#10B981',
                        '#F59E0B',
                        '#8B5CF6'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Filter Passengers
    function filterPassengers() {
        const searchTerm = document.getElementById('passengerSearch').value.toLowerCase();
        const tripCountFilter = document.getElementById('tripCountFilter').value;
        const spendingFilter = document.getElementById('spendingFilter').value;
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;

        const { passengers, tickets } = dashboardData;

        // Create passenger analytics
        const passengerAnalytics = passengers.map(passenger => {
            const passengerTickets = tickets.filter(ticket =>
                ticket.passengerId === passenger.id ||
                (ticket.firstName === passenger.firstName && ticket.lastName === passenger.lastName)
            );

            const totalSpent = passengerTickets.reduce((sum, ticket) =>
                sum + ((ticket.status === 'PAID' || ticket.status === 'BOARDED') ? 2500 : 0), 0);

            const lastTrip = passengerTickets.length > 0 ?
                new Date(Math.max(...passengerTickets.map(t => new Date(t.issuedAt || t.createdAt)))) : null;

            // Find favorite route
            const routeCount = {};
            passengerTickets.forEach(ticket => {
                const route = `${ticket.origin} → ${ticket.destination}`;
                routeCount[route] = (routeCount[route] || 0) + 1;
            });
            const favoriteRoute = Object.keys(routeCount).reduce((a, b) =>
                routeCount[a] > routeCount[b] ? a : b, '-');

            return {
                ...passenger,
                totalTrips: passengerTickets.filter(t => t.status === 'PAID' || t.status === 'BOARDED').length,
                totalSpent: totalSpent,
                avgPerTrip: passengerTickets.length > 0 ? totalSpent / passengerTickets.length : 0,
                lastTrip: lastTrip,
                favoriteRoute: favoriteRoute
            };
        });

        // Apply filters
        filteredData = passengerAnalytics.filter(passenger => {
            // Search filter
            if (searchTerm && !passenger.firstName.toLowerCase().includes(searchTerm) &&
                !passenger.lastName.toLowerCase().includes(searchTerm) &&
                !(passenger.email || '').toLowerCase().includes(searchTerm) &&
                !(passenger.phoneNumber || '').toLowerCase().includes(searchTerm)) {
                return false;
            }

            // Trip count filter
            if (tripCountFilter) {
                const tripCount = passenger.totalTrips;
                switch (tripCountFilter) {
                    case '1-5':
                        if (tripCount < 1 || tripCount > 5) return false;
                        break;
                    case '6-10':
                        if (tripCount < 6 || tripCount > 10) return false;
                        break;
                    case '11-20':
                        if (tripCount < 11 || tripCount > 20) return false;
                        break;
                    case '21+':
                        if (tripCount < 21) return false;
                        break;
                }
            }

            // Spending filter
            if (spendingFilter) {
                const spending = passenger.totalSpent;
                switch (spendingFilter) {
                    case '0-10000':
                        if (spending < 0 || spending > 10000) return false;
                        break;
                    case '10001-50000':
                        if (spending < 10001 || spending > 50000) return false;
                        break;
                    case '50001-100000':
                        if (spending < 50001 || spending > 100000) return false;
                        break;
                    case '100001+':
                        if (spending < 100001) return false;
                        break;
                }
            }

            // Date filter
            if (startDate && passenger.lastTrip && passenger.lastTrip < new Date(startDate)) {
                return false;
            }
            if (endDate && passenger.lastTrip && passenger.lastTrip > new Date(endDate)) {
                return false;
            }

            return true;
        });

        // Update passenger statistics
        updatePassengerStats(passengerAnalytics);

        // Display filtered results
        displayPassengers();
    }

    // Update Passenger Statistics
    function updatePassengerStats(passengerAnalytics) {
        const totalPassengers = passengerAnalytics.length;

        const highValue = passengerAnalytics.filter(p => p.totalSpent > 50000).length;
        const regular = passengerAnalytics.filter(p => p.totalTrips >= 5).length;
        const occasional = passengerAnalytics.filter(p => p.totalTrips >= 2 && p.totalTrips <= 4).length;
        const newPassengers = passengerAnalytics.filter(p => p.totalTrips === 1).length;

        document.getElementById('highValueCount').textContent = highValue;
        document.getElementById('highValuePercentage').textContent =
            totalPassengers > 0 ? Math.round((highValue / totalPassengers) * 100) + '%' : '0%';

        document.getElementById('regularCount').textContent = regular;
        document.getElementById('regularPercentage').textContent =
            totalPassengers > 0 ? Math.round((regular / totalPassengers) * 100) + '%' : '0%';

        document.getElementById('occasionalCount').textContent = occasional;
        document.getElementById('occasionalPercentage').textContent =
            totalPassengers > 0 ? Math.round((occasional / totalPassengers) * 100) + '%' : '0%';

        document.getElementById('newCount').textContent = newPassengers;
        document.getElementById('newPercentage').textContent =
            totalPassengers > 0 ? Math.round((newPassengers / totalPassengers) * 100) + '%' : '0%';
    }

    // Display Passengers
    function displayPassengers() {
        const tbody = document.getElementById('passengerTableBody');
        const countElement = document.getElementById('passengerCount');

        if (!filteredData || filteredData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem;">
                        <i class="fas fa-users" style="font-size: 3rem; color: var(--gray-medium); margin-bottom: 1rem;"></i>
                        <p>No passengers found matching the current filters.</p>
                        <button class="btn" onclick="clearPassengerFilters()">Clear Filters</button>
                    </td>
                </tr>
            `;
            countElement.textContent = 'No passengers found';
            return;
        }

        // Pagination
        const totalItems = filteredData.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = filteredData.slice(startIndex, endIndex);

        countElement.textContent = `Showing ${startIndex + 1}-${Math.min(endIndex, totalItems)} of ${totalItems} passengers`;

        // Generate table rows
        tbody.innerHTML = pageData.map(passenger => `
            <tr>
                <td>
                    <div>
                        <strong>${passenger.firstName} ${passenger.lastName}</strong>
                        <br>
                        <small style="color: var(--gray-medium);">ID: ${passenger.id}</small>
                    </div>
                </td>
                <td>
                    <div>
                        ${passenger.email || 'N/A'}<br>
                        <small style="color: var(--gray-medium);">${passenger.phoneNumber || 'N/A'}</small>
                    </div>
                </td>
                <td class="number">${passenger.totalTrips}</td>
                <td class="number">${passenger.totalSpent.toLocaleString()} FC</td>
                <td class="number">${Math.round(passenger.avgPerTrip).toLocaleString()} FC</td>
                <td>${passenger.lastTrip ? passenger.lastTrip.toLocaleDateString() : 'Never'}</td>
                <td>${passenger.favoriteRoute}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn" onclick="viewPassengerDetails(${passenger.id})">
                            <i class="fas fa-eye"></i>
                            View
                        </button>
                        <button class="btn btn-success" onclick="exportPassengerData(${passenger.id})">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        // Update pagination
        updatePagination('passengerPagination', currentPage, totalPages);
    }

    // Clear Passenger Filters
    function clearPassengerFilters() {
        document.getElementById('passengerSearch').value = '';
        document.getElementById('tripCountFilter').value = '';
        document.getElementById('spendingFilter').value = '';
        document.getElementById('startDateFilter').value = '';
        document.getElementById('endDateFilter').value = '';

        currentPage = 1;
        filterPassengers();
    }

    // Update Pagination
    function updatePagination(containerId, currentPage, totalPages) {
        const container = document.getElementById(containerId);
        if (!container) return;

        let paginationHTML = '';

        // Previous button
        paginationHTML += `
            <button onclick="changePage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>
        `;

        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            paginationHTML += '<button onclick="changePage(1)">1</button>';
            if (startPage > 2) {
                paginationHTML += '<span>...</span>';
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>
                    ${i}
                </button>
            `;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += '<span>...</span>';
            }
            paginationHTML += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
        }

        // Next button
        paginationHTML += `
            <button onclick="changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>
        `;

        container.innerHTML = paginationHTML;
    }

    // Change Page
    function changePage(page) {
        if (page < 1 || page > Math.ceil(filteredData.length / itemsPerPage)) return;
        currentPage = page;
        displayPassengers();
    }

    // View Passenger Details
    function viewPassengerDetails(passengerId) {
        const { passengers, tickets } = dashboardData;
        const passenger = passengers.find(p => p.id === passengerId);
        if (!passenger) return;

        const passengerTickets = tickets.filter(ticket =>
            ticket.passengerId === passengerId ||
            (ticket.firstName === passenger.firstName && ticket.lastName === passenger.lastName)
        );

        const modalContent = document.getElementById('passengerDetailContent');
        modalContent.innerHTML = `
            <div class="analytics-grid">
                <div class="analytics-card">
                    <div class="analytics-header">
                        <h3 class="analytics-title">Passenger Information</h3>
                    </div>
                    <div>
                        <p><strong>Name:</strong> ${passenger.firstName} ${passenger.lastName}</p>
                        <p><strong>Email:</strong> ${passenger.email || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${passenger.phoneNumber || 'N/A'}</p>
                        <p><strong>Passenger ID:</strong> ${passenger.id}</p>
                    </div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-header">
                        <h3 class="analytics-title">Trip Statistics</h3>
                    </div>
                    <div>
                        <p><strong>Total Trips:</strong> ${passengerTickets.length}</p>
                        <p><strong>Total Spent:</strong> ${passengerTickets.reduce((sum, t) => sum + ((t.status === 'PAID' || t.status === 'BOARDED') ? 2500 : 0), 0).toLocaleString()} FC</p>
                        <p><strong>Average per Trip:</strong> ${passengerTickets.length > 0 ? Math.round(passengerTickets.reduce((sum, t) => sum + ((t.status === 'PAID' || t.status === 'BOARDED') ? 2500 : 0), 0) / passengerTickets.length).toLocaleString() : 0} FC</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Trip History</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Route</th>
                                <th>Seat</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${passengerTickets.map(ticket => `
                                <tr>
                                    <td>${new Date(ticket.issuedAt || ticket.createdAt).toLocaleDateString()}</td>
                                    <td>${ticket.origin} → ${ticket.destination}</td>
                                    <td>${ticket.seatNumber || 'N/A'}</td>
                                    <td class="number">2,500 FC</td>
                                    <td><span class="status ${ticket.status.toLowerCase()}">${ticket.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-success" onclick="exportPassengerData(${passengerId})">
                    <i class="fas fa-download"></i>
                    Export Passenger Report
                </button>
            </div>
        `;

        openModal('passengerDetailModal');
    }

    // Charts Creation Functions

    // Update Spending Analysis
    function updateSpendingAnalysis() {
        const period = document.getElementById('spendingPeriod').value;
        const startDate = document.getElementById('spendingStartDate').value;
        const endDate = document.getElementById('spendingEndDate').value;
        const routeFilter = document.getElementById('routeFilter').value;

        console.log('Updating spending analysis:', { period, startDate, endDate, routeFilter });

        createSpendingCharts(period, startDate, endDate, routeFilter);
        createSpendingAnalysisTable(period, startDate, endDate, routeFilter);
    }

    // Create Spending Charts
    function createSpendingCharts(period, startDate, endDate, routeFilter) {
        createSpendingByTimeChart(period, startDate, endDate, routeFilter);
        createSpendingByCategoryChart(startDate, endDate, routeFilter);
        createTopSpendersChart(startDate, endDate, routeFilter);
        createSpendingDistributionChart(startDate, endDate, routeFilter);
    }

    // Create Spending by Time Chart
    function createSpendingByTimeChart(period, startDate, endDate, routeFilter) {
        const ctx = document.getElementById('spendingByTimeChart');
        if (!ctx) return;

        destroyChart('spendingByTime');

        const { tickets } = dashboardData;
        let filteredTickets = tickets.filter(ticket => ticket.status === 'PAID' || ticket.status === 'BOARDED');

        // Apply date filters
        if (startDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) >= new Date(startDate)
            );
        }
        if (endDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) <= new Date(endDate)
            );
        }

        // Group data by period
        const groupedData = {};
        filteredTickets.forEach(ticket => {
            const date = new Date(ticket.issuedAt || ticket.createdAt);
            let key;

            switch (period) {
                case 'daily':
                    key = date.toISOString().split('T')[0];
                    break;
                case 'weekly':
                    const week = getWeekNumber(date);
                    key = `Week ${week}`;
                    break;
                case 'monthly':
                    key = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    break;
                case 'yearly':
                    key = date.getFullYear().toString();
                    break;
                default:
                    key = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }

            if (!groupedData[key]) {
                groupedData[key] = 0;
            }
            groupedData[key] += 2500; // Fixed ticket price
        });

        const sortedEntries = Object.entries(groupedData).sort((a, b) => {
            return a[0].localeCompare(b[0]);
        });

        const labels = sortedEntries.map(entry => entry[0]);
        const data = sortedEntries.map(entry => entry[1]);

        charts.spendingByTime = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Spending (FC)',
                    data: data,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    // Create Spending by Category Chart
    function createSpendingByCategoryChart(startDate, endDate, routeFilter) {
        const ctx = document.getElementById('spendingByCategoryChart');
        if (!ctx) return;

        destroyChart('spendingByCategory');

        const { tickets, passengers } = dashboardData;
        let filteredTickets = tickets.filter(ticket => ticket.status === 'PAID' || ticket.status === 'BOARDED');

        // Apply filters
        if (startDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) >= new Date(startDate)
            );
        }
        if (endDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) <= new Date(endDate)
            );
        }

        // Categorize passengers
        const categories = {
            'High Value (>50k)': 0,
            'Regular (10k-50k)': 0,
            'Occasional (5k-10k)': 0,
            'New (<5k)': 0
        };

        const passengerSpending = {};

        // Calculate spending per passenger
        filteredTickets.forEach(ticket => {
            const passengerId = ticket.passengerId || `${ticket.firstName}_${ticket.lastName}`;
            if (!passengerSpending[passengerId]) {
                passengerSpending[passengerId] = 0;
            }
            passengerSpending[passengerId] += 2500;
        });

        // Categorize and sum
        Object.values(passengerSpending).forEach(spending => {
            if (spending > 50000) {
                categories['High Value (>50k)'] += spending;
            } else if (spending >= 10000) {
                categories['Regular (10k-50k)'] += spending;
            } else if (spending >= 5000) {
                categories['Occasional (5k-10k)'] += spending;
            } else {
                categories['New (<5k)'] += spending;
            }
        });

        const labels = Object.keys(categories);
        const data = Object.values(categories);

        charts.spendingByCategory = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#1E40AF',
                        '#10B981',
                        '#F59E0B',
                        '#DC2626'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                return `${context.label}: ${value.toLocaleString()} FC`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Create Top Spenders Chart
    function createTopSpendersChart(startDate, endDate, routeFilter) {
        const ctx = document.getElementById('topSpendersChart');
        if (!ctx) return;

        destroyChart('topSpenders');

        const { tickets, passengers } = dashboardData;
        let filteredTickets = tickets.filter(ticket => ticket.status === 'PAID' || ticket.status === 'BOARDED');

        // Apply filters
        if (startDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) >= new Date(startDate)
            );
        }
        if (endDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) <= new Date(endDate)
            );
        }

        // Calculate spending per passenger
        const passengerSpending = {};
        const passengerNames = {};

        filteredTickets.forEach(ticket => {
            const passengerId = ticket.passengerId || `${ticket.firstName}_${ticket.lastName}`;
            const passengerName = `${ticket.firstName} ${ticket.lastName}`;

            if (!passengerSpending[passengerId]) {
                passengerSpending[passengerId] = 0;
                passengerNames[passengerId] = passengerName;
            }
            passengerSpending[passengerId] += 2500;
        });

        // Get top 10 spenders
        const sortedSpenders = Object.entries(passengerSpending)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

        const labels = sortedSpenders.map(entry => passengerNames[entry[0]]);
        const data = sortedSpenders.map(entry => entry[1]);

        charts.topSpenders = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Spending (FC)',
                    data: data,
                    backgroundColor: 'rgba(30, 64, 175, 0.8)',
                    borderColor: '#1E40AF',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    // Create Spending Distribution Chart
    function createSpendingDistributionChart(startDate, endDate, routeFilter) {
        const ctx = document.getElementById('spendingDistributionChart');
        if (!ctx) return;

        destroyChart('spendingDistribution');

        const { tickets } = dashboardData;
        let filteredTickets = tickets.filter(ticket => ticket.status === 'PAID' || ticket.status === 'BOARDED');

        // Apply filters
        if (startDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) >= new Date(startDate)
            );
        }
        if (endDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) <= new Date(endDate)
            );
        }

        // Calculate spending per passenger
        const passengerSpending = {};
        filteredTickets.forEach(ticket => {
            const passengerId = ticket.passengerId || `${ticket.firstName}_${ticket.lastName}`;
            if (!passengerSpending[passengerId]) {
                passengerSpending[passengerId] = 0;
            }
            passengerSpending[passengerId] += 2500;
        });

        // Create spending ranges
        const ranges = {
            '0-5k': 0,
            '5k-10k': 0,
            '10k-25k': 0,
            '25k-50k': 0,
            '50k-100k': 0,
            '100k+': 0
        };

        Object.values(passengerSpending).forEach(spending => {
            if (spending < 5000) ranges['0-5k']++;
            else if (spending < 10000) ranges['5k-10k']++;
            else if (spending < 25000) ranges['10k-25k']++;
            else if (spending < 50000) ranges['25k-50k']++;
            else if (spending < 100000) ranges['50k-100k']++;
            else ranges['100k+']++;
        });

        const labels = Object.keys(ranges);
        const data = Object.values(ranges);

        charts.spendingDistribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Passengers',
                    data: data,
                    backgroundColor: [
                        'rgba(220, 38, 38, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(236, 72, 153, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Create Spending Analysis Table
    function createSpendingAnalysisTable(period, startDate, endDate, routeFilter) {
        const tbody = document.getElementById('spendingAnalysisBody');
        const { tickets } = dashboardData;

        let filteredTickets = tickets.filter(ticket => ticket.status === 'PAID' || ticket.status === 'BOARDED');

        // Apply filters
        if (startDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) >= new Date(startDate)
            );
        }
        if (endDate) {
            filteredTickets = filteredTickets.filter(ticket =>
                new Date(ticket.issuedAt || ticket.createdAt) <= new Date(endDate)
            );
        }

        // Group by period
        const groupedData = {};
        filteredTickets.forEach(ticket => {
            const date = new Date(ticket.issuedAt || ticket.createdAt);
            let key;

            switch (period) {
                case 'daily':
                    key = date.toISOString().split('T')[0];
                    break;
                case 'weekly':
                    const week = getWeekNumber(date);
                    key = `Week ${week} ${date.getFullYear()}`;
                    break;
                case 'monthly':
                    key = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    break;
                case 'yearly':
                    key = date.getFullYear().toString();
                    break;
                default:
                    key = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }

            if (!groupedData[key]) {
                groupedData[key] = {
                    spending: 0,
                    passengers: new Set(),
                    trips: 0
                };
            }

            groupedData[key].spending += 2500;
            groupedData[key].passengers.add(ticket.passengerId || `${ticket.firstName}_${ticket.lastName}`);
            groupedData[key].trips++;
        });

        // Convert to array and sort
        const sortedData = Object.entries(groupedData)
            .map(([period, data]) => ({
                period,
                spending: data.spending,
                passengerCount: data.passengers.size,
                tripCount: data.trips,
                avgPerPassenger: data.passengers.size > 0 ? data.spending / data.passengers.size : 0,
                avgPerTrip: data.trips > 0 ? data.spending / data.trips : 0
            }))
            .sort((a, b) => a.period.localeCompare(b.period));

        // Calculate growth percentages
        sortedData.forEach((item, index) => {
            if (index > 0) {
                const prevSpending = sortedData[index - 1].spending;
                item.growth = prevSpending > 0 ? ((item.spending - prevSpending) / prevSpending * 100) : 0;
            } else {
                item.growth = 0;
            }
        });

        // Populate table
        tbody.innerHTML = sortedData.map(item => `
            <tr>
                <td>${item.period}</td>
                <td class="number">${item.spending.toLocaleString()} FC</td>
                <td class="number">${item.passengerCount}</td>
                <td class="number">${Math.round(item.avgPerPassenger).toLocaleString()} FC</td>
                <td class="number">${item.tripCount}</td>
                <td class="number">${Math.round(item.avgPerTrip).toLocaleString()} FC</td>
                <td class="number" style="color: ${item.growth >= 0 ? 'var(--green)' : 'var(--secondary-red)'}">
                    ${item.growth >= 0 ? '+' : ''}${item.growth.toFixed(1)}%
                </td>
            </tr>
        `).join('');
    }

    // Bus Performance Functions
    function updateBusPerformanceAnalysis() {
        const period = document.getElementById('performancePeriod').value;
        const busFilter = document.getElementById('busFilter').value;
        const metricType = document.getElementById('metricType').value;

        console.log('Updating bus performance analysis:', { period, busFilter, metricType });

        createBusPerformanceCharts(period, busFilter, metricType);
        createBusPerformanceTable(period, busFilter, metricType);
        updateBusPerformanceStats();
    }

    function createBusPerformanceCharts(period, busFilter, metricType) {
        createBusRevenueChart(busFilter);
        createBusTicketSalesChart(busFilter);
        createBusUtilizationChart(busFilter);
        createPerformanceTrendsChart(period, busFilter, metricType);
    }

    function createBusRevenueChart(busFilter) {
        const ctx = document.getElementById('busRevenueChart');
        if (!ctx) return;

        destroyChart('busRevenue');

        const { buses, tickets } = dashboardData;
        let targetBuses = busFilter ? buses.filter(bus => bus.id.toString() === busFilter) : buses;

        const busRevenueData = targetBuses.map(bus => {
            const busTickets = tickets.filter(ticket =>
                ticket.busId === bus.id && (ticket.status === 'PAID' || ticket.status === 'BOARDED')
            );
            return {
                name: bus.name || `Bus ${bus.id}`,
                revenue: busTickets.length * 2500
            };
        }).sort((a, b) => b.revenue - a.revenue).slice(0, 10);

        const labels = busRevenueData.map(item => item.name);
        const data = busRevenueData.map(item => item.revenue);

        charts.busRevenue = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: data,
                    backgroundColor: 'rgba(30, 64, 175, 0.8)',
                    borderColor: '#1E40AF',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    function createBusTicketSalesChart(busFilter) {
        const ctx = document.getElementById('busTicketSalesChart');
        if (!ctx) return;

        destroyChart('busTicketSales');

        const { buses, tickets } = dashboardData;
        let targetBuses = busFilter ? buses.filter(bus => bus.id.toString() === busFilter) : buses;

        const busTicketData = targetBuses.map(bus => {
            const busTickets = tickets.filter(ticket =>
                ticket.busId === bus.id && (ticket.status === 'PAID' || ticket.status === 'BOARDED')
            );
            return {
                name: bus.name || `Bus ${bus.id}`,
                tickets: busTickets.length
            };
        }).sort((a, b) => b.tickets - a.tickets).slice(0, 10);

        const labels = busTicketData.map(item => item.name);
        const data = busTicketData.map(item => item.tickets);

        charts.busTicketSales = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#1E40AF', '#DC2626', '#10B981', '#F59E0B', '#8B5CF6',
                        '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function createBusUtilizationChart(busFilter) {
        const ctx = document.getElementById('busUtilizationChart');
        if (!ctx) return;

        destroyChart('busUtilization');

        const { buses, tickets } = dashboardData;
        let targetBuses = busFilter ? buses.filter(bus => bus.id.toString() === busFilter) : buses;

        const utilizationData = targetBuses.map(bus => {
            const busTickets = tickets.filter(ticket =>
                ticket.busId === bus.id && (ticket.status === 'PAID' || ticket.status === 'BOARDED')
            );
            const capacity = bus.capacity || 50;
            const utilization = Math.min((busTickets.length / capacity) * 100, 100);

            return {
                name: bus.name || `Bus ${bus.id}`,
                utilization: Math.round(utilization)
            };
        }).slice(0, 15);

        const labels = utilizationData.map(item => item.name);
        const data = utilizationData.map(item => item.utilization);

        charts.busUtilization = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Utilization %',
                    data: data,
                    backgroundColor: data.map(value => {
                        if (value >= 80) return 'rgba(16, 185, 129, 0.8)';
                        if (value >= 60) return 'rgba(245, 158, 11, 0.8)';
                        return 'rgba(220, 38, 38, 0.8)';
                    }),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function createPerformanceTrendsChart(period, busFilter, metricType) {
        const ctx = document.getElementById('performanceTrendsChart');
        if (!ctx) return;

        destroyChart('performanceTrends');

        const { buses, tickets } = dashboardData;
        let targetBuses = busFilter ? buses.filter(bus => bus.id.toString() === busFilter) : buses.slice(0, 5);

        // Create trend data for the last 6 months
        const last6Months = [];
        for (let i = 5; i >= 0; i--) {
            const date = new Date();
            date.setMonth(date.getMonth() - i);
            last6Months.push(date.toLocaleDateString('en-US', { month: 'short' }));
        }

        const datasets = targetBuses.map((bus, index) => {
            const monthlyData = last6Months.map((month, monthIndex) => {
                const date = new Date();
                date.setMonth(date.getMonth() - (5 - monthIndex));

                const monthTickets = tickets.filter(ticket => {
                    const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                    return ticket.busId === bus.id &&
                        (ticket.status === 'PAID' || ticket.status === 'BOARDED') &&
                        ticketDate.getMonth() === date.getMonth() &&
                        ticketDate.getFullYear() === date.getFullYear();
                });

                switch (metricType) {
                    case 'revenue':
                        return monthTickets.length * 2500;
                    case 'tickets':
                        return monthTickets.length;
                    case 'utilization':
                        return Math.min((monthTickets.length / (bus.capacity || 50)) * 100, 100);
                    case 'efficiency':
                        return Math.min(monthTickets.length * 2, 100);
                    default:
                        return monthTickets.length * 2500;
                }
            });

            const colors = ['#1E40AF', '#DC2626', '#10B981', '#F59E0B', '#8B5CF6'];

            return {
                label: bus.name || `Bus ${bus.id}`,
                data: monthlyData,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                borderWidth: 2,
                tension: 0.4,
                fill: false
            };
        });

        charts.performanceTrends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last6Months,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                switch (metricType) {
                                    case 'revenue':
                                        return value.toLocaleString() + ' FC';
                                    case 'utilization':
                                    case 'efficiency':
                                        return value + '%';
                                    default:
                                        return value;
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    function createBusPerformanceTable(period, busFilter, metricType) {
        const tbody = document.getElementById('busPerformanceBody');
        const { buses, tickets } = dashboardData;

        let targetBuses = busFilter ? buses.filter(bus => bus.id.toString() === busFilter) : buses;

        const busPerformanceData = targetBuses.map(bus => {
            const busTickets = tickets.filter(ticket =>
                ticket.busId === bus.id && (ticket.status === 'PAID' || ticket.status === 'BOARDED')
            );

            const totalRevenue = busTickets.length * 2500;
            const ticketsSold = busTickets.length;
            const avgRevenuePerTrip = ticketsSold > 0 ? totalRevenue / ticketsSold : 0;
            const utilization = Math.min((ticketsSold / (bus.capacity || 50)) * 100, 100);

            // Calculate performance score
            let performanceScore = 0;
            if (utilization >= 80) performanceScore += 40;
            else if (utilization >= 60) performanceScore += 30;
            else if (utilization >= 40) performanceScore += 20;
            else performanceScore += 10;

            if (avgRevenuePerTrip >= 2000) performanceScore += 30;
            else if (avgRevenuePerTrip >= 1500) performanceScore += 20;
            else performanceScore += 10;

            if (ticketsSold >= 100) performanceScore += 30;
            else if (ticketsSold >= 50) performanceScore += 20;
            else if (ticketsSold >= 20) performanceScore += 10;

            return {
                bus: bus,
                totalRevenue: totalRevenue,
                ticketsSold: ticketsSold,
                avgRevenuePerTrip: avgRevenuePerTrip,
                utilization: Math.round(utilization),
                performanceScore: Math.min(performanceScore, 100)
            };
        }).sort((a, b) => b.performanceScore - a.performanceScore);

        tbody.innerHTML = busPerformanceData.map(data => {
            const routeName = 'N/A'; // Since we don't have route info in bus object

            let scoreClass = 'poor';
            if (data.performanceScore >= 80) scoreClass = 'excellent';
            else if (data.performanceScore >= 60) scoreClass = 'good';
            else if (data.performanceScore >= 40) scoreClass = 'average';

            return `
                <tr>
                    <td>
                        <div>
                            <strong>${data.bus.name || `Bus ${data.bus.id}`}</strong><br>
                            <small style="color: var(--gray-medium);">${data.bus.busLine || 'Standard'}</small>
                        </div>
                    </td>
                    <td>${routeName}</td>
                    <td class="number">${data.totalRevenue.toLocaleString()} FC</td>
                    <td class="number">${data.ticketsSold}</td>
                    <td class="number">${Math.round(data.avgRevenuePerTrip).toLocaleString()} FC</td>
                    <td class="number">
                        <span style="color: ${data.utilization >= 80 ? 'var(--green)' : data.utilization >= 60 ? 'var(--gold)' : 'var(--secondary-red)'}">
                            ${data.utilization}%
                        </span>
                    </td>
                    <td class="number">
                        <span class="status ${scoreClass}">${data.performanceScore}/100</span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn" onclick="viewBusDetails(${data.bus.id})">
                                <i class="fas fa-eye"></i>
                                Details
                            </button>
                            <button class="btn btn-success" onclick="exportBusData(${data.bus.id})">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updateBusPerformanceStats() {
        const { buses, tickets } = dashboardData;

        // Calculate bus performance metrics
        const busPerformance = buses.map(bus => {
            const busTickets = tickets.filter(ticket =>
                ticket.busId === bus.id && (ticket.status === 'PAID' || ticket.status === 'BOARDED')
            );
            return {
                bus: bus,
                revenue: busTickets.length * 2500,
                tickets: busTickets.length,
                utilization: Math.min((busTickets.length / (bus.capacity || 50)) * 100, 100)
            };
        });

        // Find top performer
        const topBus = busPerformance.reduce((max, current) =>
            current.revenue > max.revenue ? current : max, busPerformance[0] || { bus: { name: 'N/A' }, revenue: 0, tickets: 0 });

        document.getElementById('topBusName').textContent = topBus.bus.name || 'N/A';
        document.getElementById('topBusRevenue').textContent = topBus.revenue.toLocaleString() + ' FC';
        document.getElementById('topBusTickets').textContent = topBus.tickets.toString();

        // Fleet averages
        const totalRevenue = busPerformance.reduce((sum, bus) => sum + bus.revenue, 0);
        const totalTickets = busPerformance.reduce((sum, bus) => sum + bus.tickets, 0);
        const avgUtilization = busPerformance.reduce((sum, bus) => sum + bus.utilization, 0) / busPerformance.length;

        document.getElementById('fleetAvgRevenue').textContent = buses.length > 0 ?
            Math.round(totalRevenue / buses.length).toLocaleString() + ' FC' : '0 FC';
        document.getElementById('avgTicketsPerBus').textContent = buses.length > 0 ?
            Math.round(totalTickets / buses.length).toString() : '0';
        document.getElementById('avgUtilization').textContent = Math.round(avgUtilization) + '%';

        // Most popular route
        const routeCount = {};
        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const route = `${ticket.origin} → ${ticket.destination}`;
                routeCount[route] = (routeCount[route] || 0) + 1;
            }
        });

        const popularRoute = Object.keys(routeCount).reduce((a, b) =>
            routeCount[a] > routeCount[b] ? a : b, 'N/A');

        document.getElementById('popularRoute').textContent = popularRoute;
        document.getElementById('routePassengers').textContent = routeCount[popularRoute] || '0';

        // Underperforming buses
        const underperforming = busPerformance.filter(bus => bus.utilization < 50).length;
        document.getElementById('underperformingCount').textContent = underperforming.toString();
        document.getElementById('underperformingPercentage').textContent = buses.length > 0 ?
            Math.round((underperforming / buses.length) * 100) + '%' : '0%';
    }

    // Revenue Analysis Functions
    function refreshRevenueData() {
        showNotification('Refreshing revenue data...', 'info');

        updateRevenueAnalytics();
        createRevenueCharts();

        showNotification('Revenue data refreshed successfully!', 'success');
    }

    function createRevenueCharts() {
        createRevenueTrendsChart();
        createRevenueByRouteChart();
        createDailyRevenuePatternChart();
        createRevenueSourcesChart();
    }

    function createRevenueTrendsChart() {
        const ctx = document.getElementById('revenueTrendsChart');
        if (!ctx) return;

        destroyChart('revenueTrends');

        const { tickets } = dashboardData;
        const last12Months = [];
        const revenueData = [];

        // Generate last 12 months data
        for (let i = 11; i >= 0; i--) {
            const date = new Date();
            date.setMonth(date.getMonth() - i);
            last12Months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));

            const monthRevenue = tickets.filter(ticket => {
                const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                return ticketDate.getMonth() === date.getMonth() &&
                    ticketDate.getFullYear() === date.getFullYear() &&
                    (ticket.status === 'PAID' || ticket.status === 'BOARDED');
            }).reduce((sum, ticket) => sum + 2500, 0);

            revenueData.push(monthRevenue);
        }

        charts.revenueTrends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last12Months,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: revenueData,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    function createRevenueByRouteChart() {
        const ctx = document.getElementById('revenueByRouteChart');
        if (!ctx) return;

        destroyChart('revenueByRoute');

        const { tickets } = dashboardData;
        const routeRevenue = {};

        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const route = `${ticket.origin} → ${ticket.destination}`;
                routeRevenue[route] = (routeRevenue[route] || 0) + 2500;
            }
        });

        const sortedRoutes = Object.entries(routeRevenue)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8);

        const labels = sortedRoutes.map(item => item[0]);
        const data = sortedRoutes.map(item => item[1]);

        charts.revenueByRoute = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: data,
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: '#10B981',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    function createDailyRevenuePatternChart() {
        const ctx = document.getElementById('dailyRevenuePatternChart');
        if (!ctx) return;

        destroyChart('dailyRevenuePattern');

        const { tickets } = dashboardData;
        const hourlyRevenue = new Array(24).fill(0);

        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const hour = new Date(ticket.issuedAt || ticket.createdAt).getHours();
                hourlyRevenue[hour] += 2500;
            }
        });

        const labels = Array.from({length: 24}, (_, i) => `${i}:00`);

        charts.dailyRevenuePattern = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: hourlyRevenue,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    function createRevenueSourcesChart() {
        const ctx = document.getElementById('revenueSourcesChart');
        if (!ctx) return;

        destroyChart('revenueSources');

        // Simulated revenue sources
        const sources = {
            'Regular Tickets': 75,
            'Express Service': 15,
            'Premium Seats': 8,
            'Other': 2
        };

        const labels = Object.keys(sources);
        const data = Object.values(sources);

        charts.revenueSources = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#1E40AF',
                        '#10B981',
                        '#F59E0B',
                        '#8B5CF6'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed}%`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Comparison Charts Functions
    function refreshComparisonData() {
        showNotification('Refreshing comparison data...', 'info');
        updateComparisonCharts();
        showNotification('Comparison data refreshed successfully!', 'success');
    }

    function updateComparisonCharts() {
        populateComparisonFilters();
        createComparisonCharts();
    }

    function createComparisonCharts() {
        createRevenueComparisonChart();
        createPassengerComparisonChart();
        createPerformanceRadarChart();
        createEfficiencyComparisonChart();
    }

    function createRevenueComparisonChart() {
        const ctx = document.getElementById('revenueComparisonChart');
        if (!ctx) return;

        destroyChart('revenueComparison');

        const comparisonType = document.getElementById('comparisonType').value;
        const primary = document.getElementById('primarySelection').value;
        const secondary = document.getElementById('secondarySelection').value;

        if (!primary || !secondary) {
            // Show empty chart with message
            charts.revenueComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Select items to compare'
                        }
                    }
                }
            });
            return;
        }

        // Generate comparison data based on type
        let primaryData, secondaryData, labels;

        switch (comparisonType) {
            case 'bus-vs-bus':
                const { buses, tickets } = dashboardData;
                const primaryBus = buses.find(b => b.id.toString() === primary);
                const secondaryBus = buses.find(b => b.id.toString() === secondary);

                const primaryTickets = tickets.filter(t => t.busId.toString() === primary && (t.status === 'PAID' || t.status === 'BOARDED'));
                const secondaryTickets = tickets.filter(t => t.busId.toString() === secondary && (t.status === 'PAID' || t.status === 'BOARDED'));

                labels = ['Revenue', 'Tickets', 'Utilization'];
                primaryData = [
                    primaryTickets.length * 2500,
                    primaryTickets.length,
                    Math.min((primaryTickets.length / (primaryBus?.capacity || 50)) * 100, 100)
                ];
                secondaryData = [
                    secondaryTickets.length * 2500,
                    secondaryTickets.length,
                    Math.min((secondaryTickets.length / (secondaryBus?.capacity || 50)) * 100, 100)
                ];
                break;
            default:
                // Default comparison
                labels = ['Revenue', 'Performance'];
                primaryData = [150000, 85];
                secondaryData = [120000, 72];
        }

        charts.revenueComparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Primary Selection',
                    data: primaryData,
                    backgroundColor: 'rgba(30, 64, 175, 0.8)',
                    borderColor: '#1E40AF',
                    borderWidth: 1
                }, {
                    label: 'Secondary Selection',
                    data: secondaryData,
                    backgroundColor: 'rgba(220, 38, 38, 0.8)',
                    borderColor: '#DC2626',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createPassengerComparisonChart() {
        const ctx = document.getElementById('passengerComparisonChart');
        if (!ctx) return;

        destroyChart('passengerComparison');

        // Sample passenger comparison data
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        const dataset1 = [120, 135, 150, 145, 160, 175];
        const dataset2 = [100, 115, 130, 125, 140, 155];

        charts.passengerComparison = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Primary Selection',
                    data: dataset1,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    borderWidth: 2,
                    tension: 0.4
                }, {
                    label: 'Secondary Selection',
                    data: dataset2,
                    borderColor: '#DC2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    borderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createPerformanceRadarChart() {
        const ctx = document.getElementById('performanceRadarChart');
        if (!ctx) return;

        destroyChart('performanceRadar');

        const labels = ['Revenue', 'Efficiency', 'Punctuality', 'Customer Satisfaction', 'Utilization'];
        const data1 = [8, 7, 9, 8, 6];
        const data2 = [6, 8, 7, 7, 8];

        charts.performanceRadar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Primary Selection',
                    data: data1,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.2)',
                    borderWidth: 2
                }, {
                    label: 'Secondary Selection',
                    data: data2,
                    borderColor: '#DC2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.2)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 10
                    }
                }
            }
        });
    }

    function createEfficiencyComparisonChart() {
        const ctx = document.getElementById('efficiencyComparisonChart');
        if (!ctx) return;

        destroyChart('efficiencyComparison');

        const categories = ['Fuel Efficiency', 'Time Efficiency', 'Route Optimization', 'Cost Efficiency'];
        const data1 = [85, 90, 78, 82];
        const data2 = [78, 85, 85, 75];

        charts.efficiencyComparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [{
                    label: 'Primary Selection',
                    data: data1,
                    backgroundColor: 'rgba(30, 64, 175, 0.8)',
                    borderColor: '#1E40AF',
                    borderWidth: 1
                }, {
                    label: 'Secondary Selection',
                    data: data2,
                    backgroundColor: 'rgba(220, 38, 38, 0.8)',
                    borderColor: '#DC2626',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Performance Metrics Functions
    function loadPerformanceMetrics() {
        const { tickets, buses, passengers } = dashboardData;

        // Calculate real KPIs
        const totalTickets = tickets.filter(t => t.status === 'PAID' || t.status === 'BOARDED').length;
        const totalPassengers = passengers.length;
        const totalBuses = buses.length;
        const activeBuses = buses.filter(b => !b.hasAccident).length;

        // Customer Retention Rate
        const repeatPassengers = passengers.filter(p => {
            const passengerTickets = tickets.filter(t => t.passengerId === p.id);
            return passengerTickets.length > 1;
        }).length;

        const retentionRate = totalPassengers > 0 ? Math.round((repeatPassengers / totalPassengers) * 100) : 0;
        document.getElementById('retentionRate').textContent = retentionRate + '%';
        document.getElementById('retentionProgress').style.width = retentionRate + '%';
        document.getElementById('retentionStatus').textContent = retentionRate >= 80 ? 'Above Target' :
            retentionRate >= 70 ? 'On Target' : 'Below Target';

        // Average Load Factor
        const totalCapacity = buses.reduce((sum, bus) => sum + (bus.capacity || 50), 0);
        const loadFactor = totalCapacity > 0 ? Math.round((totalTickets / totalCapacity) * 100) : 0;
        document.getElementById('loadFactor').textContent = loadFactor + '%';
        document.getElementById('loadFactorProgress').style.width = Math.min(loadFactor, 100) + '%';
        document.getElementById('loadFactorStatus').textContent = loadFactor >= 75 ? 'Above Target' :
            loadFactor >= 60 ? 'On Target' : 'Below Target';

        // Revenue per Kilometer (simulated)
        const totalRevenue = totalTickets * 2500;
        const estimatedKm = totalTickets * 25; // Estimated 25km average per trip
        const revenuePerKm = estimatedKm > 0 ? Math.round(totalRevenue / estimatedKm) : 0;
        document.getElementById('revenuePerKm').textContent = revenuePerKm + ' FC';
        document.getElementById('revenuePerKmProgress').style.width = Math.min((revenuePerKm / 150) * 100, 100) + '%';
        document.getElementById('revenuePerKmStatus').textContent = revenuePerKm >= 150 ? 'Above Target' :
            revenuePerKm >= 120 ? 'On Target' : 'Needs Improvement';

        // On-Time Performance (simulated)
        const onTimePerformance = Math.floor(Math.random() * 20) + 75; // 75-95%
        document.getElementById('onTimePerformance').textContent = onTimePerformance + '%';
        document.getElementById('onTimeProgress').style.width = onTimePerformance + '%';
        document.getElementById('onTimeStatus').textContent = onTimePerformance >= 90 ? 'Above Target' :
            onTimePerformance >= 80 ? 'On Target' : 'Below Target';

        // Create KPI charts
        createKPITrendsChart();
        createBenchmarkingChart();
    }

    function createKPITrendsChart() {
        const ctx = document.getElementById('kpiTrendsChart');
        if (!ctx) return;

        destroyChart('kpiTrends');

        const months = [];
        for (let i = 5; i >= 0; i--) {
            const date = new Date();
            date.setMonth(date.getMonth() - i);
            months.push(date.toLocaleDateString('en-US', { month: 'short' }));
        }

        // Generate trend data
        const retentionTrend = [75, 78, 82, 85, 83, 87];
        const loadFactorTrend = [65, 68, 72, 75, 73, 78];
        const revenuePerKmTrend = [140, 145, 148, 152, 150, 155];
        const onTimeTrend = [85, 88, 87, 90, 89, 92];

        charts.kpiTrends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Retention Rate (%)',
                    data: retentionTrend,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    tension: 0.4
                }, {
                    label: 'Load Factor (%)',
                    data: loadFactorTrend,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    borderWidth: 2,
                    tension: 0.4
                }, {
                    label: 'Revenue/km (FC)',
                    data: revenuePerKmTrend,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    yAxisID: 'y1'
                }, {
                    label: 'On-Time Performance (%)',
                    data: onTimeTrend,
                    borderColor: '#8B5CF6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        max: 200,
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }

    function createBenchmarkingChart() {
        const ctx = document.getElementById('benchmarkingChart');
        if (!ctx) return;

        destroyChart('benchmarking');

        const categories = ['Customer Retention', 'Load Factor', 'Revenue/km', 'On-Time Performance', 'Cost Efficiency'];
        const ourPerformance = [87, 78, 85, 92, 75];
        const industryAverage = [75, 70, 80, 85, 70];
        const bestInClass = [95, 90, 95, 98, 90];

        charts.benchmarking = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [{
                    label: 'Our Performance',
                    data: ourPerformance,
                    backgroundColor: 'rgba(30, 64, 175, 0.8)',
                    borderColor: '#1E40AF',
                    borderWidth: 1
                }, {
                    label: 'Industry Average',
                    data: industryAverage,
                    backgroundColor: 'rgba(245, 158, 11, 0.8)',
                    borderColor: '#F59E0B',
                    borderWidth: 1
                }, {
                    label: 'Best in Class',
                    data: bestInClass,
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: '#10B981',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Time Analysis Functions
    function createTimeAnalysisCharts() {
        createPeakHoursAnalysisChart();
        createWeeklyPatternsChart();
        createSeasonalTrendsChart();
        createTimeRevenueChart();
    }

    function createPeakHoursAnalysisChart() {
        const ctx = document.getElementById('peakHoursAnalysisChart');
        if (!ctx) return;

        destroyChart('peakHoursAnalysis');

        const { tickets } = dashboardData;
        const hourlyData = new Array(24).fill(0);

        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const hour = new Date(ticket.issuedAt || ticket.createdAt).getHours();
                hourlyData[hour]++;
            }
        });

        const labels = Array.from({length: 24}, (_, i) => `${i}:00`);

        charts.peakHoursAnalysis = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Passenger Count',
                    data: hourlyData,
                    backgroundColor: hourlyData.map((value, index) => {
                        const max = Math.max(...hourlyData);
                        const intensity = value / max;
                        return `rgba(30, 64, 175, ${0.3 + intensity * 0.7})`;
                    }),
                    borderColor: '#1E40AF',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createWeeklyPatternsChart() {
        const ctx = document.getElementById('weeklyPatternsChart');
        if (!ctx) return;

        destroyChart('weeklyPatterns');

        const { tickets } = dashboardData;
        const weeklyData = new Array(7).fill(0);
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const dayOfWeek = new Date(ticket.issuedAt || ticket.createdAt).getDay();
                weeklyData[dayOfWeek]++;
            }
        });

        charts.weeklyPatterns = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: dayNames,
                datasets: [{
                    data: weeklyData,
                    backgroundColor: [
                        '#1E40AF', '#DC2626', '#10B981', '#F59E0B',
                        '#8B5CF6', '#EC4899', '#06B6D4'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function createSeasonalTrendsChart() {
        const ctx = document.getElementById('seasonalTrendsChart');
        if (!ctx) return;

        destroyChart('seasonalTrends');

        const { tickets } = dashboardData;
        const monthlyData = new Array(12).fill(0);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const month = new Date(ticket.issuedAt || ticket.createdAt).getMonth();
                monthlyData[month]++;
            }
        });

        charts.seasonalTrends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthNames,
                datasets: [{
                    label: 'Passenger Count',
                    data: monthlyData,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createTimeRevenueChart() {
        const ctx = document.getElementById('timeRevenueChart');
        if (!ctx) return;

        destroyChart('timeRevenue');

        const { tickets } = dashboardData;
        const hourlyRevenue = new Array(24).fill(0);

        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const hour = new Date(ticket.issuedAt || ticket.createdAt).getHours();
                hourlyRevenue[hour] += 2500;
            }
        });

        const labels = Array.from({length: 24}, (_, i) => `${i}:00`);

        charts.timeRevenue = new Chart(ctx, {
            type: 'area',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: hourlyRevenue,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.3)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    // Geographic Analysis Functions
    function createGeographicAnalysisCharts() {
        createRoutePerformanceChart();
        createOriginDestinationChart();
    }

    function createRoutePerformanceChart() {
        const ctx = document.getElementById('routePerformanceChart');
        if (!ctx) return;

        destroyChart('routePerformance');

        const { tickets } = dashboardData;
        const routePerformance = {};

        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                const route = `${ticket.origin} → ${ticket.destination}`;
                if (!routePerformance[route]) {
                    routePerformance[route] = { count: 0, revenue: 0 };
                }
                routePerformance[route].count++;
                routePerformance[route].revenue += 2500;
            }
        });

        const routes = Object.keys(routePerformance).slice(0, 10);
        const revenues = routes.map(route => routePerformance[route].revenue);

        charts.routePerformance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: routes,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: revenues,
                    backgroundColor: 'rgba(139, 92, 246, 0.8)',
                    borderColor: '#8B5CF6',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    function createOriginDestinationChart() {
        const ctx = document.getElementById('originDestinationChart');
        if (!ctx) return;

        destroyChart('originDestination');

        const { tickets } = dashboardData;
        const locations = {};

        tickets.forEach(ticket => {
            if (ticket.status === 'PAID' || ticket.status === 'BOARDED') {
                locations[ticket.origin] = (locations[ticket.origin] || 0) + 1;
                locations[ticket.destination] = (locations[ticket.destination] || 0) + 1;
            }
        });

        const sortedLocations = Object.entries(locations)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8);

        const labels = sortedLocations.map(item => item[0]);
        const data = sortedLocations.map(item => item[1]);

        charts.originDestination = new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(30, 64, 175, 0.8)',
                        'rgba(220, 38, 38, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                        'rgba(6, 182, 212, 0.8)',
                        'rgba(132, 204, 22, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Customer Insights Functions
    function createCustomerInsightsCharts() {
        createCustomerSegmentationChart();
        createCustomerLifetimeValueChart();
        createCustomerJourneyChart();
        createLoyaltyAnalysisChart();
    }

    function createCustomerSegmentationChart() {
        const ctx = document.getElementById('customerSegmentationChart');
        if (!ctx) return;

        destroyChart('customerSegmentation');

        const { passengers, tickets } = dashboardData;
        const segments = { new: 0, occasional: 0, regular: 0, vip: 0 };

        passengers.forEach(passenger => {
            const passengerTickets = tickets.filter(t =>
                t.passengerId === passenger.id && (t.status === 'PAID' || t.status === 'BOARDED')
            );
            const tripCount = passengerTickets.length;

            if (tripCount === 1) segments.new++;
            else if (tripCount <= 4) segments.occasional++;
            else if (tripCount <= 10) segments.regular++;
            else segments.vip++;
        });

        const labels = ['New Customers', 'Occasional', 'Regular', 'VIP'];
        const data = [segments.new, segments.occasional, segments.regular, segments.vip];

        charts.customerSegmentation = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#DC2626',
                        '#F59E0B',
                        '#1E40AF',
                        '#10B981'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function createCustomerLifetimeValueChart() {
        const ctx = document.getElementById('customerLifetimeValueChart');
        if (!ctx) return;

        destroyChart('customerLifetimeValue');

        const { passengers, tickets } = dashboardData;
        const clvRanges = { '0-10k': 0, '10k-25k': 0, '25k-50k': 0, '50k+': 0 };

        passengers.forEach(passenger => {
            const passengerTickets = tickets.filter(t =>
                t.passengerId === passenger.id && (t.status === 'PAID' || t.status === 'BOARDED')
            );
            const totalValue = passengerTickets.length * 2500;

            if (totalValue <= 10000) clvRanges['0-10k']++;
            else if (totalValue <= 25000) clvRanges['10k-25k']++;
            else if (totalValue <= 50000) clvRanges['25k-50k']++;
            else clvRanges['50k+']++;
        });

        const labels = Object.keys(clvRanges);
        const data = Object.values(clvRanges);

        charts.customerLifetimeValue = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Customers',
                    data: data,
                    backgroundColor: [
                        'rgba(220, 38, 38, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(30, 64, 175, 0.8)',
                        'rgba(16, 185, 129, 0.8)'
                    ],
                    borderColor: [
                        '#DC2626',
                        '#F59E0B',
                        '#1E40AF',
                        '#10B981'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createCustomerJourneyChart() {
        const ctx = document.getElementById('customerJourneyChart');
        if (!ctx) return;

        destroyChart('customerJourney');

        // Customer journey stages
        const stages = ['Awareness', 'Consideration', 'Purchase', 'Retention', 'Advocacy'];
        const conversionRates = [100, 75, 45, 65, 25]; // Simulated conversion rates

        charts.customerJourney = new Chart(ctx, {
            type: 'line',
            data: {
                labels: stages,
                datasets: [{
                    label: 'Conversion Rate (%)',
                    data: conversionRates,
                    borderColor: '#8B5CF6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#8B5CF6',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function createLoyaltyAnalysisChart() {
        const ctx = document.getElementById('loyaltyAnalysisChart');
        if (!ctx) return;

        destroyChart('loyaltyAnalysis');

        const { passengers, tickets } = dashboardData;
        const loyaltyMetrics = {
            'Repeat Rate': 0,
            'Frequency': 0,
            'Monetary': 0,
            'Tenure': 0
        };

        // Calculate loyalty metrics
        const repeatCustomers = passengers.filter(p => {
            const passengerTickets = tickets.filter(t => t.passengerId === p.id);
            return passengerTickets.length > 1;
        });

        loyaltyMetrics['Repeat Rate'] = passengers.length > 0 ?
            Math.round((repeatCustomers.length / passengers.length) * 100) : 0;

        // Average frequency
        const totalTrips = tickets.filter(t => t.status === 'PAID' || t.status === 'BOARDED').length;
        loyaltyMetrics['Frequency'] = passengers.length > 0 ?
            Math.round((totalTrips / passengers.length) * 10) : 0; // Scale to 0-100

        // Monetary (average spending per customer as percentage)
        const totalRevenue = totalTrips * 2500;
        const avgSpending = passengers.length > 0 ? totalRevenue / passengers.length : 0;
        loyaltyMetrics['Monetary'] = Math.min(Math.round(avgSpending / 1000), 100);

        // Tenure (simulated - percentage of customers with >3 months)
        loyaltyMetrics['Tenure'] = Math.floor(Math.random() * 30) + 60; // 60-90%

        const labels = Object.keys(loyaltyMetrics);
        const data = Object.values(loyaltyMetrics);

        charts.loyaltyAnalysis = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Loyalty Score',
                    data: data,
                    borderColor: '#EC4899',
                    backgroundColor: 'rgba(236, 72, 153, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: '#EC4899',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20
                        }
                    }
                }
            }
        });
    }

    // Export Functions
    async function exportDashboardData() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Add logo
            try {
                const logoImg = new Image();
                logoImg.src = 'images/logoImas.jpg';
                logoImg.onload = function() {
                    doc.addImage(logoImg, 'JPEG', 20, 10, 30, 15);
                    generatePDFContent();
                };
                logoImg.onerror = function() {
                    console.log('Logo not found, continuing without logo');
                    generatePDFContent();
                };
            } catch (error) {
                console.log('Error loading logo, continuing without logo');
                generatePDFContent();
            }

            function generatePDFContent() {
                // Header
                doc.setFillColor(30, 64, 175);
                doc.rect(60, 10, 220, 20, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('IMAS - Dashboard Overview Report', 70, 23);

                // Statistics
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                let yPos = 45;

                const stats = [
                    ['Total Passengers:', document.getElementById('totalPassengers').textContent],
                    ['Total Revenue:', document.getElementById('totalRevenue').textContent],
                    ['Total Trips:', document.getElementById('totalTrips').textContent],
                    ['Active Buses:', document.getElementById('activeBuses').textContent]
                ];

                stats.forEach(([label, value]) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, 20, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, 120, yPos);
                    yPos += 10;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on ${new Date().toLocaleString()} by IMAS Analytics`, 20, 190);

                doc.save('IMAS-Dashboard-Overview.pdf');
                showNotification('Dashboard report exported successfully!', 'success');
            }

        } catch (error) {
            console.error('Export error:', error);
            showNotification('Failed to export dashboard report: ' + error.message, 'error');
        }
    }

    // Export Passenger Data
    async function exportPassengerData(passengerId) {
        try {
            const { passengers, tickets } = dashboardData;
            const passenger = passengers.find(p => p.id === passengerId);
            if (!passenger) throw new Error('Passenger not found');

            const passengerTickets = tickets.filter(ticket =>
                ticket.passengerId === passengerId ||
                (ticket.firstName === passenger.firstName && ticket.lastName === passenger.lastName)
            );

            const totalSpent = passengerTickets.reduce((sum, t) => sum + ((t.status === 'PAID' || t.status === 'BOARDED') ? 2500 : 0), 0);

            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add logo
            try {
                const logoImg = new Image();
                logoImg.src = 'images/logoImas.jpg';
                logoImg.onload = function() {
                    doc.addImage(logoImg, 'JPEG', 20, 10, 25, 12);
                    generatePassengerPDF();
                };
                logoImg.onerror = function() {
                    generatePassengerPDF();
                };
            } catch (error) {
                generatePassengerPDF();
            }

            function generatePassengerPDF() {
                // Header
                doc.setFillColor(30, 64, 175);
                doc.rect(0, 0, 210, 40, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('IMAS', 55, 25);

                doc.setFontSize(12);
                doc.text('Passenger Analysis Report', 55, 33);

                // Passenger Information
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Passenger Information', 20, 55);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                let yPos = 65;

                const info = [
                    ['Name:', `${passenger.firstName} ${passenger.lastName}`],
                    ['Email:', passenger.email || 'N/A'],
                    ['Phone:', passenger.phoneNumber || 'N/A'],
                    ['Passenger ID:', passenger.id.toString()],
                    ['Total Trips:', passengerTickets.filter(t => t.status === 'PAID' || t.status === 'BOARDED').length.toString()],
                    ['Total Spent:', `${totalSpent.toLocaleString()} FC`],
                    ['Average per Trip:', `${passengerTickets.length > 0 ? Math.round(totalSpent / passengerTickets.length).toLocaleString() : 0} FC`]
                ];

                info.forEach(([label, value]) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, 20, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, 80, yPos);
                    yPos += 8;
                });

                // Trip History
                yPos += 10;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('Trip History', 20, yPos);
                yPos += 10;

                // Table headers
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Date', 20, yPos);
                doc.text('Route', 50, yPos);
                doc.text('Seat', 120, yPos);
                doc.text('Amount', 140, yPos);
                doc.text('Status', 170, yPos);
                yPos += 8;

                // Draw line
                doc.setDrawColor(200, 200, 200);
                doc.line(20, yPos - 2, 190, yPos - 2);
                yPos += 2;

                // Trip data
                doc.setFont('helvetica', 'normal');
                passengerTickets.slice(0, 20).forEach(ticket => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }

                    const date = new Date(ticket.issuedAt || ticket.createdAt).toLocaleDateString();
                    doc.text(date, 20, yPos);
                    doc.text(`${ticket.origin} → ${ticket.destination}`, 50, yPos);
                    doc.text(ticket.seatNumber || 'N/A', 120, yPos);
                    doc.text('2,500 FC', 140, yPos);
                    doc.text(ticket.status, 170, yPos);
                    yPos += 6;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on ${new Date().toLocaleDateString()} by IMAS Analytics`, 20, 280);
                doc.text(`Report ID: PAX-${passengerId}-${Date.now()}`, 20, 285);

                // Save PDF
                doc.save(`IMAS-Passenger-Report-${passenger.firstName}_${passenger.lastName}-${passengerId}.pdf`);
                showNotification('Passenger report exported successfully!', 'success');
            }

        } catch (error) {
            console.error('Export error:', error);
            showNotification('Failed to export passenger report: ' + error.message, 'error');
        }
    }

    // All Export Report Functions
    function exportPassengerReport() {
        exportFilteredPassengerReport('comprehensive');
    }

    function exportPassengerDetailReport() {
        exportFilteredPassengerReport('detailed');
    }

    function exportPassengerSpendingReport() {
        exportFilteredPassengerReport('spending');
    }

    function exportPassengerBehaviorReport() {
        exportFilteredPassengerReport('behavior');
    }

    function exportBusPerformanceReport() {
        exportBusPerformanceDetailReport();
    }

    function exportBusPerformanceDetailReport() {
        exportBusReport('performance');
    }

    function exportRouteAnalysisReport() {
        exportBusReport('routes');
    }

    function exportUtilizationReport() {
        exportBusReport('utilization');
    }

    function exportRevenueReport() {
        exportRevenueDetailReport();
    }

    function exportRevenueDetailReport() {
        exportFinancialReport('revenue');
    }

    function exportProfitabilityReport() {
        exportFinancialReport('profitability');
    }

    function exportFinancialSummaryReport() {
        exportFinancialReport('summary');
    }

    function exportComparisonReport() {
        exportComparisonData();
    }

    async function exportFilteredPassengerReport(type) {
        try {
            if (!filteredData || filteredData.length === 0) {
                showNotification('No data to export. Please apply filters first.', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Add logo and generate report
            generateReportWithLogo(doc, `IMAS - ${type.charAt(0).toUpperCase() + type.slice(1)} Passenger Report`, () => {
                // Summary
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                let yPos = 45;

                doc.text(`Total Passengers: ${filteredData.length}`, 20, yPos);
                yPos += 8;
                doc.text(`Total Revenue: ${filteredData.reduce((sum, p) => sum + p.totalSpent, 0).toLocaleString()} FC`, 20, yPos);
                yPos += 8;
                doc.text(`Average Revenue per Passenger: ${Math.round(filteredData.reduce((sum, p) => sum + p.totalSpent, 0) / filteredData.length).toLocaleString()} FC`, 20, yPos);
                yPos += 15;

                // Table headers
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                const headers = ['Name', 'Email', 'Phone', 'Trips', 'Total Spent', 'Avg/Trip', 'Favorite Route'];
                const colWidths = [35, 45, 30, 15, 20, 20, 45];
                let xPos = 20;

                headers.forEach((header, i) => {
                    doc.text(header, xPos, yPos);
                    xPos += colWidths[i];
                });
                yPos += 8;

                // Table data
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);

                filteredData.slice(0, 25).forEach(passenger => {
                    if (yPos > 180) {
                        doc.addPage('landscape');
                        yPos = 20;
                    }

                    xPos = 20;
                    const data = [
                        `${passenger.firstName} ${passenger.lastName}`,
                        passenger.email || 'N/A',
                        passenger.phoneNumber || 'N/A',
                        passenger.totalTrips.toString(),
                        `${passenger.totalSpent.toLocaleString()} FC`,
                        `${Math.round(passenger.avgPerTrip).toLocaleString()} FC`,
                        passenger.favoriteRoute || 'N/A'
                    ];

                    data.forEach((item, i) => {
                        const text = item.length > 12 ? item.substring(0, 12) + '...' : item;
                        doc.text(text, xPos, yPos);
                        xPos += colWidths[i];
                    });
                    yPos += 6;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on ${new Date().toLocaleString()} by IMAS Analytics`, 20, 190);

                doc.save(`IMAS-${type}-Passenger-Report.pdf`);
                showNotification(`${type} passenger report exported successfully!`, 'success');
            });

        } catch (error) {
            console.error('Export error:', error);
            showNotification(`Failed to export ${type} report: ` + error.message, 'error');
        }
    }

    async function exportBusReport(type) {
        try {
            const { buses, tickets } = dashboardData;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            generateReportWithLogo(doc, `IMAS - Bus ${type.charAt(0).toUpperCase() + type.slice(1)} Report`, () => {
                let yPos = 45;

                // Calculate bus performance data
                const busData = buses.map(bus => {
                    const busTickets = tickets.filter(t => t.busId === bus.id && (t.status === 'PAID' || t.status === 'BOARDED'));
                    return {
                        name: bus.name || `Bus ${bus.id}`,
                        tickets: busTickets.length,
                        revenue: busTickets.length * 2500,
                        utilization: Math.min((busTickets.length / (bus.capacity || 50)) * 100, 100)
                    };
                });

                // Summary
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.text(`Total Buses: ${buses.length}`, 20, yPos);
                yPos += 8;
                doc.text(`Active Buses: ${buses.filter(b => !b.hasAccident).length}`, 20, yPos);
                yPos += 8;
                doc.text(`Total Revenue: ${busData.reduce((sum, b) => sum + b.revenue, 0).toLocaleString()} FC`, 20, yPos);
                yPos += 15;

                // Table
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                const headers = ['Bus Name', 'Line', 'Tickets Sold', 'Revenue (FC)', 'Utilization %', 'Status'];
                const colWidths = [40, 25, 25, 30, 25, 25];
                let xPos = 20;

                headers.forEach((header, i) => {
                    doc.text(header, xPos, yPos);
                    xPos += colWidths[i];
                });
                yPos += 8;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);

                buses.slice(0, 20).forEach(bus => {
                    if (yPos > 180) {
                        doc.addPage('landscape');
                        yPos = 20;
                    }

                    const busPerformance = busData.find(b => b.name === (bus.name || `Bus ${bus.id}`));

                    xPos = 20;
                    const data = [
                        bus.name || `Bus ${bus.id}`,
                        bus.busLine || 'Standard',
                        busPerformance?.tickets.toString() || '0',
                        busPerformance?.revenue.toLocaleString() || '0',
                        Math.round(busPerformance?.utilization || 0).toString() + '%',
                        bus.hasAccident ? 'Accident' : 'Active'
                    ];

                    data.forEach((item, i) => {
                        doc.text(item, xPos, yPos);
                        xPos += colWidths[i];
                    });
                    yPos += 6;
                });

                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on ${new Date().toLocaleString()} by IMAS Analytics`, 20, 190);

                doc.save(`IMAS-Bus-${type}-Report.pdf`);
                showNotification(`Bus ${type} report exported successfully!`, 'success');
            });

        } catch (error) {
            console.error('Export error:', error);
            showNotification(`Failed to export bus ${type} report: ` + error.message, 'error');
        }
    }

    async function exportFinancialReport(type) {
        try {
            const { tickets } = dashboardData;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            generateReportWithLogo(doc, `IMAS - ${type.charAt(0).toUpperCase() + type.slice(1)} Financial Report`, () => {
                const paidTickets = tickets.filter(t => t.status === 'PAID' || t.status === 'BOARDED');
                const totalRevenue = paidTickets.length * 2500;

                let yPos = 45;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Financial Summary', 20, yPos);
                yPos += 15;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');

                const financialData = [
                    ['Total Revenue:', `${totalRevenue.toLocaleString()} FC`],
                    ['Total Tickets Sold:', paidTickets.length.toString()],
                    ['Average Revenue per Ticket:', '2,500 FC'],
                    ['Operating Period:', 'Last 12 Months'],
                    ['Growth Rate:', '+15.3%'],
                    ['Market Share:', '23%']
                ];

                financialData.forEach(([label, value]) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, 20, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, 100, yPos);
                    yPos += 10;
                });

                // Monthly breakdown
                yPos += 15;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.text('Monthly Breakdown', 20, yPos);
                yPos += 10;

                doc.setFontSize(10);
                doc.text('Month', 20, yPos);
                doc.text('Revenue (FC)', 60, yPos);
                doc.text('Tickets', 110, yPos);
                doc.text('Growth %', 150, yPos);
                yPos += 8;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);

                // Generate 6 months of data
                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const month = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

                    const monthTickets = paidTickets.filter(ticket => {
                        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                        return ticketDate.getMonth() === date.getMonth() &&
                            ticketDate.getFullYear() === date.getFullYear();
                    });

                    const monthRevenue = monthTickets.length * 2500;
                    const growth = Math.floor(Math.random() * 30) - 10; // -10% to +20%

                    doc.text(month, 20, yPos);
                    doc.text(monthRevenue.toLocaleString(), 60, yPos);
                    doc.text(monthTickets.length.toString(), 110, yPos);
                    doc.text((growth >= 0 ? '+' : '') + growth.toFixed(1) + '%', 150, yPos);
                    yPos += 8;
                }

                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on ${new Date().toLocaleString()} by IMAS Analytics`, 20, 280);

                doc.save(`IMAS-${type}-Financial-Report.pdf`);
                showNotification(`${type} financial report exported successfully!`, 'success');
            });

        } catch (error) {
            console.error('Export error:', error);
            showNotification(`Failed to export ${type} financial report: ` + error.message, 'error');
        }
    }

    async function exportComparisonData() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            generateReportWithLogo(doc, 'IMAS - Comparison Analysis Report', () => {
                const comparisonType = document.getElementById('comparisonType').value;
                const primary = document.getElementById('primarySelection').value;
                const secondary = document.getElementById('secondarySelection').value;

                let yPos = 45;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Comparison Analysis', 20, yPos);
                yPos += 15;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Comparison Type: ${comparisonType}`, 20, yPos);
                yPos += 8;
                doc.text(`Primary Selection: ${primary || 'Not Selected'}`, 20, yPos);
                yPos += 8;
                doc.text(`Secondary Selection: ${secondary || 'Not Selected'}`, 20, yPos);
                yPos += 20;

                if (primary && secondary) {
                    // Sample comparison data
                    doc.setFont('helvetica', 'bold');
                    doc.text('Performance Metrics', 20, yPos);
                    yPos += 10;

                    const metrics = [
                        ['Revenue:', '150,000 FC', '120,000 FC'],
                        ['Efficiency:', '85%', '72%'],
                        ['Customer Satisfaction:', '4.6/5', '4.2/5'],
                        ['Utilization Rate:', '78%', '65%'],
                        ['Growth Rate:', '+12%', '+8%']
                    ];

                    doc.setFontSize(10);
                    doc.text('Metric', 20, yPos);
                    doc.text('Primary', 80, yPos);
                    doc.text('Secondary', 130, yPos);
                    yPos += 8;

                    doc.setFont('helvetica', 'normal');
                    metrics.forEach(([metric, primary, secondary]) => {
                        doc.text(metric, 20, yPos);
                        doc.text(primary, 80, yPos);
                        doc.text(secondary, 130, yPos);
                        yPos += 8;
                    });
                } else {
                    doc.setFont('helvetica', 'italic');
                    doc.text('Please select both primary and secondary items for detailed comparison.', 20, yPos);
                }

                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on ${new Date().toLocaleString()} by IMAS Analytics`, 20, 280);

                doc.save('IMAS-Comparison-Analysis-Report.pdf');
                showNotification('Comparison report exported successfully!', 'success');
            });

        } catch (error) {
            console.error('Export error:', error);
            showNotification('Failed to export comparison report: ' + error.message, 'error');
        }
    }

    function generateCustomReport() {
        const reportType = document.getElementById('customReportType').value;
        const startDate = document.getElementById('customStartDate').value;
        const endDate = document.getElementById('customEndDate').value;
        const format = document.getElementById('exportFormat').value;

        if (!startDate || !endDate) {
            showNotification('Please select date range for custom report', 'warning');
            return;
        }

        showNotification('Generating custom report...', 'info');

        switch (reportType) {
            case 'passenger':
                exportFilteredPassengerReport('custom');
                break;
            case 'revenue':
                exportFinancialReport('custom');
                break;
            case 'performance':
                exportBusReport('performance');
                break;
            case 'comparison':
                exportComparisonData();
                break;
            default:
                exportDashboardData();
        }
    }

    function generateReportWithLogo(doc, title, contentCallback) {
        try {
            const logoImg = new Image();
            logoImg.src = 'images/logoImas.jpg';
            logoImg.onload = function() {
                doc.addImage(logoImg, 'JPEG', 20, 10, 25, 12);
                addReportHeader();
            };
            logoImg.onerror = function() {
                console.log('Logo not found, continuing without logo');
                addReportHeader();
            };
        } catch (error) {
            console.log('Error loading logo, continuing without logo');
            addReportHeader();
        }

        function addReportHeader() {
            // Header
            doc.setFillColor(30, 64, 175);
            const headerWidth = doc.internal.pageSize.width === 210 ? 210 : 297; // A4 portrait vs landscape
            doc.rect(0, 0, headerWidth, 30, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(title, 55, 20);

            contentCallback();
        }
    }

    // View Bus Details
    function viewBusDetails(busId) {
        const { buses, tickets } = dashboardData;
        const bus = buses.find(b => b.id === busId);
        if (!bus) return;

        const busTickets = tickets.filter(ticket => ticket.busId === busId);

        const modalContent = document.getElementById('busDetailContent');
        modalContent.innerHTML = `
            <div class="analytics-grid">
                <div class="analytics-card">
                    <div class="analytics-header">
                        <h3 class="analytics-title">Bus Information</h3>
                    </div>
                    <div>
                        <p><strong>Name:</strong> ${bus.name || `Bus ${bus.id}`}</p>
                        <p><strong>Line:</strong> ${bus.busLine || 'Standard'}</p>
                        <p><strong>Capacity:</strong> ${bus.capacity || 50} passengers</p>
                        <p><strong>Status:</strong> ${bus.hasAccident ? 'Out of Service' : 'Active'}</p>
                    </div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-header">
                        <h3 class="analytics-title">Performance Metrics</h3>
                    </div>
                    <div>
                        <p><strong>Total Tickets:</strong> ${busTickets.length}</p>
                        <p><strong>Total Revenue:</strong> ${(busTickets.filter(t => t.status === 'PAID' || t.status === 'BOARDED').length * 2500).toLocaleString()} FC</p>
                        <p><strong>Utilization:</strong> ${Math.round((busTickets.length / (bus.capacity || 50)) * 100)}%</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Trips</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Route</th>
                                <th>Passenger</th>
                                <th>Seat</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${busTickets.slice(0, 20).map(ticket => `
                                <tr>
                                    <td>${new Date(ticket.issuedAt || ticket.createdAt).toLocaleDateString()}</td>
                                    <td>${ticket.origin} → ${ticket.destination}</td>
                                    <td>${ticket.firstName} ${ticket.lastName}</td>
                                    <td>${ticket.seatNumber || 'N/A'}</td>
                                    <td class="number">2,500 FC</td>
                                    <td><span class="status ${ticket.status.toLowerCase()}">${ticket.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-success" onclick="exportBusData(${busId})">
                    <i class="fas fa-download"></i>
                    Export Bus Report
                </button>
            </div>
        `;

        openModal('busDetailModal');
    }

    // Export Bus Data
    async function exportBusData(busId) {
        try {
            const { buses, tickets } = dashboardData;
            const bus = buses.find(b => b.id === busId);
            if (!bus) throw new Error('Bus not found');

            const busTickets = tickets.filter(ticket => ticket.busId === busId);
            const revenue = busTickets.filter(t => t.status === 'PAID' || t.status === 'BOARDED').length * 2500;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            generateReportWithLogo(doc, 'IMAS - Bus Performance Report', () => {
                let yPos = 45;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Bus Information', 20, yPos);
                yPos += 15;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');

                const info = [
                    ['Bus Name:', bus.name || `Bus ${bus.id}`],
                    ['Bus Line:', bus.busLine || 'Standard'],
                    ['Capacity:', `${bus.capacity || 50} passengers`],
                    ['Status:', bus.hasAccident ? 'Out of Service' : 'Active'],
                    ['Total Tickets:', busTickets.length.toString()],
                    ['Total Revenue:', `${revenue.toLocaleString()} FC`],
                    ['Utilization:', `${Math.round((busTickets.length / (bus.capacity || 50)) * 100)}%`]
                ];

                info.forEach(([label, value]) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, 20, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, 80, yPos);
                    yPos += 8;
                });

                // Recent trips
                yPos += 10;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('Recent Trips', 20, yPos);
                yPos += 10;

                // Table headers
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Date', 20, yPos);
                doc.text('Route', 50, yPos);
                doc.text('Passenger', 100, yPos);
                doc.text('Seat', 140, yPos);
                doc.text('Status', 160, yPos);
                yPos += 8;

                // Draw line
                doc.setDrawColor(200, 200, 200);
                doc.line(20, yPos - 2, 190, yPos - 2);
                yPos += 2;

                // Trip data
                doc.setFont('helvetica', 'normal');
                busTickets.slice(0, 20).forEach(ticket => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }

                    const date = new Date(ticket.issuedAt || ticket.createdAt).toLocaleDateString();
                    doc.text(date, 20, yPos);
                    doc.text(`${ticket.origin} → ${ticket.destination}`, 50, yPos);
                    doc.text(`${ticket.firstName} ${ticket.lastName}`, 100, yPos);
                    doc.text(ticket.seatNumber || 'N/A', 140, yPos);
                    doc.text(ticket.status, 160, yPos);
                    yPos += 6;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Generated on ${new Date().toLocaleDateString()} by IMAS Analytics`, 20, 280);
                doc.text(`Report ID: BUS-${busId}-${Date.now()}`, 20, 285);

                doc.save(`IMAS-Bus-Performance-Report-${bus.name || 'Bus-' + busId}-${busId}.pdf`);
                showNotification('Bus performance report exported successfully!', 'success');
            });

        } catch (error) {
            console.error('Export error:', error);
            showNotification('Failed to export bus report: ' + error.message, 'error');
        }
    }

    // Helper Functions
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function destroyChart(chartKey) {
        if (charts[chartKey]) {
            charts[chartKey].destroy();
            charts[chartKey] = null;
        }
    }

    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function showSection(sectionName, event) {
        console.log('📄 Showing section:', sectionName);

        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });

        const targetSection = document.getElementById(sectionName + '-section');
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }

        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.classList.remove('active');
        });

        if (event) {
            const clickedLink = event.target.closest('a');
            if (clickedLink) {
                clickedLink.classList.add('active');
            }
        } else {
            const targetLink = document.querySelector(`[onclick*="${sectionName}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
        }

        // Load section-specific data
        switch(sectionName) {
            case 'dashboard':
                break;
            case 'passenger-analysis':
                setTimeout(() => filterPassengers(), 100);
                break;
            case 'spending-analytics':
                setTimeout(() => updateSpendingAnalysis(), 100);
                break;
            case 'bus-performance':
                setTimeout(() => updateBusPerformanceAnalysis(), 100);
                break;
            case 'revenue-analysis':
                setTimeout(() => refreshRevenueData(), 100);
                break;
            case 'comparison-charts':
                setTimeout(() => refreshComparisonData(), 100);
                break;
            case 'performance-metrics':
                setTimeout(() => loadPerformanceMetrics(), 100);
                break;
            case 'time-analysis':
                setTimeout(() => createTimeAnalysisCharts(), 100);
                break;
            case 'geographic-analysis':
                setTimeout(() => createGeographicAnalysisCharts(), 100);
                break;
            case 'customer-insights':
                setTimeout(() => createCustomerInsightsCharts(), 100);
                break;
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const header = document.getElementById('header');

        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
        header.classList.toggle('expanded');
    }

    function toggleTheme() {
        const body = document.body;
        const themeToggle = document.getElementById('themeToggle');
        const icon = themeToggle.querySelector('i');

        if (body.getAttribute('data-theme') === 'dark') {
            body.setAttribute('data-theme', 'light');
            icon.className = 'fas fa-moon';
        } else {
            body.setAttribute('data-theme', 'dark');
            icon.className = 'fas fa-sun';
        }
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('userSession');
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }
    }

    // Refresh Functions
    function refreshDashboard() {
        showNotification('Refreshing dashboard data...', 'info');
        loadDashboardData();
    }

    function refreshPassengerData() {
        showNotification('Refreshing passenger data...', 'info');
        filterPassengers();
    }

    function refreshSpendingData() {
        showNotification('Refreshing spending data...', 'info');
        updateSpendingAnalysis();
    }

    function refreshBusPerformanceData() {
        showNotification('Refreshing bus performance data...', 'info');
        updateBusPerformanceAnalysis();
    }

    // Notification System
    function showNotification(message, type = 'info') {
        // Create notification
        const notification = document.createElement('div');
        notification.className = `notification-toast ${type}`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Remove after 5 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);

        // Add to notifications list
        const newNotification = {
            id: Date.now(),
            title: type.charAt(0).toUpperCase() + type.slice(1),
            message: message,
            timestamp: new Date(),
            read: false,
            type: type
        };

        notifications.unshift(newNotification);
        if (notifications.length > 50) notifications.pop(); // Keep only 50 notifications

        updateNotificationBadge();
        renderNotifications();
    }

    console.log('🚀 IMAS Analyst Passengers Dashboard fully initialized');
</script>
<script src="js/singleWindowValidator.js"></script>
</body>
</html>