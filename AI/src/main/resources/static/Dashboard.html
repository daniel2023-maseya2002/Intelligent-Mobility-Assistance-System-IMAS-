


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced IMAS - Intelligent Mobility Assistance System</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>




    <style>
        :root {
            --primary-blue: #1E40AF;
            --secondary-red: #DC2626;
            --light-blue: #3B82F6;
            --light-red: #EF4444;
            --gold: #F59E0B;
            --green: #10B981;
            --gray-dark: #1F2937;
            --gray-medium: #6B7280;
            --gray-light: #F3F4F6;
            --white: #FFFFFF;
            --sidebar-width: 240px;
            --header-height: 70px;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --white: #1F2937;
            --gray-light: #374151;
            --gray-medium: #9CA3AF;
            --gray-dark: #F9FAFB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-light);
            color: var(--gray-dark);
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: var(--white);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 2rem;
            transition: var(--transition);
        }

        .header.expanded {
            left: 80px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background: var(--gray-light);
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-dark);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--gray-light);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--gray-light);
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-profile:hover {
            background: var(--light-blue);
            color: var(--white);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--white);
            border-right: 1px solid rgba(0,0,0,0.1);
            box-shadow: var(--shadow);
            z-index: 1100;
            transition: var(--transition);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            transition: var(--transition);
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            transform: translateX(-10px);
        }

        .sidebar-menu {
            flex: 1;
            padding: 1rem 0;
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin: 0.25rem 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.5rem;
            color: var(--gray-medium);
            text-decoration: none;
            transition: var(--transition);
            border-radius: 0 25px 25px 0;
            margin-right: 1rem;
            font-weight: 500;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: linear-gradient(90deg, rgba(30,64,175,0.1) 0%, rgba(30,64,175,0.05) 100%);
            color: var(--primary-blue);
            transform: translateX(5px);
        }

        .sidebar-menu a.active {
            border-right: 3px solid var(--primary-blue);
        }

        .sidebar-menu i {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar-menu .menu-text {
            transition: var(--transition);
        }

        .sidebar.collapsed .menu-text {
            opacity: 0;
            transform: translateX(-10px);
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1rem;
            color: var(--secondary-red);
            text-decoration: none;
            transition: var(--transition);
            border-radius: var(--border-radius);
            font-weight: 500;
            width: 100%;
            border: none;
            background: none;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: rgba(220,38,38,0.1);
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 2rem;
            min-height: calc(100vh - var(--header-height));
            transition: var(--transition);
        }

        .main-content.expanded {
            margin-left: 80px;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: var(--white);
            flex-shrink: 0;
        }

        .stat-icon.buses {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        }

        .stat-icon.tickets {
            background: linear-gradient(135deg, var(--green), #22C55E);
        }

        .stat-icon.drivers {
            background: linear-gradient(135deg, var(--gold), #F59E0B);
        }

        .stat-icon.routes {
            background: linear-gradient(135deg, var(--secondary-red), var(--light-red));
        }

        .stat-info h3 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .stat-info p {
            color: var(--gray-medium);
            font-weight: 500;
        }

        .stat-change {
            font-size: 0.875rem;
            color: var(--green);
            font-weight: 600;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        /* Buttons */
        .btn {
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: var(--light-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30,64,175,0.3);
        }

        .btn-success {
            background: var(--green);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--gold);
            color: var(--gray-dark);
        }

        .btn-warning:hover {
            background: #F59E0B;
        }

        .btn-danger {
            background: var(--secondary-red);
        }

        .btn-danger:hover {
            background: var(--light-red);
        }

        .btn-secondary {
            background: var(--gray-medium);
        }

        .btn-secondary:hover {
            background: var(--gray-dark);
        }

        /* Tables */
        .table-container {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        .table th {
            background: var(--gray-light);
            font-weight: 600;
            color: var(--gray-dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tr:hover {
            background: rgba(30,64,175,0.05);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-dark);
        }

        .form-control {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
            color: var(--gray-dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
        }

        .form-control:read-only {
            background-color: #f8f9fa;
            border-color: #e9ecef;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Map */
        #map {
            height: 500px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        /* Live Tracking Enhanced Styles */
        .tracking-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            height: 600px;
        }

        .tracking-panel {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            overflow-y: auto;
        }

        .tracking-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .bus-tracking-item {
            background: var(--gray-light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid var(--primary-blue);
        }

        .bus-tracking-item:hover {
            background: rgba(30,64,175,0.05);
            transform: translateX(5px);
        }

        .bus-tracking-item.active {
            background: rgba(30,64,175,0.1);
            border-left-color: var(--green);
        }

        .bus-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .bus-name {
            font-weight: 600;
            color: var(--gray-dark);
        }

        .bus-line {
            background: var(--primary-blue);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .bus-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray-medium);
        }

        .progress-container {
            margin-top: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--green));
            transition: width 0.6s ease;
        }

        /* Enhanced bus markers */
        .bus-marker {
            background: var(--primary-blue);
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1000;
        }

        .bus-marker.moving {
            background: var(--green);
            animation: pulse 2s infinite;
        }

        .bus-marker.stopped {
            background: var(--gold);
        }

        .bus-marker.accident {
            background: var(--secondary-red);
            animation: urgentPulse 1s infinite;
        }

        .bus-marker.completed {
            background: #22C55E;
            animation: completedPulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.7; }
        }

        @keyframes completedPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-medium);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-btn:hover {
            background: var(--gray-light);
            color: var(--gray-dark);
        }

        /* Status badges */
        .status-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: rgba(16,185,129,0.1);
            color: var(--green);
        }

        .status-stopped {
            background: rgba(245,158,11,0.1);
            color: var(--gold);
        }

        .status-accident {
            background: rgba(220,38,38,0.1);
            color: var(--secondary-red);
        }

        .status-pending {
            background: rgba(59,130,246,0.1);
            color: var(--light-blue);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .action-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .action-btn.start {
            background: var(--green);
            color: var(--white);
        }

        .action-btn.stop {
            background: var(--secondary-red);
            color: var(--white);
        }

        .action-btn.view {
            background: var(--light-blue);
            color: var(--white);
        }

        .action-btn.edit {
            background: var(--gold);
            color: var(--gray-dark);
        }

        .action-btn.delete {
            background: var(--secondary-red);
            color: var(--white);
        }

        .action-btn.download {
            background: var(--green);
            color: var(--white);
        }

        .action-btn.scan {
            background: var(--primary-blue);
            color: var(--white);
        }

        /* QR Scanner Enhanced */
        .qr-scanner {
            text-align: center;
            margin: 2rem 0;
            position: relative;
        }

        .qr-video {
            width: 100%;
            max-width: 500px;
            border-radius: var(--border-radius);
            border: 3px solid var(--primary-blue);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }

        .qr-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid var(--green);
            border-radius: 12px;
            pointer-events: none;
        }

        .qr-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            font-weight: 600;
        }

        .qr-result.success {
            background: rgba(16,185,129,0.1);
            color: var(--green);
            border: 1px solid var(--green);
        }

        .qr-result.error {
            background: rgba(220,38,38,0.1);
            color: var(--secondary-red);
            border: 1px solid var(--secondary-red);
        }

        /* Reports section */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .report-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
        }

        .report-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .report-description {
            color: var(--gray-medium);
            font-size: 0.9rem;
        }

        /* Detail cards for view modals */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .detail-item {
            background: var(--gray-light);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-blue);
        }

        .detail-label {
            font-weight: 600;
            color: var(--gray-medium);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--gray-dark);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s linear infinite;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }

            .sidebar .menu-text,
            .sidebar .logo-text {
                opacity: 0;
                transform: translateX(-10px);
            }

            .main-content {
                margin-left: 80px;
            }

            .header {
                left: 80px;
            }

            .tracking-container {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
        }





        .error-border {
            border-color: var(--secondary-red) !important;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
        }

        .error-message {
            color: var(--secondary-red);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }
    </style>
</head>
<body data-theme="light">



<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo-icon">
            <i class="fas fa-bus"></i>
        </div>
        <span class="logo-text">IMAS</span>
    </div>
    <div class="sidebar-menu">
        <ul>
            <li>
                <a href="#" class="active" onclick="showSection('dashboard', event)">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('buses', event)">
                    <i class="fas fa-bus"></i>
                    <span class="menu-text">Bus Management</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('tickets', event)">
                    <i class="fas fa-ticket-alt"></i>
                    <span class="menu-text">Tickets</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('routes', event)">
                    <i class="fas fa-route"></i>
                    <span class="menu-text">Routes</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('drivers', event)">
                    <i class="fas fa-users"></i>
                    <span class="menu-text">Drivers</span>
                </a>
            </li>
            <li>
                <a href="CrudStaff.html" target="_blank">
                    <i class="fas fa-user-tie"></i>
                    <span class="menu-text">Staff Management</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('tracking', event)">
                    <i class="fas fa-map-marked-alt"></i>
                    <span class="menu-text">Stop Bus</span>
                </a>
            </li>

            <li>
                <a href="AdminTaskManager.html" target="_blank">
                    <i class="fas fa-tasks"></i>
                    <span class="menu-text">Task Management</span>
                </a>
            </li>


            <li>
                <a href="ScheduleManagement.html" target="_blank">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="menu-text">Schedule</span>
                </a>
            </li>

            <li>
                <a href="#" onclick="showSection('maintenance', event)">
                    <i class="fas fa-tools"></i>
                    <span class="menu-text">Predictive Maintenance</span>
                </a>
            </li>


            <li>
                <a href="WhatsApp.html" target="_blank">
                    <i class="fab fa-whatsapp"></i>
                    <span class="menu-text">WhatsApp</span>
                </a>
            </li>

            <li>
                <a href="Vehicles.html" target="_blank">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="menu-text">Live Tracking</span>
                </a>
            </li>

            <li>
                <a href="#" onclick="showSection('reports', event)">
                    <i class="fas fa-chart-bar"></i>
                    <span class="menu-text">Reports & Analytics</span>
                </a>
            </li>

            <li>
                <a href="DashboardAnalyst.html" target="_blank">
                    <i class="fas fa-chart-line"></i>
                    <span class="menu-text">Analyst Management</span>
                </a>
            </li>
            <li>
                <a href="ReportingDashboard.html" target="_blank">
                    <i class="fas fa-chart-bar"></i>
                    <span class="menu-text">Reporting Dashboard</span>
                </a>
            </li>

            <li>
                <a href="MaintenanceManagement.html" target="_blank">
                    <i class="fas fa-wrench"></i>
                    <span class="menu-text">Maintenance Management</span>
                </a>
            </li>


            <li>
                <a href="#" onclick="showSection('settings', event)">
                    <i class="fas fa-cog"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span class="menu-text">Logout</span>
        </button>
    </div>
</nav>

<!-- Header -->
<header class="header" id="header">
    <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    <div class="header-center">
        <h1 class="header-title">Enhanced IMAS - Live Tracking System</h1>
    </div>
    <div class="header-right">
        <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
        <div class="user-profile" id="userProfile">
            <div class="user-avatar" id="userAvatar">A</div>
            <span id="userName">Admin User</span>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="main-content" id="mainContent">
    <!-- Dashboard Section -->
    <section id="dashboard-section" class="section">
        <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Enhanced Dashboard Overview</h1>

        <div class="stats-grid">
            <div class="stat-card" onclick="showSection('buses')">
                <div class="stat-icon buses">
                    <i class="fas fa-bus"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalBuses">0</h3>
                    <p>Total Buses</p>
                    <span class="stat-change">+12% this month</span>
                </div>
            </div>
            <div class="stat-card" onclick="showSection('tickets')">
                <div class="stat-icon tickets">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalTickets">0</h3>
                    <p>Tickets Sold</p>
                    <span class="stat-change">+25% this week</span>
                </div>
            </div>
            <div class="stat-card" onclick="showSection('drivers')">
                <div class="stat-icon drivers">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalDrivers">0</h3>
                    <p>Active Drivers</p>
                    <span class="stat-change">+8% this month</span>
                </div>
            </div>
            <div class="stat-card" onclick="showSection('routes')">
                <div class="stat-icon routes">
                    <i class="fas fa-route"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalRoutes">0</h3>
                    <p>Active Routes</p>
                    <span class="stat-change">+5% this month</span>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">Revenue Overview</h3>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">Bus Performance</h3>
                <div class="chart-container">
                    <canvas id="busPerformanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">Route Popularity</h3>
                <div class="chart-container">
                    <canvas id="routePopularityChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">Monthly Trends</h3>
                <div class="chart-container">
                    <canvas id="monthlyTrendsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 1.5rem;">Live Bus Status</h3>
            <div id="activeBusesList">
                <p style="color: var(--gray-medium);">Loading...</p>
            </div>
        </div>
    </section>


    <!-- Predictive Maintenance Section -->
    <section id="maintenance-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <h1 style="color: var(--gray-dark);">Predictive Maintenance</h1>
        </div>
        <div class="card">
            <h3 style="margin-bottom: 1.5rem;">Check Maintenance Status</h3>
            <form id="prediction-form" class="form-group">
                <div class="form-row">
                    <div class="form-group">
                        <label for="equipment-id"><i class="fas fa-bus"></i> Equipment ID</label>
                        <input type="text" class="form-control" id="equipment-id" name="equipment-id" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn"><i class="fas fa-search"></i> Get Prediction</button>
                    </div>
                </div>
            </form>
            <div id="loading" class="hidden" style="text-align: center; font-size: 1rem; margin-top: 1rem;">
                <span class="loading"></span> Loading...
            </div>
            <div id="results-section" class="hidden">
                <div id="prediction-result" style="padding: 1rem; border-radius: var(--border-radius); text-align: center;"></div>
            </div>
        </div>
    </section>




    <!-- Bus Management Section -->
    <section id="buses-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <h1 style="color: var(--gray-dark);">Enhanced Bus Management</h1>
            <button class="btn" onclick="openModal('addBusModal')">
                <i class="fas fa-plus"></i>
                Add New Bus
            </button>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>All Buses</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input type="text" placeholder="Search buses..." class="form-control" style="width: 250px;" id="busSearchInput">
                    <button class="btn btn-secondary" onclick="exportBusData()">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                </div>
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Line</th>
                    <th>Capacity</th>
                    <th>Driver</th>
                    <th>Route</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="busesTableBody">
                <tr>
                    <td colspan="9" style="text-align: center; color: var(--gray-medium);">Loading...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Tickets Section -->
    <section id="tickets-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <h1 style="color: var(--gray-dark);">Enhanced Ticket Management</h1>
            <button class="btn" onclick="openModal('addTicketModal')">
                <i class="fas fa-plus"></i>
                Add New Ticket
            </button>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3>Enhanced QR Code Scanner</h3>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-success" id="startScannerBtn" onclick="startAdvancedQRScanner()">
                        <i class="fas fa-qrcode"></i>
                        Start Scanner
                    </button>
                    <button class="btn btn-secondary" onclick="uploadQRImage()">
                        <i class="fas fa-upload"></i>
                        Upload QR Image
                    </button>
                </div>
            </div>
            <div class="qr-scanner">
                <div style="position: relative; display: inline-block;">
                    <video id="qrVideo" class="qr-video hidden" autoplay muted playsinline></video>
                    <div id="qrOverlay" class="qr-overlay hidden"></div>
                </div>
                <input type="file" id="qrImageInput" accept="image/*" class="hidden" onchange="processQRImage(this)">
                <div id="qrResult" class="qr-result hidden"></div>
                <div style="margin-top: 1rem;">
                    <button id="stopScannerBtn" class="btn btn-danger hidden" onclick="stopAdvancedQRScanner()">
                        <i class="fas fa-stop"></i>
                        Stop Scanner
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>All Tickets</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input type="text" placeholder="Search tickets..." class="form-control" style="width: 250px;" id="ticketSearchInput">
                    <select class="form-control" style="width: 150px;" id="ticketStatusFilter">
                        <option value="">All Status</option>
                        <option value="PAID">Paid</option>
                        <option value="PENDING">Pending</option>
                        <option value="BOARDED">Boarded</option>
                    </select>
                </div>
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th>Ticket #</th>
                    <th>Passenger</th>
                    <th>Bus</th>
                    <th>Route</th>
                    <th>Price (FC)</th>
                    <th>Status</th>
                    <th>Departure</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="ticketsTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; color: var(--gray-medium);">Loading...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Routes Section -->
    <section id="routes-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <h1 style="color: var(--gray-dark);">Enhanced Route Management</h1>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-success" onclick="createKinshasaRoutes()">
                    <i class="fas fa-map"></i>
                    Create Kinshasa Routes
                </button>
                <button class="btn" onclick="openModal('addRouteModal')">
                    <i class="fas fa-plus"></i>
                    Add Custom Route
                </button>
            </div>
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Distance (km)</th>
                    <th>Duration (min)</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="routesTableBody">
                <tr>
                    <td colspan="7" style="text-align: center; color: var(--gray-medium);">Loading...</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Drivers Section -->
    <section id="drivers-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <h1 style="color: var(--gray-dark);">Enhanced Driver Management</h1>
            <button class="btn" onclick="openModal('addDriverModal')">
                <i class="fas fa-plus"></i>
                Add New Driver
            </button>
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Assigned Bus</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="driversTableBody">
                <!-- Le contenu sera généré dynamiquement -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Enhanced Live Tracking Section -->
    <section id="tracking-section" class="section hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="color: var(--gray-dark);">Real-Time Live Bus Tracking</h1>
            <div class="tracking-controls">
                <button class="btn btn-success" onclick="startAllBuses()">
                    <i class="fas fa-play"></i>
                    Start All Buses
                </button>
                <button class="btn btn-warning" onclick="refreshTracking()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Tracking
                </button>
                <button class="btn btn-secondary" onclick="resetAllBuses()">
                    <i class="fas fa-undo"></i>
                    Reset All
                </button>
                <button class="btn btn-danger" onclick="stopAllBuses()">
                    <i class="fas fa-stop"></i>
                    Stop All
                </button>
            </div>
        </div>

        <div class="tracking-container">
            <div class="card" style="margin: 0; padding: 0; overflow: hidden;">
                <div id="map"></div>
            </div>

            <div class="tracking-panel">
                <h3 style="margin-bottom: 1.5rem;">Live Bus Status</h3>
                <div id="activeBusesTracking">
                    <p style="color: var(--gray-medium);">Loading tracking data...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Enhanced Reports Section -->
    <section id="reports-section" class="section hidden">
        <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Enhanced Reports & Analytics</h1>

        <div class="reports-grid">
            <div class="report-card" onclick="generateReport('daily')">
                <div class="report-icon">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="report-title">Daily Report</div>
                <div class="report-description">Today's operations summary</div>
            </div>
            <div class="report-card" onclick="generateReport('weekly')">
                <div class="report-icon">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div class="report-title">Weekly Report</div>
                <div class="report-description">Last 7 days performance</div>
            </div>
            <div class="report-card" onclick="generateReport('monthly')">
                <div class="report-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="report-title">Monthly Report</div>
                <div class="report-description">Monthly analytics</div>
            </div>
            <div class="report-card" onclick="generateReport('yearly')">
                <div class="report-icon">
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="report-title">Yearly Report</div>
                <div class="report-description">Annual performance</div>
            </div>
            <div class="report-card" onclick="generateDetailedReport()">
                <div class="report-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="report-title">Detailed Report</div>
                <div class="report-description">Complete system analysis</div>
            </div>
            <div class="report-card" onclick="exportToExcel()">
                <div class="report-icon">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div class="report-title">Excel Export</div>
                <div class="report-description">Export all data to Excel</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 1.5rem;">Enhanced Revenue Analytics</h3>
            <div class="chart-container">
                <canvas id="revenueAnalyticsChart"></canvas>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon tickets">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3 id="todayRevenue">0 FC</h3>
                    <p>Today's Revenue</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon buses">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-info">
                    <h3 id="monthlyRevenue">0 FC</h3>
                    <p>Monthly Revenue</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Settings Section -->
    <section id="settings-section" class="section hidden">
        <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">System Settings</h1>

        <div class="card">
            <h3 style="margin-bottom: 1.5rem;">Pricing Configuration</h3>
            <form id="settingsForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Base Ticket Price (FC)</label>
                        <input type="number" class="form-control" id="basePrice" value="2000">
                    </div>
                    <div class="form-group">
                        <label>Luggage Fee (FC)</label>
                        <input type="number" class="form-control" id="luggagePrice" value="500">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Station Wait Time (seconds)</label>
                        <input type="number" class="form-control" id="stationWaitTime" value="30">
                    </div>
                    <div class="form-group">
                        <label>Bus Start Buffer (minutes)</label>
                        <input type="number" class="form-control" id="startBuffer" value="5">
                    </div>
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-save"></i>
                    Save Settings
                </button>
            </form>
        </div>
    </section>
</main>

<!-- Enhanced Modals -->




<!-- Add Bus Modal -->
<div id="addBusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add New Bus</h2>
            <button class="close-btn" onclick="closeModal('addBusModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addBusForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Bus Name</label>
                    <input type="text" class="form-control" id="busName" required>
                    <small id="busNameError" class="error-message" style="display: none;">
                        Un bus avec un nom similaire existe déjà. Veuillez choisir un nom différent.
                    </small>
                </div>
                <div class="form-group">
                    <label>Bus Line</label>
                    <input type="text" class="form-control" id="busLine" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Capacity</label>
                    <input type="number" class="form-control" id="busCapacity" required>
                </div>
                <div class="form-group">
                    <label>Route</label>
                    <select class="form-control" id="busRoute" required>
                        <option value="">Select a route</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Driver</label>
                    <select class="form-control" id="busDriver">
                        <option value="">Select a driver</option>
                    </select>
                </div>
                <!-- Dans votre addBusModal -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Departure Time</label>
                        <input type="datetime-local" class="form-control" id="busDepartureTime" required>
                        <small id="departureTimeError" style="color: var(--secondary-red); display: none;">Departure time must be in the future</small>
                    </div>
                    <div class="form-group">
                        <label>Arrival Time</label>
                        <input type="datetime-local" class="form-control" id="busArrivalTime" required>
                        <small id="arrivalTimeError" style="color: var(--secondary-red); display: none;">Arrival time must be after departure time</small>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addBusModal')">Cancel</button>
                <button type="submit" class="btn">Add Bus</button>
            </div>
        </form>
    </div>
</div>

<!-- View Bus Modal -->
<div id="viewBusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Bus Details</h2>
            <button class="close-btn" onclick="closeModal('viewBusModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="viewBusContent">
            <!-- Content will be populated dynamically -->
        </div>
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn" onclick="closeModal('viewBusModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Bus Modal -->
<div id="editBusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Edit Bus</h2>
            <button class="close-btn" onclick="closeModal('editBusModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editBusForm">
            <input type="hidden" id="editBusId">
            <div class="form-row">
                <div class="form-group">
                    <label>Bus Name</label>
                    <input type="text" class="form-control" id="editBusName" required>
                </div>
                <div class="form-group">
                    <label>Bus Line</label>
                    <input type="text" class="form-control" id="editBusLine" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Capacity</label>
                    <input type="number" class="form-control" id="editBusCapacity" required>
                </div>
                <div class="form-group">
                    <label>Route</label>
                    <select class="form-control" id="editBusRoute" required>
                        <option value="">Select a route</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editBusModal')">Cancel</button>
                <button type="submit" class="btn">Update Bus</button>
            </div>
        </form>
    </div>
</div>






<!-- Add Ticket Modal -->
<div id="addTicketModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add New Ticket</h2>
            <button class="close-btn" onclick="closeModal('addTicketModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addTicketForm">
            <div class="form-row">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" class="form-control" id="ticketFirstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" class="form-control" id="ticketLastName" required>
                </div>
            </div>
            <div class="form-group">
                <label>Bus</label>
                <select class="form-control" id="ticketBus" required>
                    <option value="">Select a bus</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Origin</label>
                    <input type="text" class="form-control" id="ticketOrigin" readonly>
                </div>
                <div class="form-group">
                    <label>Destination</label>
                    <input type="text" class="form-control" id="ticketDestination" readonly>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Seat Number</label>
                    <input type="text" class="form-control" id="ticketSeat" placeholder="e.g., A1">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="hasLuggage" style="margin-right: 0.5rem;">
                        Has Luggage (+500 FC)
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>Luggage Weight (kg)</label>
                <input type="number" class="form-control" id="luggageWeight" step="0.1" disabled>
            </div>
            <div class="form-group">
                <label>Total Price: <span id="totalPrice">2000 FC</span></label>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addTicketModal')">Cancel</button>
                <button type="submit" class="btn">Create Ticket</button>
            </div>
        </form>
    </div>
</div>

<!-- View Ticket Modal -->
<div id="viewTicketModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Ticket Details</h2>
            <button class="close-btn" onclick="closeModal('viewTicketModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="viewTicketContent">
            <!-- Content will be populated dynamically -->
        </div>
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn" onclick="closeModal('viewTicketModal')">Close</button>
        </div>
    </div>
</div>

<!-- Add Route Modal -->
<div id="addRouteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add New Route</h2>
            <button class="close-btn" onclick="closeModal('addRouteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addRouteForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Route Code</label>
                    <input type="text" class="form-control" id="routeCode" required>
                </div>
                <div class="form-group">
                    <label>Route Name</label>
                    <input type="text" class="form-control" id="routeName" required>
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" id="routeDescription" rows="3"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Distance (km)</label>
                    <input type="number" step="0.1" class="form-control" id="routeDistance" required>
                </div>
                <div class="form-group">
                    <label>Estimated Duration (min)</label>
                    <input type="number" class="form-control" id="routeDuration" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Route Type</label>
                    <select class="form-control" id="routeType" required>
                        <option value="URBAN">Urban</option>
                        <option value="SUBURBAN">Suburban</option>
                        <option value="INTERCITY">Intercity</option>
                        <option value="EXPRESS">Express</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" class="form-control" id="routeColor" value="#1E40AF">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addRouteModal')">Cancel</button>
                <button type="submit" class="btn">Add Route</button>
            </div>
        </form>
    </div>
</div>

<!-- View Route Modal -->
<div id="viewRouteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Route Details</h2>
            <button class="close-btn" onclick="closeModal('viewRouteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="viewRouteContent">
            <!-- Content will be populated dynamically -->
        </div>
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn" onclick="closeModal('viewRouteModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Route Modal -->
<div id="editRouteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Edit Route</h2>
            <button class="close-btn" onclick="closeModal('editRouteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editRouteForm">
            <input type="hidden" id="editRouteId">
            <div class="form-row">
                <div class="form-group">
                    <label>Route Code</label>
                    <input type="text" class="form-control" id="editRouteCode" required>
                </div>
                <div class="form-group">
                    <label>Route Name</label>
                    <input type="text" class="form-control" id="editRouteName" required>
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" id="editRouteDescription" rows="3"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Distance (km)</label>
                    <input type="number" step="0.1" class="form-control" id="editRouteDistance" required>
                </div>
                <div class="form-group">
                    <label>Estimated Duration (min)</label>
                    <input type="number" class="form-control" id="editRouteDuration" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Route Type</label>
                    <select class="form-control" id="editRouteType" required>
                        <option value="URBAN">Urban</option>
                        <option value="SUBURBAN">Suburban</option>
                        <option value="INTERCITY">Intercity</option>
                        <option value="EXPRESS">Express</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" class="form-control" id="editRouteColor">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editRouteModal')">Cancel</button>
                <button type="submit" class="btn">Update Route</button>
            </div>
        </form>
    </div>
</div>





<!-- Add Driver Modal -->
<div id="addDriverModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"></h2>
            <button class="close-btn" onclick="closeModal('addDriverModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addDriverForm">
            <div class="form-row">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" class="form-control" id="driverFirstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" class="form-control" id="driverLastName" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="driverEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" class="form-control" id="driverPhone" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>License Number</label>
                    <input type="text" class="form-control" id="driverLicense" required>
                </div>
                <div class="form-group">
                    <label>Experience (years)</label>
                    <input type="number" class="form-control" id="driverExperience" min="0" required>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addDriverModal')">Cancel</button>
                <button type="submit" class="btn">Add Driver</button>
            </div>
        </form>
    </div>
</div>
Add New Driver
<!-- View Driver Modal -->
<div id="viewDriverModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Driver Details</h2>
            <button class="close-btn" onclick="closeModal('viewDriverModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="viewDriverContent">
            <!-- Content will be populated dynamically -->
        </div>
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn" onclick="closeModal('viewDriverModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Driver Modal -->
<div id="editDriverModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Edit Driver</h2>
            <button class="close-btn" onclick="closeModal('editDriverModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editDriverForm">
            <input type="hidden" id="editDriverId">
            <div class="form-row">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" class="form-control" id="editDriverFirstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" class="form-control" id="editDriverLastName" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="editDriverEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" class="form-control" id="editDriverPhone" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>License Number</label>
                    <input type="text" class="form-control" id="editDriverLicense" required>
                </div>
                <div class="form-group">
                    <label>Experience (years)</label>
                    <input type="number" class="form-control" id="editDriverExperience" min="0" required>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editDriverModal')">Cancel</button>
                <button type="submit" class="btn">Update Driver</button>
            </div>
        </form>
    </div>
</div>





<script>
    // Global variables
    let currentUser = null;
    let map = null;
    let busMarkers = {};
    let routeLines = {};
    let charts = {};
    let qrScanner = null;
    let isScanning = false;
    let busSimulations = {};
    let videoStream = null;
    let jsQRLibrary = null;
    let isJsQRLoaded = false;
    let jsQRLoadPromise = null;
    let scanningInterval = null;
    const API_BASE = 'http://localhost:8080/api';

    // Real Kinshasa coordinates with accurate bus stations
    const KINSHASA_STATIONS = {
        'Gare Centrale': { lat: -4.3276, lng: 15.3136 },
        'Matete': { lat: -4.3833, lng: 15.3667 },
        'Limete': { lat: -4.3333, lng: 15.3333 },
        'Bandalungwa': { lat: -4.3167, lng: 15.2833 },
        'Ndjili': { lat: -4.3833, lng: 15.3833 },
        'Masina': { lat: -4.3833, lng: 15.4000 },
        'Kimbanseke': { lat: -4.4500, lng: 15.4167 },
        'Ngaliema': { lat: -4.3167, lng: 15.2333 },
        'Mont Ngafula': { lat: -4.4000, lng: 15.2667 },
        'Selembao': { lat: -4.3500, lng: 15.2833 },
        'Kintambo': { lat: -4.3042, lng: 15.2853 },
        'Kasavubu': { lat: -4.3200, lng: 15.3000 },
        'Kalamu': { lat: -4.3400, lng: 15.3200 },
        'Makala': { lat: -4.3600, lng: 15.3400 },
        'Kinshasa': { lat: -4.3200, lng: 15.3070 }
    };

    // Enhanced bus route paths with realistic intermediate points for smooth movement
    const BUS_ROUTES = {
        1: [ // Gare Centrale to Matete
            { lat: -4.3276, lng: 15.3136, station: 'Gare Centrale' },
            { lat: -4.3300, lng: 15.3200 },
            { lat: -4.3350, lng: 15.3300 },
            { lat: -4.3400, lng: 15.3400 },
            { lat: -4.3500, lng: 15.3500 },
            { lat: -4.3600, lng: 15.3600 },
            { lat: -4.3700, lng: 15.3650 },
            { lat: -4.3833, lng: 15.3667, station: 'Matete' }
        ],
        2: [ // Gare Centrale to Bandalungwa
            { lat: -4.3276, lng: 15.3136, station: 'Gare Centrale' },
            { lat: -4.3250, lng: 15.3100 },
            { lat: -4.3200, lng: 15.3000 },
            { lat: -4.3180, lng: 15.2950 },
            { lat: -4.3167, lng: 15.2833, station: 'Bandalungwa' }
        ],
        3: [ // Gare Centrale to Ndjili
            { lat: -4.3276, lng: 15.3136, station: 'Gare Centrale' },
            { lat: -4.3300, lng: 15.3200 },
            { lat: -4.3400, lng: 15.3400 },
            { lat: -4.3500, lng: 15.3500 },
            { lat: -4.3600, lng: 15.3600 },
            { lat: -4.3700, lng: 15.3700 },
            { lat: -4.3800, lng: 15.3800 },
            { lat: -4.3833, lng: 15.3833, station: 'Ndjili' }
        ],
        4: [ // Gare Centrale to Kimbanseke
            { lat: -4.3276, lng: 15.3136, station: 'Gare Centrale' },
            { lat: -4.3400, lng: 15.3300 },
            { lat: -4.3600, lng: 15.3500 },
            { lat: -4.3800, lng: 15.3700 },
            { lat: -4.4000, lng: 15.3900 },
            { lat: -4.4200, lng: 15.4100 },
            { lat: -4.4500, lng: 15.4167, station: 'Kimbanseke' }
        ]
    };




    document.addEventListener('DOMContentLoaded', function() {
        initializeUser();
        initializeEventListeners();
        showSection('dashboard');
        loadAllData();

        // Initialize QR scanner with proper error handling
        initializeAdvancedQRScanner()
            .then(() => {
                console.log('QR Scanner initialized successfully');
                // Add any additional QR-related initialization here
            })
            .catch((error) => {
                console.error('QR Scanner initialization failed:', error);
                showNotification('QR Scanner not available', 'warning');
            });
    });


    // Initialize user information
    function initializeUser() {
        const userSession = localStorage.getItem('userSession');
        if (userSession) {
            currentUser = JSON.parse(userSession);
            document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
            document.getElementById('userAvatar').textContent = currentUser.firstName.charAt(0);
        } else {
            currentUser = { firstName: 'Admin', lastName: 'User', role: 'ADMIN' };
            document.getElementById('userName').textContent = 'Admin User';
            document.getElementById('userAvatar').textContent = 'A';
        }
    }

    // Initialize event listeners
    // Update initializeEventListeners to include prediction form
    function initializeEventListeners() {
        // Existing event listeners
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.getElementById('addBusForm').addEventListener('submit', handleAddBus);
        document.getElementById('editBusForm').addEventListener('submit', handleEditBus);
        document.getElementById('addTicketForm').addEventListener('submit', handleAddTicket);
        document.getElementById('addRouteForm').addEventListener('submit', handleAddRoute);
        document.getElementById('editRouteForm').addEventListener('submit', handleEditRoute);
        document.getElementById('addDriverForm').addEventListener('submit', handleAddDriver);
        document.getElementById('editDriverForm').addEventListener('submit', handleEditDriver);
        document.getElementById('settingsForm').addEventListener('submit', handleSaveSettings);
        document.getElementById('ticketBus').addEventListener('change', handleBusSelection);
        document.getElementById('hasLuggage').addEventListener('change', function() {
            const luggageWeight = document.getElementById('luggageWeight');
            luggageWeight.disabled = !this.checked;
            if (!this.checked) luggageWeight.value = '';
            updateTicketPrice();
        });
        document.getElementById('busSearchInput')?.addEventListener('input', filterBuses);
        document.getElementById('ticketSearchInput')?.addEventListener('input', filterTickets);
        document.getElementById('ticketStatusFilter')?.addEventListener('change', filterTickets);

        // Predictive maintenance form
        document.getElementById('prediction-form')?.addEventListener('submit', handlePredictMaintenance);
    }

    // Add after existing functions
    async function handlePredictMaintenance(event) {
        event.preventDefault();
        const equipmentId = document.getElementById('equipment-id').value.trim();
        if (!equipmentId) {
            showNotification('Please enter an equipment ID', 'error');
            return;
        }
        showLoading();
        try {
            const response = await fetch(`${API_BASE}/data/predictions/maintenance`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': currentUser && localStorage.getItem('jwtToken') ? `Bearer ${localStorage.getItem('jwtToken')}` : ''
                },
                body: JSON.stringify({ equipmentId: equipmentId })
            });
            if (!response.ok) {
                const data = await response.json();
                let errorMessage = 'Network response was not ok';
                if (response.status === 404) {
                    errorMessage = data.error || `No maintenance records found for equipmentId ${equipmentId}`;
                } else if (response.status === 400) {
                    errorMessage = data.error || 'Invalid equipment ID format';
                } else if (response.status === 500) {
                    errorMessage = data.error || `Prediction service error: ${data.detail || 'Internal server error'}`;
                }
                throw new Error(errorMessage);
            }
            const data = await response.json();
            if (data.error) {
                showNotification(data.error, 'error');
            } else {
                showPrediction(data);
            }
        } catch (error) {
            showNotification(error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function showLoading() {
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) {
            loadingDiv.classList.remove('hidden');
        }
        const resultsSection = document.getElementById('results-section');
        if (resultsSection) {
            resultsSection.classList.add('hidden');
        }
    }

    function hideLoading() {
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) {
            loadingDiv.classList.add('hidden');
        }
    }

    function showPrediction(data) {
        const resultDiv = document.getElementById('prediction-result');
        const resultsSection = document.getElementById('results-section');
        if (!resultDiv || !resultsSection) return;

        const needsMaintenance = data.needsMaintenance ? 'Yes' : 'No';
        const probability = (data.probability * 100).toFixed(2) + '%';
        const icon = data.needsMaintenance
            ? '<i class="fas fa-exclamation-triangle"></i>'
            : '<i class="fas fa-check-circle"></i>';
        const statusClass = data.needsMaintenance ? 'status-accident' : 'status-active';

        resultDiv.innerHTML = `
        <h3 style="margin-bottom: 1rem;">${icon} Prediction for ${data.equipmentId}</h3>
        <div class="detail-grid">
            <div class="detail-item">
                <div class="detail-label">Needs Maintenance</div>
                <div class="detail-value">${needsMaintenance}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Probability</div>
                <div class="detail-value">${probability}</div>
            </div>
        </div>
    `;
        resultDiv.className = statusClass;
        resultsSection.classList.remove('hidden');
        showNotification(`Maintenance prediction loaded for equipment ${data.equipmentId}`, 'success');
    }




    // Enhanced QR Scanner Initialization with retry logic
    function initializeAdvancedQRScanner() {
        return new Promise((resolve, reject) => {
            // Check if jsQR is already loaded
            if (typeof jsQR !== 'undefined') {
                console.log('jsQR loaded successfully');
                resolve(true);
                return;
            }

            // Retry mechanism with timeout
            let retryCount = 0;
            const maxRetries = 10;
            const retryInterval = 500; // 500ms between retries

            const checkForJsQR = () => {
                if (typeof jsQR !== 'undefined') {
                    console.log('jsQR loaded successfully after', retryCount, 'retries');
                    resolve(true);
                    return;
                }

                retryCount++;
                if (retryCount >= maxRetries) {
                    console.error('jsQR library failed to load after', maxRetries, 'attempts');
                    reject(new Error('jsQR library not loaded'));
                    return;
                }

                console.log('Waiting for jsQR library... attempt', retryCount);
                setTimeout(checkForJsQR, retryInterval);
            };

            checkForJsQR();
        });
    }



    async function loadJsQRLibrary() {
        if (jsQRLoadPromise) {
            return jsQRLoadPromise;
        }

        jsQRLoadPromise = new Promise((resolve, reject) => {
            if (isJsQRLoaded && jsQRLibrary) {
                resolve(jsQRLibrary);
                return;
            }

            const script = document.createElement('script');
            script.src = '/js/jsQR.min.js'; // Path to your local copy
            script.onload = () => {
                if (window.jsQR) {
                    jsQRLibrary = window.jsQR;
                    isJsQRLoaded = true;
                    console.log('jsQR library loaded successfully');
                    resolve(jsQRLibrary);
                } else {
                    reject(new Error('jsQR library failed to load'));
                }
            };
            script.onerror = () => {
                reject(new Error('Failed to load jsQR library'));
            };
            document.head.appendChild(script);
        });

        return jsQRLoadPromise;
    }




    async function initializeAdvancedQRScanner() {
        try {
            // Vérifier si jsQR est déjà chargé
            if (typeof jsQR === 'undefined') {
                // Charger jsQR depuis CDN si pas déjà chargé
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            // Vérifier l'accès à la caméra
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Camera access not supported or permission denied');
            }

            return true;
        } catch (error) {
            console.error('QR Scanner initialization failed:', error);
            showNotification('QR Scanner initialization failed: ' + error.message, 'error');
            return false;
        }
    }


    // Load all data
    async function loadAllData() {
        try {
            await Promise.all([
                loadDashboardData(),
                loadBuses(),
                loadTickets(),
                loadRoutes(),
                loadDrivers()
            ]);
        } catch (error) {
            console.error('Error loading data:', error);
            showNotification('Error loading data: ' + error.message, 'error');
        }
    }

    // Enhanced Dashboard functions
    async function loadDashboardData() {
        try {
            const [buses, tickets, drivers, routes] = await Promise.all([
                fetchData('/buses'),
                fetchData('/tickets'),
                fetchData('/staff?role=DRIVER'),
                fetchData('/routes')
            ]);

            // Update statistics
            document.getElementById('totalBuses').textContent = buses.length;
            document.getElementById('totalTickets').textContent = tickets.length;
            document.getElementById('totalDrivers').textContent = drivers.length;
            document.getElementById('totalRoutes').textContent = routes.length;

            // Display active buses with enhanced information
            const activeBuses = buses.filter(bus => !bus.isStopped && !bus.hasAccident);
            displayActiveBuses(activeBuses);

            // Create enhanced charts
            createRevenueChart(tickets);
            createBusPerformanceChart(buses);
            createRoutePopularityChart(routes, tickets);
            createMonthlyTrendsChart(tickets);
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showNotification('Error loading dashboard data', 'error');
        }
    }

    // Enhanced chart creation
    function createRevenueChart(tickets) {
        const ctx = document.getElementById('revenueChart');
        if (!ctx) return;

        if (charts.revenue) {
            charts.revenue.destroy();
        }

        const last30Days = [];
        const revenues = [];
        const today = new Date();

        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

            const dayRevenue = tickets.filter(ticket => {
                const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                return ticketDate.toDateString() === date.toDateString();
            }).reduce((sum, ticket) => {
                return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
            }, 0);

            revenues.push(dayRevenue);
        }

        charts.revenue = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last30Days,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: revenues,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#1E40AF',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    function createBusPerformanceChart(buses) {
        const ctx = document.getElementById('busPerformanceChart');
        if (!ctx) return;

        if (charts.busPerformance) {
            charts.busPerformance.destroy();
        }

        const activeBuses = buses.filter(bus => !bus.isStopped && !bus.hasAccident).length;
        const stoppedBuses = buses.filter(bus => bus.isStopped && !bus.hasAccident).length;
        const accidentBuses = buses.filter(bus => bus.hasAccident).length;
        const maintenanceBuses = buses.filter(bus => bus.isMaintenance).length;

        charts.busPerformance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Active', 'Stopped', 'Accident', 'Maintenance'],
                datasets: [{
                    data: [activeBuses, stoppedBuses, accidentBuses, maintenanceBuses],
                    backgroundColor: ['#10B981', '#F59E0B', '#DC2626', '#6B7280'],
                    borderWidth: 3,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function createRoutePopularityChart(routes, tickets) {
        const ctx = document.getElementById('routePopularityChart');
        if (!ctx) return;

        if (charts.routePopularity) {
            charts.routePopularity.destroy();
        }

        // Calculate actual route usage from tickets
        const routeUsage = routes.map(route => {
            const routeTickets = tickets.filter(ticket => {
                return ticket.bus && ticket.bus.route && ticket.bus.route.id === route.id;
            });
            return {
                name: route.routeName || route.name,
                count: routeTickets.length
            };
        }).slice(0, 6);

        const routeNames = routeUsage.map(r => r.name);
        const routeCounts = routeUsage.map(r => r.count);

        charts.routePopularity = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: routeNames,
                datasets: [{
                    label: 'Tickets Sold',
                    data: routeCounts,
                    backgroundColor: 'rgba(30, 64, 175, 0.8)',
                    borderColor: '#1E40AF',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createMonthlyTrendsChart(tickets) {
        const ctx = document.getElementById('monthlyTrendsChart');
        if (!ctx) return;

        if (charts.monthlyTrends) {
            charts.monthlyTrends.destroy();
        }

        const months = [];
        const ticketCounts = [];
        const revenues = [];
        const today = new Date();

        for (let i = 11; i >= 0; i--) {
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            months.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));

            const monthTickets = tickets.filter(ticket => {
                const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                return ticketDate.getMonth() === date.getMonth() &&
                    ticketDate.getFullYear() === date.getFullYear();
            });

            ticketCounts.push(monthTickets.length);

            const monthRevenue = monthTickets.reduce((sum, ticket) => {
                return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
            }, 0);
            revenues.push(monthRevenue);
        }

        charts.monthlyTrends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Tickets',
                    data: ticketCounts,
                    borderColor: '#DC2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4
                }, {
                    label: 'Revenue (FC)',
                    data: revenues,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    }
                }
            }
        });
    }

    // Enhanced display functions
    function displayActiveBuses(buses) {
        const container = document.getElementById('activeBusesList');
        if (buses.length === 0) {
            container.innerHTML = '<p style="color: var(--gray-medium);">No active buses</p>';
            return;
        }

        container.innerHTML = buses.map(bus => {
            const progress = Math.round(bus.progress || 0);
            const speed = bus.currentSpeed || 0;
            const eta = bus.estimatedArrival || 'N/A';

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--gray-light);">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <strong>${bus.name}</strong> - ${bus.busLine}
                            <span class="status-badge ${bus.hasAccident ? 'status-accident' : 'status-active'}">
                                ${bus.hasAccident ? 'Accident' : 'Moving'}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
                            <small style="color: var(--gray-medium);">
                                <i class="fas fa-users"></i> ${bus.passengers || 0}/${bus.capacity} passengers
                            </small>
                            <small style="color: var(--gray-medium);">
                                <i class="fas fa-tachometer-alt"></i> ${speed} km/h
                            </small>
                            <small style="color: var(--gray-medium);">
                                <i class="fas fa-clock"></i> ETA: ${eta}
                            </small>
                        </div>
                        <div class="progress-bar" style="margin-top: 0.5rem;">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <small style="color: var(--gray-medium);">${progress}% complete</small>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                        <button class="action-btn view" onclick="centerMapOnBus(${bus.id})" title="View on Map">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                        <button class="action-btn edit" onclick="trackBus(${bus.id})" title="Track Bus">
                            <i class="fas fa-route"></i>
                        </button>
                        <button class="action-btn stop" onclick="stopBus(${bus.id})" title="Stop Bus">
                            <i class="fas fa-stop"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Enhanced Bus management functions
    async function loadBuses() {
        try {
            const buses = await fetchData('/buses');
            displayBuses(buses);
            populateBusSelects(buses);
        } catch (error) {
            console.error('Error loading buses:', error);
            document.getElementById('busesTableBody').innerHTML =
                '<tr><td colspan="9" style="text-align: center; color: var(--secondary-red);">Error loading buses</td></tr>';
        }
    }

    function displayBuses(buses) {
        const tbody = document.getElementById('busesTableBody');
        if (buses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--gray-medium);">No buses found</td></tr>';
            return;
        }

        tbody.innerHTML = buses.map(bus => {
            const status = bus.hasAccident ? 'Accident' : (bus.isStopped ? 'Stopped' : 'Active');
            const statusClass = bus.hasAccident ? 'status-accident' : (bus.isStopped ? 'status-stopped' : 'status-active');
            const progress = Math.round(bus.progress || 0);
            const driverName = bus.driver ? `${bus.driver.firstName} ${bus.driver.lastName}` : 'Not assigned';
            const routeName = bus.route ? bus.route.routeName : 'Not assigned';

            return `
                <tr>
                    <td>${bus.id}</td>
                    <td>${bus.name}</td>
                    <td>${bus.busLine}</td>
                    <td>${bus.capacity}</td>
                    <td>${driverName}</td>
                    <td>${routeName}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        ${progress}%
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn start" onclick="startBus(${bus.id})" title="Start Bus">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="action-btn stop" onclick="stopBus(${bus.id})" title="Stop Bus">
                                <i class="fas fa-stop"></i>
                            </button>
                            <button class="action-btn view" onclick="viewBusDetails(${bus.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editBus(${bus.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteBus(${bus.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function populateBusSelects(buses) {
        const select = document.getElementById('ticketBus');
        if (select) {
            select.innerHTML = '<option value="">Select a bus</option>';
            buses.forEach(bus => {
                const routeInfo = bus.route ? ` (${bus.route.routeName})` : '';
                const routeDetails = bus.route ? ` - ${bus.route.startLocation || 'Start'} to ${bus.route.endLocation || 'End'}` : '';
                select.innerHTML += `<option value="${bus.id}" data-route-id="${bus.route ? bus.route.id : ''}">${bus.name} - ${bus.busLine}${routeInfo}${routeDetails}</option>`;
            });
        }
    }

    // **ENHANCED LIVE TRACKING SYSTEM**
    // This is the core of the real-time bus tracking functionality

    // Initialize and display the live tracking map
    function initializeMap() {
        if (map) return;

        console.log('Initializing live tracking map...');

        // Create map centered on Kinshasa
        map = L.map('map').setView([-4.3276, 15.3136], 12);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Add bus stations as permanent markers
        Object.entries(KINSHASA_STATIONS).forEach(([name, coords]) => {
            L.marker([coords.lat, coords.lng], {
                icon: L.divIcon({
                    className: 'station-marker',
                    html: '<i class="fas fa-map-marker-alt" style="color: #DC2626; font-size: 20px;"></i>',
                    iconSize: [25, 25],
                    iconAnchor: [12, 25]
                })
            }).addTo(map).bindPopup(`
                <div style="text-align: center; padding: 0.5rem;">
                    <strong>${name}</strong><br>
                    <small style="color: #666;">Bus Station</small>
                </div>
            `);
        });

        // Add route lines
        Object.entries(BUS_ROUTES).forEach(([routeId, path]) => {
            const routeLine = L.polyline(path.map(p => [p.lat, p.lng]), {
                color: getRouteColor(routeId),
                weight: 3,
                opacity: 0.6,
                dashArray: '10, 5'
            }).addTo(map);

            routeLines[routeId] = routeLine;

            routeLine.bindPopup(`
                <div style="text-align: center; padding: 0.5rem;">
                    <strong>Route ${routeId}</strong><br>
                    <small>${path[0].station || 'Start'} → ${path[path.length-1].station || 'End'}</small>
                </div>
            `);
        });

        console.log('Map initialized with stations and routes');
    }

    function getRouteColor(routeId) {
        const colors = ['#1E40AF', '#DC2626', '#10B981', '#F59E0B', '#8B5CF6'];
        return colors[parseInt(routeId) - 1] || '#1E40AF';
    }

    // Enhanced bus start function with immediate live tracking
    async function startBus(busId) {
        try {
            console.log(`Starting bus ${busId}...`);

            const bus = await fetchData(`/buses/${busId}`);
            if (!bus) throw new Error('Bus not found');

            if (!bus.driver) {
                showNotification('Cannot start: No driver assigned', 'error');
                return;
            }

            if (!bus.route) {
                showNotification('Cannot start: No route assigned', 'error');
                return;
            }

            // Get route path and starting position
            const routePath = BUS_ROUTES[bus.route.id] || BUS_ROUTES[1];
            const startPoint = routePath[0];

            // Reset bus to starting position
            await putData(`/buses/${busId}/start`, {
                currentLat: startPoint.lat,
                currentLng: startPoint.lng,
                progress: 0,
                currentSpeed: 0,
                passengers: Math.floor(Math.random() * 5) + 3,
                estimatedArrival: 'Calculating...',
                departureTime: new Date().toISOString(),
                isStopped: false,
                hasAccident: false
            });

            // Start the enhanced real-time simulation
            startRealTimeBusSimulation(busId);

            // Immediately show bus on map if tracking section is active
            if (!document.getElementById('tracking-section').classList.contains('hidden')) {
                await loadBusTracking();
                centerMapOnBus(busId);
            }

            showNotification(`Bus ${bus.name} started successfully! Live tracking activated.`, 'success');

        } catch (error) {
            console.error('Error starting bus:', error);
            showNotification('Error starting bus: ' + error.message, 'error');
        }
    }

    // **CORE REAL-TIME SIMULATION ENGINE**
    function startRealTimeBusSimulation(busId) {
        // Clear any existing simulation
        if (busSimulations[busId]) {
            clearInterval(busSimulations[busId]);
        }

        console.log(`Starting real-time simulation for bus ${busId}`);

        // Enhanced simulation configuration for smooth real-time movement
        const config = {
            updateInterval: 500, // Update every 500ms for smooth movement
            baseSpeed: 0.15, // Base progress increment per update (0.15% per 500ms)
            acceleration: 0.05,
            deceleration: 0.08,
            stationWaitTime: 10, // Reduced wait time for better demo
            speedVariation: 0.4, // Speed can vary ±40%
            stationStopChance: 0.12, // 12% chance to stop at intermediate points
        };

        let currentProgress = 0;
        let currentSpeed = config.baseSpeed;
        let targetSpeed = config.baseSpeed;
        let isAtStation = false;
        let stationWaitTime = 0;
        let passengers = Math.floor(Math.random() * 10) + 5;
        let lastProgressUpdate = Date.now();

        busSimulations[busId] = setInterval(async () => {
            try {
                const bus = await fetchData(`/buses/${busId}`);
                if (!bus || bus.isStopped || bus.hasAccident) {
                    console.log(`Stopping simulation for bus ${busId}: stopped or accident`);
                    clearInterval(busSimulations[busId]);
                    delete busSimulations[busId];
                    return;
                }

                // Check if journey is complete
                if (currentProgress >= 100) {
                    await putData(`/buses/${busId}/complete`, {
                        progress: 100,
                        currentSpeed: 0,
                        estimatedArrival: 'Arrived',
                        isStopped: true
                    });
                    clearInterval(busSimulations[busId]);
                    delete busSimulations[busId];
                    showNotification(`Bus ${bus.name} has completed its journey!`, 'success');

                    // Update tracking display
                    if (!document.getElementById('tracking-section').classList.contains('hidden')) {
                        setTimeout(() => loadBusTracking(), 1000);
                    }
                    return;
                }

                // Station stop simulation
                const shouldStopAtStation = Math.random() < config.stationStopChance &&
                    currentProgress > 10 && currentProgress < 85 && !isAtStation;

                if (shouldStopAtStation) {
                    isAtStation = true;
                    stationWaitTime = config.stationWaitTime;
                    targetSpeed = 0;

                    // Simulate passenger boarding/alighting
                    const boarding = Math.floor(Math.random() * 4) + 1;
                    const alighting = Math.floor(Math.random() * Math.min(passengers, 3));
                    passengers = Math.min(bus.capacity, Math.max(1, passengers - alighting + boarding));
                }

                // Handle station waiting
                if (isAtStation) {
                    stationWaitTime--;
                    if (stationWaitTime <= 0) {
                        isAtStation = false;
                        targetSpeed = config.baseSpeed * (1 + (Math.random() * config.speedVariation * 2 - config.speedVariation));
                    }
                }

                // Speed adjustments (acceleration/deceleration)
                if (currentSpeed < targetSpeed) {
                    currentSpeed = Math.min(targetSpeed, currentSpeed + config.acceleration);
                } else if (currentSpeed > targetSpeed) {
                    currentSpeed = Math.max(0, currentSpeed - config.deceleration);
                }

                // Random traffic simulation
                if (Math.random() < 0.05 && !isAtStation) {
                    targetSpeed = config.baseSpeed * (0.6 + Math.random() * 0.8); // Random slowdown/speedup
                }

                // Update progress only when moving
                if (!isAtStation && currentSpeed > 0) {
                    currentProgress = Math.min(100, currentProgress + currentSpeed);
                }

                // Calculate real-time position along route
                const routePath = BUS_ROUTES[bus.route?.id] || BUS_ROUTES[1];
                const position = calculateBusPosition(routePath, currentProgress);

                // Calculate realistic ETA
                const remainingProgress = 100 - currentProgress;
                const avgSpeed = Math.max(currentSpeed, 0.1);
                const etaSeconds = (remainingProgress / avgSpeed) * (config.updateInterval / 1000);
                const etaMinutes = Math.round(etaSeconds / 60);

                // Update bus data in backend
                const updateData = {
                    currentLat: position.lat,
                    currentLng: position.lng,
                    progress: currentProgress,
                    currentSpeed: Math.round(currentSpeed * 120), // Convert to km/h for display
                    passengers: passengers,
                    estimatedArrival: etaMinutes > 0 ? `${etaMinutes} min` : 'Arriving',
                    currentStation: isAtStation ? position.nearestStation : null,
                    nextStation: position.nextStation,
                    isStopped: false
                };

                await putData(`/buses/${busId}/position`, updateData);

                // **REAL-TIME MAP UPDATE** - This is key for live tracking
                if (!document.getElementById('tracking-section').classList.contains('hidden')) {
                    updateBusMarkerRealTime(busId, position.lat, position.lng, currentProgress, currentSpeed, isAtStation);

                    // Update tracking panel every few updates to avoid too frequent DOM manipulation
                    const now = Date.now();
                    if (now - lastProgressUpdate > 2000) { // Update panel every 2 seconds
                        const buses = await fetchData('/buses');
                        const activeBuses = buses.filter(bus => !bus.isStopped);
                        displayLiveTrackingPanel(activeBuses);
                        lastProgressUpdate = now;
                    }
                }

            } catch (error) {
                console.error('Error in bus simulation:', error);
            }
        }, config.updateInterval);
    }

    // Calculate precise bus position along route
    function calculateBusPosition(routePath, progress) {
        const totalSegments = routePath.length - 1;
        const segmentProgress = (progress / 100) * totalSegments;
        const segmentIndex = Math.min(Math.floor(segmentProgress), totalSegments - 1);
        const segmentFraction = segmentProgress - segmentIndex;

        const startPoint = routePath[segmentIndex];
        const endPoint = routePath[Math.min(segmentIndex + 1, routePath.length - 1)];

        // Precise interpolation for smooth movement
        const lat = startPoint.lat + (endPoint.lat - startPoint.lat) * segmentFraction;
        const lng = startPoint.lng + (endPoint.lng - startPoint.lng) * segmentFraction;

        return {
            lat: lat,
            lng: lng,
            nearestStation: startPoint.station,
            nextStation: endPoint.station
        };
    }

    // **REAL-TIME MAP MARKER UPDATE** - Core live tracking function
    function updateBusMarkerRealTime(busId, lat, lng, progress, speed, isAtStation) {
        if (!map) return;

        const statusClass = progress >= 100 ? 'completed' :
            isAtStation ? 'stopped' : 'moving';

        if (!busMarkers[busId]) {
            // Create new marker
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: `bus-marker ${statusClass}`,
                    html: `
                        <div style="position: relative;">
                            <i class="fas fa-bus" style="color: white; font-size: 16px;"></i>
                            <div style="position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
                                        background: white; padding: 2px 6px; border-radius: 10px;
                                        font-size: 10px; font-weight: bold; border: 1px solid #ccc;
                                        min-width: 35px; text-align: center;">
                                ${Math.round(progress)}%
                            </div>
                        </div>
                    `,
                    iconSize: [35, 35],
                    iconAnchor: [17, 17]
                })
            });

            marker.addTo(map);
            busMarkers[busId] = marker;

            // Add popup with real-time info
            marker.bindPopup(() => {
                return `
                    <div style="text-align: center; min-width: 200px;">
                        <h4 style="margin-bottom: 1rem; color: var(--primary-blue);">Bus ${busId}</h4>
                        <div style="text-align: left;">
                            <p><strong>Progress:</strong> ${Math.round(progress)}%</p>
                            <p><strong>Speed:</strong> ${Math.round(speed * 120)} km/h</p>
                            <p><strong>Status:</strong> ${isAtStation ? 'At Station' : 'Moving'}</p>
                            <p><strong>Position:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button onclick="centerMapOnBus(${busId})" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                <i class="fas fa-crosshairs"></i> Follow
                            </button>
                        </div>
                    </div>
                `;
            });

        } else {
            // Update existing marker position with smooth animation
            const currentLatLng = busMarkers[busId].getLatLng();
            const newLatLng = L.latLng(lat, lng);

            // Smooth position transition
            busMarkers[busId].setLatLng(newLatLng);

            // Update marker appearance
            const icon = busMarkers[busId].getIcon();
            icon.options.html = `
                <div style="position: relative;">
                    <i class="fas fa-bus" style="color: white; font-size: 16px;"></i>
                    <div style="position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
                                background: white; padding: 2px 6px; border-radius: 10px;
                                font-size: 10px; font-weight: bold; border: 1px solid #ccc;
                                min-width: 35px; text-align: center;">
                        ${Math.round(progress)}%
                    </div>
                </div>
            `;
            icon.options.className = `bus-marker ${statusClass}`;
            busMarkers[busId].setIcon(icon);
        }
    }




    // Load and display live tracking data
    async function loadBusTracking() {
        try {
            if (!map) {
                initializeMap();
                return;
            }

            console.log('Loading live bus tracking data...');

            const buses = await fetchData('/buses');
            const activeBuses = buses.filter(bus => !bus.isStopped);

            // Remove markers for stopped buses
            Object.keys(busMarkers).forEach(busId => {
                const busExists = activeBuses.find(bus => bus.id == busId);
                if (!busExists) {
                    if (busMarkers[busId] && map.hasLayer(busMarkers[busId])) {
                        map.removeLayer(busMarkers[busId]);
                    }
                    delete busMarkers[busId];
                }
            });

            // Update markers for active buses
            activeBuses.forEach(bus => {
                if (bus.currentLat && bus.currentLng) {
                    updateBusMarkerRealTime(
                        bus.id,
                        bus.currentLat,
                        bus.currentLng,
                        bus.progress || 0,
                        bus.currentSpeed / 120 || 0, // Convert back from km/h
                        bus.currentStation !== null
                    );
                }
            });

            // Update tracking panel
            displayLiveTrackingPanel(activeBuses);

            // Auto-fit map view to show all active buses
            if (activeBuses.length > 0 && Object.keys(busMarkers).length > 0) {
                const markerPositions = Object.values(busMarkers).map(marker => marker.getLatLng());
                if (markerPositions.length > 1) {
                    const bounds = L.latLngBounds(markerPositions);
                    map.fitBounds(bounds, { padding: [20, 20], maxZoom: 14 });
                }
            }

        } catch (error) {
            console.error('Error loading bus tracking:', error);
            showNotification('Error loading tracking data', 'error');
        }
    }

    // Display live tracking panel with real-time updates
    function displayLiveTrackingPanel(buses) {
        const container = document.getElementById('activeBusesTracking');
        if (!container) return;

        if (buses.length === 0) {
            container.innerHTML = '<p style="color: var(--gray-medium);">No buses currently active</p>';
            return;
        }

        container.innerHTML = buses.map(bus => {
            const progress = Math.round(bus.progress || 0);
            const speed = Math.round(bus.currentSpeed || 0);
            const eta = bus.estimatedArrival || 'Calculating...';
            const statusClass = bus.hasAccident ? 'status-accident' :
                bus.currentStation ? 'status-stopped' : 'status-active';
            const statusText = bus.hasAccident ? 'Accident' :
                bus.currentStation ? 'At Station' : 'Moving';

            return `
                <div class="bus-tracking-item" onclick="centerMapOnBus(${bus.id})">
                    <div class="bus-header">
                        <div>
                            <span class="bus-name">${bus.name}</span>
                            <span class="bus-line">${bus.busLine}</span>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <small>${progress}% completed</small>
                    </div>

                    <div class="bus-stats">
                        <div><i class="fas fa-tachometer-alt"></i> ${speed} km/h</div>
                        <div><i class="fas fa-users"></i> ${bus.passengers || 0}/${bus.capacity}</div>
                        <div><i class="fas fa-clock"></i> ETA: ${eta}</div>
                        <div><i class="fas fa-route"></i> ${bus.route?.routeName || 'No route'}</div>
                    </div>

                    ${bus.currentStation ? `
                        <div style="background: #f0f5ff; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.9rem;">
                            <i class="fas fa-map-marker-alt"></i> Currently at: ${bus.currentStation}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    // Center map on specific bus
    function centerMapOnBus(busId) {
        if (busMarkers[busId] && map) {
            map.setView(busMarkers[busId].getLatLng(), 15);
            busMarkers[busId].openPopup();
            showNotification(`Centered on Bus ${busId}`, 'info');
        }
    }

    // Track specific bus continuously
    function trackBus(busId) {
        if (!busMarkers[busId]) {
            showNotification('Bus not found on map', 'error');
            return;
        }

        centerMapOnBus(busId);

        // Start continuous tracking
        const trackingInterval = setInterval(() => {
            if (!busMarkers[busId] || document.getElementById('tracking-section').classList.contains('hidden')) {
                clearInterval(trackingInterval);
                return;
            }

            // Keep bus centered
            map.setView(busMarkers[busId].getLatLng(), 15);
        }, 3000);

        showNotification(`Continuous tracking activated for Bus ${busId}`, 'success');
    }

    // Stop bus function
    async function stopBus(busId) {
        try {
            await putData(`/buses/${busId}/stop`);
            showNotification('Bus stopped successfully!', 'success');

            if (busSimulations[busId]) {
                clearInterval(busSimulations[busId]);
                delete busSimulations[busId];
            }

            // Remove from map
            if (busMarkers[busId]) {
                map.removeLayer(busMarkers[busId]);
                delete busMarkers[busId];
            }

            await Promise.all([
                loadBuses(),
                loadDashboardData(),
                loadBusTracking()
            ]);
        } catch (error) {
            console.error('Error stopping bus:', error);
            showNotification('Error stopping bus: ' + error.message, 'error');
        }
    }

    // Enhanced control functions for the tracking interface
    async function startAllBuses() {
        try {
            const buses = await fetchData('/buses');
            const availableBuses = buses.filter(bus =>
                bus.isStopped &&
                !bus.hasAccident &&
                bus.driver &&
                bus.route &&
                (bus.progress === 0 || bus.progress === 100)
            );

            if (availableBuses.length === 0) {
                showNotification('No buses available to start', 'warning');
                return;
            }

            showNotification(`Starting ${availableBuses.length} buses...`, 'info');

            for (const bus of availableBuses) {
                await startBus(bus.id);
                await new Promise(resolve => setTimeout(resolve, 1500)); // Stagger starts
            }

            showNotification(`Successfully started ${availableBuses.length} buses!`, 'success');
        } catch (error) {
            console.error('Error starting all buses:', error);
            showNotification('Error starting buses: ' + error.message, 'error');
        }
    }

    async function stopAllBuses() {
        try {
            const buses = await fetchData('/buses');
            const activeBuses = buses.filter(bus => !bus.isStopped && !bus.hasAccident);

            if (activeBuses.length === 0) {
                showNotification('No active buses to stop', 'info');
                return;
            }

            for (const bus of activeBuses) {
                await stopBus(bus.id);
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            showNotification(`Stopped ${activeBuses.length} buses`, 'success');
        } catch (error) {
            console.error('Error stopping all buses:', error);
            showNotification('Error stopping buses: ' + error.message, 'error');
        }
    }

    async function resetAllBuses() {
        try {
            if (confirm('Are you sure you want to reset all buses to their starting positions?')) {
                const buses = await fetchData('/buses');

                for (const bus of buses) {
                    if (busSimulations[bus.id]) {
                        clearInterval(busSimulations[bus.id]);
                        delete busSimulations[bus.id];
                    }

                    if (busMarkers[bus.id]) {
                        map.removeLayer(busMarkers[bus.id]);
                        delete busMarkers[bus.id];
                    }

                    await putData(`/buses/${bus.id}/reset`);
                }

                showNotification('All buses have been reset!', 'success');

                await Promise.all([
                    loadBuses(),
                    loadDashboardData(),
                    loadBusTracking()
                ]);
            }
        } catch (error) {
            console.error('Error resetting buses:', error);
            showNotification('Error resetting buses: ' + error.message, 'error');
        }
    }

    function refreshTracking() {
        loadBusTracking();
        showNotification('Tracking data refreshed!', 'success');
    }

    // Auto-refresh tracking when section is active
    setInterval(() => {
        if (!document.getElementById('tracking-section').classList.contains('hidden')) {
            loadBusTracking();
        }
    }, 5000); // Refresh every 5 seconds for live updates

    // Enhanced View Bus Details
    async function viewBusDetails(busId) {
        try {
            const bus = await fetchData(`/buses/${busId}`);
            if (!bus) {
                throw new Error('Bus not found');
            }

            const driverInfo = bus.driver ?
                `${bus.driver.firstName} ${bus.driver.lastName} (${bus.driver.email})` :
                'Not assigned';

            const routeInfo = bus.route ?
                `${bus.route.routeName} (${bus.route.totalDistance || 'N/A'} km)` :
                'Not assigned';

            const content = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Bus ID</div>
                        <div class="detail-value">${bus.id}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bus Name</div>
                        <div class="detail-value">${bus.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bus Line</div>
                        <div class="detail-value">${bus.busLine}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Capacity</div>
                        <div class="detail-value">${bus.capacity} passengers</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Current Passengers</div>
                        <div class="detail-value">${bus.passengers || 0}/${bus.capacity}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Driver</div>
                        <div class="detail-value">${driverInfo}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Route</div>
                        <div class="detail-value">${routeInfo}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <span class="status-badge ${bus.hasAccident ? 'status-accident' : (bus.isStopped ? 'status-stopped' : 'status-active')}">
                                ${bus.hasAccident ? 'Accident' : (bus.isStopped ? 'Stopped' : 'Active')}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Progress</div>
                        <div class="detail-value">
                            <div class="progress-bar" style="margin-top: 0.5rem;">
                                <div class="progress-fill" style="width: ${Math.round(bus.progress || 0)}%"></div>
                            </div>
                            ${Math.round(bus.progress || 0)}%
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Current Speed</div>
                        <div class="detail-value">${bus.currentSpeed || 0} km/h</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Departure Time</div>
                        <div class="detail-value">${bus.departureTime ? new Date(bus.departureTime).toLocaleString() : 'Not set'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ETA</div>
                        <div class="detail-value">${bus.estimatedArrival || 'N/A'}</div>
                    </div>
                </div>

                ${bus.currentLat && bus.currentLng ? `
                    <div style="margin-top: 2rem;">
                        <h4>Current Location</h4>
                        <p><strong>Coordinates:</strong> ${bus.currentLat.toFixed(6)}, ${bus.currentLng.toFixed(6)}</p>
                        ${bus.currentStation ? `<p><strong>Current Station:</strong> ${bus.currentStation}</p>` : ''}
                        ${bus.nextStation ? `<p><strong>Next Station:</strong> ${bus.nextStation}</p>` : ''}
                    </div>
                ` : ''}
            `;

            document.getElementById('viewBusContent').innerHTML = content;
            openModal('viewBusModal');

        } catch (error) {
            console.error('Error loading bus details:', error);
            showNotification('Error loading bus details: ' + error.message, 'error');
        }
    }

    // Enhanced Edit Bus
    async function editBus(busId) {
        try {
            const bus = await fetchData(`/buses/${busId}`);
            if (!bus) {
                throw new Error('Bus not found');
            }

            // Populate edit form
            document.getElementById('editBusId').value = bus.id;
            document.getElementById('editBusName').value = bus.name;
            document.getElementById('editBusLine').value = bus.busLine;
            document.getElementById('editBusCapacity').value = bus.capacity;

            // Populate route select
            const routes = await fetchData('/routes');
            const routeSelect = document.getElementById('editBusRoute');
            routeSelect.innerHTML = '<option value="">Select a route</option>';
            routes.forEach(route => {
                const selected = bus.route && bus.route.id === route.id ? 'selected' : '';
                routeSelect.innerHTML += `<option value="${route.id}" ${selected}>${route.routeName}</option>`;
            });

            openModal('editBusModal');
        } catch (error) {
            console.error('Error loading bus for edit:', error);
            showNotification('Error loading bus details: ' + error.message, 'error');
        }
    }




    async function handleAddBus(e) {
        e.preventDefault();
        const routeId = document.getElementById('busRoute').value;
        const driverId = document.getElementById('busDriver').value;
        const departureTime = document.getElementById('busDepartureTime').value;
        const arrivalTime = document.getElementById('busArrivalTime').value;
        const busName = document.getElementById('busName').value.trim();
        const busLine = document.getElementById('busLine').value.trim();
        const capacity = document.getElementById('busCapacity').value;

        // Reset error styles
        document.getElementById('busName').classList.remove('error-border');
        const errorMessage = document.getElementById('busNameError');
        if (errorMessage) errorMessage.style.display = 'none';

        // Validate required fields
        if (!routeId || !driverId || !departureTime || !busName || !busLine || !capacity) {
            showNotification('Please fill all required fields.', 'error');
            return;
        }

        // Validate capacity is a positive number
        const capacityNum = parseInt(capacity);
        if (isNaN(capacityNum) || capacityNum <= 0) {
            showNotification('Bus capacity must be a positive number.', 'error');
            return;
        }

        // Validate dates
        if (!validateBusDates(departureTime, arrivalTime)) {
            return;
        }

        // Validate bus name
        try {
            const isNameValid = await validateBusName(busName);
            if (!isNameValid) {
                showNotification('A bus with a similar name already exists. Please choose a different name.', 'error');
                document.getElementById('busName').classList.add('error-border');
                if (errorMessage) errorMessage.style.display = 'block';
                return;
            }
        } catch (error) {
            console.error('Error validating bus name:', error);
            showNotification('Error validating bus name', 'error');
            return;
        }

        try {
            showLoader();

            // Convert datetime-local format to ISO format for backend
            const departureDateTime = new Date(departureTime).toISOString();
            let arrivalDateTime = null;
            if (arrivalTime) {
                arrivalDateTime = new Date(arrivalTime).toISOString();
            }

            // Calculate estimated duration if both times are provided
            let estimatedDuration = null;
            if (departureTime && arrivalTime) {
                const depTime = new Date(departureTime);
                const arrTime = new Date(arrivalTime);
                estimatedDuration = Math.round((arrTime - depTime) / (1000 * 60)); // in minutes
            }

            // Create bus data object matching backend DTO structure
            const busData = {
                name: busName,
                busLine: busLine,
                capacity: capacityNum,
                routeId: parseInt(routeId),
                driverId: parseInt(driverId),
                departureTime: departureDateTime,
                estimatedDuration: estimatedDuration,
                // Add default coordinates if needed (you might want to get these from route)
                startLat: 0.0,
                startLng: 0.0,
                endLat: 0.0,
                endLng: 0.0
            };

            console.log('Sending bus data:', busData); // Debug log

            const response = await fetch(`${API_BASE}/buses`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(busData)
            });

            // Handle response
            if (!response.ok) {
                let errorMessage = 'Failed to add bus';
                try {
                    const errorData = await response.json();
                    console.error('Backend error response:', errorData);

                    // Handle different error response formats
                    if (errorData.error) {
                        errorMessage = errorData.error;
                    } else if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (typeof errorData === 'string') {
                        errorMessage = errorData;
                    }
                } catch (parseError) {
                    console.error('Error parsing error response:', parseError);
                    errorMessage = `Server error (${response.status}): ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            const result = await response.json();
            console.log('Bus created successfully:', result);

            showNotification('Bus added successfully!', 'success');
            document.getElementById('addBusForm').reset();
            closeModal('addBusModal');

            // Reload bus list if function exists
            if (typeof loadBuses === 'function') {
                loadBuses();
            }

        } catch (error) {
            console.error('Error adding bus:', error);
            showNotification('Error adding bus: ' + error.message, 'error');
        } finally {
            hideLoader();
        }
    }


    document.getElementById('busName').addEventListener('blur', async function() {
        const name = this.value.trim();
        if (name) {
            const isValid = await validateBusName(name);
            if (!isValid) {
                document.getElementById('busNameError').style.display = 'block';
                this.classList.add('error-border');
            } else {
                document.getElementById('busNameError').style.display = 'none';
                this.classList.remove('error-border');
            }
        }
    });

    document.getElementById('editBusName').addEventListener('blur', async function() {
        const name = this.value.trim();
        const busId = document.getElementById('editBusId').value;
        if (name) {
            const isValid = await validateBusName(name, busId);
            if (!isValid) {
                // Vous devrez peut-être ajouter un élément d'erreur dans votre modal d'édition
                this.classList.add('error-border');
                showNotification('Un bus avec un nom similaire existe déjà', 'error');
            } else {
                this.classList.remove('error-border');
            }
        }
    });













    async function validateBusName(name, currentId = null) {
        try {
            const buses = await fetchData('/buses');
            const normalizedInput = name.toLowerCase().trim();

            // Vérification stricte : nom exact uniquement
            const exactMatch = buses.find(bus => {
                // Don't check against current bus during editing
                if (currentId && bus.id == currentId) return false;

                const normalizedBusName = bus.name.toLowerCase().trim();

                // Comparaison exacte uniquement
                return normalizedBusName === normalizedInput;
            });

            return !exactMatch; // Return true if name is valid (no exact match found)
        } catch (error) {
            console.error('Error validating bus name:', error);
            return false; // Consider invalid on error for safety
        }
    }






    // Fonction pour calculer la similarité entre deux chaînes (algorithme de Levenshtein)
    function calculateSimilarity(s1, s2) {
        const longer = s1.length > s2.length ? s1 : s2;
        const shorter = s1.length > s2.length ? s2 : s1;
        const longerLength = longer.length;

        if (longerLength === 0) return 1.0;

        return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }

    // Distance de Levenshtein
    function editDistance(s1, s2) {
        s1 = s1.toLowerCase();
        s2 = s2.toLowerCase();

        const costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) {
                    costs[j] = j;
                } else {
                    if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }














    // Also update your validateBusDates function to be more lenient
    function validateBusDates(departureTime, arrivalTime) {
        const now = new Date();
        const departure = new Date(departureTime);

        // Check if departure time is in the past
        if (departure <= now) {
            showNotification('Departure time must be in the future.', 'error');
            return false;
        }

        // If arrival time is provided, validate it
        if (arrivalTime) {
            const arrival = new Date(arrivalTime);

            // Check if arrival is after departure
            if (arrival <= departure) {
                showNotification('Arrival time must be after departure time.', 'error');
                return false;
            }

            // Check if duration is reasonable (not more than 24 hours)
            const durationHours = (arrival - departure) / (1000 * 60 * 60);
            if (durationHours > 24) {
                showNotification('Trip duration cannot exceed 24 hours.', 'error');
                return false;
            }
        }

        return true;
    }


    async function handleEditBus(e) {
        e.preventDefault();

        const busId = document.getElementById('editBusId').value;
        const formData = {
            name: document.getElementById('editBusName').value,
            busLine: document.getElementById('editBusLine').value,
            capacity: parseInt(document.getElementById('editBusCapacity').value),
            routeId: parseInt(document.getElementById('editBusRoute').value)
        };

        try {
            await putData(`/buses/${busId}`, formData);
            closeModal('editBusModal');
            showNotification('Bus updated successfully!', 'success');
            loadBuses();
        } catch (error) {
            console.error('Error updating bus:', error);
            showNotification('Error updating bus: ' + error.message, 'error');
        }
    }




    async function deleteBus(busId) {
        if (!confirm('Are you sure you want to delete this bus? This action cannot be undone.')) {
            return;
        }

        try {
            // First, check if the bus has any dependencies
            const bus = await fetchData(`/buses/${busId}`);
            if (!bus) {
                showNotification('Bus not found', 'error');
                return;
            }

            // Check if bus is currently running or has passengers
            if (!bus.stopped && bus.progress > 0) {
                if (!confirm('This bus is currently running. Are you sure you want to delete it? This will stop the bus immediately.')) {
                    return;
                }

                // Stop the bus first
                try {
                    await putData(`/buses/${busId}/stop`, {});
                } catch (stopError) {
                    console.warn('Could not stop bus before deletion:', stopError);
                }
            }

            if (bus.passengers && bus.passengers > 0) {
                if (!confirm(`This bus has ${bus.passengers} passengers. Deleting it will affect their tickets. Continue?`)) {
                    return;
                }
            }

            // Check for tickets associated with this bus
            try {
                const tickets = await fetchData('/tickets');
                const busTickets = tickets.filter(ticket => ticket.busId === busId || (ticket.bus && ticket.bus.id === busId));

                if (busTickets.length > 0) {
                    const activeTickets = busTickets.filter(ticket => ticket.status === 'PAID' || ticket.status === 'BOARDED');

                    if (activeTickets.length > 0) {
                        if (!confirm(`This bus has ${activeTickets.length} active tickets. Deleting the bus will affect these tickets. Continue?`)) {
                            return;
                        }
                    }
                }
            } catch (ticketError) {
                console.warn('Could not check tickets for bus:', ticketError);
            }

            // Attempt to delete the bus
            const response = await fetch(`${API_BASE}/buses/${busId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                }
            });

            if (!response.ok) {
                let errorMessage = `HTTP error! status: ${response.status}`;

                try {
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } else {
                        // Response is plain text
                        const textError = await response.text();
                        errorMessage = textError || errorMessage;
                    }

                    // Handle specific error cases
                    if (response.status === 400) {
                        if (errorMessage.toLowerCase().includes('foreign key') ||
                            errorMessage.toLowerCase().includes('constraint') ||
                            errorMessage.toLowerCase().includes('referenced') ||
                            errorMessage.toLowerCase().includes('tickets') ||
                            errorMessage.toLowerCase().includes('dependencies')) {
                            errorMessage = 'Cannot delete bus: This bus has associated tickets or other dependencies. Please remove all related tickets first.';
                        } else if (errorMessage.toLowerCase().includes('running') ||
                            errorMessage.toLowerCase().includes('active') ||
                            errorMessage.toLowerCase().includes('passengers')) {
                            errorMessage = 'Cannot delete bus: The bus is currently active or has passengers. Please stop the bus and wait for all passengers to disembark.';
                        } else if (errorMessage.toLowerCase().includes('driver')) {
                            errorMessage = 'Cannot delete bus: This bus is assigned to a driver. Please unassign the driver first.';
                        }
                    } else if (response.status === 404) {
                        errorMessage = 'Bus not found. It may have already been deleted.';
                    } else if (response.status === 403) {
                        errorMessage = 'You do not have permission to delete this bus.';
                    } else if (response.status === 409) {
                        errorMessage = 'Cannot delete bus: It conflicts with existing data. Please resolve dependencies first.';
                    }
                } catch (parseError) {
                    console.warn('Could not parse error response:', parseError);
                    // If we can't parse the response, try to get text
                    try {
                        const textError = await response.text();
                        if (textError) {
                            errorMessage = textError;
                        }
                    } catch (textError) {
                        console.warn('Could not get text error either:', textError);
                    }
                }

                throw new Error(errorMessage);
            }

            // Success
            showNotification('Bus deleted successfully!', 'success');

            // Reload data
            await Promise.all([
                loadBuses(),
                loadDashboardData(),
                loadTickets() // Reload tickets in case any were affected
            ]);

        } catch (error) {
            console.error('Error deleting bus:', error);

            // Provide user-friendly error messages
            let userMessage = error.message;

            if (error.message.includes('Failed to fetch')) {
                userMessage = 'Network error: Could not connect to server. Please check your connection and try again.';
            } else if (error.message.includes('NetworkError')) {
                userMessage = 'Network error occurred. Please try again.';
            }

            showNotification('Error deleting bus: ' + userMessage, 'error');
        }
    }



    // Simpler approach using bus line
    document.getElementById('ticketBus').addEventListener('change', async function() {
        const busId = this.value;
        const originField = document.getElementById('ticketOrigin');
        const destinationField = document.getElementById('ticketDestination');

        if (!busId) {
            originField.value = '';
            destinationField.value = '';
            return;
        }

        try {
            const bus = await fetchData(`/buses/${busId}`);

            if (bus) {
                // From your example: "CAR 1 - KDD (Gare Centrale - Bandalungwa)"
                // Extract the route part from bus line or name
                let routeInfo = bus.busLine || bus.name || '';

                // Look for pattern like "(Origin - Destination)"
                const routeMatch = routeInfo.match(/\(([^)]+)\)/);
                if (routeMatch) {
                    const routePart = routeMatch[1]; // "Gare Centrale - Bandalungwa"
                    if (routePart.includes(' - ')) {
                        const parts = routePart.split(' - ');
                        originField.value = parts[0].trim();
                        destinationField.value = parts[1].trim();
                    } else {
                        originField.value = 'Gare Centrale';
                        destinationField.value = 'Matete';
                    }
                } else {
                    // Fallback values
                    originField.value = 'Gare Centrale';
                    destinationField.value = 'Matete';
                }

                console.log(`Set Origin: ${originField.value}, Destination: ${destinationField.value}`);
            }
        } catch (error) {
            console.error('Error:', error);
            originField.value = 'Gare Centrale';
            destinationField.value = 'Matete';
        }
    });



    // Enhanced Ticket Management
    async function handleBusSelection() {
        const busSelect = document.getElementById('ticketBus');
        const selectedBusId = busSelect.value;
        const originField = document.getElementById('ticketOrigin');
        const destinationField = document.getElementById('ticketDestination');

        if (selectedBusId) {
            try {
                console.log('Selected bus ID:', selectedBusId);

                const bus = await fetchData(`/buses/${selectedBusId}`);
                console.log('Bus data received:', bus);

                if (!bus) {
                    throw new Error('Bus not found');
                }

                // Try multiple approaches to get origin and destination
                if (bus.route) {
                    console.log('Route data:', bus.route);

                    // Approach 1: Check if route has startStation/endStation
                    if (bus.route.startStation && bus.route.endStation) {
                        originField.value = bus.route.startStation;
                        destinationField.value = bus.route.endStation;
                    }
                    // Approach 2: Parse route name
                    else if (bus.route.routeName) {
                        const routeName = bus.route.routeName;
                        console.log('Parsing route name:', routeName);

                        if (routeName.includes(' - ')) {
                            const parts = routeName.split(' - ');
                            originField.value = parts[0].trim();
                            destinationField.value = parts[1].trim();
                        } else if (routeName.includes('-')) {
                            const parts = routeName.split('-');
                            originField.value = parts[0].trim();
                            destinationField.value = parts[1].trim();
                        } else {
                            originField.value = 'Gare Centrale';
                            destinationField.value = 'Matete';
                        }
                    }
                    // Approach 3: Check if route has stops
                    else if (bus.route.stops && bus.route.stops.length > 0) {
                        const sortedStops = bus.route.stops.sort((a, b) => a.sequenceOrder - b.sequenceOrder);
                        originField.value = sortedStops[0].stopName || sortedStops[0].name;
                        destinationField.value = sortedStops[sortedStops.length - 1].stopName || sortedStops[sortedStops.length - 1].name;
                    } else {
                        originField.value = 'Gare Centrale';
                        destinationField.value = 'Matete';
                    }
                }
                // Approach 4: Parse bus line if no route
                else if (bus.busLine) {
                    console.log('No route found, parsing bus line:', bus.busLine);

                    // Look for pattern like "KDD (Gare Centrale - Bandalungwa)"
                    const routeMatch = bus.busLine.match(/\(([^)]+)\)/);
                    if (routeMatch) {
                        const routePart = routeMatch[1];
                        if (routePart.includes(' - ')) {
                            const parts = routePart.split(' - ');
                            originField.value = parts[0].trim();
                            destinationField.value = parts[1].trim();
                        } else {
                            originField.value = 'Gare Centrale';
                            destinationField.value = 'Matete';
                        }
                    } else if (bus.busLine.includes(' - ')) {
                        const parts = bus.busLine.split(' - ');
                        originField.value = parts[0].trim();
                        destinationField.value = parts[1].trim();
                    } else {
                        originField.value = 'Gare Centrale';
                        destinationField.value = 'Matete';
                    }
                } else {
                    originField.value = 'Gare Centrale';
                    destinationField.value = 'Matete';
                }

                console.log(`Final values - Origin: ${originField.value}, Destination: ${destinationField.value}`);
                updateTicketPrice();

            } catch (error) {
                console.error('Error loading bus details:', error);
                showNotification('Error loading bus details. Please select a different bus.', 'error');
                originField.value = '';
                destinationField.value = '';
                updateTicketPrice();
            }
        } else {
            originField.value = '';
            destinationField.value = '';
            updateTicketPrice();
        }
    }

    // IMPORTANT: Attach the event listener when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const busSelect = document.getElementById('ticketBus');
        if (busSelect) {
            busSelect.addEventListener('change', handleBusSelection);
        }
    });

    async function loadTickets() {
        try {
            const tickets = await fetchData('/tickets');
            displayTickets(tickets);
        } catch (error) {
            console.error('Error loading tickets:', error);
            document.getElementById('ticketsTableBody').innerHTML =
                '<tr><td colspan="8" style="text-align: center; color: var(--secondary-red);">Error loading tickets</td></tr>';
        }
    }

    function displayTickets(tickets) {
        const tbody = document.getElementById('ticketsTableBody');
        if (tickets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-medium);">No tickets found</td></tr>';
            return;
        }

        tbody.innerHTML = tickets.map(ticket => {
            const statusClass = ticket.status === 'PAID' ? 'status-active' :
                ticket.status === 'BOARDED' ? 'status-stopped' : 'status-pending';
            const price = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
            const departureTime = ticket.departureTime ? new Date(ticket.departureTime).toLocaleString() : 'N/A';
            const busName = ticket.bus ? ticket.bus.name : (ticket.busName || 'N/A');
            const route = `${ticket.origin} → ${ticket.destination}`;

            return `
                <tr>
                    <td>${ticket.ticketNumber}</td>
                    <td>${ticket.firstName} ${ticket.lastName}</td>
                    <td>${busName}</td>
                    <td>${route}</td>
                    <td>${price.toLocaleString()} FC</td>
                    <td><span class="status-badge ${statusClass}">${ticket.status}</span></td>
                    <td>${departureTime}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewTicketDetails(${ticket.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn download" onclick="downloadQrCode(${ticket.id})" title="Download QR">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="action-btn scan" onclick="scanTicket(${ticket.id})" title="Scan Ticket">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteTicket(${ticket.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Enhanced View Ticket Details
    async function viewTicketDetails(ticketId) {
        try {
            const ticket = await fetchData(`/tickets/${ticketId}`);
            if (!ticket) {
                throw new Error('Ticket not found');
            }

            const price = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
            const busInfo = ticket.bus ?
                `${ticket.bus.name} - ${ticket.bus.busLine}` :
                (ticket.busName || 'Not assigned');

            const content = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Ticket Number</div>
                        <div class="detail-value">${ticket.ticketNumber}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Passenger Name</div>
                        <div class="detail-value">${ticket.firstName} ${ticket.lastName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bus</div>
                        <div class="detail-value">${busInfo}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Route</div>
                        <div class="detail-value">${ticket.origin} → ${ticket.destination}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Seat Number</div>
                        <div class="detail-value">${ticket.seatNumber || 'Not assigned'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Price</div>
                        <div class="detail-value">${price.toLocaleString()} FC</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <span class="status-badge ${ticket.status === 'PAID' ? 'status-active' :
                ticket.status === 'BOARDED' ? 'status-stopped' : 'status-pending'}">
                                ${ticket.status}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Departure Time</div>
                        <div class="detail-value">${ticket.departureTime ? new Date(ticket.departureTime).toLocaleString() : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Issue Date</div>
                        <div class="detail-value">${new Date(ticket.issuedAt || ticket.createdAt).toLocaleString()}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Luggage</div>
                        <div class="detail-value">${ticket.hasLuggage ? `Yes (${ticket.luggageWeight || 0} kg)` : 'No'}</div>
                    </div>
                    ${ticket.boardingTime ? `
                        <div class="detail-item">
                            <div class="detail-label">Boarding Time</div>
                            <div class="detail-value">${new Date(ticket.boardingTime).toLocaleString()}</div>
                        </div>
                    ` : ''}
                </div>

                <div style="margin-top: 2rem; text-align: center;">
                    <div style="background: var(--gray-light); padding: 2rem; border-radius: var(--border-radius); display: inline-block;">
                        <h4>QR Code</h4>
                        <div style="width: 150px; height: 150px; background: white; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; margin: 1rem auto;">
                            <i class="fas fa-qrcode" style="font-size: 3rem; color: #666;"></i>
                        </div>
                        <p style="font-family: monospace; font-size: 0.9rem; margin-top: 1rem;">
                            ${ticket.id}-${ticket.ticketNumber}
                        </p>
                    </div>
                </div>
            `;

            document.getElementById('viewTicketContent').innerHTML = content;
            openModal('viewTicketModal');

        } catch (error) {
            console.error('Error loading ticket details:', error);
            showNotification('Error loading ticket details: ' + error.message, 'error');
        }
    }





    async function handleAddTicket(e) {
        e.preventDefault();

        const busId = parseInt(document.getElementById('ticketBus').value);
        const firstName = document.getElementById('ticketFirstName').value.trim();
        const lastName = document.getElementById('ticketLastName').value.trim();
        const origin = document.getElementById('ticketOrigin').value.trim();
        const destination = document.getElementById('ticketDestination').value.trim();
        const seatNumber = document.getElementById('ticketSeat').value.trim();
        const hasLuggage = document.getElementById('hasLuggage').checked;
        const luggageWeight = hasLuggage ? parseFloat(document.getElementById('luggageWeight').value) || 0 : 0;

        if (!busId || isNaN(busId)) {
            showNotification('Please select a valid bus', 'error');
            return;
        }

        if (!firstName || !lastName) {
            showNotification('Please enter passenger name', 'error');
            return;
        }

        if (!origin || !destination) {
            showNotification('Origin and destination are required', 'error');
            return;
        }

        if (hasLuggage && luggageWeight <= 0) {
            showNotification('Please enter valid luggage weight', 'error');
            return;
        }

        const submitBtn = document.querySelector('#addTicketForm button[type="submit"]');
        const originalText = submitBtn ? submitBtn.textContent : 'Create Ticket';

        try {
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loading"></div> Creating...';
            }

            const bus = await fetchData(`/buses/${busId}`);
            if (!bus) {
                throw new Error('Selected bus does not exist');
            }

            if (bus.hasAccident) {
                throw new Error('Cannot create ticket for a bus that has an accident');
            }

            if (bus.passengers >= bus.capacity) {
                throw new Error('Bus is full. Cannot create more tickets.');
            }

            const passengerId = Date.now();
            const formattedOrigin = formatLocation(origin);
            const formattedDestination = formatLocation(destination);
            const departureTime = bus.departureTime || new Date(Date.now() + 60 * 60 * 1000).toISOString();

            const ticketData = {
                passengerId: passengerId,
                firstName: firstName,
                lastName: lastName,
                origin: formattedOrigin,
                destination: formattedDestination,
                departureTime: departureTime,
                busId: busId,
                seatNumber: seatNumber || null,
                luggageWeight: luggageWeight,
                hasLuggage: hasLuggage
            };

            const response = await fetch(`${API_BASE}/tickets`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                },
                body: JSON.stringify(ticketData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Server error: ${response.status}`);
            }

            const responseData = await response.json();

            closeModal('addTicketModal');
            document.getElementById('addTicketForm').reset();

            const priceDisplay = document.getElementById('totalPrice');
            if (priceDisplay) {
                priceDisplay.textContent = '2000 FC';
            }

            const luggageWeightField = document.getElementById('luggageWeight');
            if (luggageWeightField) {
                luggageWeightField.disabled = true;
            }

            const createdTicket = responseData.ticket || responseData;
            const displayTicketNumber = createdTicket.ticketNumber || `TK${Date.now().toString().slice(-6)}`;
            showNotification(`Ticket created successfully! Ticket number: ${displayTicketNumber}`, 'success');

            await Promise.all([
                loadTickets(),
                loadDashboardData()
            ]);

        } catch (error) {
            console.error('Error creating ticket:', error);
            showNotification(`Error creating ticket: ${error.message}`, 'error');
        } finally {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
    }

    async function deleteTicket(ticketId) {
        if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
            return;
        }

        try {
            await deleteData(`/tickets/${ticketId}`);
            showNotification('Ticket deleted successfully!', 'success');
            loadTickets();
            loadDashboardData();
        } catch (error) {
            console.error('Error deleting ticket:', error);
            showNotification('Error deleting ticket: ' + error.message, 'error');
        }
    }

    async function scanTicket(ticketId) {
        try {
            const ticket = await fetchData(`/tickets/${ticketId}`);

            if (ticket.status !== 'PAID') {
                showNotification('Only PAID tickets can be scanned', 'error');
                return;
            }

            if (confirm(`Scan ticket ${ticket.ticketNumber} for ${ticket.firstName} ${ticket.lastName}?`)) {
                const qrData = `${ticket.id}-${ticket.ticketNumber}`;
                const response = await fetch(`${API_BASE}/tickets/scan-qr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    },
                    body: JSON.stringify({ qrData })
                });

                const result = await response.json();

                if (result.valid) {
                    showNotification(`Ticket scanned successfully! ${ticket.firstName} has boarded.`, 'success');
                    loadTickets();
                } else {
                    showNotification(result.message || 'Error scanning ticket', 'error');
                }
            }
        } catch (error) {
            console.error('Error scanning ticket:', error);
            showNotification('Error scanning ticket: ' + error.message, 'error');
        }
    }

    function downloadQrCode(ticketId) {
        window.open(`${API_BASE}/tickets/${ticketId}/qr-code`, '_blank');
    }

    // Helper functions for tickets
    function calculateTicketPrice(origin, destination, hasLuggage) {
        const basePrice = 2000.0;
        const formattedOrigin = formatLocation(origin);
        const formattedDestination = formatLocation(destination);
        const distanceMultiplier = calculateDistanceMultiplier(formattedOrigin, formattedDestination);
        const luggagePrice = hasLuggage ? 500.0 : 0.0;
        return (basePrice * distanceMultiplier) + luggagePrice;
    }

    function calculateDistanceMultiplier(origin, destination) {
        const locationMultipliers = {
            "GARE_CENTRALE-MATETE": 1.2,
            "GARE_CENTRALE-LIMETE": 1.0,
            "GARE_CENTRALE-BANDALUNGWA": 1.1,
            "GARE_CENTRALE-NDJILI": 1.5,
            "GARE_CENTRALE-MASINA": 1.6,
            "GARE_CENTRALE-KIMBANSEKE": 2.0
        };

        const route = origin + "-" + destination;
        return locationMultipliers[route] || 1.0;
    }

    function updateTicketPrice() {
        const hasLuggage = document.getElementById('hasLuggage').checked;
        const price = calculateTicketPrice('', '', hasLuggage);
        document.getElementById('totalPrice').textContent = `${price.toLocaleString()} FC`;
    }

    function formatLocation(location) {
        const locationMap = {
            'Gare Centrale': 'GARE_CENTRALE',
            'Matete': 'MATETE',
            'Limete': 'LIMETE',
            'Bandalungwa': 'BANDALUNGWA',
            'Ndjili': 'NDJILI',
            'Masina': 'MASINA',
            'Kimbanseke': 'KIMBANSEKE'
        };

        return locationMap[location] || location.toUpperCase().replace(/\s+/g, '_');
    }

    // Route Management
    async function loadRoutes() {
        try {
            const routes = await fetchData('/routes');
            displayRoutes(routes);
            populateRouteSelects(routes);
        } catch (error) {
            console.error('Error loading routes:', error);
            document.getElementById('routesTableBody').innerHTML =
                '<tr><td colspan="7" style="text-align: center; color: var(--secondary-red);">Error loading routes</td></tr>';
        }
    }

    function displayRoutes(routes) {
        const tbody = document.getElementById('routesTableBody');
        if (routes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray-medium);">No routes found</td></tr>';
            return;
        }

        tbody.innerHTML = routes.map(route => `
            <tr>
                <td>${route.routeCode}</td>
                <td>${route.routeName}</td>
                <td>${route.totalDistance || 'N/A'}</td>
                <td>${route.estimatedDuration || 'N/A'}</td>
                <td>${route.routeType}</td>
                <td><span class="status-badge ${route.active ? 'status-active' : 'status-stopped'}">${route.active ? 'Active' : 'Inactive'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view" onclick="viewRouteDetails(${route.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn edit" onclick="editRoute(${route.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteRoute(${route.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function populateRouteSelects(routes) {
        const selects = ['busRoute', 'editBusRoute'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select a route</option>';
                routes.forEach(route => {
                    const selected = currentValue == route.id ? 'selected' : '';
                    select.innerHTML += `<option value="${route.id}" ${selected}>${route.routeName}</option>`;
                });
            }
        });
    }

    // Enhanced View Route Details
    async function viewRouteDetails(routeId) {
        try {
            const route = await fetchData(`/routes/${routeId}`);
            if (!route) {
                throw new Error('Route not found');
            }

            const content = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Route ID</div>
                        <div class="detail-value">${route.id}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Route Code</div>
                        <div class="detail-value">${route.routeCode}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Route Name</div>
                        <div class="detail-value">${route.routeName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Route Type</div>
                        <div class="detail-value">${route.routeType}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Distance</div>
                        <div class="detail-value">${route.totalDistance || 'N/A'} km</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Duration</div>
                        <div class="detail-value">${route.estimatedDuration || 'N/A'} min</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <span class="status-badge ${route.active ? 'status-active' : 'status-stopped'}">
                                ${route.active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Color</div>
                        <div class="detail-value">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 20px; height: 20px; background: ${route.color || '#1E40AF'}; border-radius: 4px; border: 1px solid #ccc;"></div>
                                ${route.color || '#1E40AF'}
                            </div>
                        </div>
                    </div>
                </div>

                ${route.description ? `
                    <div style="margin-top: 2rem;">
                        <h4>Description</h4>
                        <p style="background: var(--gray-light); padding: 1rem; border-radius: var(--border-radius); margin-top: 1rem;">
                            ${route.description}
                        </p>
                    </div>
                ` : ''}

                <div style="margin-top: 2rem;">
                    <h4>Route Statistics</h4>
                    <div class="detail-grid" style="margin-top: 1rem;">
                        <div class="detail-item">
                            <div class="detail-label">Created</div>
                            <div class="detail-value">${route.createdAt ? new Date(route.createdAt).toLocaleDateString() : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Start Station</div>
                            <div class="detail-value">${route.startStation || 'Gare Centrale'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">End Station</div>
                            <div class="detail-value">${route.endStation || 'Terminal'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Assigned Buses</div>
                            <div class="detail-value">${route.assignedBuses || 0}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('viewRouteContent').innerHTML = content;
            openModal('viewRouteModal');

        } catch (error) {
            console.error('Error loading route details:', error);
            showNotification('Error loading route details: ' + error.message, 'error');
        }
    }

    // Enhanced Edit Route
    async function editRoute(routeId) {
        try {
            const route = await fetchData(`/routes/${routeId}`);
            if (!route) {
                throw new Error('Route not found');
            }

            // Populate edit form
            document.getElementById('editRouteId').value = route.id;
            document.getElementById('editRouteCode').value = route.routeCode;
            document.getElementById('editRouteName').value = route.routeName;
            document.getElementById('editRouteDescription').value = route.description || '';
            document.getElementById('editRouteDistance').value = route.totalDistance || '';
            document.getElementById('editRouteDuration').value = route.estimatedDuration || '';
            document.getElementById('editRouteType').value = route.routeType;
            document.getElementById('editRouteColor').value = route.color || '#1E40AF';

            openModal('editRouteModal');
        } catch (error) {
            console.error('Error loading route for edit:', error);
            showNotification('Error loading route details: ' + error.message, 'error');
        }
    }

    async function handleAddRoute(e) {
        e.preventDefault();

        const formData = {
            routeCode: document.getElementById('routeCode').value,
            routeName: document.getElementById('routeName').value,
            description: document.getElementById('routeDescription').value,
            totalDistance: parseFloat(document.getElementById('routeDistance').value),
            estimatedDuration: parseInt(document.getElementById('routeDuration').value),
            routeType: document.getElementById('routeType').value,
            color: document.getElementById('routeColor').value,
            active: true
        };

        try {
            await postData('/routes', formData);
            closeModal('addRouteModal');
            showNotification('Route added successfully!', 'success');
            loadRoutes();
            document.getElementById('addRouteForm').reset();
        } catch (error) {
            console.error('Error adding route:', error);
            showNotification('Error adding route: ' + error.message, 'error');
        }
    }



    // Add these functions near the top of your script section
    function showLoader() {
        const loader = document.createElement('div');
        loader.id = 'formLoader';
        loader.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
        loader.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 8px; display: flex; flex-direction: column; align-items: center;">
            <div class="loading" style="width: 40px; height: 40px; border-width: 4px;"></div>
            <p style="margin-top: 1rem;">Processing, please wait...</p>
        </div>
    `;
        document.body.appendChild(loader);
    }

    function hideLoader() {
        const loader = document.getElementById('formLoader');
        if (loader) {
            loader.remove();
        }
    }




    async function handleEditRoute(e) {
        e.preventDefault();

        const routeId = document.getElementById('editRouteId').value;
        const formData = {
            routeCode: document.getElementById('editRouteCode').value,
            routeName: document.getElementById('editRouteName').value,
            description: document.getElementById('editRouteDescription').value,
            totalDistance: parseFloat(document.getElementById('editRouteDistance').value),
            estimatedDuration: parseInt(document.getElementById('editRouteDuration').value),
            routeType: document.getElementById('editRouteType').value,
            color: document.getElementById('editRouteColor').value
        };

        try {
            await putData(`/routes/${routeId}`, formData);
            closeModal('editRouteModal');
            showNotification('Route updated successfully!', 'success');
            loadRoutes();
        } catch (error) {
            console.error('Error updating route:', error);
            showNotification('Error updating route: ' + error.message, 'error');
        }
    }






    // Fonction pour créer les routes prédéfinies de Kinshasa
    async function createKinshasaRoutes() {
        try {
            const response = await fetch('/api/routes/kinshasa/predefined', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const result = await response.json(); // Maintenant on attend du JSON
                showNotification(result.message + ` (${result.generatedRoutes} nouvelles routes générées)`, 'success');
                loadRoutes(); // Recharger la liste des routes

                // Optionnel: Afficher les détails des routes générées
                if (result.routes && result.routes.length > 0) {
                    console.log('Routes générées:', result.routes);
                }
            } else {
                const errorResult = await response.json();
                showNotification('Erreur: ' + errorResult.message, 'error');
            }
        } catch (error) {
            console.error('Error creating Kinshasa routes:', error);
            showNotification('Erreur lors de la création des routes de Kinshasa: ' + error.message, 'error');
        }
    }

    // Nouvelle fonction pour générer des routes aléatoires
    async function generateRandomRoutes(count = 4) {
        try {
            const response = await fetch(`/api/routes/generate?count=${count}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(result.message, 'success');
                loadRoutes(); // Recharger la liste des routes

                // Afficher les détails des routes générées dans la console
                if (result.routes && result.routes.length > 0) {
                    console.log('Nouvelles routes générées:', result.routes);

                    // Optionnel: Afficher un résumé des routes générées
                    const routeNames = result.routes.map(route => route.routeName).join(', ');
                    showNotification(`Routes générées: ${routeNames}`, 'info', 5000);
                }
            } else {
                const errorResult = await response.json();
                showNotification('Erreur: ' + errorResult.message, 'error');
            }
        } catch (error) {
            console.error('Error generating routes:', error);
            showNotification('Erreur lors de la génération des routes: ' + error.message, 'error');
        }
    }

    // Fonction pour afficher les notifications (si elle n'existe pas déjà)
    function showNotification(message, type = 'info', duration = 3000) {
        // Créer l'élément de notification s'il n'existe pas
        let notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) {
            notificationContainer = document.createElement('div');
            notificationContainer.id = 'notification-container';
            notificationContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
            document.body.appendChild(notificationContainer);
        }

        // Créer la notification
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
        padding: 12px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateX(100%);
    `;

        // Définir les couleurs selon le type
        const colors = {
            success: '#10B981',
            error: '#EF4444',
            warning: '#F59E0B',
            info: '#3B82F6'
        };
        notification.style.backgroundColor = colors[type] || colors.info;

        notification.textContent = message;
        notificationContainer.appendChild(notification);

        // Animation d'entrée
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
        }, 10);

        // Supprimer la notification après la durée spécifiée
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, duration);
    }






    async function deleteRoute(routeId) {
        if (!confirm('Are you sure you want to delete this route? This action cannot be undone.')) {
            return;
        }

        try {
            await deleteData(`/routes/${routeId}`);
            showNotification('Route deleted successfully!', 'success');
            loadRoutes();
        } catch (error) {
            console.error('Error deleting route:', error);
            showNotification('Error deleting route: ' + error.message, 'error');
        }
    }



    async function loadDrivers() {
        try {
            const drivers = await fetchData('/staff?role=DRIVER');
            displayDrivers(drivers);
            populateDriverSelects(drivers);
        } catch (error) {
            console.error('Error loading drivers:', error);
            document.getElementById('driversTableBody').innerHTML =
                '<tr><td colspan="7" style="text-align: center; color: var(--secondary-red);">Error loading drivers</td></tr>';
        }
    }




    function displayDrivers(drivers) {
        const tbody = document.getElementById('driversTableBody');
        if (drivers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray-medium);">No drivers found</td></tr>';
            return;
        }

        tbody.innerHTML = drivers.map(driver => `
        <tr>
            <td>${driver.id}</td>
            <td>${driver.firstName} ${driver.lastName}</td>
            <td>${driver.email}</td>
            <td>${driver.phoneNumber || 'N/A'}</td>
            <td>${driver.assignedBus || 'Not assigned'}</td>
            <td><span class="status-badge ${driver.active ? 'status-active' : 'status-stopped'}">${driver.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn view" onclick="viewDriverDetails(${driver.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn edit" onclick="editDriver(${driver.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" onclick="deleteDriver(${driver.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    }




    function populateDriverSelects(drivers) {
        const select = document.getElementById('busDriver');
        if (select) {
            select.innerHTML = '<option value="">Select a driver</option>';
            drivers.filter(driver => driver.role === 'DRIVER').forEach(driver => {
                select.innerHTML += `<option value="${driver.id}">${driver.firstName} ${driver.lastName}</option>`;
            });
        }
    }




    async function viewDriverDetails(driverId) {
        try {
            const driver = await fetchData(`/staff/${driverId}`);
            if (!driver) {
                throw new Error('Driver not found');
            }

            const content = `
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Driver ID</div>
                    <div class="detail-value">${driver.id}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Full Name</div>
                    <div class="detail-value">${driver.firstName} ${driver.lastName}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${driver.email}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone Number</div>
                    <div class="detail-value">${driver.phoneNumber || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Role</div>
                    <div class="detail-value">${driver.role}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge ${driver.active ? 'status-active' : 'status-stopped'}">
                            ${driver.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Joined Date</div>
                    <div class="detail-value">${driver.createdAt ? new Date(driver.createdAt).toLocaleDateString() : 'N/A'}</div>
                </div>
            </div>

            ${driver.photo ? `
                <div style="margin-top: 2rem;">
                    <h4>Photo</h4>
                    <img src="data:image/jpeg;base64,${driver.photo}" style="max-width: 200px; border-radius: 8px;"/>
                </div>
            ` : ''}
        `;

            document.getElementById('viewDriverContent').innerHTML = content;
            openModal('viewDriverModal');

        } catch (error) {
            console.error('Error loading driver details:', error);
            showNotification('Error loading driver details: ' + error.message, 'error');
        }
    }




    // Enhanced Edit Driver
    async function editDriver(driverId) {
        try {
            const driver = await fetchData(`/staff/${driverId}`);
            if (!driver) {
                throw new Error('Driver not found');
            }

            // Populate edit form
            document.getElementById('editDriverId').value = driver.id;
            document.getElementById('editDriverFirstName').value = driver.firstName;
            document.getElementById('editDriverLastName').value = driver.lastName;
            document.getElementById('editDriverEmail').value = driver.email;
            document.getElementById('editDriverPhone').value = driver.phoneNumber || '';
            document.getElementById('editDriverLicense').value = driver.licenseNumber || '';
            document.getElementById('editDriverExperience').value = driver.experience || 0;

            openModal('editDriverModal');
        } catch (error) {
            console.error('Error loading driver for edit:', error);
            showNotification('Error loading driver details: ' + error.message, 'error');
        }
    }




    async function handleAddDriver(e) {
        e.preventDefault();

        // Create FormData object since your controller expects multipart/form-data
        const formData = new FormData();

        // Add required fields that match your Staff model
        formData.append('firstName', document.getElementById('driverFirstName').value);
        formData.append('lastName', document.getElementById('driverLastName').value);
        formData.append('email', document.getElementById('driverEmail').value);
        formData.append('phoneNumber', document.getElementById('driverPhone').value);
        formData.append('role', 'DRIVER');  // Must match StaffRole enum
        formData.append('password', generateTempPassword()); // Generate temporary password

        // Note: licenseNumber and experience are not part of your Staff model
        // You might want to store these in the phone number field or create a separate Driver entity

        try {
            const response = await fetch('/api/staff', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}` // Add auth header if needed
                },
                body: formData // Send as FormData, not JSON
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to add driver');
            }

            const result = await response.json();

            closeModal('addDriverModal');
            showNotification('Driver added successfully!', 'success');
            loadDrivers();
            document.getElementById('addDriverForm').reset();

        } catch (error) {
            console.error('Error adding driver:', error);
            showNotification('Error adding driver: ' + error.message, 'error');
        }
    }
    function generateTempPassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let password = '';
        for (let i = 0; i < 12; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return password;
    }



    async function handleEditDriver(e) {
        e.preventDefault();

        const driverId = document.getElementById('editDriverId').value;
        const formData = {
            firstName: document.getElementById('editDriverFirstName').value,
            lastName: document.getElementById('editDriverLastName').value,
            email: document.getElementById('editDriverEmail').value,
            phoneNumber: document.getElementById('editDriverPhone').value,
            licenseNumber: document.getElementById('editDriverLicense').value,
            experience: parseInt(document.getElementById('editDriverExperience').value)
        };

        try {
            await putData(`/staff/${driverId}`, formData);
            closeModal('editDriverModal');
            showNotification('Driver updated successfully!', 'success');
            loadDrivers();
        } catch (error) {
            console.error('Error updating driver:', error);
            showNotification('Error updating driver: ' + error.message, 'error');
        }
    }

    async function deleteDriver(driverId) {
        if (!confirm('Are you sure you want to delete this driver? This action cannot be undone.')) {
            return;
        }

        try {
            await deleteData(`/staff/${driverId}`);
            showNotification('Driver deleted successfully!', 'success');
            loadDrivers();
        } catch (error) {
            console.error('Error deleting driver:', error);
            showNotification('Error deleting driver: ' + error.message, 'error');
        }
    }

    // Enhanced Reports functions with TABLE FORMATTING for PDFs
    async function loadReports() {
        try {
            const [tickets, buses, drivers, routes] = await Promise.all([
                fetchData('/tickets'),
                fetchData('/buses'),
                fetchData('/staff?role=DRIVER'),
                fetchData('/routes')
            ]);

            // Calculate today's revenue
            const today = new Date().toDateString();
            const todayTickets = tickets.filter(ticket => {
                const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                return ticketDate.toDateString() === today;
            });
            const todayRevenue = todayTickets.reduce((sum, ticket) => {
                return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
            }, 0);

            // Calculate monthly revenue
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthlyTickets = tickets.filter(ticket => {
                const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                return ticketDate.getMonth() === thisMonth && ticketDate.getFullYear() === thisYear;
            });
            const monthlyRevenue = monthlyTickets.reduce((sum, ticket) => {
                return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
            }, 0);

            document.getElementById('todayRevenue').textContent = `${todayRevenue.toLocaleString()} FC`;
            document.getElementById('monthlyRevenue').textContent = `${monthlyRevenue.toLocaleString()} FC`;

            createAnalyticsChart(tickets);
        } catch (error) {
            console.error('Error loading reports:', error);
        }
    }

    function createAnalyticsChart(tickets) {
        const ctx = document.getElementById('revenueAnalyticsChart');
        if (!ctx) return;

        if (charts.analytics) {
            charts.analytics.destroy();
        }

        const months = [];
        const revenues = [];
        const ticketCounts = [];
        const today = new Date();

        for (let i = 11; i >= 0; i--) {
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            months.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));

            const monthTickets = tickets.filter(ticket => {
                const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
                return ticketDate.getMonth() === date.getMonth() &&
                    ticketDate.getFullYear() === date.getFullYear();
            });

            const monthRevenue = monthTickets.reduce((sum, ticket) => {
                return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
            }, 0);

            revenues.push(monthRevenue);
            ticketCounts.push(monthTickets.length);
        }

        charts.analytics = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Revenue (FC)',
                    data: revenues,
                    borderColor: '#1E40AF',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4
                }, {
                    label: 'Tickets Sold',
                    data: ticketCounts,
                    borderColor: '#DC2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' FC';
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        }
                    }
                }
            }
        });
    }

    // **ENHANCED PDF REPORT GENERATION WITH TABLES**
    async function generateReport(type) {
        try {
            showNotification(`Generating ${type} report with table formatting...`, 'info');

            const [buses, tickets, drivers, routes] = await Promise.all([
                fetchData('/buses'),
                fetchData('/tickets'),
                fetchData('/staff?role=DRIVER'),
                fetchData('/routes')
            ]);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Enhanced header
            doc.setFillColor(30, 64, 175);
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text('IMAS', 20, 25);

            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text('Intelligent Mobility Assistance System', 20, 35);

            // Report title
            doc.setTextColor(30, 64, 175);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(`${type.charAt(0).toUpperCase() + type.slice(1)} Report`, 20, 60);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 70);
            doc.text(`Report Period: ${getReportPeriod(type)}`, 20, 75);

            let yPosition = 90;

            // **TABLE 1: SYSTEM OVERVIEW**
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('System Overview', 20, yPosition);
            yPosition += 10;

            // Create overview table
            const overviewData = [
                ['Metric', 'Count', 'Status'],
                ['Total Buses', buses.length.toString(), `${buses.filter(b => !b.isStopped).length} Active`],
                ['Total Tickets', tickets.length.toString(), `${tickets.filter(t => t.status === 'PAID').length} Paid`],
                ['Active Drivers', drivers.filter(d => d.active).length.toString(), `${drivers.length} Total`],
                ['Active Routes', routes.filter(r => r.active).length.toString(), `${routes.length} Total`]
            ];

            drawTable(doc, overviewData, 20, yPosition, [60, 40, 60]);
            yPosition += (overviewData.length * 8) + 20;

            // **TABLE 2: BUS PERFORMANCE**
            if (yPosition > 220) {
                doc.addPage();
                yPosition = 30;
            }

            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Bus Performance Details', 20, yPosition);
            yPosition += 10;

            const busData = [
                ['Bus ID', 'Name', 'Line', 'Status', 'Progress', 'Passengers']
            ];

            buses.slice(0, 10).forEach(bus => {
                busData.push([
                    bus.id.toString(),
                    bus.name,
                    bus.busLine,
                    bus.hasAccident ? 'Accident' : (bus.isStopped ? 'Stopped' : 'Active'),
                    `${Math.round(bus.progress || 0)}%`,
                    `${bus.passengers || 0}/${bus.capacity}`
                ]);
            });

            drawTable(doc, busData, 20, yPosition, [20, 30, 25, 25, 25, 35]);
            yPosition += (busData.length * 8) + 20;

            // **TABLE 3: REVENUE BREAKDOWN**
            if (yPosition > 200) {
                doc.addPage();
                yPosition = 30;
            }

            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Revenue Breakdown by Route', 20, yPosition);
            yPosition += 10;

            const revenueData = [
                ['Route', 'Tickets Sold', 'Revenue (FC)', 'Avg. Price']
            ];

            routes.slice(0, 8).forEach(route => {
                const routeTickets = tickets.filter(t => t.bus && t.bus.route && t.bus.route.id === route.id);
                const routeRevenue = routeTickets.reduce((sum, t) =>
                    sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0);
                const avgPrice = routeTickets.length > 0 ? (routeRevenue / routeTickets.length) : 0;

                revenueData.push([
                    route.routeName,
                    routeTickets.length.toString(),
                    routeRevenue.toLocaleString(),
                    Math.round(avgPrice).toLocaleString()
                ]);
            });

            drawTable(doc, revenueData, 20, yPosition, [50, 25, 35, 30]);
            yPosition += (revenueData.length * 8) + 20;

            // **TABLE 4: DRIVER SUMMARY**
            if (yPosition > 180) {
                doc.addPage();
                yPosition = 30;
            }

            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Driver Summary', 20, yPosition);
            yPosition += 10;

            const driverData = [
                ['Driver ID', 'Name', 'Experience', 'Status', 'Assigned Bus']
            ];

            drivers.slice(0, 8).forEach(driver => {
                const assignedBus = buses.find(b => b.driver && b.driver.id === driver.id);
                driverData.push([
                    driver.id.toString(),
                    `${driver.firstName} ${driver.lastName}`,
                    `${driver.experience || 0} years`,
                    driver.active ? 'Active' : 'Inactive',
                    assignedBus ? assignedBus.name : 'None'
                ]);
            });

            drawTable(doc, driverData, 20, yPosition, [20, 40, 25, 25, 30]);

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('This report was automatically generated by IMAS', 20, 280);
            doc.text(`Page 1 of 1 - ${type.toUpperCase()} Report`, 150, 280);

            doc.save(`IMAS_${type}_report_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} report with tables generated successfully!`, 'success');

        } catch (error) {
            console.error('Error generating report:', error);
            showNotification('Error generating report: ' + error.message, 'error');
        }
    }

    // **TABLE DRAWING FUNCTION FOR PDFs**
    function drawTable(doc, data, x, y, columnWidths) {
        const rowHeight = 8;
        const cellPadding = 2;

        data.forEach((row, rowIndex) => {
            let currentX = x;

            row.forEach((cell, colIndex) => {
                const cellWidth = columnWidths[colIndex] || 30;

                // Draw cell border
                doc.rect(currentX, y + (rowIndex * rowHeight), cellWidth, rowHeight);

                // Fill header row
                if (rowIndex === 0) {
                    doc.setFillColor(240, 240, 240);
                    doc.rect(currentX, y + (rowIndex * rowHeight), cellWidth, rowHeight, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                } else {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                }

                // Add cell text
                doc.text(
                    cell.toString(),
                    currentX + cellPadding,
                    y + (rowIndex * rowHeight) + rowHeight - cellPadding
                );

                currentX += cellWidth;
            });
        });
    }

    // Enhanced detailed report generation with tables
    async function generateDetailedReport() {
        try {
            showNotification('Generating comprehensive detailed report with tables...', 'info');

            const [buses, tickets, drivers, routes] = await Promise.all([
                fetchData('/buses'),
                fetchData('/tickets'),
                fetchData('/staff?role=DRIVER'),
                fetchData('/routes')
            ]);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cover page
            doc.setFillColor(30, 64, 175);
            doc.rect(0, 0, 210, 297, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(36);
            doc.setFont('helvetica', 'bold');
            doc.text('IMAS', 105, 100, { align: 'center' });

            doc.setFontSize(24);
            doc.text('Comprehensive System Report', 105, 120, { align: 'center' });

            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.text('Detailed Analysis with Complete Data Tables', 105, 140, { align: 'center' });

            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 200, { align: 'center' });
            doc.text('Kinshasa, Democratic Republic of Congo', 105, 220, { align: 'center' });

            // Page 2 - Complete Bus Table
            doc.addPage();
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Complete Bus Inventory', 20, 30);

            let yPos = 45;
            const busTableData = [
                ['ID', 'Name', 'Line', 'Capacity', 'Driver', 'Route', 'Status', 'Progress']
            ];

            buses.forEach(bus => {
                busTableData.push([
                    bus.id.toString(),
                    bus.name,
                    bus.busLine,
                    bus.capacity.toString(),
                    bus.driver ? `${bus.driver.firstName} ${bus.driver.lastName}` : 'None',
                    bus.route ? bus.route.routeName : 'None',
                    bus.hasAccident ? 'Accident' : (bus.isStopped ? 'Stopped' : 'Active'),
                    `${Math.round(bus.progress || 0)}%`
                ]);
            });

            drawTable(doc, busTableData, 10, yPos, [15, 25, 20, 20, 30, 30, 20, 20]);

            // Page 3 - Complete Route Table
            doc.addPage();
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Complete Route Directory', 20, 30);

            yPos = 45;
            const routeTableData = [
                ['ID', 'Code', 'Name', 'Distance', 'Duration', 'Type', 'Status']
            ];

            routes.forEach(route => {
                routeTableData.push([
                    route.id.toString(),
                    route.routeCode,
                    route.routeName,
                    `${route.totalDistance || 'N/A'} km`,
                    `${route.estimatedDuration || 'N/A'} min`,
                    route.routeType,
                    route.active ? 'Active' : 'Inactive'
                ]);
            });

            drawTable(doc, routeTableData, 15, yPos, [15, 25, 40, 25, 25, 25, 25]);

            // Page 4 - Complete Driver Table
            doc.addPage();
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Complete Driver Directory', 20, 30);

            yPos = 45;
            const driverTableData = [
                ['ID', 'Name', 'Email', 'Phone', 'License', 'Experience', 'Status']
            ];

            drivers.forEach(driver => {
                driverTableData.push([
                    driver.id.toString(),
                    `${driver.firstName} ${driver.lastName}`,
                    driver.email,
                    driver.phoneNumber || 'N/A',
                    driver.licenseNumber || 'N/A',
                    `${driver.experience || 0} years`,
                    driver.active ? 'Active' : 'Inactive'
                ]);
            });

            drawTable(doc, driverTableData, 10, yPos, [15, 35, 40, 25, 25, 20, 20]);

            // Page 5 - Ticket Summary Table
            doc.addPage();
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Ticket Sales Summary', 20, 30);

            yPos = 45;
            const ticketSummaryData = [
                ['Status', 'Count', 'Total Revenue (FC)', 'Average Price (FC)']
            ];

            const ticketStatuses = ['PAID', 'PENDING', 'BOARDED'];
            ticketStatuses.forEach(status => {
                const statusTickets = tickets.filter(t => t.status === status);
                const totalRevenue = statusTickets.reduce((sum, t) =>
                    sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0);
                const avgPrice = statusTickets.length > 0 ? (totalRevenue / statusTickets.length) : 0;

                ticketSummaryData.push([
                    status,
                    statusTickets.length.toString(),
                    totalRevenue.toLocaleString(),
                    Math.round(avgPrice).toLocaleString()
                ]);
            });

            drawTable(doc, ticketSummaryData, 30, yPos, [40, 30, 50, 50]);

            doc.save(`IMAS_detailed_report_with_tables_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Comprehensive detailed report with complete tables generated successfully!', 'success');

        } catch (error) {
            console.error('Error generating detailed report:', error);
            showNotification('Error generating detailed report: ' + error.message, 'error');
        }
    }

    // Enhanced Excel export
    async function exportToExcel() {
        try {
            showNotification('Generating Excel export...', 'info');

            const [buses, tickets, drivers, routes] = await Promise.all([
                fetchData('/buses'),
                fetchData('/tickets'),
                fetchData('/staff?role=DRIVER'),
                fetchData('/routes')
            ]);

            const workbook = XLSX.utils.book_new();

            // Buses worksheet
            const busesData = buses.map(bus => ({
                'Bus ID': bus.id,
                'Name': bus.name,
                'Line': bus.busLine,
                'Capacity': bus.capacity,
                'Current Passengers': bus.passengers || 0,
                'Driver': bus.driver ? `${bus.driver.firstName} ${bus.driver.lastName}` : 'Not assigned',
                'Route': bus.route ? bus.route.routeName : 'Not assigned',
                'Status': bus.hasAccident ? 'Accident' : (bus.isStopped ? 'Stopped' : 'Active'),
                'Progress (%)': Math.round(bus.progress || 0),
                'Current Speed (km/h)': bus.currentSpeed || 0,
                'Departure Time': bus.departureTime ? new Date(bus.departureTime).toLocaleString() : 'Not set',
                'Current Latitude': bus.currentLat || 'N/A',
                'Current Longitude': bus.currentLng || 'N/A',
                'ETA': bus.estimatedArrival || 'N/A'
            }));

            const busesWs = XLSX.utils.json_to_sheet(busesData);
            XLSX.utils.book_append_sheet(workbook, busesWs, 'Buses');

            // Tickets worksheet
            const ticketsData = tickets.map(ticket => ({
                'Ticket Number': ticket.ticketNumber,
                'Passenger': `${ticket.firstName} ${ticket.lastName}`,
                'Bus': ticket.bus ? ticket.bus.name : 'N/A',
                'Route': `${ticket.origin} → ${ticket.destination}`,
                'Seat Number': ticket.seatNumber || 'Not assigned',
                'Price (FC)': calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage),
                'Has Luggage': ticket.hasLuggage ? 'Yes' : 'No',
                'Luggage Weight (kg)': ticket.luggageWeight || 0,
                'Status': ticket.status,
                'Issue Date': new Date(ticket.issuedAt || ticket.createdAt).toLocaleString(),
                'Departure Time': ticket.departureTime ? new Date(ticket.departureTime).toLocaleString() : 'N/A',
                'Boarding Time': ticket.boardingTime ? new Date(ticket.boardingTime).toLocaleString() : 'N/A'
            }));

            const ticketsWs = XLSX.utils.json_to_sheet(ticketsData);
            XLSX.utils.book_append_sheet(workbook, ticketsWs, 'Tickets');

            // Routes worksheet
            const routesData = routes.map(route => ({
                'Route ID': route.id,
                'Code': route.routeCode,
                'Name': route.routeName,
                'Description': route.description || 'N/A',
                'Type': route.routeType,
                'Distance (km)': route.totalDistance || 'N/A',
                'Duration (min)': route.estimatedDuration || 'N/A',
                'Color': route.color || '#1E40AF',
                'Status': route.active ? 'Active' : 'Inactive',
                'Created Date': route.createdAt ? new Date(route.createdAt).toLocaleDateString() : 'N/A',
                'Start Station': route.startStation || 'Gare Centrale',
                'End Station': route.endStation || 'Terminal'
            }));

            const routesWs = XLSX.utils.json_to_sheet(routesData);
            XLSX.utils.book_append_sheet(workbook, routesWs, 'Routes');

            // Drivers worksheet
            const driversData = drivers.map(driver => ({
                'Driver ID': driver.id,
                'First Name': driver.firstName,
                'Last Name': driver.lastName,
                'Email': driver.email,
                'Phone Number': driver.phoneNumber || 'N/A',
                'License Number': driver.licenseNumber || 'N/A',
                'Experience (years)': driver.experience || 0,
                'Role': driver.role,
                'Status': driver.active ? 'Active' : 'Inactive',
                'Joined Date': driver.createdAt ? new Date(driver.createdAt).toLocaleDateString() : 'N/A',
                'Assigned Bus': 'To be determined'
            }));

            const driversWs = XLSX.utils.json_to_sheet(driversData);
            XLSX.utils.book_append_sheet(workbook, driversWs, 'Drivers');

            // Summary worksheet
            const totalRevenue = tickets.reduce((sum, t) =>
                sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0);
            const activeBuses = buses.filter(b => !b.isStopped && !b.hasAccident).length;

            const summaryData = [
                { 'Metric': 'Total Buses', 'Value': buses.length },
                { 'Metric': 'Active Buses', 'Value': activeBuses },
                { 'Metric': 'Total Tickets Sold', 'Value': tickets.length },
                { 'Metric': 'Total Revenue (FC)', 'Value': totalRevenue },
                { 'Metric': 'Active Drivers', 'Value': drivers.filter(d => d.active).length },
                { 'Metric': 'Total Routes', 'Value': routes.length },
                { 'Metric': 'Active Routes', 'Value': routes.filter(r => r.active).length },
                { 'Metric': 'Report Generated', 'Value': new Date().toLocaleString() }
            ];

            const summaryWs = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, summaryWs, 'Summary');

            // Write and download
            XLSX.writeFile(workbook, `IMAS_complete_data_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Excel export completed successfully!', 'success');

        } catch (error) {
            console.error('Error exporting to Excel:', error);
            showNotification('Error exporting to Excel: ' + error.message, 'error');
        }
    }

    function getReportPeriod(type) {
        const today = new Date();
        switch(type) {
            case 'daily':
                return today.toLocaleDateString();
            case 'weekly':
                const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
                return `${weekStart.toLocaleDateString()} - ${new Date().toLocaleDateString()}`;
            case 'monthly':
                return `${today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            case 'yearly':
                return today.getFullYear().toString();
            default:
                return 'All Time';
        }
    }

    // Settings functions
    async function handleSaveSettings(e) {
        e.preventDefault();

        const settings = {
            basePrice: parseInt(document.getElementById('basePrice').value),
            luggagePrice: parseInt(document.getElementById('luggagePrice').value),
            stationWaitTime: parseInt(document.getElementById('stationWaitTime').value),
            startBuffer: parseInt(document.getElementById('startBuffer').value)
        };

        localStorage.setItem('imasSettings', JSON.stringify(settings));
        showNotification('Settings saved successfully!', 'success');
    }



    async function startAdvancedQRScanner() {
        try {
            // Initialiser le scanner
            const initialized = await initializeAdvancedQRScanner();
            if (!initialized) return;

            // Éléments UI
            const video = document.getElementById('qrVideo');
            const overlay = document.getElementById('qrOverlay');
            const resultDiv = document.getElementById('qrResult');
            const startBtn = document.getElementById('startScannerBtn');
            const stopBtn = document.getElementById('stopScannerBtn');

            // Afficher les éléments de scan
            video.classList.remove('hidden');
            overlay.classList.remove('hidden');
            stopBtn.classList.remove('hidden');
            startBtn.classList.add('hidden');
            resultDiv.classList.add('hidden');

            // Configurer la caméra
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { min: 640, ideal: 1280, max: 1920 },
                    height: { min: 480, ideal: 720, max: 1080 }
                }
            };

            // Démarrer le flux vidéo
            videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = videoStream;
            video.setAttribute('playsinline', 'true');
            await video.play();

            // Créer un canvas pour le traitement
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d', { willReadFrequently: true });

            // Fonction de scan
            const scanFrame = () => {
                if (!isScanning) return;

                try {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);

                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: 'dontInvert'
                        });

                        if (code) {
                            isScanning = false;
                            processDetectedQR(code.data, resultDiv);
                            return;
                        }
                    }
                    requestAnimationFrame(scanFrame);
                } catch (error) {
                    console.error('Scan error:', error);
                    stopAdvancedQRScanner();
                    showNotification('Scanning error: ' + error.message, 'error');
                }
            };

            isScanning = true;
            requestAnimationFrame(scanFrame);
            showNotification('QR Scanner ready! Point camera at QR code', 'success');

        } catch (error) {
            console.error('Error starting scanner:', error);
            showNotification('Error starting scanner: ' + error.message, 'error');
            stopAdvancedQRScanner();
        }
    }

    // Enhanced QR code processing
    async function processDetectedQR(qrData, resultDiv) {
        try {
            stopAdvancedQRScanner();

            resultDiv.classList.remove('hidden');
            resultDiv.className = 'qr-result';
            resultDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Processing QR code...</p>';

            // Validate QR data format
            if (!qrData || typeof qrData !== 'string' || qrData.trim() === '') {
                throw new Error('Invalid or empty QR code data');
            }

            // Parse ticket ID and number from QR data
            let ticketId, ticketNumber;

            // Support multiple QR formats
            if (qrData.includes('IMAS_TICKET')) {
                // Format: "IMAS_TICKET:TK123456"
                const parts = qrData.split(':');
                if (parts.length < 2) throw new Error('Invalid IMAS QR code format');
                ticketNumber = parts[1].trim();

                // Lookup ticket by number
                const ticket = await fetchData(`/tickets/number/${ticketNumber}`);
                if (!ticket) throw new Error('Ticket not found: ' + ticketNumber);
                ticketId = ticket.id;
                qrData = `${ticketId}-${ticketNumber}`;
            } else if (qrData.match(/^\d+-[A-Z0-9]+$/)) {
                // Format: "123-TK123456"
                const parts = qrData.split('-');
                ticketId = parts[0].trim();
                ticketNumber = parts[1].trim();
            } else {
                throw new Error('Invalid QR code format. Expected: ID-TICKET_NUMBER or IMAS_TICKET:TICKET_NUMBER');
            }

            // Validate parsed data
            if (!ticketId || isNaN(parseInt(ticketId))) {
                throw new Error('Invalid ticket ID in QR code');
            }
            if (!ticketNumber || ticketNumber.trim() === '') {
                throw new Error('Invalid ticket number in QR code');
            }

            // Verify ticket with backend
            const response = await fetch(`${API_BASE}/tickets/scan-qr`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                },
                body: JSON.stringify({
                    qrData: `${ticketId}-${ticketNumber}`,
                    scanTime: new Date().toISOString()
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || 'Failed to verify QR code');
            }

            const result = await response.json();
            displayQRResult(result, resultDiv);

            // Refresh tickets list if on tickets page
            if (typeof loadTickets === 'function') {
                await loadTickets();
            }

        } catch (error) {
            console.error('Error processing QR code:', error);
            displayQRError(error.message, qrData, resultDiv);
        }
    }

    function displayQRResult(result, resultDiv) {
        resultDiv.className = `qr-result ${result.valid ? 'success' : 'error'}`;

        if (result.valid) {
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <h4 style="color: var(--green); margin-bottom: 1rem;">
                        <i class="fas fa-check-circle"></i> Valid Ticket
                    </h4>
                    <div style="background: rgba(16,185,129,0.05); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p><strong>Passenger:</strong> ${result.passenger || 'N/A'}</p>
                        <p><strong>Ticket #:</strong> ${result.ticketNumber || 'N/A'}</p>
                        <p><strong>Bus:</strong> ${result.bus || 'N/A'}</p>
                        <p><strong>Route:</strong> ${result.origin || 'N/A'} → ${result.destination || 'N/A'}</p>
                        <p><strong>Seat:</strong> ${result.seatNumber || 'Not assigned'}</p>
                        <p><strong>Status:</strong> <span style="color: var(--green); font-weight: bold;">BOARDED</span></p>
                        <p><strong>Boarding Time:</strong> ${result.boardingTime ? new Date(result.boardingTime).toLocaleString() : new Date().toLocaleString()}</p>
                    </div>
                </div>
            `;
            showNotification(`${result.passenger} successfully boarded!`, 'success');
        } else {
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <h4 style="color: var(--secondary-red); margin-bottom: 1rem;">
                        <i class="fas fa-times-circle"></i> ${result.message || 'Invalid Ticket'}
                    </h4>
                    <div style="background: rgba(220,38,38,0.05); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        ${result.ticketNumber ? `<p><strong>Ticket #:</strong> ${result.ticketNumber}</p>` : ''}
                        ${result.passenger ? `<p><strong>Passenger:</strong> ${result.passenger}</p>` : ''}
                        ${result.status ? `<p><strong>Current Status:</strong> ${result.status}</p>` : ''}
                    </div>
                </div>
            `;
            showNotification(result.message || 'Invalid ticket scanned', 'error');
        }
    }

    function displayQRError(errorMessage, qrData, resultDiv) {
        resultDiv.classList.remove('hidden');
        resultDiv.className = 'qr-result error';
        resultDiv.innerHTML = `
            <div style="text-align: center; padding: 1rem;">
                <h4 style="color: var(--secondary-red); margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i> Scanning Error
                </h4>
                <div style="background: rgba(220,38,38,0.05); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <p><strong>Error:</strong> ${errorMessage}</p>
                    <p><strong>Scanned Data:</strong> ${qrData || 'N/A'}</p>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn" onclick="startAdvancedQRScanner()">
                        <i class="fas fa-qrcode"></i> Try Again
                    </button>
                </div>
            </div>
        `;
    }

    // Stop scanner function
    function stopAdvancedQRScanner() {
        const video = document.getElementById('qrVideo');
        const overlay = document.getElementById('qrOverlay');
        const stopBtn = document.getElementById('stopScannerBtn');
        const startBtn = document.getElementById('startScannerBtn');

        isScanning = false;

        if (scanningInterval) {
            clearInterval(scanningInterval);
            scanningInterval = null;
        }

        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }

        if (video) {
            video.srcObject = null;
            video.classList.add('hidden');
        }

        if (overlay) overlay.classList.add('hidden');
        if (stopBtn) stopBtn.classList.add('hidden');
        if (startBtn) startBtn.classList.remove('hidden');
    }

    function uploadQRImage() {
        document.getElementById('qrImageInput').click();
    }


    async function processQRImage(input) {
        const file = input.files[0];
        if (!file) return;

        try {
            showNotification('Processing QR image...', 'info');

            // Initialiser jsQR si pas déjà fait
            await initializeAdvancedQRScanner();

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                context.drawImage(img, 0, 0);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    const resultDiv = document.getElementById('qrResult');
                    processDetectedQR(code.data, resultDiv);
                } else {
                    showNotification('No QR code found in image', 'error');
                }
            };

            img.src = URL.createObjectURL(file);
        } catch (error) {
            console.error('Error processing QR image:', error);
            showNotification('Error processing image: ' + error.message, 'error');
        }
    }



    // Navigation functions
    // Replace the existing showSection function
    function showSection(sectionName, event) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });

        // Show target section
        const targetSection = document.getElementById(sectionName + '-section');
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }

        // Update active menu item
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.classList.remove('active');
        });

        if (event) {
            const clickedLink = event.target.closest('a');
            if (clickedLink) {
                clickedLink.classList.add('active');
            }
        } else {
            const targetLink = document.querySelector(`[onclick*="${sectionName}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
        }

        // Load section-specific data
        switch(sectionName) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'buses':
                loadBuses();
                break;
            case 'tickets':
                loadTickets();
                break;
            case 'routes':
                loadRoutes();
                break;
            case 'drivers':
                loadDrivers();
                break;
            case 'tracking':
                initializeMap();
                loadBusTracking();
                break;
            case 'reports':
                loadReports();
                break;
            case 'maintenance':
                // No specific data loading required for maintenance section
                break;
        }
    }

    // UI functions
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const header = document.getElementById('header');

        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
        header.classList.toggle('expanded');
    }

    function toggleTheme() {
        const body = document.body;
        const themeToggle = document.getElementById('themeToggle');
        const icon = themeToggle.querySelector('i');

        if (body.getAttribute('data-theme') === 'dark') {
            body.setAttribute('data-theme', 'light');
            icon.className = 'fas fa-moon';
            showNotification('Switched to light theme', 'success');
        } else {
            body.setAttribute('data-theme', 'dark');
            icon.className = 'fas fa-sun';
            showNotification('Switched to dark theme', 'success');
        }
    }

    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    // Enhanced notification function
    function showNotification(message, type = 'info') {
        const existingNotifications = document.querySelectorAll('.notification');
        existingNotifications.forEach(notification => notification.remove());

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;

        const colors = {
            success: '#10B981',
            error: '#DC2626',
            warning: '#F59E0B',
            info: '#3B82F6'
        };
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
            background: ${colors[type] || colors.info};
        `;

        const icons = {
            success: '✅',
            error: '❌',
            warning: '⚠️',
            info: 'ℹ️'
        };
        notification.innerHTML = `${icons[type] || icons.info} ${message}`;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('userSession');
            window.location.href = '/login.html';
        }
    }



    function getAuthToken() {
        return localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || '';
    }





    // Helper function to safely fetch data with error handling
    async function fetchData(endpoint) {
        try {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error(`Error fetching data from ${endpoint}:`, error);
            throw error;
        }
    }



    // Update your postData function to get more detailed error info
    async function postData(endpoint, data) {
        try {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                let errorMessage = `HTTP error! status: ${response.status}`;

                try {
                    const errorData = await response.json();
                    console.error('Server error response:', errorData); // Debug log
                    errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (parseError) {
                    const textError = await response.text();
                    console.error('Server error text:', textError); // Debug log
                    errorMessage = textError || errorMessage;
                }

                throw new Error(errorMessage);
            }

            return await response.json();
        } catch (error) {
            console.error('Error in postData:', error);
            throw error;
        }
    }


    async function putData(endpoint, data) {
        try {
            const response = await fetch(API_BASE + endpoint, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error in putData:', error);
            throw error;
        }
    }











    async function deleteData(endpoint) {
        try {
            const response = await fetch(API_BASE + endpoint, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                }
            });

            if (!response.ok) {
                let errorMessage = `HTTP error! status: ${response.status}`;

                try {
                    // Check content type to determine how to parse the error
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } else {
                        // Try to get as text if not JSON
                        const textError = await response.text();
                        if (textError && textError.trim()) {
                            errorMessage = textError;
                        }
                    }
                } catch (parseError) {
                    console.warn('Could not parse error response:', parseError);
                    // Keep the default error message
                }

                throw new Error(errorMessage);
            }

            // Check if response has content
            const contentType = response.headers.get('content-type');
            if (response.status === 204 || !contentType || !contentType.includes('application/json')) {
                return {}; // No content or not JSON
            }

            return await response.json();
        } catch (error) {
            console.error('Error in deleteData:', error);
            throw error;
        }
    }





    function validateBusDates(departureTime, arrivalTime) {
        const now = new Date();
        const departureDate = new Date(departureTime);
        const arrivalDate = new Date(arrivalTime);

        const departureError = document.getElementById('departureTimeError');
        const arrivalError = document.getElementById('arrivalTimeError');

        let isValid = true;

        // Reset errors
        departureError.style.display = 'none';
        arrivalError.style.display = 'none';

        // Validate departure
        if (!departureTime) {
            departureError.textContent = 'Departure time is required';
            departureError.style.display = 'block';
            document.getElementById('busDepartureTime').classList.add('error-border');
            isValid = false;
        } else if (departureDate <= now) {
            departureError.textContent = 'Departure time must be in the future';
            departureError.style.display = 'block';
            document.getElementById('busDepartureTime').classList.add('error-border');
            isValid = false;
        } else {
            document.getElementById('busDepartureTime').classList.remove('error-border');
        }

        // Validate arrival
        if (!arrivalTime) {
            arrivalError.textContent = 'Arrival time is required';
            arrivalError.style.display = 'block';
            document.getElementById('busArrivalTime').classList.add('error-border');
            isValid = false;
        } else if (arrivalDate <= departureDate) {
            arrivalError.textContent = 'Arrival time must be after departure time';
            arrivalError.style.display = 'block';
            document.getElementById('busArrivalTime').classList.add('error-border');
            isValid = false;
        } else {
            document.getElementById('busArrivalTime').classList.remove('error-border');
        }

        return isValid;
    }




    // Ajoutez ce style CSS pour les erreurs
    const style = document.createElement('style');
    style.textContent = `
    .error-border {
        border-color: var(--secondary-red) !important;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
    }
`;
    document.head.appendChild(style);


    // Filter functions
    function filterBuses() {
        const searchTerm = document.getElementById('busSearchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#busesTableBody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }


    function openStaffPage() {
        window.open('crudStaff.html', '_blank');
    }

    function filterTickets() {
        const searchTerm = document.getElementById('ticketSearchInput').value.toLowerCase();
        const statusFilter = document.getElementById('ticketStatusFilter').value;
        const rows = document.querySelectorAll('#ticketsTableBody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const statusCell = row.cells[5];
            const status = statusCell ? statusCell.textContent.trim() : '';

            const matchesSearch = text.includes(searchTerm);
            const matchesStatus = !statusFilter || status === statusFilter;

            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }

    function exportBusData() {
        showNotification('Bus data exported successfully!', 'success');
    }

    // Add CSS animations

    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);

    // Ajoutez ce code dans votre fonction initializeEventListeners()
    document.getElementById('busDepartureTime').addEventListener('change', function() {
        const arrivalTime = document.getElementById('busArrivalTime').value;
        if (arrivalTime) {
            validateBusDates(this.value, arrivalTime);
        }
    });

    document.getElementById('busArrivalTime').addEventListener('change', function() {
        const departureTime = document.getElementById('busDepartureTime').value;
        if (departureTime) {
            validateBusDates(departureTime, this.value);
        }
    });
</script>
<script src="js/singleWindowValidator.js"></script>
</body>
</html>

