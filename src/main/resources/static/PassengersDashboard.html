<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMAS - Enhanced Passenger Dashboard with Rating System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root {
      --primary-blue: #1E40AF;
      --secondary-red: #DC2626;
      --light-blue: #3B82F6;
      --light-red: #EF4444;
      --gold: #F59E0B;
      --green: #10B981;
      --gray-dark: #1F2937;
      --gray-medium: #6B7280;
      --gray-light: #F3F4F6;
      --white: #FFFFFF;
      --sidebar-width: 240px;
      --header-height: 70px;
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --ticket-blue: #1a4875;
      --ticket-orange: #f5a623;
    }

    [data-theme="dark"] {
      --white: #1F2937;
      --gray-light: #374151;
      --gray-medium: #9CA3AF;
      --gray-dark: #F9FAFB;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-light);
      color: var(--gray-dark);
      transition: var(--transition);
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      height: var(--header-height);
      background: var(--white);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      box-shadow: var(--shadow);
      z-index: 1000;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      transition: var(--transition);
    }

    .header.expanded {
      left: 80px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray-dark);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .sidebar-toggle:hover {
      background: var(--gray-light);
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-dark);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .notification-btn {
      position: relative;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--gray-dark);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .notification-btn:hover {
      background: var(--gray-light);
    }

    .notification-badge {
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      background: var(--secondary-red);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .theme-toggle {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--gray-dark);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .theme-toggle:hover {
      background: var(--gray-light);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 1rem;
      background: var(--gray-light);
      border-radius: 50px;
      cursor: pointer;
      transition: var(--transition);
    }

    .user-profile:hover {
      background: var(--light-blue);
      color: var(--white);
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--white);
      border-right: 1px solid rgba(0,0,0,0.1);
      box-shadow: var(--shadow);
      z-index: 1100;
      transition: var(--transition);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar.collapsed {
      width: 80px;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary-blue);
      transition: var(--transition);
    }

    .sidebar.collapsed .logo-text {
      opacity: 0;
      transform: translateX(-10px);
    }

    .sidebar-menu {
      flex: 1;
      padding: 1rem 0;
    }

    .sidebar-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-menu li {
      margin: 0.25rem 0;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: var(--gray-medium);
      text-decoration: none;
      transition: var(--transition);
      border-radius: 0 25px 25px 0;
      margin-right: 1rem;
      font-weight: 500;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: linear-gradient(90deg, rgba(30,64,175,0.1) 0%, rgba(30,64,175,0.05) 100%);
      color: var(--primary-blue);
      transform: translateX(5px);
    }

    .sidebar-menu a.active {
      border-right: 3px solid var(--primary-blue);
    }

    .sidebar-menu i {
      font-size: 1.25rem;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .sidebar-menu .menu-text {
      transition: var(--transition);
    }

    .sidebar.collapsed .menu-text {
      opacity: 0;
      transform: translateX(-10px);
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      margin-top: var(--header-height);
      padding: 2rem;
      min-height: calc(100vh - var(--header-height));
      transition: var(--transition);
    }

    .main-content.expanded {
      margin-left: 80px;
    }

    /* Cards */
    .card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 1.5rem;
      transition: var(--transition);
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .stat-icon {
      width: 70px;
      height: 70px;
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      color: var(--white);
      flex-shrink: 0;
    }

    .stat-icon.tickets {
      background: linear-gradient(135deg, var(--green), #22C55E);
    }

    .stat-icon.spent {
      background: linear-gradient(135deg, var(--secondary-red), var(--light-red));
    }

    .stat-icon.upcoming {
      background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
    }

    .stat-icon.completed {
      background: linear-gradient(135deg, var(--gold), #F59E0B);
    }

    .stat-info h3 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--gray-dark);
      margin-bottom: 0.5rem;
    }

    .stat-info p {
      color: var(--gray-medium);
      font-weight: 500;
    }

    /* Bus List */
    .bus-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .bus-card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
      cursor: pointer;
      border: 2px solid transparent;
    }

    .bus-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      border-color: var(--primary-blue);
    }

    .bus-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .bus-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-dark);
    }

    .bus-line {
      background: var(--primary-blue);
      color: var(--white);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .bus-route {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      font-weight: 600;
      color: var(--gray-dark);
      word-break: break-word;
    }

    .bus-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .bus-info-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--gray-medium);
    }

    .bus-price {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--green);
      text-align: center;
      margin-bottom: 1rem;
    }

    .btn {
      background: var(--primary-blue);
      color: var(--white);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      font-size: 0.9rem;
      width: 100%;
      justify-content: center;
    }

    .btn:hover {
      background: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(30,64,175,0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-success {
      background: var(--green);
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-warning {
      background: var(--gold);
      color: var(--gray-dark);
    }

    .btn-warning:hover {
      background: #F59E0B;
    }

    .btn-danger {
      background: var(--secondary-red);
    }

    .btn-danger:hover {
      background: var(--light-red);
    }

    .btn-secondary {
      background: var(--gray-medium);
    }

    .btn-secondary:hover {
      background: var(--gray-dark);
    }

    /* Seat Selection */
    .seat-selection {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .bus-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      margin: 2rem 0;
    }

    .driver-section {
      width: 80px;
      height: 40px;
      background: var(--gray-light);
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-medium);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .seats-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      max-width: 300px;
      width: 100%;
    }

    .seat {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 0.9rem;
      position: relative;
      border: 2px solid;
    }

    /* Siège disponible - VERT */
    .seat.available {
      background: var(--white) !important;
      border-color: var(--green) !important;
      color: var(--green) !important;
      cursor: pointer !important;
    }

    .seat.available:hover {
      border-color: var(--primary-blue) !important;
      background: rgba(30, 64, 175, 0.1) !important;
      transform: scale(1.05);
    }

    /* Siège sélectionné - BLEU */
    .seat.selected {
      background: var(--primary-blue) !important;
      border-color: var(--primary-blue) !important;
      color: var(--white) !important;
      cursor: default !important;
    }

    /* Siège pris - GRIS FORCÉ */
    .seat.taken,
    .seat[data-taken="true"],
    .seat.taken.available,
    .seat.taken.selected {
      background: #9CA3AF !important;
      border-color: #9CA3AF !important;
      color: white !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
      opacity: 1 !important;
      user-select: none !important;
    }

    /* Override FORCÉ pour tous les états des sièges pris */
    .seat.taken:hover,
    .seat.taken:focus,
    .seat.taken:active,
    .seat[data-taken="true"]:hover,
    .seat[data-taken="true"]:focus,
    .seat[data-taken="true"]:active {
      background: #9CA3AF !important;
      border-color: #9CA3AF !important;
      color: white !important;
      transform: none !important;
      cursor: not-allowed !important;
    }

    .seat-legend {
      display: flex;
      gap: 2rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .legend-seat {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid;
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-light);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-dark);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray-medium);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: var(--transition);
    }

    .close-btn:hover {
      background: var(--gray-light);
      color: var(--gray-dark);
    }

    /* Forms */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--gray-dark);
    }

    .form-control {
      width: 100%;
      padding: 0.875rem;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
      background: var(--white);
      color: var(--gray-dark);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Map */
    #trackingMap {
      height: 100%;
      width: 100%;
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }

    /* Trip Card */
    .trip-card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary-blue);
    }

    .trip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .trip-status {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .trip-status.upcoming {
      background: rgba(30, 64, 175, 0.1);
      color: var(--primary-blue);
    }

    .trip-status.active {
      background: rgba(16, 185, 129, 0.1);
      color: var(--green);
    }

    .trip-status.completed {
      background: rgba(107, 114, 128, 0.1);
      color: var(--gray-medium);
    }

    /* Search and Filter */
    .search-filters {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .filter-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    /* Notifications */
    .notification-item {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary-blue);
      transition: var(--transition);
      cursor: pointer;
    }

    .notification-item.unread {
      background: rgba(30, 64, 175, 0.05);
    }

    .notification-item:hover {
      transform: translateX(5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .notification-title {
      font-weight: 600;
      color: var(--gray-dark);
    }

    .notification-time {
      font-size: 0.8rem;
      color: var(--gray-medium);
    }

    .notification-message {
      color: var(--gray-medium);
      line-height: 1.4;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s linear infinite;
    }

    /* Ticket Design */
    .ticket-preview {
      background: linear-gradient(135deg, var(--ticket-blue), #2563EB);
      border-radius: 16px;
      padding: 0;
      margin: 1rem 0;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      overflow: hidden;
      color: white;
      position: relative;
      min-height: 400px;
    }

    .ticket-header {
      background: linear-gradient(135deg, var(--ticket-blue), #1e40af);
      padding: 2rem;
      text-align: center;
      position: relative;
    }

    .ticket-logo {
      width: 80px;
      height: 80px;
      background: var(--ticket-orange);
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      border: 4px solid rgba(255,255,255,0.2);
    }

    .ticket-company {
      font-size: 2rem;
      font-weight: bold;
      color: var(--ticket-orange);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .ticket-subtitle {
      opacity: 0.9;
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .ticket-content {
      padding: 2rem;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 2rem;
      align-items: start;
    }

    .ticket-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .info-section {
      background: rgba(255,255,255,0.1);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .info-section h4 {
      color: var(--ticket-orange);
      font-size: 0.9rem;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .info-section p {
      margin-bottom: 0.25rem;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .ticket-qr {
      text-align: center;
      padding: 1rem;
      background: rgba(255,255,255,0.15);
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.2);
      min-width: 140px;
    }

    .ticket-qr canvas {
      background: white;
      border-radius: 8px;
      padding: 8px;
    }

    .ticket-footer {
      background: rgba(0,0,0,0.2);
      padding: 1rem 2rem;
      text-align: center;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    /* Smart Trip Suggestions */
    .trip-suggestion {
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.1), rgba(59, 130, 246, 0.05));
      border: 2px solid rgba(30, 64, 175, 0.2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: var(--transition);
      cursor: pointer;
    }

    .trip-suggestion:hover {
      border-color: var(--primary-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(30, 64, 175, 0.15);
    }

    .trip-suggestion.recommended {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05));
      border-color: rgba(16, 185, 129, 0.3);
    }

    .trip-suggestion.recommended:hover {
      border-color: var(--green);
    }

    .suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .suggestion-badge {
      background: var(--green);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .suggestion-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .detail-icon {
      width: 16px;
      text-align: center;
      color: var(--primary-blue);
    }

    /* Rating System Styles */
    .rating-container {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .rating-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      background: var(--gray-light);
    }

    .rating-section h3 {
      margin-bottom: 1rem;
      color: var(--gray-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .rating-stars {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1rem;
    }

    .star {
      font-size: 1.5rem;
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .star.active {
      color: var(--gold);
    }

    .star:hover {
      color: var(--gold);
    }

    .rating-comment {
      width: 100%;
      min-height: 100px;
      padding: 1rem;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      resize: vertical;
      font-family: inherit;
    }

    .rating-comment:focus {
      outline: none;
      border-color: var(--primary-blue);
    }

    .rating-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .rating-display .stars {
      display: flex;
      gap: 0.1rem;
    }

    .rating-display .star {
      font-size: 1rem;
      color: var(--gold);
    }

    .rating-display .star.empty {
      color: #ddd;
    }

    /* Hidden class */
    .hidden {
      display: none !important;
    }

    /* Notifications Toast */
    .notification-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease-out;
    }

    .notification-toast.success {
      background: var(--green);
    }

    .notification-toast.error {
      background: var(--secondary-red);
    }

    .notification-toast.warning {
      background: var(--gold);
    }

    .notification-toast.info {
      background: var(--primary-blue);
    }

    /* Real-time indicators */
    .real-time-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(16, 185, 129, 0.1);
      color: var(--green);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    /* Bus status indicators */
    .bus-status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 15px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .bus-status-indicator.moving {
      background: rgba(16, 185, 129, 0.1);
      color: var(--green);
    }

    .bus-status-indicator.stopped {
      background: rgba(245, 158, 11, 0.1);
      color: var(--gold);
    }

    .bus-status-indicator.accident {
      background: rgba(220, 38, 38, 0.1);
      color: var(--secondary-red);
    }

    /* Progress indicators */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--gray-light);
      border-radius: 3px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-blue), var(--light-blue));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .logout-item {
      margin-top: auto;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 10px;
    }

    .logout-item a {
      color: #ff6b6b !important;
    }

    .logout-item a:hover {
      background-color: rgba(255, 107, 107, 0.1) !important;
      color: #ff5252 !important;
    }

    .sidebar-menu {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .sidebar-menu ul {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    /* Seat styles enhancements */
    .seat {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all 0.2s ease;
      margin: 5px;
    }

    .seat.available {
      background: var(--white);
      border: 2px solid var(--primary-blue);
      color: var(--primary-blue);
    }

    .seat.selected {
      background: var(--primary-blue);
      color: var(--white);
      border: 2px solid var(--primary-blue);
    }

    /* Animation for taken seats */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-3px); }
      40%, 80% { transform: translateX(3px); }
    }

    .seat.taken:hover {
      animation: shake 0.5s ease-in-out;
    }

    /* Red X icon for taken seats */
    .seat.taken::after,
    .seat[data-taken="true"]::after {
      content: '✖';
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--secondary-red);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border: 2px solid white;
      pointer-events: none;
    }

    /* Green check icon for selected seats */
    .seat.selected::before {
      content: '✓';
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--green);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border: 2px solid white;
      font-weight: bold;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        width: 80px;
      }

      .sidebar .menu-text,
      .sidebar .logo-text {
        opacity: 0;
        transform: translateX(-10px);
      }

      .main-content {
        margin-left: 80px;
      }

      .header {
        left: 80px;
      }

      .filter-row {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.mobile-show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .header {
        left: 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .bus-list {
        grid-template-columns: 1fr;
      }

      .seats-container {
        max-width: 250px;
        gap: 0.5rem;
      }

      .seat {
        width: 40px;
        height: 40px;
        font-size: 0.8rem;
      }

      .ticket-content {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .ticket-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body data-theme="light">
<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="logo-icon">
      <i class="fas fa-bus"></i>
    </div>
    <span class="logo-text">IMAS</span>
  </div>
  <div class="sidebar-menu">
    <ul>
      <li>
        <a href="#" class="active" onclick="showSection('dashboard', event)">
          <i class="fas fa-tachometer-alt"></i>
          <span class="menu-text">Dashboard</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('book-ticket', event)">
          <i class="fas fa-ticket-alt"></i>
          <span class="menu-text">Book Ticket</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('smart-planning', event)">
          <i class="fas fa-brain"></i>
          <span class="menu-text">Smart Planning</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('my-trips', event)">
          <i class="fas fa-route"></i>
          <span class="menu-text">My Trips</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('live-tracking', event)">
          <i class="fas fa-map-marked-alt"></i>
          <span class="menu-text">Live Tracking</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('ratings', event)">
          <i class="fas fa-star"></i>
          <span class="menu-text">Rate & Review</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('statistics', event)">
          <i class="fas fa-chart-bar"></i>
          <span class="menu-text">Statistics</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('notifications', event)">
          <i class="fas fa-bell"></i>
          <span class="menu-text">Notifications</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('profile', event)">
          <i class="fas fa-user"></i>
          <span class="menu-text">Profile</span>
        </a>
      </li>
      <li class="logout-item">
        <a href="#" onclick="handleLogout(event)">
          <i class="fas fa-sign-out-alt"></i>
          <span class="menu-text">Logout</span>
        </a>
      </li>
    </ul>
  </div>
</nav>

<!-- Header -->
<header class="header" id="header">
  <div class="header-left">
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-bars"></i>
    </button>
  </div>
  <div class="header-center">
    <h1 class="header-title">Enhanced Passenger Dashboard</h1>
  </div>
  <div class="header-right">
    <button class="notification-btn" onclick="showSection('notifications')">
      <i class="fas fa-bell"></i>
      <span class="notification-badge" id="notificationCount">0</span>
    </button>
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
    </button>
    <div class="user-profile" id="userProfile">
      <div class="user-avatar" id="userAvatar">P</div>
      <span id="userName">Passenger</span>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="main-content" id="mainContent">
  <!-- Dashboard Section -->
  <section id="dashboard-section" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h1 style="color: var(--gray-dark);" id="welcomeMessage"></h1>
      <div class="real-time-indicator">
        <div class="pulse-dot"></div>
        Live Updates
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon tickets">
          <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="stat-info">
          <h3 id="totalTickets">0</h3>
          <p>Total Tickets</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon spent">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <h3 id="totalSpent">0 FC</h3>
          <p>Total Spent</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon upcoming">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-info">
          <h3 id="upcomingTrips">0</h3>
          <p>Upcoming Trips</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon completed">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
          <h3 id="completedTrips">0</h3>
          <p>Completed Trips</p>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Monthly Spending</h3>
        <div class="chart-container">
          <canvas id="spendingChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Trip Frequency</h3>
        <div class="chart-container">
          <canvas id="frequencyChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom: 1.5rem;">Recent Activity</h3>
      <div id="recentActivity">
        <p style="color: var(--gray-medium);">Loading recent activity...</p>
      </div>
    </div>
  </section>

  <!-- Smart Planning Section -->
  <section id="smart-planning-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">AI-Powered Smart Trip Planning</h1>

    <div class="search-filters">
      <h3 style="margin-bottom: 1rem;">Plan Your Perfect Journey</h3>
      <div class="filter-row">
        <div class="form-group">
          <label>From</label>
          <select class="form-control" id="planningOrigin">
            <option value="">Select Origin</option>
          </select>
        </div>
        <div class="form-group">
          <label>To</label>
          <select class="form-control" id="planningDestination">
            <option value="">Select Destination</option>
          </select>
        </div>
        <div class="form-group">
          <label>Preferred Time</label>
          <select class="form-control" id="preferredTime">
            <option value="">Any Time</option>
            <option value="morning">Morning (6:00-12:00)</option>
            <option value="afternoon">Afternoon (12:00-18:00)</option>
            <option value="evening">Evening (18:00-24:00)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select class="form-control" id="travelPriority">
            <option value="fastest">Fastest Route</option>
            <option value="cheapest">Cheapest Option</option>
            <option value="comfortable">Most Comfortable</option>
            <option value="least_crowded">Least Crowded</option>
          </select>
        </div>
        <button class="btn" onclick="generateSmartTripSuggestions()">
          <i class="fas fa-brain"></i>
          Get AI Suggestions
        </button>
      </div>
    </div>

    <div id="tripSuggestionsContainer">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">
          <i class="fas fa-lightbulb" style="color: var(--gold); margin-right: 0.5rem;"></i>
          AI-Powered Trip Suggestions
        </h3>
        <div id="tripSuggestions">
          <div style="text-align: center; padding: 3rem; color: var(--gray-medium);">
            <i class="fas fa-route" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p>Select your origin and destination to get smart travel suggestions based on real-time availability</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Book Ticket Section -->
  <section id="book-ticket-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Book Your Ticket</h1>

    <div class="search-filters">
      <div class="filter-row">
        <div class="form-group">
          <label>Search Bus or Route</label>
          <input type="text" class="form-control" id="routeSearch" placeholder="Search by bus name, route, or destination...">
        </div>
        <div class="form-group">
          <label>Departure Date</label>
          <input type="date" class="form-control" id="departureDate">
        </div>
        <div class="form-group">
          <label>Passengers</label>
          <select class="form-control" id="passengerCount">
            <option value="1">1 Passenger</option>
            <option value="2">2 Passengers</option>
            <option value="3">3 Passengers</option>
            <option value="4">4 Passengers</option>
          </select>
        </div>
        <div class="form-group">
          <label>Sort By</label>
          <select class="form-control" id="sortBy">
            <option value="price">Price</option>
            <option value="time">Departure Time</option>
            <option value="capacity">Available Seats</option>
          </select>
        </div>
        <button class="btn" onclick="searchBuses()">
          <i class="fas fa-search"></i>
          Search
        </button>
      </div>
    </div>

    <div id="busListContainer">
      <div class="bus-list" id="busList">
        <!-- Bus cards will be populated here -->
      </div>
    </div>
  </section>

  <!-- My Trips Section -->
  <section id="my-trips-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">My Trips</h1>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h3>All Trips</h3>
        <div style="display: flex; gap: 1rem;">
          <select class="form-control" style="width: 150px;" id="tripStatusFilter" onchange="loadMyTrips()">
            <option value="">All Status</option>
            <option value="upcoming">Upcoming</option>
            <option value="active">Active</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>
      <div id="tripsList">
        <!-- Trip cards will be populated here -->
      </div>
    </div>
  </section>

  <!-- Live Tracking Section -->
  <section id="live-tracking-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Live Bus Tracking</h1>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; height: 600px;">
      <div class="card" style="margin: 0; padding: 0; overflow: hidden;">
        <div id="trackingMap" style="height: 100%; width: 100%;"></div>
      </div>

      <div class="card" style="margin: 0; overflow-y: auto;">
        <h3 style="margin-bottom: 1.5rem;">Your Active Trips</h3>
        <div id="activeTripsTracking">
          <p style="color: var(--gray-medium);">Loading active trips...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Rating & Review Section -->
  <section id="ratings-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Rate & Review Your Experience</h1>

    <div class="card">
      <h3 style="margin-bottom: 2rem;">
        <i class="fas fa-star" style="color: var(--gold); margin-right: 0.5rem;"></i>
        Rate Your Recent Trips
      </h3>
      <div id="tripsToRate">
        <p style="color: var(--gray-medium);">Loading recent trips for rating...</p>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom: 2rem;">
        <i class="fas fa-history" style="color: var(--primary-blue); margin-right: 0.5rem;"></i>
        Your Rating History
      </h3>
      <div id="ratingHistory">
        <p style="color: var(--gray-medium);">Loading your rating history...</p>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom: 2rem;">
        <i class="fas fa-chart-line" style="color: var(--green); margin-right: 0.5rem;"></i>
        Rating Statistics
      </h3>
      <div id="ratingStatistics">
        <!-- Rating statistics will be displayed here -->
      </div>
    </div>
  </section>

  <!-- Statistics Section -->
  <section id="statistics-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Personal Statistics</h1>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon tickets">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-info">
          <h3 id="monthlyTrips">0</h3>
          <p>This Month</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon spent">
          <i class="fas fa-coins"></i>
        </div>
        <div class="stat-info">
          <h3 id="monthlySpent">0 FC</h3>
          <p>Monthly Spending</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon upcoming">
          <i class="fas fa-route"></i>
        </div>
        <div class="stat-info">
          <h3 id="favoriteRoute">-</h3>
          <p>Favorite Route</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon completed">
          <i class="fas fa-star"></i>
        </div>
        <div class="stat-info">
          <h3 id="loyaltyPoints">0</h3>
          <p>Loyalty Points</p>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Spending Analysis</h3>
        <div class="chart-container">
          <canvas id="spendingAnalysisChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Route Usage</h3>
        <div class="chart-container">
          <canvas id="routeUsageChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Monthly Trends</h3>
        <div class="chart-container">
          <canvas id="monthlyTrendsChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Travel Patterns</h3>
        <div class="chart-container">
          <canvas id="travelPatternsChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Notifications Section -->
  <section id="notifications-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Notifications</h1>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h3>All Notifications</h3>
        <div style="display: flex; gap: 1rem;">
          <button class="btn btn-secondary" onclick="markAllAsRead()">
            <i class="fas fa-check-double"></i>
            Mark All as Read
          </button>
          <button class="btn btn-success" onclick="requestNotificationPermission()">
            <i class="fas fa-bell"></i>
            Enable Notifications
          </button>
        </div>
      </div>
      <div id="notificationsList">
        <!-- Notifications will be populated here -->
      </div>
    </div>
  </section>

  <!-- Profile Section -->
  <section id="profile-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">My Profile</h1>

    <div class="card">
      <h3 style="margin-bottom: 1.5rem;">Personal Information</h3>
      <form id="profileForm">
        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" class="form-control" id="firstName" required>
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" class="form-control" id="lastName" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" class="form-control" id="phoneNumber" required>
          </div>
        </div>
        <button type="submit" class="btn">
          <i class="fas fa-save"></i>
          Update Profile
        </button>
      </form>
    </div>
  </section>
</main>

<!-- Seat Selection Modal -->
<div id="seatModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Select Your Seat</h2>
      <button class="close-btn" onclick="closeModal('seatModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="seatSelectionContent">
      <div class="seat-selection">
        <div class="bus-layout">
          <div class="driver-section">DRIVER</div>
          <div class="seats-container" id="seatsContainer">
            <!-- Seats will be generated dynamically -->
          </div>
        </div>

        <div class="seat-legend">
          <div class="legend-item">
            <div class="legend-seat" style="background: white; border-color: #ddd;"></div>
            <span>Available</span>
          </div>
          <div class="legend-item">
            <div class="legend-seat" style="background: var(--primary-blue); border-color: var(--primary-blue);"></div>
            <span>Selected</span>
          </div>
          <div class="legend-item">
            <div class="legend-seat" style="background: var(--gray-medium); border-color: var(--gray-medium);"></div>
            <span>Taken</span>
          </div>
        </div>

        <div style="margin-top: 2rem; text-align: center;">
          <div style="margin-bottom: 1rem;">
            <strong>Selected Seat: </strong>
            <span id="selectedSeatDisplay">None</span>
          </div>
          <button class="btn" id="proceedToPayment" onclick="proceedToPayment()" disabled>
            <i class="fas fa-credit-card"></i>
            Proceed to Payment
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Payment Details</h2>
      <button class="close-btn" onclick="closeModal('paymentModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="paymentContent">
      <div class="form-group">
        <h4>Trip Summary</h4>
        <div id="tripSummary" style="background: var(--gray-light); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
          <!-- Trip details will be populated here -->
        </div>
      </div>

      <form id="paymentForm">
        <div class="form-row">
          <div class="form-group">
            <label>Passenger Name</label>
            <input type="text" class="form-control" id="passengerName" required>
          </div>
          <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" class="form-control" id="passengerPhone" required>
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="hasLuggage" style="margin-right: 0.5rem;">
            Add Luggage (+500 FC)
          </label>
        </div>

        <div class="form-group" id="luggageWeightGroup" style="display: none;">
          <label>Luggage Weight (kg)</label>
          <input type="number" class="form-control" id="luggageWeight" step="0.1" min="0" max="50">
        </div>

        <div style="text-align: center; margin: 2rem 0;">
          <div style="font-size: 1.5rem; font-weight: bold; color: var(--green);">
            Total: <span id="totalPrice">0 FC</span>
          </div>
        </div>

        <button type="submit" class="btn" id="confirmPaymentBtn">
          <i class="fas fa-credit-card"></i>
          Confirm Payment
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Ticket Download Modal -->
<div id="ticketDownloadModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title">Download Your Ticket</h2>
      <button class="close-btn" onclick="closeModal('ticketDownloadModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="ticketPreviewContainer">
      <div class="ticket-preview" id="ticketPreview">
        <div class="ticket-header">
          <div class="ticket-logo">🚌</div>
          <div class="ticket-company">IMAS</div>
          <div class="ticket-subtitle">Intelligent Management & Analytics System</div>
        </div>

        <div class="ticket-content">
          <div class="ticket-info">
            <div class="info-section">
              <h4>Passenger Information</h4>
              <p id="previewPassengerName"><strong>Name:</strong> John Doe</p>
              <p id="previewPassengerPhone"><strong>Phone:</strong> +243123456789</p>
              <p id="previewTicketNumber"><strong>Ticket #:</strong> TKT123456789</p>
            </div>

            <div class="info-section">
              <h4>Journey Details</h4>
              <p id="previewRoute"><strong>Route:</strong> Origin → Destination</p>
              <p id="previewDeparture"><strong>Departure:</strong> Dec 15, 2024 - 14:30</p>
              <p id="previewSeat"><strong>Seat:</strong> 12</p>
            </div>

            <div class="info-section">
              <h4>Bus Information</h4>
              <p id="previewBusName"><strong>Bus:</strong> Express 001</p>
              <p id="previewBusLine"><strong>Line:</strong> Line A</p>
              <p id="previewStatus"><strong>Status:</strong> Confirmed</p>
            </div>

            <div class="info-section">
              <h4>Payment Details</h4>
              <p id="previewPrice"><strong>Total Paid:</strong> 2,500 FC</p>
              <p id="previewIssueDate"><strong>Issued:</strong> Dec 14, 2024</p>
              <p><strong>Payment:</strong> Confirmed</p>
            </div>
          </div>

          <div class="ticket-qr">
            <div id="previewQRCode"></div>
            <p style="font-size: 0.8rem; margin-top: 0.5rem;">
              Show this QR code when boarding
            </p>
          </div>
        </div>

        <div class="ticket-footer">
          <p>Generated by IMAS - Intelligent Management & Analytics System</p>
          <p>Keep this ticket safe during your journey</p>
        </div>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
      <button class="btn" onclick="downloadTicketAsPDF()">
        <i class="fas fa-file-pdf"></i>
        Download PDF
      </button>
      <button class="btn btn-success" onclick="downloadTicketAsImage()">
        <i class="fas fa-image"></i>
        Download Image
      </button>
      <button class="btn btn-warning" onclick="downloadQRCodeOnly()">
        <i class="fas fa-qrcode"></i>
        Download QR Code
      </button>
    </div>
  </div>
</div>

<!-- Rating Modal -->
<div id="ratingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Rate Your Experience</h2>
      <button class="close-btn" onclick="closeModal('ratingModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="ratingContent">
      <form id="ratingForm">
        <input type="hidden" id="ratingTicketId">
        <input type="hidden" id="ratingBusId">
        <input type="hidden" id="ratingDriverId">
        <input type="hidden" id="ratingRouteId">

        <div class="rating-section">
          <h3><i class="fas fa-bus"></i> Overall Service</h3>
          <div class="rating-stars" data-rating="overall">
            <span class="star" data-value="1">★</span>
            <span class="star" data-value="2">★</span>
            <span class="star" data-value="3">★</span>
            <span class="star" data-value="4">★</span>
            <span class="star" data-value="5">★</span>
          </div>
          <textarea class="rating-comment" id="overallComment" placeholder="Share your overall experience..."></textarea>
        </div>

        <div class="rating-section">
          <h3><i class="fas fa-user"></i> Driver Performance</h3>
          <div class="rating-stars" data-rating="driver">
            <span class="star" data-value="1">★</span>
            <span class="star" data-value="2">★</span>
            <span class="star" data-value="3">★</span>
            <span class="star" data-value="4">★</span>
            <span class="star" data-value="5">★</span>
          </div>
          <textarea class="rating-comment" id="driverComment" placeholder="How was the driver's performance?"></textarea>
        </div>

        <div class="rating-section">
          <h3><i class="fas fa-route"></i> Route & Schedule</h3>
          <div class="rating-stars" data-rating="route">
            <span class="star" data-value="1">★</span>
            <span class="star" data-value="2">★</span>
            <span class="star" data-value="3">★</span>
            <span class="star" data-value="4">★</span>
            <span class="star" data-value="5">★</span>
          </div>
          <textarea class="rating-comment" id="routeComment" placeholder="How was the route and punctuality?"></textarea>
        </div>

        <div class="rating-section">
          <h3><i class="fas fa-bus-alt"></i> Bus Condition</h3>
          <div class="rating-stars" data-rating="bus">
            <span class="star" data-value="1">★</span>
            <span class="star" data-value="2">★</span>
            <span class="star" data-value="3">★</span>
            <span class="star" data-value="4">★</span>
            <span class="star" data-value="5">★</span>
          </div>
          <textarea class="rating-comment" id="busComment" placeholder="How was the bus condition and cleanliness?"></textarea>
        </div>

        <button type="submit" class="btn" style="width: 100%; margin-top: 2rem;">
          <i class="fas fa-star"></i>
          Submit Rating
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // Global variables
  let currentUser = null;
  let trackingMap = null;
  let selectedBus = null;
  let selectedSeat = null;
  let charts = {};
  let notifications = [];
  let userTickets = [];
  let activeTrips = [];
  let busMarkers = [];
  let realTimeInterval = null;
  let currentTicketForDownload = null;
  let notificationPermission = 'default';
  let availableBuses = [];
  let availableRoutes = [];
  let currentBusData = null;
  let availableSeatsCount = 0;
  let userRatings = [];

  const API_BASE = 'http://localhost:8080/api';

  // Initialize application
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing Enhanced IMAS Passenger Dashboard...');

    checkLibraries();
    initializeUser();
    initializeEventListeners();
    initializeNotifications();
    initializeRatingSystem();
    showSection('dashboard');
    loadDashboardData();
    startRealTimeUpdates();
    setupPushNotifications();

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    const departureDateInput = document.getElementById('departureDate');
    if (departureDateInput) {
      departureDateInput.value = today;
      departureDateInput.min = today; // Prevent selecting past dates
    }
  });

  // Check if all required libraries are loaded
  function checkLibraries() {
    const libraries = {
      'Chart.js': typeof Chart !== 'undefined',
      'Leaflet': typeof L !== 'undefined',
      'QRCode': typeof QRCode !== 'undefined',
      'jsPDF': typeof window.jspdf !== 'undefined',
      'html2canvas': typeof html2canvas !== 'undefined'
    };

    console.log('📚 Library Status:', libraries);

    Object.entries(libraries).forEach(([name, loaded]) => {
      if (!loaded) {
        console.warn(`⚠️ ${name} library not loaded properly`);
      }
    });
  }

  function initializeUser() {
    const userSession = localStorage.getItem('userSession');
    if (userSession) {
      currentUser = JSON.parse(userSession);
    } else {
      currentUser = {
        id: 1,
        firstName: 'John',
        lastName: 'Doe',
        email: 'john.doe@example.com',
        phoneNumber: '+243123456789',
        role: 'PASSENGER'
      };
      localStorage.setItem('userSession', JSON.stringify(currentUser));
    }

    document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
    document.getElementById('userAvatar').textContent = currentUser.firstName.charAt(0);
    updateWelcomeMessage();
    loadProfileData();
  }

  // Initialize push notifications
  function initializeNotifications() {
    if ('Notification' in window) {
      notificationPermission = Notification.permission;

      if (notificationPermission === 'granted') {
        console.log('✅ Notifications already granted');
      } else if (notificationPermission === 'default') {
        console.log('ℹ️ Notification permission not requested yet');
      } else {
        console.log('❌ Notifications blocked');
      }
    }
  }

  // Initialize Rating System
  function initializeRatingSystem() {
    console.log('⭐ Initializing rating system...');

    // Initialize star rating interactions
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('star')) {
        const starsContainer = e.target.parentElement;
        const ratingType = starsContainer.getAttribute('data-rating');
        const value = parseInt(e.target.getAttribute('data-value'));

        updateStarRating(starsContainer, value);
      }
    });

    // Initialize rating form submission
    const ratingForm = document.getElementById('ratingForm');
    if (ratingForm) {
      ratingForm.addEventListener('submit', handleRatingSubmission);
    }
  }

  // Request notification permission
  async function requestNotificationPermission() {
    if (!('Notification' in window)) {
      showNotification('This browser does not support notifications', 'error');
      return;
    }

    try {
      const permission = await Notification.requestPermission();
      notificationPermission = permission;

      if (permission === 'granted') {
        showNotification('Notifications enabled! You\'ll receive trip alerts.', 'success');

        // Send test notification
        new Notification('IMAS Notifications Enabled', {
          body: 'You will now receive important trip updates',
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🚌</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🚌</text></svg>'
        });

      } else {
        showNotification('Notifications were not enabled', 'warning');
      }
    } catch (error) {
      console.error('Error requesting notification permission:', error);
      showNotification('Error enabling notifications', 'error');
    }
  }

  // Send push notification
  function sendPushNotification(title, body, options = {}) {
    if (notificationPermission === 'granted' && 'Notification' in window) {
      try {
        const notification = new Notification(title, {
          body: body,
          icon: options.icon || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🚌</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🚌</text></svg>',
          tag: options.tag || 'imas-notification',
          requireInteraction: options.requireInteraction || false,
          ...options
        });

        notification.onclick = function(event) {
          event.preventDefault();
          window.focus();
          if (options.clickAction) {
            options.clickAction();
          }
        };

        return notification;
      } catch (error) {
        console.error('Error sending push notification:', error);
      }
    }
  }

  // Setup push notifications for trip alerts
  function setupPushNotifications() {
    // Check for upcoming trips every minute
    setInterval(checkUpcomingTrips, 60000);
  }

  // Check for trips departing soon
  async function checkUpcomingTrips() {
    if (!userTickets.length) return;

    const now = new Date();

    userTickets.forEach(ticket => {
      if (ticket.status !== 'PAID') return;

      const departureTime = new Date(ticket.departureTime);
      const timeDiff = departureTime - now;
      const minutesToDepart = Math.floor(timeDiff / (1000 * 60));

      // Notify 60 minutes, 30 minutes, and 15 minutes before departure
      if ([60, 30, 15].includes(minutesToDepart)) {
        const title = `🚌 Trip Departure Alert`;
        const body = `Your bus ${ticket.origin} → ${ticket.destination} departs in ${minutesToDepart} minutes! Seat ${ticket.seatNumber}`;

        sendPushNotification(title, body, {
          tag: `departure-${ticket.id}-${minutesToDepart}`,
          requireInteraction: true,
          clickAction: () => {
            showSection('my-trips');
            trackTrip(ticket.id);
          }
        });

        // Add to notifications list
        addNotification({
          title: title,
          message: body,
          type: 'departure-alert',
          ticketId: ticket.id,
          time: new Date(),
          read: false
        });
      }
    });
  }

  // Load profile data
  function loadProfileData() {
    document.getElementById('firstName').value = currentUser.firstName || '';
    document.getElementById('lastName').value = currentUser.lastName || '';
    document.getElementById('email').value = currentUser.email || '';
    document.getElementById('phoneNumber').value = currentUser.phoneNumber || '';
  }

  // Initialize event listeners
  function initializeEventListeners() {
    document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // Payment form
    document.getElementById('paymentForm')?.addEventListener('submit', function(e) {
      handlePayment(e);
    });

    document.getElementById('profileForm')?.addEventListener('submit', handleProfileUpdate);

    // Search and filters
    document.getElementById('routeSearch')?.addEventListener('input', debounce(searchBuses, 500));
    document.getElementById('departureDate')?.addEventListener('change', searchBuses);
    document.getElementById('passengerCount')?.addEventListener('change', searchBuses);
    document.getElementById('sortBy')?.addEventListener('change', searchBuses);

    // Luggage checkbox
    document.getElementById('hasLuggage')?.addEventListener('change', toggleLuggageWeight);
    document.getElementById('luggageWeight')?.addEventListener('input', updateTotalPrice);

    // Proceed to payment button
    document.getElementById('proceedToPayment')?.addEventListener('click', proceedToPayment);
  }

  // Handle profile update
  async function handleProfileUpdate(e) {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    try {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading"></div> Updating...';

      const formData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phoneNumber: document.getElementById('phoneNumber').value
      };

      currentUser = { ...currentUser, ...formData };
      localStorage.setItem('userSession', JSON.stringify(currentUser));

      document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
      document.getElementById('userAvatar').textContent = currentUser.firstName.charAt(0);

      showNotification('Profile updated successfully!', 'success');

    } catch (error) {
      console.error('Profile update error:', error);
      showNotification('Failed to update profile: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }

  // Start real-time updates
  function startRealTimeUpdates() {
    realTimeInterval = setInterval(async () => {
      await updateRealTimeData();
    }, 30000);
  }

  // Update real-time data
  async function updateRealTimeData() {
    try {
      await loadUserTickets();
      updateDashboardStats();

      const currentSection = document.querySelector('.section:not(.hidden)');
      if (currentSection && currentSection.id === 'live-tracking-section') {
        await loadActiveTripsTracking();
      }

      await loadNotifications();

    } catch (error) {
      console.error('Real-time update error:', error);
    }
  }

  // Load dashboard data
  async function loadDashboardData() {
    try {
      await Promise.all([
        loadUserTickets(),
        loadAvailableRoutes(),
        loadRecentActivity(),
        loadNotifications(),
        loadUserRatings()
      ]);

      updateDashboardStats();
      createDashboardCharts();
    } catch (error) {
      console.error('Error loading dashboard data:', error);
      showNotification('Error loading dashboard data', 'error');
    }
  }

  // Load available routes for smart planning
  async function loadAvailableRoutes() {
    try {
      const routes = await fetchData('/routes');
      availableRoutes = routes.filter(route => route.active !== false);

      // Populate planning selects
      const origins = [...new Set(availableRoutes.map(r => r.startStation).filter(Boolean))];
      const destinations = [...new Set(availableRoutes.map(r => r.endStation).filter(Boolean))];

      // Add common stations if not present
      const commonStations = ['Gare Centrale', 'Limete', 'Bandalungwa', 'Matete', 'Ndjili', 'Masina', 'Kimbanseke'];
      commonStations.forEach(station => {
        if (!origins.includes(station)) origins.push(station);
        if (!destinations.includes(station)) destinations.push(station);
      });

      const originSelect = document.getElementById('planningOrigin');
      const destinationSelect = document.getElementById('planningDestination');

      if (originSelect) {
        originSelect.innerHTML = '<option value="">Select Origin</option>';
        origins.forEach(origin => {
          originSelect.innerHTML += `<option value="${origin}">${origin}</option>`;
        });
      }

      if (destinationSelect) {
        destinationSelect.innerHTML = '<option value="">Select Destination</option>';
        destinations.forEach(destination => {
          destinationSelect.innerHTML += `<option value="${destination}">${destination}</option>`;
        });
      }

    } catch (error) {
      console.error('Error loading routes:', error);
    }
  }

  // Load user tickets from API
  async function loadUserTickets() {
    try {
      const response = await fetch(`${API_BASE}/tickets/passenger/${currentUser.id}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        userTickets = await response.json();
        console.log('✅ Loaded user tickets:', userTickets.length);

        // Ensure bus data is loaded for each ticket
        for (let ticket of userTickets) {
          if (ticket.busId && !ticket.bus) {
            try {
              const busResponse = await fetch(`${API_BASE}/buses/${ticket.busId}`, {
                headers: {
                  'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
                  'Content-Type': 'application/json'
                }
              });
              if (busResponse.ok) {
                ticket.bus = await busResponse.json();
                console.log('✅ Loaded bus data for ticket:', ticket.id);
              }
            } catch (busError) {
              console.warn('⚠️ Could not load bus data for ticket:', ticket.id);
            }
          }
        }

      } else if (response.status === 404) {
        userTickets = [];
        console.log('ℹ️ No tickets found for user');
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      // Categorize trips
      const now = new Date();
      activeTrips = userTickets.filter(ticket => {
        const departureTime = new Date(ticket.departureTime);
        const timeDiff = departureTime - now;
        return timeDiff > -3600000 && timeDiff < 14400000 && ticket.status === 'PAID';
      });

    } catch (error) {
      console.error('❌ Error loading user tickets:', error);
      userTickets = [];
      activeTrips = [];
    }
  }




  async function loadUserRatings() {
    try {
      const response = await fetch(`${API_BASE}/ratings/passenger/${currentUser.id}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        // S'assurer que userRatings est toujours un tableau
        userRatings = Array.isArray(data) ? data : [];
        console.log('✅ Loaded user ratings:', userRatings.length);
      } else if (response.status === 404) {
        userRatings = []; // Initialiser comme tableau vide si pas de ratings
        console.log('ℹ️ No ratings found for user');
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    } catch (error) {
      console.error('❌ Error loading user ratings:', error);
      userRatings = []; // Initialiser comme tableau vide en cas d'erreur
    }
  }

  // Update dashboard stats
  function updateDashboardStats() {
    const totalTickets = userTickets.length;
    const totalSpent = userTickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const now = new Date();
    const upcomingTrips = userTickets.filter(ticket => {
      const departureTime = new Date(ticket.departureTime);
      return departureTime > now && ticket.status === 'PAID';
    }).length;

    const completedTrips = userTickets.filter(ticket => {
      const departureTime = new Date(ticket.departureTime);
      return departureTime <= now || ticket.status === 'BOARDED';
    }).length;

    // Update dashboard stats
    document.getElementById('totalTickets').textContent = totalTickets;
    document.getElementById('totalSpent').textContent = totalSpent.toLocaleString() + ' FC';
    document.getElementById('upcomingTrips').textContent = upcomingTrips;
    document.getElementById('completedTrips').textContent = completedTrips;

    // Update monthly stats
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();

    const monthlyTrips = userTickets.filter(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      return ticketDate.getMonth() === currentMonth && ticketDate.getFullYear() === currentYear;
    }).length;

    const monthlySpent = userTickets.filter(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      return ticketDate.getMonth() === currentMonth && ticketDate.getFullYear() === currentYear;
    }).reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    // Find favorite route
    const routeCounts = {};
    userTickets.forEach(ticket => {
      const route = `${ticket.origin} → ${ticket.destination}`;
      routeCounts[route] = (routeCounts[route] || 0) + 1;
    });

    const favoriteRoute = Object.keys(routeCounts).reduce((a, b) =>
            routeCounts[a] > routeCounts[b] ? a : b, '-'
    );

    const loyaltyPoints = Math.floor(totalSpent / 100);

    if (document.getElementById('monthlyTrips')) {
      document.getElementById('monthlyTrips').textContent = monthlyTrips;
      document.getElementById('monthlySpent').textContent = monthlySpent.toLocaleString() + ' FC';
      document.getElementById('favoriteRoute').textContent = favoriteRoute;
      document.getElementById('loyaltyPoints').textContent = loyaltyPoints;
    }
  }

  // Load recent activity
  async function loadRecentActivity() {
    const container = document.getElementById('recentActivity');

    if (userTickets.length === 0) {
      container.innerHTML = '<p style="color: var(--gray-medium);">No recent activity</p>';
      return;
    }

    const recentTickets = userTickets
            .sort((a, b) => new Date(b.issuedAt || b.createdAt) - new Date(a.issuedAt || a.createdAt))
            .slice(0, 5);

    container.innerHTML = recentTickets.map(ticket => {
      const price = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      const date = new Date(ticket.issuedAt || ticket.createdAt).toLocaleDateString();

      return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--gray-light);">
                  <div>
                      <strong>${ticket.origin} → ${ticket.destination}</strong><br>
                      <small style="color: var(--gray-medium);">${date} • Ticket ${ticket.ticketNumber}</small>
                  </div>
                  <div style="text-align: right;">
                      <strong style="color: var(--green);">${price.toLocaleString()} FC</strong><br>
                      <span class="trip-status ${ticket.status.toLowerCase()}">${ticket.status}</span>
                  </div>
              </div>
          `;
    }).join('');
  }

  // Enhanced Smart Trip Planning with Real-time Bus Availability
  async function generateSmartTripSuggestions() {
    const origin = document.getElementById('planningOrigin').value;
    const destination = document.getElementById('planningDestination').value;
    const preferredTime = document.getElementById('preferredTime').value;
    const priority = document.getElementById('travelPriority').value;

    if (!origin || !destination) {
      showNotification('Please select both origin and destination', 'warning');
      return;
    }

    if (origin === destination) {
      showNotification('Origin and destination cannot be the same', 'warning');
      return;
    }

    const container = document.getElementById('tripSuggestions');
    container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="loading" style="margin: 0 auto;"></div><p>Analyzing real-time bus availability and generating AI-powered suggestions...</p></div>';

    try {
      // Fetch real-time available buses with actual seat data
      const [schedules, buses] = await Promise.all([
        fetchData('/schedule-buses'),
        fetchData('/buses')
      ]);

      console.log('🔍 Smart Planning - Schedules:', schedules.length);
      console.log('🔍 Smart Planning - Buses:', buses.length);

      const now = new Date();

      // Filter for future and active schedules
      const availableSchedules = schedules.filter(schedule => {
        if (!schedule.isActive) return false;
        const departureTime = new Date(schedule.departureTime);
        return departureTime > now;
      });

      console.log('✅ Available schedules:', availableSchedules.length);

      // Enhanced matching with real-time seat availability
      const matchingTrips = [];

      for (const schedule of availableSchedules) {
        const bus = buses.find(b => b.id === schedule.bus?.id);
        if (!bus) continue;

        // Check route compatibility with origin/destination
        const routeMatch = checkRouteCompatibility(bus, origin, destination);
        if (!routeMatch.compatible) continue;

        // Get real-time seat availability for this specific trip
        const seatAvailability = await getRealTimeSeatAvailability(bus.id, schedule.departureTime);

        if (seatAvailability.available <= 0) continue; // Skip fully booked buses

        // Calculate price based on distance and priority
        const basePrice = calculateSmartPrice(bus, origin, destination, priority);

        // Check time preference compatibility
        const timeCompatibility = checkTimeCompatibility(schedule.departureTime, preferredTime);

        matchingTrips.push({
          schedule: schedule,
          bus: bus,
          routeMatch: routeMatch,
          seatAvailability: seatAvailability,
          price: basePrice,
          timeCompatibility: timeCompatibility,
          departureTime: schedule.departureTime,
          estimatedDuration: schedule.estimatedDurationMinutes || 60
        });
      }

      console.log('🎯 Matching trips found:', matchingTrips.length);

      if (matchingTrips.length === 0) {
        container.innerHTML = `
                  <div style="text-align: center; padding: 3rem; color: var(--gray-medium);">
                      <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; color: var(--gold);"></i>
                      <h3>No Available Trips Found</h3>
                      <p>We couldn't find any available buses for ${origin} → ${destination} at this time.</p>
                      <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-light); border-radius: var(--border-radius);">
                          <h4 style="margin-bottom: 0.5rem;">Suggestions:</h4>
                          <ul style="text-align: left; max-width: 300px; margin: 0 auto;">
                              <li>Try different departure/arrival locations</li>
                              <li>Check back later for new schedules</li>
                              <li>Consider flexible travel times</li>
                          </ul>
                      </div>
                      <button class="btn" onclick="searchBuses()" style="margin-top: 1rem;">
                          <i class="fas fa-search"></i>
                          Browse All Available Buses
                      </button>
                  </div>
              `;
        return;
      }

      // Generate AI-powered suggestions based on priority and preferences
      const suggestions = generateAISuggestions(matchingTrips, origin, destination, preferredTime, priority);

      container.innerHTML = suggestions.map((suggestion, index) => `
              <div class="trip-suggestion ${suggestion.recommended ? 'recommended' : ''}" onclick="selectSuggestionForBooking(${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
                  <div class="suggestion-header">
                      <div>
                          <h4 style="color: var(--gray-dark); margin-bottom: 0.5rem;">
                              ${suggestion.busName} - ${suggestion.busLine}
                              ${suggestion.recommended ? '<span class="suggestion-badge">🏆 AI RECOMMENDED</span>' : ''}
                              ${index === 0 ? '<span class="suggestion-badge" style="background: var(--gold);">BEST MATCH</span>' : ''}
                          </h4>
                          <div style="font-weight: 600; color: var(--gray-dark);">
                              ${origin} → ${destination}
                          </div>
                      </div>
                      <div class="bus-price">${suggestion.price.toLocaleString()} FC</div>
                  </div>

                  <div class="suggestion-details">
                      <div class="detail-item">
                          <i class="fas fa-clock detail-icon"></i>
                          <span>Departs: ${new Date(suggestion.departureTime).toLocaleString()}</span>
                      </div>
                      <div class="detail-item">
                          <i class="fas fa-hourglass-half detail-icon"></i>
                          <span>Duration: ~${suggestion.duration} min</span>
                      </div>
                      <div class="detail-item">
                          <i class="fas fa-users detail-icon" style="color: ${suggestion.availableSeats <= 5 ? 'var(--gold)' : 'var(--green)'};"></i>
                          <span style="color: ${suggestion.availableSeats <= 5 ? 'var(--gold)' : 'var(--green)'};">
                              ${suggestion.availableSeats} seats available
                          </span>
                      </div>
                      <div class="detail-item">
                          <i class="fas fa-route detail-icon"></i>
                          <span>Route: ${suggestion.routeInfo}</span>
                      </div>
                  </div>

                  <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.1);">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                          <div style="font-size: 0.9rem; color: var(--gray-medium);">
                              <strong>AI Insight:</strong> ${suggestion.reason}
                          </div>
                          <div style="display: flex; gap: 0.5rem;">
                              ${suggestion.features.map(feature => `
                                  <span class="bus-status-indicator moving" style="background: rgba(16, 185, 129, 0.1); color: var(--green);">
                                      <i class="fas fa-${feature.icon}"></i>
                                      ${feature.name}
                                  </span>
                              `).join('')}
                          </div>
                      </div>

                      ${suggestion.availableSeats <= 5 ? `
                          <div style="background: rgba(245, 158, 11, 0.1); color: var(--gold); padding: 0.5rem; border-radius: 6px; font-size: 0.85rem; text-align: center;">
                              ⚡ Limited availability - Only ${suggestion.availableSeats} seats left!
                          </div>
                      ` : ''}

                      <div style="margin-top: 1rem; text-align: center;">
                          <button class="btn" onclick="event.stopPropagation(); selectSuggestionForBooking(${JSON.stringify(suggestion).replace(/"/g, '&quot;')})"
                                  style="background: var(--green); padding: 0.5rem 2rem;">
                              <i class="fas fa-ticket-alt"></i>
                              Book This Trip Now
                          </button>
                      </div>
                  </div>
              </div>
          `).join('');

      // Send notification about smart suggestions
      sendPushNotification(
              '🧠 Smart Suggestions Ready',
              `Found ${suggestions.length} optimized trip options for ${origin} → ${destination}`,
              {
                tag: 'smart-suggestions',
                clickAction: () => showSection('smart-planning')
              }
      );

    } catch (error) {
      console.error('Error generating smart suggestions:', error);
      container.innerHTML = `
              <div style="text-align: center; padding: 3rem; color: var(--secondary-red);">
                  <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                  <h3>Error Loading Suggestions</h3>
                  <p>We're having trouble connecting to our smart planning system. Please try again.</p>
                  <button class="btn" onclick="generateSmartTripSuggestions()" style="margin-top: 1rem;">
                      <i class="fas fa-refresh"></i>
                      Retry Smart Planning
                  </button>
              </div>
          `;
    }
  }

  // Check route compatibility
  function checkRouteCompatibility(bus, origin, destination) {
    const routeName = (bus.route?.routeName || '').toLowerCase();
    const routeDescription = (bus.route?.description || '').toLowerCase();
    const busName = (bus.name || '').toLowerCase();

    const originLower = origin.toLowerCase();
    const destinationLower = destination.toLowerCase();

    // Direct route matching
    const directMatch = routeName.includes(originLower) && routeName.includes(destinationLower);

    // Partial matching for common routes
    const partialMatch = routeName.includes('express') || routeName.includes('general') ||
            routeDescription.includes(originLower) || routeDescription.includes(destinationLower) ||
            busName.includes('line');

    // Station compatibility (for common Kinshasa routes)
    const stationCompatibility = checkStationCompatibility(origin, destination);

    return {
      compatible: directMatch || partialMatch || stationCompatibility,
      matchType: directMatch ? 'direct' : partialMatch ? 'partial' : 'station',
      confidence: directMatch ? 1.0 : partialMatch ? 0.7 : stationCompatibility ? 0.5 : 0.2
    };
  }

  // Check station compatibility for Kinshasa routes
  function checkStationCompatibility(origin, destination) {
    const commonRoutes = {
      'Gare Centrale': ['Limete', 'Bandalungwa', 'Matete', 'Kimbanseke'],
      'Limete': ['Gare Centrale', 'Matete', 'Bandalungwa'],
      'Bandalungwa': ['Gare Centrale', 'Limete', 'Matete'],
      'Matete': ['Gare Centrale', 'Limete', 'Ndjili', 'Masina'],
      'Ndjili': ['Matete', 'Masina', 'Kimbanseke'],
      'Masina': ['Ndjili', 'Matete', 'Kimbanseke'],
      'Kimbanseke': ['Gare Centrale', 'Ndjili', 'Masina']
    };

    return commonRoutes[origin]?.includes(destination) || commonRoutes[destination]?.includes(origin) || false;
  }

  // Get real-time seat availability
  async function getRealTimeSeatAvailability(busId, departureTime) {
    try {
      const response = await fetch(`${API_BASE}/tickets/bus/${busId}/taken-seats`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          busId: busId,
          departureTime: departureTime,
          date: new Date(departureTime).toISOString().split('T')[0]
        })
      });

      if (response.ok) {
        const data = await response.json();
        const takenSeats = data.takenSeats?.length || 0;
        const capacity = 50; // Default capacity

        return {
          total: capacity,
          taken: takenSeats,
          available: capacity - takenSeats
        };
      }
    } catch (error) {
      console.error('Error getting seat availability:', error);
    }

    // Fallback
    return { total: 50, taken: 0, available: 50 };
  }

  // Calculate smart pricing
  function calculateSmartPrice(bus, origin, destination, priority) {
    let basePrice = 2500; // Base price

    // Adjust based on priority
    switch(priority) {
      case 'cheapest':
        basePrice *= 0.8; // 20% discount
        break;
      case 'fastest':
        basePrice *= 1.2; // 20% premium
        break;
      case 'comfortable':
        basePrice *= 1.1; // 10% premium
        break;
    }

    // Route-based pricing
    if (bus.route?.totalDistance > 20) {
      basePrice *= 1.3; // Long distance premium
    }

    return Math.round(basePrice);
  }

  // Check time compatibility
  function checkTimeCompatibility(departureTime, preferredTime) {
    if (!preferredTime) return { compatible: true, score: 0.7 };

    const hour = new Date(departureTime).getHours();

    switch(preferredTime) {
      case 'morning':
        return { compatible: hour >= 6 && hour < 12, score: hour >= 6 && hour < 12 ? 1.0 : 0.3 };
      case 'afternoon':
        return { compatible: hour >= 12 && hour < 18, score: hour >= 12 && hour < 18 ? 1.0 : 0.3 };
      case 'evening':
        return { compatible: hour >= 18, score: hour >= 18 ? 1.0 : 0.3 };
      default:
        return { compatible: true, score: 0.7 };
    }
  }

  // Generate AI-powered suggestions
  function generateAISuggestions(matchingTrips, origin, destination, preferredTime, priority) {
    const suggestions = matchingTrips.map(trip => {
      let score = 0;
      let features = [];
      let reason = '';

      // Base scoring
      const timeScore = trip.timeCompatibility.score * 25;
      const availabilityScore = Math.min(trip.seatAvailability.available / 10, 1) * 20;
      const routeScore = trip.routeMatch.confidence * 30;

      score = timeScore + availabilityScore + routeScore;

      // Priority-based scoring
      switch(priority) {
        case 'cheapest':
          score += (3000 - trip.price) / 50; // Lower price = higher score
          reason = `Most economical option at ${trip.price.toLocaleString()} FC`;
          features.push({ name: 'Best Value', icon: 'coins' });
          break;
        case 'fastest':
          score += (120 - trip.estimatedDuration) / 2; // Shorter duration = higher score
          reason = `Fastest route with ${trip.estimatedDuration} minute journey`;
          features.push({ name: 'Express', icon: 'tachometer-alt' });
          break;
        case 'comfortable':
          score += trip.seatAvailability.available * 2; // More seats = higher score
          reason = `Most comfortable with ${trip.seatAvailability.available} available seats`;
          features.push({ name: 'Comfortable', icon: 'couch' });
          break;
        case 'least_crowded':
          score += trip.seatAvailability.available * 3; // Much higher weight for availability
          reason = `Least crowded with ${trip.seatAvailability.available} free seats`;
          features.push({ name: 'Spacious', icon: 'expand-arrows-alt' });
          break;
      }

      // Additional features based on trip characteristics
      if (trip.timeCompatibility.compatible) {
        features.push({ name: 'Perfect Timing', icon: 'clock' });
        score += 15;
      }

      if (trip.seatAvailability.available > 20) {
        features.push({ name: 'High Availability', icon: 'check-circle' });
      } else if (trip.seatAvailability.available <= 5) {
        features.push({ name: 'Limited Seats', icon: 'exclamation-triangle' });
      }

      if (trip.routeMatch.matchType === 'direct') {
        features.push({ name: 'Direct Route', icon: 'route' });
        score += 20;
      }

      const busName = trip.bus.name || `Bus ${trip.bus.id}`;
      const busLine = trip.bus.busLine || `Line ${trip.bus.id}`;

      return {
        scheduleId: trip.schedule.id,
        busId: trip.bus.id,
        busName: busName,
        busLine: busLine,
        price: trip.price,
        departureTime: trip.departureTime,
        duration: trip.estimatedDuration,
        availableSeats: trip.seatAvailability.available,
        routeInfo: trip.bus.route?.routeName || 'Standard Route',
        score: score,
        reason: reason,
        features: features,
        recommended: false,
        tripData: trip
      };
    });

    // Sort by score and mark recommendations
    suggestions.sort((a, b) => b.score - a.score);

    if (suggestions.length > 0) {
      suggestions[0].recommended = true;
      suggestions[0].reason = `🏆 TOP CHOICE: ${suggestions[0].reason}`;
    }

    return suggestions.slice(0, 6); // Return top 6 suggestions
  }

  // Select suggestion for booking
  function selectSuggestionForBooking(suggestion) {
    console.log('🎯 Selected suggestion for booking:', suggestion);

    // Store the selected trip data
    selectedBus = {
      id: suggestion.busId,
      name: suggestion.busName,
      busLine: suggestion.busLine,
      price: suggestion.price,
      departureTime: suggestion.departureTime,
      estimatedDurationMinutes: suggestion.duration,
      availableSeats: suggestion.availableSeats,
      schedule: { id: suggestion.scheduleId },
      ...suggestion.tripData
    };

    // Navigate to booking section with pre-filled data
    showSection('book-ticket');

    // Auto-populate search with selected bus
    setTimeout(() => {
      document.getElementById('routeSearch').value = suggestion.busName;
      searchBuses();
    }, 500);

    showNotification(`Selected ${suggestion.busName} for booking! Redirecting to seat selection...`, 'success');

    // Automatically open seat selection after a moment
    setTimeout(() => {
      selectBusForBooking(selectedBus);
    }, 1500);
  }

  // ENHANCED SEARCH BUSES WITH REAL-TIME SEAT DATA
  async function searchBuses() {
    try {
      console.log('🔍 Enhanced search for available buses...');
      showNotification('Searching for available buses with real-time seat data...', 'info');

      const now = new Date();
      const selectedDate = document.getElementById('departureDate').value;

      // Validate selected date
      if (selectedDate) {
        const selectedDateTime = new Date(selectedDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selectedDateTime < today) {
          showNotification('Please select a future date', 'error');
          document.getElementById('departureDate').value = today.toISOString().split('T')[0];
          return;
        }
      }

      // Fetch schedules and buses
      const [schedules, buses] = await Promise.all([
        fetchData('/schedule-buses'),
        fetchData('/buses')
      ]);

      console.log('✅ Loaded schedules:', schedules.length);
      console.log('✅ Loaded buses:', buses.length);

      // Filter for future schedules only
      const futureSchedules = schedules.filter(schedule => {
        if (!schedule.isActive) return false;
        const departureTime = new Date(schedule.departureTime);
        const timeDiff = departureTime.getTime() - now.getTime();
        return timeDiff > -60000; // 1 minute tolerance
      });

      console.log('✅ Future schedules found:', futureSchedules.length);

      // Enhanced bus matching with real-time seat availability
      const availableBuses = [];

      for (const schedule of futureSchedules) {
        const bus = schedule.bus;
        if (!bus || bus.hasAccident === true) continue;

        // Get real-time seat availability for this specific trip
        let realAvailableSeats = parseInt(bus.capacity) || 50;
        let takenSeatsForThisTrip = [];

        try {
          const response = await fetch(`${API_BASE}/tickets/bus/${bus.id}/taken-seats`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              busId: bus.id,
              departureTime: schedule.departureTime,
              date: new Date(schedule.departureTime).toISOString().split('T')[0]
            })
          });

          if (response.ok) {
            const data = await response.json();
            if (data.takenSeats && Array.isArray(data.takenSeats)) {
              takenSeatsForThisTrip = data.takenSeats;
            } else if (data.tickets && Array.isArray(data.tickets)) {
              takenSeatsForThisTrip = data.tickets
                      .filter(ticket =>
                              ticket.seatNumber &&
                              (ticket.status === 'PAID' || ticket.status === 'BOARDED')
                      )
                      .map(ticket => ticket.seatNumber);
            }

            realAvailableSeats = (parseInt(bus.capacity) || 50) - takenSeatsForThisTrip.length;

            console.log(`🎯 Bus ${bus.id} - Real-time seat data:`, {
              totalCapacity: parseInt(bus.capacity) || 50,
              takenSeats: takenSeatsForThisTrip.length,
              availableSeats: realAvailableSeats
            });
          }
        } catch (error) {
          console.error(`❌ Error fetching seat data for bus ${bus.id}:`, error);
        }

        // Skip fully booked buses
        if (realAvailableSeats <= 0) continue;

        availableBuses.push({
          ...bus,
          schedule: schedule,
          departureTime: schedule.departureTime,
          estimatedDurationMinutes: schedule.estimatedDurationMinutes,
          availableSeats: realAvailableSeats,
          takenSeatsForThisTrip: takenSeatsForThisTrip,
          price: calculateBusPrice(bus)
        });
      }

      console.log('✅ Available buses with real seat data:', availableBuses.length);

      // Apply search filters
      const searchTerm = document.getElementById('routeSearch')?.value?.toLowerCase() || '';
      const sortBy = document.getElementById('sortBy')?.value || 'time';

      let filteredBuses = availableBuses;

      // Enhanced search filtering
      if (searchTerm) {
        filteredBuses = filteredBuses.filter(bus => {
          const busName = (bus.name || '').toLowerCase();
          const busLine = (bus.busLine || '').toLowerCase();
          const routeName = (bus.route?.routeName || '').toLowerCase();
          const startStation = (bus.route?.startStation || '').toLowerCase();
          const endStation = (bus.route?.endStation || '').toLowerCase();

          return busName.includes(searchTerm) ||
                  busLine.includes(searchTerm) ||
                  routeName.includes(searchTerm) ||
                  startStation.includes(searchTerm) ||
                  endStation.includes(searchTerm);
        });
      }

      // Enhanced sorting
      switch (sortBy) {
        case 'price':
          filteredBuses.sort((a, b) => (a.price || 0) - (b.price || 0));
          break;
        case 'time':
          filteredBuses.sort((a, b) => new Date(a.departureTime) - new Date(b.departureTime));
          break;
        case 'capacity':
          filteredBuses.sort((a, b) => (b.availableSeats || 0) - (a.availableSeats || 0));
          break;
        default:
          filteredBuses.sort((a, b) => new Date(a.departureTime) - new Date(b.departureTime));
      }

      displayBuses(filteredBuses);

      // Show results notification
      if (filteredBuses.length === 0) {
        if (availableBuses.length === 0) {
          showNotification('No buses available for the selected criteria. Try selecting a different date.', 'warning');
        } else {
          showNotification('No buses match your search criteria. Try adjusting your filters.', 'warning');
        }
      } else {
        showNotification(`Found ${filteredBuses.length} available buses with real-time seat data`, 'success');
      }

    } catch (error) {
      console.error('❌ Error in enhanced bus search:', error);
      showNotification('Error searching for buses: ' + error.message, 'error');
      displayBuses([]);
    }
  }

  // ENHANCED DISPLAY BUSES WITH BETTER UI
  function displayBuses(buses) {
    const container = document.getElementById('busList');

    if (buses.length === 0) {
      container.innerHTML = `
              <div style="grid-column: 1/-1; text-align: center; padding: 4rem;">
                  <i class="fas fa-bus" style="font-size: 4rem; color: var(--gray-medium); margin-bottom: 1rem;"></i>
                  <h3 style="color: var(--gray-medium); margin-bottom: 0.5rem;">No buses available</h3>
                  <p style="color: var(--gray-medium);">Try adjusting your search criteria or check back later.</p>
                  <button class="btn" onclick="searchBuses()" style="margin-top: 1rem;">
                      <i class="fas fa-refresh"></i>
                      Refresh Search
                  </button>
              </div>
          `;
      return;
    }

    container.innerHTML = buses.map(bus => {
      const departureTime = new Date(bus.departureTime);
      const now = new Date();
      const hoursUntilDeparture = Math.ceil((departureTime - now) / (1000 * 60 * 60));

      // Enhanced route information
      let origin = bus.route?.startStation || 'Departure Station';
      let destination = bus.route?.endStation || 'Arrival Station';
      let routeName = bus.route?.routeName || 'Standard Route';

      const duration = bus.estimatedDurationMinutes || bus.route?.estimatedDuration || 60;

      // Enhanced status indicators
      let statusHtml = '';
      let statusClass = 'moving';

      if (bus.hasAccident) {
        statusHtml = '🚨 Issue Reported';
        statusClass = 'accident';
      } else if (bus.isStopped) {
        statusHtml = '⏸️ At Station';
        statusClass = 'stopped';
      } else {
        statusHtml = '🚌 Ready to Depart';
        statusClass = 'moving';
      }

      // Time until departure indicator
      let timeIndicator = '';
      if (hoursUntilDeparture <= 24) {
        const urgencyColor = hoursUntilDeparture <= 2 ? 'var(--gold)' : 'var(--green)';
        timeIndicator = `
                  <div style="background: rgba(16, 185, 129, 0.1); color: ${urgencyColor}; padding: 0.5rem; border-radius: 8px; margin: 1rem 0; text-align: center; font-weight: 600;">
                      🕒 Departs in ${hoursUntilDeparture} hour${hoursUntilDeparture !== 1 ? 's' : ''}
                      ${hoursUntilDeparture <= 2 ? ' - Book Soon!' : ''}
                  </div>
              `;
      }

      // Enhanced seat availability indicator
      let seatsColor = 'var(--green)';
      let seatsText = `${bus.availableSeats} seats left`;
      let urgencyIndicator = '';

      if (bus.availableSeats <= 0) {
        seatsColor = 'var(--secondary-red)';
        seatsText = 'Fully Booked';
      } else if (bus.availableSeats <= 5) {
        seatsColor = 'var(--gold)';
        seatsText = `Only ${bus.availableSeats} seats left`;
        urgencyIndicator = '⚡';
      } else if (bus.availableSeats <= 10) {
        seatsColor = 'var(--gold)';
        urgencyIndicator = '⏰';
      }

      return `
              <div class="bus-card" onclick="selectBusForBooking(${JSON.stringify(bus).replace(/"/g, '&quot;')})">
                  <div class="bus-header">
                      <div class="bus-name">${bus.name || 'Bus #' + bus.id}</div>
                      <div class="bus-line">${bus.busLine || 'Line ' + bus.id}</div>
                  </div>

                  <div class="bus-route">
                      <span>${origin}</span>
                      <i class="fas fa-arrow-right" style="color: var(--primary-blue);"></i>
                      <span>${destination}</span>
                  </div>

                  <div class="bus-info">
                      <div class="bus-info-item">
                          <i class="fas fa-clock"></i>
                          <span>${departureTime.toLocaleString()}</span>
                      </div>
                      <div class="bus-info-item">
                          <i class="fas fa-hourglass-half"></i>
                          <span>~${duration} min</span>
                      </div>
                      <div class="bus-info-item">
                          <i class="fas fa-users" style="color: ${seatsColor};"></i>
                          <span style="color: ${seatsColor}; font-weight: 600;">${urgencyIndicator} ${seatsText}</span>
                      </div>
                      <div class="bus-info-item">
                          <i class="fas fa-route"></i>
                          <span>${routeName}</span>
                      </div>
                  </div>

                  ${timeIndicator}

                  <!-- Real-time availability display -->
                  <div style="background: rgba(0,0,0,0.05); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                          <span style="font-weight: 600;">Real-time Availability:</span>
                          <span style="color: ${seatsColor}; font-weight: bold;">${bus.availableSeats}/${bus.capacity || 50}</span>
                      </div>
                      <div class="progress-bar" style="height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                          <div class="progress-fill" style="background: ${seatsColor}; height: 100%; width: ${(bus.availableSeats / (bus.capacity || 50)) * 100}%; transition: width 0.3s ease;"></div>
                      </div>
                      ${bus.takenSeatsForThisTrip && bus.takenSeatsForThisTrip.length > 0 ? `
                          <div style="margin-top: 0.25rem; color: var(--gray-medium); font-size: 0.8rem;">
                              ${bus.takenSeatsForThisTrip.length} seats already booked for this departure
                          </div>
                      ` : ''}
                  </div>

                  <div style="margin: 1rem 0;">
                      <div class="bus-status-indicator ${statusClass}">
                          ${statusHtml}
                      </div>
                  </div>

                  <div class="bus-price">${bus.price.toLocaleString()} FC</div>

                  <button class="btn ${bus.availableSeats <= 0 ? 'btn-disabled' : bus.availableSeats <= 5 ? 'btn-warning' : ''}"
                          onclick="event.stopPropagation(); selectBusForBooking(${JSON.stringify(bus).replace(/"/g, '&quot;')})"
                          ${bus.availableSeats <= 0 ? 'disabled' : ''}>
                      <i class="fas fa-ticket-alt"></i>
                      ${bus.availableSeats <= 0 ? 'Fully Booked' : bus.availableSeats <= 5 ? 'Book Now (Limited!)' : 'Book Now'}
                  </button>
              </div>
          `;
    }).join('');
  }

  // ENHANCED SELECT BUS FOR BOOKING
  async function selectBusForBooking(busData) {
    try {
      // Validate departure time
      const departureTime = new Date(busData.departureTime);
      const now = new Date();

      if (departureTime <= now) {
        showNotification('This bus has already departed. Please refresh and select another bus.', 'error');
        searchBuses();
        return;
      }

      // Check real-time availability
      if (busData.availableSeats <= 0) {
        showNotification('This bus is now fully booked. Please select another bus.', 'error');
        searchBuses();
        return;
      }

      selectedBus = busData;
      console.log('✅ Selected bus for booking:', selectedBus);

      // Generate seat layout with real-time data
      await generateEnhancedSeatLayout(selectedBus);
      openModal('seatModal');

      // Send selection notification
      sendPushNotification(
              '🎯 Bus Selected',
              `Selected ${selectedBus.name} with ${selectedBus.availableSeats} seats available`,
              {
                tag: 'bus-selected'
              }
      );

    } catch (error) {
      console.error('❌ Error selecting bus:', error);
      showNotification('Error loading bus details: ' + error.message, 'error');
    }
  }

  // ENHANCED SEAT LAYOUT GENERATION
  async function generateEnhancedSeatLayout(bus) {
    console.log('🚌 Generating enhanced seat layout for bus:', bus);

    currentBusData = bus;
    const container = document.getElementById('seatsContainer');
    const totalSeats = bus.capacity || 50;
    let takenSeatNumbers = bus.takenSeatsForThisTrip || [];

    // Refresh seat data to ensure accuracy
    try {
      console.log('📡 Refreshing seat data for accuracy...');

      const response = await fetch(`${API_BASE}/tickets/bus/${bus.id}/taken-seats`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          busId: bus.id,
          departureTime: bus.departureTime,
          date: new Date(bus.departureTime).toISOString().split('T')[0]
        })
      });

      if (response.ok) {
        const data = await response.json();
        if (data.takenSeats && Array.isArray(data.takenSeats)) {
          takenSeatNumbers = data.takenSeats;
        } else if (data.tickets && Array.isArray(data.tickets)) {
          takenSeatNumbers = data.tickets
                  .filter(ticket =>
                          ticket.seatNumber &&
                          (ticket.status === 'PAID' || ticket.status === 'BOARDED')
                  )
                  .map(ticket => ticket.seatNumber);
        }

        console.log('🎫 Latest taken seats:', takenSeatNumbers);
      }

    } catch (error) {
      console.error('❌ Error refreshing seat data:', error);
    }

    // Create enhanced seat layout
    container.innerHTML = '';
    availableSeatsCount = totalSeats - takenSeatNumbers.length;

    console.log(`🎯 Creating ${totalSeats} seats (${takenSeatNumbers.length} taken, ${availableSeatsCount} available)`);

    // Update modal title with real-time info
    const modalTitle = document.querySelector('#seatModal .modal-title');
    if (modalTitle) {
      modalTitle.innerHTML = `
              Select Your Seat - ${bus.name}
              <div style="font-size: 0.8rem; font-weight: normal; color: var(--gray-medium); margin-top: 0.25rem;">
                  ${availableSeatsCount} of ${totalSeats} seats available
              </div>
          `;
    }

    for (let i = 1; i <= totalSeats; i++) {
      const seatNumber = String(i).padStart(2, '0');
      const seat = document.createElement('div');
      seat.className = 'seat';
      seat.textContent = seatNumber;
      seat.dataset.seatNumber = seatNumber;
      seat.dataset.busId = bus.id;
      seat.dataset.departureTime = bus.departureTime;

      const isTaken = takenSeatNumbers.includes(seatNumber);

      if (isTaken) {
        // Taken seat - gray and disabled
        seat.classList.add('taken');
        seat.setAttribute('data-taken', 'true');
        seat.style.cssText = `
                  width: 50px;
                  height: 50px;
                  background: #9CA3AF !important;
                  border: 2px solid #9CA3AF !important;
                  color: white !important;
                  border-radius: 8px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                  cursor: not-allowed !important;
                  pointer-events: none !important;
                  font-weight: 600;
                  font-size: 0.9rem;
                  user-select: none;
                  opacity: 0.8;
              `;

        seat.title = `Seat ${seatNumber} is taken`;

        // Add red X icon
        setTimeout(() => {
          const icon = document.createElement('div');
          icon.innerHTML = '✖';
          icon.style.cssText = `
                      position: absolute;
                      top: -5px;
                      right: -5px;
                      background: #DC2626;
                      color: white;
                      border-radius: 50%;
                      width: 18px;
                      height: 18px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 10px;
                      border: 2px solid white;
                      pointer-events: none;
                  `;
          seat.appendChild(icon);
        }, 50);

      } else {
        // Available seat - green
        seat.classList.add('available');
        seat.setAttribute('data-taken', 'false');
        seat.style.cssText = `
                  width: 50px;
                  height: 50px;
                  background: white !important;
                  border: 2px solid var(--green) !important;
                  color: var(--green) !important;
                  border-radius: 8px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  position: relative;
                  cursor: pointer;
                  font-weight: 600;
                  font-size: 0.9rem;
                  transition: all 0.3s ease;
              `;

        seat.title = `Select seat ${seatNumber} (Available)`;

        // Add click event
        seat.addEventListener('click', () => selectSeat(seatNumber));

        // Add hover effects
        seat.addEventListener('mouseenter', () => {
          if (!seat.classList.contains('selected')) {
            seat.style.borderColor = 'var(--primary-blue)';
            seat.style.background = 'rgba(30, 64, 175, 0.1)';
            seat.style.transform = 'scale(1.05)';
          }
        });

        seat.addEventListener('mouseleave', () => {
          if (!seat.classList.contains('selected')) {
            seat.style.borderColor = 'var(--green)';
            seat.style.background = 'white';
            seat.style.transform = 'scale(1)';
          }
        });
      }

      container.appendChild(seat);
    }

    // Reset selection UI
    const proceedButton = document.getElementById('proceedToPayment');
    if (proceedButton) {
      proceedButton.disabled = true;
    }

    const selectedSeatDisplay = document.getElementById('selectedSeatDisplay');
    if (selectedSeatDisplay) {
      selectedSeatDisplay.textContent = 'None';
    }

    // Add real-time availability indicator
    const availabilityIndicator = document.createElement('div');
    availabilityIndicator.innerHTML = `
          <div style="text-align: center; margin: 1rem 0; padding: 1rem; background: var(--gray-light); border-radius: 8px;">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">Real-time Availability</div>
              <div class="progress-bar" style="margin: 0.5rem 0;">
                  <div class="progress-fill" style="width: ${(availableSeatsCount / totalSeats) * 100}%;"></div>
              </div>
              <div style="color: var(--gray-medium); font-size: 0.9rem;">
                  ${availableSeatsCount} of ${totalSeats} seats available for this departure
              </div>
          </div>
      `;
    container.parentNode.insertBefore(availabilityIndicator, container.parentNode.querySelector('.seat-legend'));

    console.log(`✅ Enhanced seat layout generated successfully`);

    if (takenSeatNumbers.length > 0) {
      showNotification(`${takenSeatNumbers.length} seats are already booked for this departure`, 'info');
    }
  }

  // ENHANCED SEAT SELECTION
  async function selectSeat(seatNumber) {
    if (!currentBusData) {
      console.error('❌ No current bus data available');
      showNotification('Error: No bus selected', 'error');
      return;
    }

    console.log(`🎯 Attempting to select seat: ${seatNumber}`);

    const seatElement = document.querySelector(`[data-seat-number="${seatNumber}"]`);
    if (!seatElement) {
      console.error(`❌ Seat element not found: ${seatNumber}`);
      return;
    }

    // Strict validation - if seat is taken
    if (seatElement.classList.contains('taken') ||
            seatElement.getAttribute('data-taken') === 'true') {

      console.warn(`🚫 Seat ${seatNumber} is TAKEN - blocking selection`);
      showNotification(`Seat ${seatNumber} is already taken for this trip.`, 'error');

      // Shake animation for error feedback
      seatElement.style.animation = 'shake 0.5s ease-in-out';
      setTimeout(() => {
        seatElement.style.animation = '';
      }, 500);

      return;
    }

    // If already selected, ignore
    if (seatElement.classList.contains('selected')) {
      console.log(`ℹ️ Seat ${seatNumber} already selected`);
      return;
    }

    // Server-side validation for extra safety
    try {
      const response = await fetch(`${API_BASE}/tickets/validate-seat`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          busId: currentBusData.id,
          seatNumber: seatNumber,
          departureTime: currentBusData.departureTime
        })
      });

      if (response.ok) {
        const validation = await response.json();
        if (!validation.available) {
          console.warn(`🚫 Server says seat ${seatNumber} is not available`);
          showNotification(validation.message || `Seat ${seatNumber} is not available.`, 'error');
          markSeatAsTaken(seatNumber);
          return;
        }
      }
    } catch (error) {
      console.error('❌ Error validating seat:', error);
      // Continue even if validation fails
    }

    // Deselect previous seats
    const previouslySelected = document.querySelectorAll('.seat.selected');
    previouslySelected.forEach(seat => {
      seat.classList.remove('selected');
      seat.classList.add('available');
      seat.style.cssText = `
              width: 50px;
              height: 50px;
              background: white !important;
              border: 2px solid var(--green) !important;
              color: var(--green) !important;
              border-radius: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
              cursor: pointer;
              font-weight: 600;
              font-size: 0.9rem;
              transition: all 0.3s ease;
          `;
      // Remove check icon
      const icon = seat.querySelector('div');
      if (icon) icon.remove();
    });

    // Select new seat
    seatElement.classList.remove('available');
    seatElement.classList.add('selected');

    // Blue style for selection
    seatElement.style.cssText = `
          width: 50px;
          height: 50px;
          background: var(--primary-blue) !important;
          border: 2px solid var(--primary-blue) !important;
          color: white !important;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          cursor: default;
          font-weight: 600;
          font-size: 0.9rem;
          transform: scale(1.1);
          box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
      `;

    // Add green check icon
    const checkIcon = document.createElement('div');
    checkIcon.innerHTML = '✓';
    checkIcon.style.cssText = `
          position: absolute;
          top: -5px;
          right: -5px;
          background: var(--green);
          color: white;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          border: 2px solid white;
          font-weight: bold;
      `;
    seatElement.appendChild(checkIcon);

    selectedSeat = seatNumber;

    // Update UI
    const selectedSeatDisplay = document.getElementById('selectedSeatDisplay');
    const proceedButton = document.getElementById('proceedToPayment');

    if (selectedSeatDisplay) {
      selectedSeatDisplay.textContent = seatNumber;
      selectedSeatDisplay.style.color = 'var(--primary-blue)';
      selectedSeatDisplay.style.fontWeight = 'bold';
    }

    if (proceedButton) {
      proceedButton.disabled = false;
      proceedButton.style.background = 'var(--green)';
    }

    console.log(`✅ Successfully selected seat ${seatNumber}`);
    showNotification(`Seat ${seatNumber} selected successfully!`, 'success');

    // Send selection notification
    sendPushNotification(
            '💺 Seat Selected',
            `Seat ${seatNumber} reserved for ${currentBusData.name}. Proceed to payment to confirm.`,
            {
              tag: 'seat-selected'
            }
    );
  }

  // Mark seat as taken (for real-time updates)
  function markSeatAsTaken(seatNumber) {
    const seatElement = document.querySelector(`[data-seat-number="${seatNumber}"]`);
    if (seatElement) {
      seatElement.classList.remove('available', 'selected');
      seatElement.classList.add('taken');
      seatElement.style.pointerEvents = 'none';
      seatElement.setAttribute('data-taken', 'true');
      seatElement.removeEventListener('click', () => selectSeat(seatNumber));

      console.log(`🚫 Seat ${seatNumber} marked as taken`);
    }
  }

  // Proceed to payment
  function proceedToPayment() {
    if (!selectedSeat || !selectedBus) {
      showNotification('Please select a seat', 'error');
      return;
    }

    // Final validation
    const seatElement = document.querySelector(`[data-seat-number="${selectedSeat}"]`);
    if (seatElement.classList.contains('taken')) {
      showNotification('This seat was just taken. Please select another seat.', 'error');
      generateEnhancedSeatLayout(selectedBus);
      return;
    }

    // Validate departure time
    const departureTime = new Date(selectedBus.departureTime);
    const now = new Date();

    if (departureTime <= now) {
      showNotification('This bus has already departed. Please select another bus.', 'error');
      closeModal('seatModal');
      searchBuses();
      return;
    }

    const origin = getRouteOrigin(selectedBus);
    const destination = getRouteDestination(selectedBus);
    const basePrice = selectedBus.price || calculateBusPrice(selectedBus);

    document.getElementById('tripSummary').innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div><strong>Bus:</strong> ${selectedBus.name} (${selectedBus.busLine})</div>
              <div><strong>Seat:</strong> ${selectedSeat}</div>
              <div><strong>Route:</strong> ${origin} → ${destination}</div>
              <div><strong>Departure:</strong> ${new Date(selectedBus.departureTime).toLocaleString()}</div>
              <div><strong>Duration:</strong> ${selectedBus.estimatedDurationMinutes || selectedBus.route?.estimatedDuration || 60} minutes</div>
              <div><strong>Base Price:</strong> ${basePrice.toLocaleString()} FC</div>
          </div>
      `;

    document.getElementById('passengerName').value = `${currentUser.firstName} ${currentUser.lastName}`;
    document.getElementById('passengerPhone').value = currentUser.phoneNumber || '';

    updateTotalPrice();
    closeModal('seatModal');
    openModal('paymentModal');
  }

  // ENHANCED PAYMENT HANDLING WITH REAL-TIME SEAT UPDATES
  async function handlePayment(e) {
    e.preventDefault();

    if (!selectedBus || !selectedSeat) {
      showNotification('Invalid booking data', 'error');
      return;
    }

    // Final validation
    const departureTime = new Date(selectedBus.departureTime);
    const now = new Date();

    if (departureTime <= now) {
      showNotification('This bus has already departed. Booking cancelled.', 'error');
      closeModal('paymentModal');
      searchBuses();
      return;
    }

    const submitBtn = document.getElementById('confirmPaymentBtn');
    const originalText = submitBtn.innerHTML;

    try {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading"></div> Processing Payment...';

      const passengerName = document.getElementById('passengerName').value.trim();
      const passengerPhone = document.getElementById('passengerPhone').value.trim();

      // Validation
      if (!passengerName || passengerName.length < 2) {
        throw new Error('Please enter a valid passenger name');
      }

      if (!passengerPhone || passengerPhone.length < 10) {
        throw new Error('Please enter a valid phone number');
      }

      const formData = {
        passengerId: currentUser.id,
        firstName: currentUser.firstName,
        lastName: currentUser.lastName,
        origin: getRouteOrigin(selectedBus),
        destination: getRouteDestination(selectedBus),
        departureTime: selectedBus.departureTime,
        busId: selectedBus.id,
        scheduleId: selectedBus.schedule?.id,
        seatNumber: selectedSeat,
        hasLuggage: document.getElementById('hasLuggage').checked,
        luggageWeight: document.getElementById('hasLuggage').checked ?
                parseFloat(document.getElementById('luggageWeight').value) || 0 : 0,
        passengerName: passengerName,
        passengerPhone: passengerPhone
      };

      console.log('🎫 Creating ticket with enhanced data:', formData);

      const response = await fetch(`${API_BASE}/tickets`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
        },
        body: JSON.stringify(formData)
      });

      if (!response.ok) {
        const errorData = await response.text();
        throw new Error(errorData || 'Failed to create ticket');
      }

      const result = await response.json();
      console.log('✅ Ticket created successfully:', result);

      if (result.ticket && selectedBus) {
        result.ticket.bus = selectedBus;
      }

      // IMMEDIATE REAL-TIME UPDATE: Mark seat as taken locally
      const seatElement = document.querySelector(`[data-seat-number="${selectedSeat}"]`);
      if (seatElement) {
        markSeatAsTaken(selectedSeat);
      }

      // Update available seats count immediately
      if (currentBusData) {
        currentBusData.availableSeats = Math.max(0, currentBusData.availableSeats - 1);
        availableSeatsCount = Math.max(0, availableSeatsCount - 1);
      }

      // Broadcast seat update to all related UI elements
      updateSeatsLeftDisplay(availableSeatsCount, selectedBus.id);

      closeModal('paymentModal');

      // Reset selections
      selectedBus = null;
      selectedSeat = null;

      showNotification('✅ Ticket booked successfully! Seat confirmed immediately.', 'success');

      // Refresh data
      await Promise.all([
        loadDashboardData(),
        loadMyTrips(),
        searchBuses() // Refresh bus list with updated seat counts
      ]);

      showTicketConfirmation(result.ticket);

      // Enhanced booking notification
      sendPushNotification(
              '🎫 Booking Confirmed!',
              `Your seat is secured! ${result.ticket.origin} → ${result.ticket.destination}, Seat ${result.ticket.seatNumber}`,
              {
                tag: 'booking-confirmed',
                clickAction: () => showSection('my-trips')
              }
      );

    } catch (error) {
      console.error('❌ Payment error:', error);
      showNotification('Payment failed: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }

  // Update seats left display for real-time updates
  function updateSeatsLeftDisplay(seatsLeft, busId) {
    // Update all seat count displays for this specific bus
    const seatsLeftElements = document.querySelectorAll('[data-seats-left]');

    seatsLeftElements.forEach(element => {
      const elementBusId = element.getAttribute('data-bus-id');
      if (elementBusId && elementBusId !== busId.toString()) {
        return; // Skip if not for this bus
      }

      // Update text and color
      if (seatsLeft === 0) {
        element.textContent = 'Fully Booked';
        element.style.color = '#dc3545';
        element.classList.add('full');
      } else if (seatsLeft <= 5) {
        element.textContent = `Only ${seatsLeft} seats left`;
        element.style.color = '#ffc107';
        element.classList.add('low');
      } else {
        element.textContent = `${seatsLeft} seats left`;
        element.style.color = '#28a745';
      }

      element.classList.add('seats-counter');
    });

    console.log(`📊 Updated seats display for bus ${busId}: ${seatsLeft} seats`);
  }

  // Show ticket confirmation
  function showTicketConfirmation(ticket) {
    const price = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);

    const confirmationHtml = `
          <div style="text-align: center; padding: 2rem; background: var(--gray-light); border-radius: var(--border-radius); margin: 2rem 0;">
              <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--green); margin-bottom: 1rem;"></i>
              <h3 style="color: var(--green); margin-bottom: 1rem;">Booking Confirmed!</h3>
              <div style="background: var(--white); padding: 1.5rem; border-radius: var(--border-radius); margin: 1rem 0;">
                  <p><strong>Ticket Number:</strong> ${ticket.ticketNumber}</p>
                  <p><strong>Route:</strong> ${ticket.origin} → ${ticket.destination}</p>
                  <p><strong>Departure:</strong> ${new Date(ticket.departureTime).toLocaleString()}</p>
                  <p><strong>Seat:</strong> ${ticket.seatNumber}</p>
                  <p><strong>Amount Paid:</strong> ${price.toLocaleString()} FC</p>
                  <p style="color: var(--gray-medium); margin-top: 1rem;">
                      Your seat is immediately reserved. Download your ticket with QR code below.
                  </p>
              </div>
              <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                  <button class="btn btn-success" onclick="downloadTicketFromConfirmation(${ticket.id}); this.closest('.modal').remove();">
                      <i class="fas fa-download"></i>
                      Download Ticket
                  </button>
                  <button class="btn" onclick="this.closest('.modal').remove(); showSection('my-trips')">
                      <i class="fas fa-route"></i>
                      View My Trips
                  </button>
              </div>
          </div>
      `;

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
          <div class="modal-content">
              <div class="modal-header">
                  <h2 class="modal-title">Booking Confirmed</h2>
                  <button class="close-btn" onclick="this.closest('.modal').remove()">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
              ${confirmationHtml}
          </div>
      `;

    document.body.appendChild(modal);

    setTimeout(() => {
      if (modal.parentNode) {
        modal.remove();
      }
    }, 20000);
  }

  // Download ticket from confirmation
  function downloadTicketFromConfirmation(ticketId) {
    const ticket = userTickets.find(t => t.id === ticketId);
    if (ticket) {
      downloadTicket(ticketId);
    } else {
      // Refresh tickets and try again
      loadUserTickets().then(() => {
        const refreshedTicket = userTickets.find(t => t.id === ticketId);
        if (refreshedTicket) {
          downloadTicket(ticketId);
        }
      });
    }
  }

  // Load my trips with enhanced filtering
  async function loadMyTrips() {
    try {
      await loadUserTickets();

      const container = document.getElementById('tripsList');
      const statusFilter = document.getElementById('tripStatusFilter').value;

      let filteredTickets = userTickets;

      if (statusFilter) {
        const now = new Date();
        filteredTickets = userTickets.filter(ticket => {
          const departureTime = new Date(ticket.departureTime);

          switch (statusFilter) {
            case 'upcoming':
              return departureTime > now && ticket.status === 'PAID';
            case 'active':
              return Math.abs(departureTime - now) < 2 * 60 * 60 * 1000;
            case 'completed':
              return departureTime <= now || ticket.status === 'BOARDED';
            case 'cancelled':
              return ticket.status === 'CANCELLED';
            default:
              return true;
          }
        });
      }

      if (filteredTickets.length === 0) {
        container.innerHTML = `
                  <div style="text-align: center; padding: 4rem;">
                      <i class="fas fa-route" style="font-size: 4rem; color: var(--gray-medium); margin-bottom: 1rem;"></i>
                      <h3 style="color: var(--gray-medium); margin-bottom: 0.5rem;">No trips found</h3>
                      <p style="color: var(--gray-medium);">Book your first trip to get started!</p>
                      <button class="btn" onclick="showSection('book-ticket')" style="margin-top: 1rem;">
                          <i class="fas fa-plus"></i>
                          Book a Trip
                      </button>
                  </div>
              `;
        return;
      }

      filteredTickets.sort((a, b) => new Date(b.departureTime) - new Date(a.departureTime));

      container.innerHTML = filteredTickets.map(ticket => {
        const price = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        const departureTime = new Date(ticket.departureTime);
        const now = new Date();

        let status = 'completed';
        let statusText = 'Completed';

        if (departureTime > now && ticket.status === 'PAID') {
          status = 'upcoming';
          statusText = 'Upcoming';
        } else if (Math.abs(departureTime - now) < 2 * 60 * 60 * 1000) {
          status = 'active';
          statusText = 'Active';
        }

        const busName = ticket.bus ? ticket.bus.name : 'N/A';

        return `
                  <div class="trip-card">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                          <div>
                              <h4 style="color: var(--gray-dark); margin-bottom: 0.5rem;">
                                  ${ticket.origin} → ${ticket.destination}
                              </h4>
                              <p style="color: var(--gray-medium); font-size: 0.9rem;">
                                  Ticket #${ticket.ticketNumber}
                              </p>
                          </div>
                          <div class="trip-status ${status}">${statusText}</div>
                      </div>

                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                          <div>
                              <strong>Bus:</strong> ${busName}
                          </div>
                          <div>
                              <strong>Seat:</strong> ${ticket.seatNumber || 'Not assigned'}
                          </div>
                          <div>
                              <strong>Departure:</strong> ${departureTime.toLocaleString()}
                          </div>
                          <div>
                              <strong>Price:</strong> ${price.toLocaleString()} FC
                          </div>
                      </div>

                      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                          ${status === 'upcoming' || status === 'active' ? `
                              <button class="btn btn-success" onclick="trackTrip(${ticket.id})">
                                  <i class="fas fa-map-marker-alt"></i>
                                  Track Bus
                              </button>
                          ` : ''}
                          <button class="btn btn-secondary" onclick="downloadTicket(${ticket.id})">
                              <i class="fas fa-download"></i>
                              Download Ticket
                          </button>
                          ${status === 'completed' && !userRatings.find(r => r.ticketId === ticket.id) ? `
                              <button class="btn btn-warning" onclick="openRatingModal(${ticket.id})">
                                  <i class="fas fa-star"></i>
                                  Rate Trip
                              </button>
                          ` : ''}
                      </div>
                  </div>
              `;
      }).join('');

    } catch (error) {
      console.error('❌ Error loading trips:', error);
      showNotification('Error loading trips', 'error');
    }
  }

  // Enhanced download ticket function
  async function downloadTicket(ticketId) {
    const ticket = userTickets.find(t => t.id === ticketId);
    if (!ticket) {
      showNotification('Ticket not found', 'error');
      return;
    }

    currentTicketForDownload = ticket;
    await populateTicketPreview(ticket);
    openModal('ticketDownloadModal');
  }

  // Populate ticket preview with enhanced design and QR code
  async function populateTicketPreview(ticket) {
    const price = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    const busName = ticket.bus ? ticket.bus.name : 'N/A';
    const busLine = ticket.bus ? ticket.bus.busLine : 'N/A';

    // Update preview content
    document.getElementById('previewPassengerName').innerHTML = `<strong>Name:</strong> ${currentUser.firstName} ${currentUser.lastName}`;
    document.getElementById('previewPassengerPhone').innerHTML = `<strong>Phone:</strong> ${currentUser.phoneNumber || 'N/A'}`;
    document.getElementById('previewTicketNumber').innerHTML = `<strong>Ticket #:</strong> ${ticket.ticketNumber}`;

    document.getElementById('previewRoute').innerHTML = `<strong>Route:</strong> ${ticket.origin} → ${ticket.destination}`;
    document.getElementById('previewDeparture').innerHTML = `<strong>Departure:</strong> ${new Date(ticket.departureTime).toLocaleString()}`;
    document.getElementById('previewSeat').innerHTML = `<strong>Seat:</strong> ${ticket.seatNumber}`;

    document.getElementById('previewBusName').innerHTML = `<strong>Bus:</strong> ${busName}`;
    document.getElementById('previewBusLine').innerHTML = `<strong>Line:</strong> ${busLine}`;
    document.getElementById('previewStatus').innerHTML = `<strong>Status:</strong> ${ticket.status}`;

    document.getElementById('previewPrice').innerHTML = `<strong>Total Paid:</strong> ${price.toLocaleString()} FC`;
    document.getElementById('previewIssueDate').innerHTML = `<strong>Issued:</strong> ${new Date(ticket.issuedAt || Date.now()).toLocaleDateString()}`;

    // Generate enhanced QR code
    const qrContainer = document.getElementById('previewQRCode');
    const qrData = JSON.stringify({
      ticketId: ticket.id,
      ticketNumber: ticket.ticketNumber,
      passengerName: `${currentUser.firstName} ${currentUser.lastName}`,
      route: `${ticket.origin}-${ticket.destination}`,
      seat: ticket.seatNumber,
      departure: ticket.departureTime,
      busId: ticket.busId,
      status: ticket.status,
      issuer: 'IMAS',
      timestamp: new Date().toISOString()
    });

    if (typeof QRCode !== 'undefined') {
      try {
        qrContainer.innerHTML = '';
        await new Promise((resolve, reject) => {
          QRCode.toCanvas(qrData, {
            width: 120,
            margin: 1,
            color: {
              dark: '#1a4875',
              light: '#FFFFFF'
            },
            errorCorrectionLevel: 'H'
          }, (error, canvas) => {
            if (error) {
              reject(error);
              return;
            }
            qrContainer.appendChild(canvas);
            resolve();
          });
        });
        console.log('✅ Enhanced QR code generated successfully');
      } catch (error) {
        console.error('QR generation error:', error);
        qrContainer.innerHTML = `
                  <div style="width: 120px; height: 120px; background: var(--gray-light); display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                      <span style="font-size: 0.8rem; text-align: center;">QR Code<br>Unavailable</span>
                  </div>
              `;
      }
    } else {
      qrContainer.innerHTML = `
              <div style="width: 120px; height: 120px; background: var(--gray-light); display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                  <span style="font-size: 0.8rem; text-align: center;">QR Code<br>Loading...</span>
              </div>
          `;
    }
  }

  // Enhanced PDF download with matching design
  async function downloadTicketAsPDF() {
    if (!currentTicketForDownload) {
      showNotification('No ticket selected for download', 'error');
      return;
    }

    if (typeof window.jspdf === 'undefined') {
      showNotification('PDF library not available', 'error');
      return;
    }

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const ticket = currentTicketForDownload;

      const price = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      const busName = ticket.bus ? ticket.bus.name : 'N/A';
      const busLine = ticket.bus ? ticket.bus.busLine : 'N/A';

      // Enhanced ticket design matching the preview
      const ticketWidth = 180;
      const ticketHeight = 260;
      const startX = 15;
      const startY = 15;

      // Main ticket background with gradient effect
      doc.setFillColor(26, 72, 117);
      doc.roundedRect(startX, startY, ticketWidth, ticketHeight, 8, 8, 'F');

      // Header section with logo
      doc.setFillColor(245, 166, 35);
      doc.circle(startX + 30, startY + 30, 20, 'F');

      // Logo - Bus emoji simulation
      doc.setTextColor(26, 72, 117);
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('BUS', startX + 20, startY + 35);

      // Company name
      doc.setTextColor(245, 166, 35);
      doc.setFontSize(32);
      doc.setFont('helvetica', 'bold');
      doc.text('IMAS', startX + 60, startY + 30);

      doc.setTextColor(255, 255, 255);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.text('Intelligent Management & Analytics System', startX + 60, startY + 45);

      // White content section
      doc.setFillColor(255, 255, 255);
      doc.roundedRect(startX + 10, startY + 60, ticketWidth - 20, 140, 6, 6, 'F');

      // Ticket details in organized sections
      let yPos = startY + 80;

      // Passenger Information Section
      doc.setTextColor(26, 72, 117);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('PASSENGER INFORMATION', startX + 20, yPos);

      doc.setTextColor(0, 0, 0);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      yPos += 10;
      doc.text(`Name: ${currentUser.firstName} ${currentUser.lastName}`, startX + 20, yPos);
      yPos += 8;
      doc.text(`Phone: ${currentUser.phoneNumber}`, startX + 20, yPos);
      yPos += 8;
      doc.text(`Ticket #: ${ticket.ticketNumber}`, startX + 20, yPos);

      yPos += 15;

      // Journey Details Section
      doc.setTextColor(26, 72, 117);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('JOURNEY DETAILS', startX + 20, yPos);

      doc.setTextColor(0, 0, 0);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      yPos += 10;
      doc.text(`Route: ${ticket.origin} → ${ticket.destination}`, startX + 20, yPos);
      yPos += 8;
      doc.text(`Departure: ${new Date(ticket.departureTime).toLocaleString()}`, startX + 20, yPos);
      yPos += 8;
      doc.text(`Bus: ${busName} (${busLine})`, startX + 20, yPos);
      yPos += 8;
      doc.text(`Seat: ${ticket.seatNumber}`, startX + 20, yPos);

      yPos += 15;

      // Payment Information
      doc.setTextColor(26, 72, 117);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('PAYMENT DETAILS', startX + 20, yPos);

      doc.setTextColor(0, 0, 0);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      yPos += 10;
      doc.text(`Total Paid: ${price.toLocaleString()} FC`, startX + 20, yPos);

      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      yPos += 8;
      doc.text(`Status: ${ticket.status} | Issued: ${new Date().toLocaleDateString()}`, startX + 20, yPos);

      // Enhanced QR Code
      const qrData = JSON.stringify({
        ticketId: ticket.id,
        ticketNumber: ticket.ticketNumber,
        passenger: `${currentUser.firstName} ${currentUser.lastName}`,
        route: `${ticket.origin}-${ticket.destination}`,
        seat: ticket.seatNumber,
        departure: ticket.departureTime,
        issuer: 'IMAS'
      });

      if (typeof QRCode !== 'undefined') {
        try {
          const qrCanvas = document.createElement('canvas');
          await new Promise((resolve, reject) => {
            QRCode.toCanvas(qrCanvas, qrData, {
              width: 100,
              margin: 1,
              color: {
                dark: '#1a4875',
                light: '#FFFFFF'
              },
              errorCorrectionLevel: 'H'
            }, (error) => {
              if (error) reject(error);
              else resolve();
            });
          });

          const qrDataURL = qrCanvas.toDataURL();
          doc.addImage(qrDataURL, 'PNG', startX + 130, startY + 120, 50, 50);

          // QR Code instructions
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(8);
          doc.text('Show QR code when boarding', startX + 130, startY + 180);

        } catch (qrError) {
          console.error('QR generation error:', qrError);
        }
      }

      // Enhanced footer
      doc.setFillColor(245, 166, 35);
      doc.roundedRect(startX + 10, startY + 210, ticketWidth - 20, 25, 4, 4, 'F');

      doc.setTextColor(26, 72, 117);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text('Keep this ticket safe during your journey', startX + 55, startY + 225);

      // Save the PDF
      doc.save(`IMAS-Enhanced-Ticket-${ticket.ticketNumber}.pdf`);
      showNotification('Enhanced PDF ticket downloaded successfully!', 'success');

      // Send download notification
      sendPushNotification(
              '📄 Ticket Downloaded',
              `PDF ticket for ${ticket.origin} → ${ticket.destination} saved successfully`,
              {
                tag: 'ticket-download'
              }
      );

    } catch (error) {
      console.error('PDF generation error:', error);
      showNotification('Failed to generate PDF: ' + error.message, 'error');
    }
  }

  // Download ticket as image
  async function downloadTicketAsImage() {
    if (!currentTicketForDownload) {
      showNotification('No ticket selected for download', 'error');
      return;
    }

    if (typeof html2canvas === 'undefined') {
      showNotification('html2canvas library not available', 'error');
      return;
    }

    try {
      const ticketPreview = document.getElementById('ticketPreview');

      const canvas = await html2canvas(ticketPreview, {
        scale: 2,
        backgroundColor: '#1a4875',
        useCORS: true,
        allowTaint: true
      });

      const dataUrl = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = `IMAS-Ticket-${currentTicketForDownload.ticketNumber}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('Image ticket downloaded successfully!', 'success');

    } catch (error) {
      console.error('Image generation error:', error);
      showNotification('Failed to generate image: ' + error.message, 'error');
    }
  }




  // Méthode alternative pour générer le QR code (à placer AVANT downloadQRCodeOnly)
  async function alternativeQRDownload(qrData, ticketNumber) {
    console.log('Using alternative QR download method');

    // Créer un canvas pour dessiner le QR code de manière basique
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // Taille du canvas
    canvas.width = 500;
    canvas.height = 600;

    // Fond blanc
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, 500, 600);

    // Bordure
    ctx.strokeStyle = '#1a4875';
    ctx.lineWidth = 3;
    ctx.strokeRect(10, 10, 480, 580);

    // Titre
    ctx.fillStyle = '#1a4875';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('IMAS TICKET', 250, 50);

    // Sous-titre
    ctx.font = 'bold 16px Arial';
    ctx.fillText('Show this code when boarding', 250, 80);

    // Simuler un QR code avec des carrés
    const qrSize = 300;
    const startX = (500 - qrSize) / 2;
    const startY = 120;
    const cellSize = 10;

    // Créer un pattern basé sur les données
    let dataHash = 0;
    for (let i = 0; i < qrData.length; i++) {
      dataHash = ((dataHash << 5) - dataHash + qrData.charCodeAt(i)) & 0xffffffff;
    }

    // Dessiner le pattern du QR code
    ctx.fillStyle = '#1a4875';
    for (let row = 0; row < 30; row++) {
      for (let col = 0; col < 30; col++) {
        const hash = (dataHash + row * 31 + col * 37) & 0xffffffff;
        if (hash % 3 === 0) {
          ctx.fillRect(startX + col * cellSize, startY + row * cellSize, cellSize, cellSize);
        }
      }
    }

    // Coins du QR code (pattern standard)
    const cornerSize = 70;
    const corners = [
      [startX, startY], // Top-left
      [startX + qrSize - cornerSize, startY], // Top-right
      [startX, startY + qrSize - cornerSize] // Bottom-left
    ];

    corners.forEach(([x, y]) => {
      // Carré extérieur
      ctx.fillRect(x, y, cornerSize, cornerSize);
      // Carré intérieur blanc
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(x + 10, y + 10, cornerSize - 20, cornerSize - 20);
      // Carré central
      ctx.fillStyle = '#1a4875';
      ctx.fillRect(x + 20, y + 20, cornerSize - 40, cornerSize - 40);
    });

    // Informations du ticket en bas
    ctx.fillStyle = '#1a4875';
    ctx.font = '14px Arial';
    ctx.textAlign = 'left';

    const ticketInfo = JSON.parse(qrData);
    const infoY = startY + qrSize + 40;

    ctx.fillText(`Ticket: ${ticketInfo.ticketNumber}`, 30, infoY);
    ctx.fillText(`Route: ${ticketInfo.route}`, 30, infoY + 25);
    ctx.fillText(`Seat: ${ticketInfo.seat}`, 30, infoY + 50);
    ctx.fillText(`Passenger: ${ticketInfo.passenger}`, 30, infoY + 75);
    ctx.fillText(`Departure: ${new Date(ticketInfo.departure).toLocaleString()}`, 30, infoY + 100);

    // Code unique en bas
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(`ID: ${ticketInfo.ticketId}`, 250, infoY + 130);

    // Télécharger
    const dataUrl = canvas.toDataURL('image/png', 0.9);
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = `IMAS-QR-${ticketNumber}.png`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showNotification('QR code downloaded successfully!', 'success');
  }

  // Enhanced QR code download - VERSION CORRIGÉE COMPLÈTE
  async function downloadQRCodeOnly() {
    if (!currentTicketForDownload) {
      showNotification('No ticket selected for download', 'error');
      return;
    }

    const ticket = currentTicketForDownload;
    const qrData = JSON.stringify({
      ticketId: ticket.id,
      ticketNumber: ticket.ticketNumber,
      passenger: `${currentUser.firstName} ${currentUser.lastName}`,
      route: `${ticket.origin}-${ticket.destination}`,
      seat: ticket.seatNumber,
      departure: ticket.departureTime,
      busId: ticket.busId,
      issuer: 'IMAS',
      generated: new Date().toISOString()
    });

    console.log('Starting QR code download process...');
    console.log('QRCode library available:', typeof QRCode !== 'undefined');

    // Essayer d'abord la méthode alternative (plus fiable)
    try {
      await alternativeQRDownload(qrData, ticket.ticketNumber);

      // Send QR download notification
      if (typeof sendPushNotification === 'function') {
        sendPushNotification(
                '📱 QR Code Ready',
                `QR code for ticket ${ticket.ticketNumber} saved. Show it when boarding.`,
                {
                  tag: 'qr-download'
                }
        );
      }
      return;
    } catch (error) {
      console.error('Alternative QR generation failed:', error);
    }

    // Si la méthode alternative échoue, essayer avec la vraie bibliothèque QRCode
    try {
      // Fonction pour charger dynamiquement QRCode si pas disponible
      async function loadQRCodeLibrary() {
        if (typeof QRCode !== 'undefined') {
          return Promise.resolve();
        }

        console.log('Loading QRCode library...');

        return new Promise((resolve, reject) => {
          const script = document.createElement('script');

          // Essayer plusieurs URLs
          const urls = [
            'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js',
            'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js'
          ];

          let urlIndex = 0;

          function tryNextUrl() {
            if (urlIndex >= urls.length) {
              reject(new Error('All QRCode library URLs failed'));
              return;
            }

            script.src = urls[urlIndex];
            script.onload = () => {
              console.log('QRCode library loaded from:', urls[urlIndex]);
              resolve();
            };
            script.onerror = () => {
              console.error('Failed to load from:', urls[urlIndex]);
              urlIndex++;
              tryNextUrl();
            };
            document.head.appendChild(script);
          }

          tryNextUrl();
        });
      }

      // Charger la bibliothèque QRCode si nécessaire
      await loadQRCodeLibrary();

      // Attendre un moment pour l'initialisation
      await new Promise(resolve => setTimeout(resolve, 200));

      if (typeof QRCode === 'undefined') {
        throw new Error('QRCode library still not available after loading');
      }

      const qrCanvas = document.createElement('canvas');

      // Générer le QR code
      await new Promise((resolve, reject) => {
        QRCode.toCanvas(qrCanvas, qrData, {
          width: 512,
          margin: 2,
          color: {
            dark: '#1a4875',
            light: '#FFFFFF'
          },
          errorCorrectionLevel: 'H'
        }, (error) => {
          if (error) {
            console.error('QRCode generation error:', error);
            reject(error);
          } else {
            console.log('QRCode generated successfully');
            resolve();
          }
        });
      });

      // Télécharger le QR code
      const dataUrl = qrCanvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = `IMAS-QR-${ticket.ticketNumber}.png`;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('Professional QR code downloaded successfully!', 'success');

      // Send QR download notification
      if (typeof sendPushNotification === 'function') {
        sendPushNotification(
                '📱 QR Code Ready',
                `QR code for ticket ${ticket.ticketNumber} saved. Show it when boarding.`,
                {
                  tag: 'qr-download'
                }
        );
      }

    } catch (error) {
      console.error('QR generation error:', error);
      showNotification('Failed to generate QR code: ' + error.message, 'error');
    }
  }




  async function loadTripsToRate() {
    const container = document.getElementById('tripsToRate');

    // Vérifier que userRatings est un tableau
    if (!Array.isArray(userRatings)) {
      userRatings = [];
    }

    // Get completed trips that haven't been rated yet
    const now = new Date();
    const completedTrips = userTickets.filter(ticket => {
      const departureTime = new Date(ticket.departureTime);
      const hasAlreadyRated = userRatings.some(rating => rating.ticketId === ticket.id);

      // Trip must be completed and not already rated
      return departureTime <= now &&
              (ticket.status === 'BOARDED' || ticket.status === 'PAID') &&
              !hasAlreadyRated;
    });

    if (completedTrips.length === 0) {
      container.innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-star" style="font-size: 3rem; color: var(--gold); margin-bottom: 1rem;"></i>
                <h3 style="color: var(--gray-medium); margin-bottom: 0.5rem;">No trips to rate</h3>
                <p style="color: var(--gray-medium);">Complete a trip to share your experience!</p>
            </div>
        `;
      return;
    }

    container.innerHTML = completedTrips.map(ticket => {
      const departureTime = new Date(ticket.departureTime);
      const busName = ticket.bus?.name || 'Bus ' + ticket.busId;

      return `
            <div class="rating-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="color: var(--gray-dark); margin-bottom: 0.5rem;">
                            ${ticket.origin} → ${ticket.destination}
                        </h4>
                        <p style="color: var(--gray-medium); font-size: 0.9rem;">
                            ${busName} • Seat ${ticket.seatNumber} • ${departureTime.toLocaleDateString()}
                        </p>
                    </div>
                    <button class="btn btn-warning" onclick="openRatingModal(${ticket.id})">
                        <i class="fas fa-star"></i>
                        Rate This Trip
                    </button>
                </div>
            </div>
        `;
    }).join('');
  }

  async function loadRatingHistory() {
    const container = document.getElementById('ratingHistory');

    // Vérifier que userRatings est un tableau
    if (!Array.isArray(userRatings)) {
      userRatings = [];
    }

    if (userRatings.length === 0) {
      container.innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-history" style="font-size: 3rem; color: var(--gray-medium); margin-bottom: 1rem;"></i>
                <h3 style="color: var(--gray-medium); margin-bottom: 0.5rem;">No ratings yet</h3>
                <p style="color: var(--gray-medium);">Your trip ratings will appear here.</p>
            </div>
        `;
      return;
    }

    // Sort ratings by date
    const sortedRatings = [...userRatings].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    container.innerHTML = sortedRatings.map(rating => {
      const ticket = userTickets.find(t => t.id === rating.ticketId);
      const ratingDate = new Date(rating.createdAt).toLocaleDateString();

      return `
            <div style="background: var(--gray-light); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="color: var(--gray-dark); margin-bottom: 0.5rem;">
                            ${ticket ? `${ticket.origin} → ${ticket.destination}` : 'Trip Rating'}
                        </h4>
                        <p style="color: var(--gray-medium); font-size: 0.9rem;">
                            Rated on ${ratingDate}
                        </p>
                    </div>
                    <div class="rating-display">
                        <div class="stars">
                            ${generateStarDisplay(rating.overall || rating.rating)}
                        </div>
                        <span style="margin-left: 0.5rem; font-weight: 600;">${rating.overall || rating.rating}/5</span>
                    </div>
                </div>

                ${rating.overallComment ? `
                    <div style="margin-bottom: 1rem;">
                        <strong>Comment:</strong> ${rating.overallComment}
                    </div>
                ` : ''}

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                    ${rating.driver ? `
                        <div>
                            <strong>Driver:</strong>
                            <div class="rating-display">
                                <div class="stars">${generateStarDisplay(rating.driver)}</div>
                                <span>${rating.driver}/5</span>
                            </div>
                        </div>
                    ` : ''}
                    ${rating.route ? `
                        <div>
                            <strong>Route:</strong>
                            <div class="rating-display">
                                <div class="stars">${generateStarDisplay(rating.route)}</div>
                                <span>${rating.route}/5</span>
                            </div>
                        </div>
                    ` : ''}
                    ${rating.bus ? `
                        <div>
                            <strong>Bus:</strong>
                            <div class="rating-display">
                                <div class="stars">${generateStarDisplay(rating.bus)}</div>
                                <span>${rating.bus}/5</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
  }
















  // Generate star display for ratings
  function generateStarDisplay(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
      stars += `<span class="star ${i <= rating ? 'active' : 'empty'}">★</span>`;
    }
    return stars;
  }

  async function loadRatingStatistics() {
    const container = document.getElementById('ratingStatistics');

    // Vérifier que userRatings est un tableau
    if (!Array.isArray(userRatings)) {
      userRatings = [];
    }

    if (userRatings.length === 0) {
      container.innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-chart-line" style="font-size: 3rem; color: var(--gray-medium); margin-bottom: 1rem;"></i>
                <h3 style="color: var(--gray-medium); margin-bottom: 0.5rem;">No statistics available</h3>
                <p style="color: var(--gray-medium);">Rate some trips to see your statistics.</p>
            </div>
        `;
      return;
    }

    // Calculate statistics
    const totalRatings = userRatings.length;
    const averageOverall = userRatings.reduce((sum, rating) => sum + (rating.overall || rating.rating), 0) / totalRatings;

    const categoryAverages = {
      driver: userRatings.filter(r => r.driver).reduce((sum, r, _, arr) => arr.length ? sum + r.driver / arr.length : 0, 0),
      route: userRatings.filter(r => r.route).reduce((sum, r, _, arr) => arr.length ? sum + r.route / arr.length : 0, 0),
      bus: userRatings.filter(r => r.bus).reduce((sum, r, _, arr) => arr.length ? sum + r.bus / arr.length : 0, 0)
    };

    // Rating distribution
    const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    userRatings.forEach(rating => {
      const overall = rating.overall || rating.rating;
      distribution[overall] = (distribution[overall] || 0) + 1;
    });

    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
            <div style="background: var(--gray-light); padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
                <h4 style="color: var(--primary-blue); margin-bottom: 1rem;">Overall Average</h4>
                <div style="font-size: 2rem; font-weight: bold; color: var(--gold); margin-bottom: 0.5rem;">
                    ${averageOverall.toFixed(1)}/5
                </div>
                <div class="rating-display" style="justify-content: center;">
                    <div class="stars">${generateStarDisplay(Math.round(averageOverall))}</div>
                </div>
                <div style="color: var(--gray-medium); margin-top: 0.5rem;">
                    Based on ${totalRatings} rating${totalRatings !== 1 ? 's' : ''}
                </div>
            </div>

            <div style="background: var(--gray-light); padding: 1.5rem; border-radius: var(--border-radius);">
                <h4 style="color: var(--primary-blue); margin-bottom: 1rem; text-align: center;">Category Averages</h4>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fas fa-user"></i> Driver</span>
                        <div class="rating-display">
                            <div class="stars">${generateStarDisplay(Math.round(categoryAverages.driver))}</div>
                            <span style="margin-left: 0.5rem;">${categoryAverages.driver.toFixed(1)}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fas fa-route"></i> Route</span>
                        <div class="rating-display">
                            <div class="stars">${generateStarDisplay(Math.round(categoryAverages.route))}</div>
                            <span style="margin-left: 0.5rem;">${categoryAverages.route.toFixed(1)}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fas fa-bus"></i> Bus</span>
                        <div class="rating-display">
                            <div class="stars">${generateStarDisplay(Math.round(categoryAverages.bus))}</div>
                            <span style="margin-left: 0.5rem;">${categoryAverages.bus.toFixed(1)}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="background: var(--gray-light); padding: 1.5rem; border-radius: var(--border-radius);">
                <h4 style="color: var(--primary-blue); margin-bottom: 1rem; text-align: center;">Rating Distribution</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${Object.entries(distribution).reverse().map(([stars, count]) => `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="min-width: 80px;">${stars} stars</span>
                            <div style="flex: 1; background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: var(--gold); height: 100%; width: ${totalRatings > 0 ? (count / totalRatings) * 100 : 0}%; border-radius: 10px; transition: width 0.5s ease;"></div>
                            </div>
                            <span style="min-width: 30px; text-align: right;">${count}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
  }






  // Open rating modal
  function openRatingModal(ticketId) {
    const ticket = userTickets.find(t => t.id === ticketId);
    if (!ticket) {
      showNotification('Ticket not found', 'error');
      return;
    }

    // Populate hidden fields
    document.getElementById('ratingTicketId').value = ticketId;
    document.getElementById('ratingBusId').value = ticket.busId || '';
    document.getElementById('ratingDriverId').value = ticket.bus?.driver?.id || '';
    document.getElementById('ratingRouteId').value = ticket.bus?.route?.id || '';

    // Update modal title
    const modalTitle = document.querySelector('#ratingModal .modal-title');
    modalTitle.textContent = `Rate: ${ticket.origin} → ${ticket.destination}`;

    // Reset form
    document.getElementById('ratingForm').reset();
    resetAllStars();

    openModal('ratingModal');
  }

  // Update star rating display
  function updateStarRating(starsContainer, value) {
    const stars = starsContainer.querySelectorAll('.star');
    stars.forEach((star, index) => {
      if (index < value) {
        star.classList.add('active');
      } else {
        star.classList.remove('active');
      }
    });
  }

  // Reset all star ratings
  function resetAllStars() {
    document.querySelectorAll('.rating-stars').forEach(container => {
      container.querySelectorAll('.star').forEach(star => {
        star.classList.remove('active');
      });
    });
  }






  async function handleRatingSubmission(e) {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    try {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading"></div> Submitting Rating...';

      // Validation de currentUser
      if (!currentUser || !currentUser.id) {
        throw new Error('User not authenticated');
      }

      // Collect rating data avec validation
      const ticketIdInput = document.getElementById('ratingTicketId');
      const busIdInput = document.getElementById('ratingBusId');
      const driverIdInput = document.getElementById('ratingDriverId');
      const routeIdInput = document.getElementById('ratingRouteId');

      if (!ticketIdInput || !ticketIdInput.value) {
        throw new Error('Ticket ID is missing');
      }

      const ratingData = {
        passengerId: currentUser.id,
        ticketId: parseInt(ticketIdInput.value),
        busId: busIdInput && busIdInput.value ? parseInt(busIdInput.value) : null,
        driverId: driverIdInput && driverIdInput.value ? parseInt(driverIdInput.value) : null,
        routeId: routeIdInput && routeIdInput.value ? parseInt(routeIdInput.value) : null,

        // Get star ratings
        overall: getStarRating('overall'),
        driver: getStarRating('driver'),
        route: getStarRating('route'),
        bus: getStarRating('bus'),

        // Get comments
        overallComment: document.getElementById('overallComment')?.value?.trim() || '',
        driverComment: document.getElementById('driverComment')?.value?.trim() || '',
        routeComment: document.getElementById('routeComment')?.value?.trim() || '',
        busComment: document.getElementById('busComment')?.value?.trim() || ''
      };

      // Validate at least overall rating
      if (!ratingData.overall || ratingData.overall < 1) {
        throw new Error('Please provide at least an overall rating (minimum 1 star)');
      }

      console.log('🌟 Submitting rating:', ratingData);

      // Submit multiple ratings based on the data
      const ratingPromises = [];

      // Overall service rating
      if (ratingData.overall) {
        ratingPromises.push(
                submitSingleRating({
                  ratingType: 'SERVICE',
                  rating: ratingData.overall,
                  comment: ratingData.overallComment,
                  passengerId: ratingData.passengerId,
                  busId: ratingData.busId
                })
        );
      }

      // Driver rating
      if (ratingData.driver && ratingData.driverId) {
        ratingPromises.push(
                submitSingleRating({
                  ratingType: 'DRIVER',
                  rating: ratingData.driver,
                  comment: ratingData.driverComment,
                  passengerId: ratingData.passengerId,
                  driverId: ratingData.driverId,
                  busId: ratingData.busId
                })
        );
      }

      // Route rating
      if (ratingData.route && ratingData.routeId) {
        ratingPromises.push(
                submitSingleRating({
                  ratingType: 'ROUTE',
                  rating: ratingData.route,
                  comment: ratingData.routeComment,
                  passengerId: ratingData.passengerId,
                  routeId: ratingData.routeId,
                  busId: ratingData.busId
                })
        );
      }

      // Bus rating
      if (ratingData.bus && ratingData.busId) {
        ratingPromises.push(
                submitSingleRating({
                  ratingType: 'BUS',
                  rating: ratingData.bus,
                  comment: ratingData.busComment,
                  passengerId: ratingData.passengerId,
                  busId: ratingData.busId
                })
        );
      }

      if (ratingPromises.length === 0) {
        throw new Error('Please provide at least one rating');
      }

      // Submit all ratings
      const results = await Promise.allSettled(ratingPromises);

      const successful = results.filter(r => r.status === 'fulfilled').length;
      const failed = results.filter(r => r.status === 'rejected').length;

      // Log des erreurs pour debugging
      results.forEach((result, index) => {
        if (result.status === 'rejected') {
          console.error(`Rating ${index + 1} failed:`, result.reason);
        }
      });

      if (successful > 0) {
        // Store rating locally
        userRatings = userRatings || [];
        userRatings.push({
          id: Date.now(),
          ticketId: ratingData.ticketId,
          overall: ratingData.overall,
          driver: ratingData.driver,
          route: ratingData.route,
          bus: ratingData.bus,
          overallComment: ratingData.overallComment,
          createdAt: new Date().toISOString()
        });

        closeModal('ratingModal');

        if (failed === 0) {
          showNotification(`All ratings submitted successfully! Thank you for your feedback.`, 'success');
        } else {
          showNotification(`${successful} ratings submitted, ${failed} failed. Thank you for your feedback.`, 'warning');
        }

        // Refresh rating data
        try {
          await loadUserRatings();
        } catch (refreshError) {
          console.warn('Could not refresh ratings:', refreshError);
        }

        // Reload ratings section if currently viewed
        const currentSection = document.querySelector('.section:not(.hidden)');
        if (currentSection && currentSection.id === 'ratings-section') {
          try {
            await loadTripsToRate();
            await loadRatingHistory();
            await loadRatingStatistics();
          } catch (reloadError) {
            console.warn('Could not reload rating sections:', reloadError);
          }
        }

        // Send thank you notification
        try {
          sendPushNotification(
                  '⭐ Thank You!',
                  'Your rating helps us improve our service. We appreciate your feedback!',
                  {
                    tag: 'rating-thanks'
                  }
          );
        } catch (notifError) {
          console.warn('Could not send notification:', notifError);
        }

      } else {
        // Tous ont échoué - afficher les erreurs détaillées
        const errors = results
                .filter(r => r.status === 'rejected')
                .map(r => r.reason.message)
                .join('; ');
        throw new Error(`All rating submissions failed: ${errors}`);
      }

    } catch (error) {
      console.error('❌ Rating submission error:', error);
      showNotification('Failed to submit rating: ' + error.message, 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }





  async function submitSingleRating(ratingData) {
    try {
      console.log('🚀 Submitting single rating:', ratingData);

      // Validation côté client
      if (!ratingData.rating || ratingData.rating < 1 || ratingData.rating > 5) {
        throw new Error('Rating must be between 1 and 5');
      }

      if (!ratingData.ratingType) {
        throw new Error('Rating type is required');
      }

      if (!ratingData.passengerId) {
        throw new Error('Passenger ID is required');
      }

      // Construire l'objet de données proprement
      const requestBody = {
        rating: parseInt(ratingData.rating),
        ratingType: ratingData.ratingType.toString().toUpperCase(),
        comment: ratingData.comment || null,
        busId: ratingData.busId ? parseInt(ratingData.busId) : null,
        driverId: ratingData.driverId ? parseInt(ratingData.driverId) : null,
        routeId: ratingData.routeId ? parseInt(ratingData.routeId) : null
      };

      console.log('📤 Sending request body:', requestBody);

      const response = await fetch(`${API_BASE}/ratings/passenger/${ratingData.passengerId}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      console.log('📥 Response status:', response.status);

      if (!response.ok) {
        let errorMessage = `HTTP ${response.status}`;
        try {
          const errorData = await response.json();
          console.error('❌ Error response:', errorData);

          if (errorData.error) {
            errorMessage = errorData.error;
          } else if (errorData.message) {
            errorMessage = errorData.message;
          } else {
            errorMessage = `Failed to submit ${ratingData.ratingType} rating`;
          }
        } catch (parseError) {
          const errorText = await response.text();
          console.error('❌ Error parsing response:', parseError);
          errorMessage = errorText || errorMessage;
        }

        throw new Error(errorMessage);
      }

      const result = await response.json();
      console.log('✅ Rating submitted successfully:', result);
      return result;

    } catch (error) {
      console.error('❌ Error in submitSingleRating:', error);
      throw error;
    }
  }

  // Get star rating value
  function getStarRating(category) {
    const activeStars = document.querySelectorAll(`[data-rating="${category}"] .star.active`);
    return activeStars.length;
  }

  // ENHANCED LIVE TRACKING WITH REAL-TIME GPS

  // Enhanced track trip function with real-time GPS tracking
  function trackTrip(ticketId) {
    console.log('🗺️ Starting enhanced trip tracking for ticket:', ticketId);

    const ticket = userTickets.find(t => t.id === ticketId);

    if (!ticket) {
      console.error('❌ Ticket not found:', ticketId);
      showNotification('Ticket not found for tracking', 'error');
      return;
    }

    let busId = null;
    let busData = null;

    if (ticket.bus && ticket.bus.id) {
      busId = ticket.bus.id;
      busData = ticket.bus;
    } else if (ticket.busId) {
      busId = ticket.busId;
    } else {
      showNotification('Bus information not available for this trip. Please contact support.', 'error');
      return;
    }

    showSection('live-tracking');

    setTimeout(async () => {
      if (!trackingMap) {
        initializeLiveTracking();
        setTimeout(() => {
          focusOnBusWithEnhancedTracking(busId, ticket);
        }, 2000);
      } else {
        focusOnBusWithEnhancedTracking(busId, ticket);
      }
    }, 500);
  }

  // Enhanced focus on bus with advanced real-time GPS tracking
  async function focusOnBusWithEnhancedTracking(busId, ticket) {
    try {
      console.log('🎯 Enhanced tracking focus on bus:', busId);

      const response = await fetch(`${API_BASE}/buses/${busId}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const bus = await response.json();
        console.log('✅ Enhanced bus data loaded:', bus);

        if (bus.currentLat && bus.currentLng && trackingMap) {
          console.log('✅ GPS coordinates available:', bus.currentLat, bus.currentLng);

          // Enhanced map view with smooth animation
          trackingMap.flyTo([bus.currentLat, bus.currentLng], 16, {
            duration: 2
          });

          // Enhanced status indication
          let statusIcon = '🚌';
          let statusText = 'Moving';
          let statusColor = '#10B981';
          let pulseClass = 'pulse';

          if (bus.hasAccident) {
            statusIcon = '🚨';
            statusText = 'Emergency';
            statusColor = '#DC2626';
            pulseClass = 'pulse-danger';
          } else if (bus.isStopped) {
            statusIcon = '⏸️';
            statusText = 'At Station';
            statusColor = '#F59E0B';
            pulseClass = 'pulse-warning';
          } else if (bus.progress >= 100) {
            statusIcon = '🏁';
            statusText = 'Arrived';
            statusColor = '#8B5CF6';
            pulseClass = 'pulse-success';
          }

          // Create enhanced animated marker
          const marker = L.marker([bus.currentLat, bus.currentLng], {
            icon: L.divIcon({
              className: `bus-marker-enhanced ${pulseClass}`,
              html: `
                              <div class="marker-container">
                                  <div class="marker-pulse" style="background: ${statusColor}; animation: pulse 2s infinite;"></div>
                                  <div class="marker-icon" style="background: ${statusColor}; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 3px solid white; position: relative; z-index: 2;">
                                      ${statusIcon}
                                  </div>
                                  <div class="marker-label" style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; white-space: nowrap; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                      ${bus.name || 'Your Bus'}
                                  </div>
                              </div>
                          `,
              iconSize: [60, 60],
              iconAnchor: [30, 30]
            })
          }).addTo(trackingMap);

          // Enhanced real-time popup with comprehensive information
          const departureTime = new Date(ticket.departureTime);
          const now = new Date();
          const timeDiff = departureTime - now;
          const minutesToDepart = Math.floor(timeDiff / (1000 * 60));

          let timeInfo = '';
          let tripPhase = '';

          if (minutesToDepart > 0) {
            timeInfo = `<div style="color: #F59E0B;"><strong>⏰ Departs in:</strong> ${minutesToDepart} minutes</div>`;
            tripPhase = 'Pre-departure';
          } else if (minutesToDepart > -60) {
            timeInfo = `<div style="color: #10B981;"><strong>🚌 Status:</strong> Journey in progress</div>`;
            tripPhase = 'In transit';
          } else {
            timeInfo = `<div style="color: #8B5CF6;"><strong>🏁 Status:</strong> Journey completed</div>`;
            tripPhase = 'Completed';
          }

          // Calculate estimated arrival
          let estimatedArrival = '';
          if (bus.progress > 0 && bus.progress < 100) {
            const remainingTime = Math.round(((100 - bus.progress) / 100) * (bus.route?.estimatedDuration || 60));
            const arrivalTime = new Date(now.getTime() + remainingTime * 60000);
            estimatedArrival = `<div><strong>🎯 ETA:</strong> ${arrivalTime.toLocaleTimeString()}</div>`;
          }

          marker.bindPopup(`
                      <div style="text-align: center; min-width: 300px; max-width: 350px;">
                          <div style="background: linear-gradient(135deg, ${statusColor}, ${statusColor}CC); padding: 15px; margin: -10px -10px 15px -10px; border-radius: 8px 8px 0 0;">
                              <h3 style="margin: 0; color: white; font-size: 18px;">${bus.name}</h3>
                              <div style="color: rgba(255,255,255,0.9); font-size: 12px; margin-top: 5px;">
                                  🎫 Your Tracked Bus • ${tripPhase}
                              </div>
                          </div>

                          <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; text-align: left;">
                                  <div><strong>From:</strong> ${ticket.origin}</div>
                                  <div><strong>To:</strong> ${ticket.destination}</div>
                                  <div><strong>Ticket:</strong> ${ticket.ticketNumber}</div>
                                  <div><strong>Seat:</strong> ${ticket.seatNumber}</div>
                              </div>
                          </div>

                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 11px; margin-bottom: 12px; text-align: left;">
                              <div style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 6px;">
                                  <strong>📊 Progress:</strong><br>
                                  <div style="background: #e5e7eb; height: 6px; border-radius: 3px; margin: 4px 0; overflow: hidden;">
                                      <div style="background: ${statusColor}; height: 100%; width: ${Math.round(bus.progress || 0)}%; transition: width 1s ease;"></div>
                                  </div>
                                  <span style="font-weight: bold; color: ${statusColor};">${Math.round(bus.progress || 0)}%</span>
                              </div>

                              <div style="background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 6px;">
                                  <strong>👥 Occupancy:</strong><br>
                                  <span style="font-weight: bold;">${bus.passengers || 0}/${bus.capacity || 50}</span><br>
                                  <span style="color: #6b7280; font-size: 10px;">passengers aboard</span>
                              </div>
                          </div>

                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 11px; margin-bottom: 12px;">
                              <div>
                                  <strong>🚀 Status:</strong><br>
                                  <span style="color: ${statusColor}; font-weight: bold;">${statusIcon} ${statusText}</span>
                              </div>
                              <div>
                                  <strong>⚡ Speed:</strong><br>
                                  <span style="font-weight: bold;">${bus.speed || 0} km/h</span>
                              </div>
                          </div>

                          ${timeInfo}
                          ${estimatedArrival}

                          <div style="margin-top: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid ${statusColor};">
                              <div style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 10px; color: ${statusColor}; font-weight: bold;">
                                  <div style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                                  LIVE GPS TRACKING • Updated: ${new Date().toLocaleTimeString()}
                              </div>
                          </div>

                          ${bus.progress < 100 ? `
                              <div style="margin-top: 10px;">
                                  <button style="background: ${statusColor}; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 11px; cursor: pointer;" onclick="refreshBusLocation(${busId})">
                                      🔄 Refresh Location
                                  </button>
                              </div>
                          ` : ''}
                      </div>
                  `).openPopup();

          busMarkers.push(marker);

          // Start enhanced real-time tracking
          startEnhancedBusTracking(busId, marker, ticket);

          // Send enhanced tracking notification
          sendPushNotification(
                  '🗺️ Enhanced Tracking Active',
                  `Live GPS tracking ${bus.name}. Progress: ${Math.round(bus.progress || 0)}% • ${statusText}`,
                  {
                    tag: 'enhanced-tracking',
                    requireInteraction: bus.hasAccident,
                    clickAction: () => showSection('live-tracking')
                  }
          );

          showNotification('✅ Enhanced GPS tracking activated! Real-time updates every 5 seconds.', 'success');

          // Add route prediction if available
          if (bus.startLat && bus.startLng && bus.endLat && bus.endLng) {
            addRouteVisualization(bus, marker);
          }

        } else {
          console.warn('⚠️ Bus exists but no GPS coordinates available');
          showEnhancedTrackingFallback(bus, ticket);
        }
      } else {
        console.error('❌ Failed to fetch enhanced bus data:', response.status);
        showGenericEnhancedTrackingFallback(ticket);
      }
    } catch (error) {
      console.error('❌ Error in enhanced bus tracking:', error);
      showGenericEnhancedTrackingFallback(ticket);
    }
  }

  // Add route visualization to map
  function addRouteVisualization(bus, busMarker) {
    if (!trackingMap) return;

    try {
      // Create route line
      const routeCoordinates = [
        [bus.startLat, bus.startLng],
        [bus.currentLat, bus.currentLng],
        [bus.endLat, bus.endLng]
      ];

      // Completed route (green)
      const completedRoute = L.polyline([
        [bus.startLat, bus.startLng],
        [bus.currentLat, bus.currentLng]
      ], {
        color: '#10B981',
        weight: 4,
        opacity: 0.8
      }).addTo(trackingMap);

      // Remaining route (gray)
      const remainingRoute = L.polyline([
        [bus.currentLat, bus.currentLng],
        [bus.endLat, bus.endLng]
      ], {
        color: '#9CA3AF',
        weight: 3,
        opacity: 0.5,
        dashArray: '10, 10'
      }).addTo(trackingMap);

      // Start and end markers
      const startMarker = L.marker([bus.startLat, bus.startLng], {
        icon: L.divIcon({
          className: 'route-marker start',
          html: '<div style="background: #10B981; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">🏁</div>',
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        })
      }).addTo(trackingMap);

      const endMarker = L.marker([bus.endLat, bus.endLng], {
        icon: L.divIcon({
          className: 'route-marker end',
          html: '<div style="background: #DC2626; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">🎯</div>',
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        })
      }).addTo(trackingMap);

      startMarker.bindPopup('<strong>🏁 Start:</strong> Departure Point');
      endMarker.bindPopup('<strong>🎯 Destination:</strong> Arrival Point');

      // Store for cleanup
      busMarkers.push(completedRoute, remainingRoute, startMarker, endMarker);

    } catch (error) {
      console.error('Error adding route visualization:', error);
    }
  }

  // Refresh bus location manually
  async function refreshBusLocation(busId) {
    try {
      const response = await fetch(`${API_BASE}/buses/${busId}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const updatedBus = await response.json();
        console.log('🔄 Manual location refresh:', updatedBus);

        showNotification(`Location refreshed: ${updatedBus.name} at ${Math.round(updatedBus.progress || 0)}% progress`, 'success');
      }
    } catch (error) {
      console.error('Error refreshing location:', error);
      showNotification('Could not refresh location', 'error');
    }
  }

  // Start enhanced real-time bus tracking
  function startEnhancedBusTracking(busId, marker, ticket) {
    // Clear any existing tracking
    if (window.enhancedBusTrackingInterval) {
      clearInterval(window.enhancedBusTrackingInterval);
    }

    console.log('🎯 Starting enhanced real-time tracking for bus:', busId);

    // Update every 5 seconds for enhanced experience
    window.enhancedBusTrackingInterval = setInterval(async () => {
      try {
        const response = await fetch(`${API_BASE}/buses/${busId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const bus = await response.json();

          if (bus.currentLat && bus.currentLng) {
            // Smooth marker movement
            const currentPos = marker.getLatLng();
            const newPos = [bus.currentLat, bus.currentLng];

            // Only update if position changed significantly (>5 meters)
            const distance = currentPos.distanceTo(L.latLng(newPos));
            if (distance > 5) {
              // Smooth transition
              marker.setLatLng(newPos);

              // Update route visualization if available
              updateRouteVisualization(bus);

              console.log('📍 Enhanced position update:', newPos, `Distance moved: ${Math.round(distance)}m`);
            }

            // Update popup with fresh data
            updateEnhancedPopupContent(marker, bus, ticket);
          }
        }
      } catch (error) {
        console.error('Error in enhanced tracking update:', error);
      }
    }, 5000); // Update every 5 seconds

    console.log('✅ Enhanced real-time tracking started (5-second intervals)');
  }

  // Update enhanced popup content
  function updateEnhancedPopupContent(marker, bus, ticket) {
    const departureTime = new Date(ticket.departureTime);
    const now = new Date();
    const timeDiff = departureTime - now;
    const minutesToDepart = Math.floor(timeDiff / (1000 * 60));

    let timeInfo = '';
    let tripPhase = '';
    let statusIcon = '🚌';
    let statusText = 'Moving';
    let statusColor = '#10B981';

    if (bus.hasAccident) {
      statusIcon = '🚨';
      statusText = 'Emergency';
      statusColor = '#DC2626';
    } else if (bus.isStopped) {
      statusIcon = '⏸️';
      statusText = 'At Station';
      statusColor = '#F59E0B';
    } else if (bus.progress >= 100) {
      statusIcon = '🏁';
      statusText = 'Arrived';
      statusColor = '#8B5CF6';
    }

    if (minutesToDepart > 0) {
      timeInfo = `<div style="color: #F59E0B;"><strong>⏰ Departs in:</strong> ${minutesToDepart} minutes</div>`;
      tripPhase = 'Pre-departure';
    } else if (minutesToDepart > -60) {
      timeInfo = `<div style="color: #10B981;"><strong>🚌 Status:</strong> Journey in progress</div>`;
      tripPhase = 'In transit';
    } else {
      timeInfo = `<div style="color: #8B5CF6;"><strong>🏁 Status:</strong> Journey completed</div>`;
      tripPhase = 'Completed';
    }

    // Calculate estimated arrival
    let estimatedArrival = '';
    if (bus.progress > 0 && bus.progress < 100) {
      const remainingTime = Math.round(((100 - bus.progress) / 100) * (bus.route?.estimatedDuration || 60));
      const arrivalTime = new Date(now.getTime() + remainingTime * 60000);
      estimatedArrival = `<div><strong>🎯 ETA:</strong> ${arrivalTime.toLocaleTimeString()}</div>`;
    }

    const updatedContent = `
          <div style="text-align: center; min-width: 300px; max-width: 350px;">
              <div style="background: linear-gradient(135deg, ${statusColor}, ${statusColor}CC); padding: 15px; margin: -10px -10px 15px -10px; border-radius: 8px 8px 0 0;">
                  <h3 style="margin: 0; color: white; font-size: 18px;">${bus.name}</h3>
                  <div style="color: rgba(255,255,255,0.9); font-size: 12px; margin-top: 5px;">
                      🎫 Your Tracked Bus • ${tripPhase}
                  </div>
              </div>

              <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; text-align: left;">
                      <div><strong>From:</strong> ${ticket.origin}</div>
                      <div><strong>To:</strong> ${ticket.destination}</div>
                      <div><strong>Ticket:</strong> ${ticket.ticketNumber}</div>
                      <div><strong>Seat:</strong> ${ticket.seatNumber}</div>
                  </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 11px; margin-bottom: 12px; text-align: left;">
                  <div style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 6px;">
                      <strong>📊 Progress:</strong><br>
                      <div style="background: #e5e7eb; height: 6px; border-radius: 3px; margin: 4px 0; overflow: hidden;">
                          <div style="background: ${statusColor}; height: 100%; width: ${Math.round(bus.progress || 0)}%; transition: width 1s ease;"></div>
                      </div>
                      <span style="font-weight: bold; color: ${statusColor};">${Math.round(bus.progress || 0)}%</span>
                  </div>

                  <div style="background: rgba(59, 130, 246, 0.1); padding: 8px; border-radius: 6px;">
                      <strong>👥 Occupancy:</strong><br>
                      <span style="font-weight: bold;">${bus.passengers || 0}/${bus.capacity || 50}</span><br>
                      <span style="color: #6b7280; font-size: 10px;">passengers aboard</span>
                  </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 11px; margin-bottom: 12px;">
                  <div>
                      <strong>🚀 Status:</strong><br>
                      <span style="color: ${statusColor}; font-weight: bold;">${statusIcon} ${statusText}</span>
                  </div>
                  <div>
                      <strong>⚡ Speed:</strong><br>
                      <span style="font-weight: bold;">${bus.speed || 0} km/h</span>
                  </div>
              </div>

              ${timeInfo}
              ${estimatedArrival}

              <div style="margin-top: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid ${statusColor};">
                  <div style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 10px; color: ${statusColor}; font-weight: bold;">
                      <div style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
                      LIVE GPS TRACKING • Updated: ${new Date().toLocaleTimeString()}
                  </div>
              </div>

              ${bus.progress < 100 ? `
                  <div style="margin-top: 10px;">
                      <button style="background: ${statusColor}; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 11px; cursor: pointer;" onclick="refreshBusLocation(${bus.id})">
                          🔄 Refresh Location
                      </button>
                  </div>
              ` : ''}
          </div>
      `;

    marker.setPopupContent(updatedContent);
  }

  // Stop enhanced bus tracking
  function stopEnhancedBusTracking() {
    if (window.enhancedBusTrackingInterval) {
      clearInterval(window.enhancedBusTrackingInterval);
      window.enhancedBusTrackingInterval = null;
      console.log('🛑 Enhanced bus tracking stopped');
    }
  }

  // Enhanced fallback displays
  function showEnhancedTrackingFallback(bus, ticket) {
    if (trackingMap) {
      trackingMap.setView([-4.3276, 15.3136], 12);
    }

    const infoPopup = L.popup()
            .setLatLng([-4.3276, 15.3136])
            .setContent(`
              <div style="text-align: center; min-width: 280px;">
                  <h4 style="color: var(--primary-blue);">🚌 ${bus.name}</h4>
                  <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin: 15px 0;">
                      <strong>Your Trip Details:</strong>
                      <div style="margin-top: 8px; text-align: left;">
                          <div>📍 Route: ${ticket.origin} → ${ticket.destination}</div>
                          <div>💺 Seat: ${ticket.seatNumber}</div>
                          <div>🎫 Ticket: ${ticket.ticketNumber}</div>
                          <div>📊 Progress: ${Math.round(bus.progress || 0)}%</div>
                          <div>🚦 Status: ${bus.isStopped ? 'At Station' : 'In Transit'}</div>
                      </div>
                  </div>
                  <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 6px; color: #92400e; font-size: 12px;">
                      🛰️ GPS signal temporarily unavailable<br>
                      Bus is operating normally on schedule
                  </div>
              </div>
          `)
            .openOn(trackingMap);

    showNotification('🗺️ Enhanced tracking activated! GPS coordinates updating...', 'info');
  }

  function showGenericEnhancedTrackingFallback(ticket) {
    if (trackingMap) {
      trackingMap.setView([-4.3276, 15.3136], 12);
    }

    const tripPopup = L.popup()
            .setLatLng([-4.3276, 15.3136])
            .setContent(`
              <div style="text-align: center; min-width: 280px;">
                  <h4 style="color: var(--green);">✅ Enhanced Trip Tracking Active</h4>
                  <div style="background: #dcfce7; padding: 20px; border-radius: 8px; margin: 15px 0;">
                      <div style="text-align: left;">
                          <div><strong>📍 Route:</strong> ${ticket.origin} → ${ticket.destination}</div>
                          <div><strong>💺 Seat:</strong> ${ticket.seatNumber}</div>
                          <div><strong>🎫 Ticket:</strong> ${ticket.ticketNumber}</div>
                          <div><strong>📅 Departure:</strong> ${new Date(ticket.departureTime).toLocaleString()}</div>
                          <div><strong>🎯 Status:</strong> Confirmed & Monitored</div>
                      </div>
                  </div>
                  <div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 6px; color: #065f46; font-size: 12px;">
                      🛰️ Your trip is confirmed and being monitored<br>
                      Enhanced GPS updates will appear here shortly
                  </div>
              </div>
          `)
            .openOn(trackingMap);

    showNotification('✅ Enhanced trip tracking confirmed! Your journey is being monitored with GPS.', 'success');
  }

  // Initialize enhanced live tracking
  function initializeLiveTracking() {
    if (trackingMap) {
      console.log('ℹ️ Enhanced map already initialized');
      return;
    }

    console.log('🗺️ Initializing enhanced live tracking map...');

    try {
      trackingMap = L.map('trackingMap').setView([-4.3276, 15.3136], 11);

      // Enhanced map tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors | IMAS Enhanced Bus Tracking',
        maxZoom: 20,
        minZoom: 8
      }).addTo(trackingMap);

      // Enhanced Kinshasa landmarks
      const landmarks = [
        { name: 'Gare Centrale', lat: -4.3276, lng: 15.3136, icon: '🚉', type: 'transport' },
        { name: 'Aéroport de N\'djili', lat: -4.3857, lng: 15.4446, icon: '✈️', type: 'transport' },
        { name: 'Université de Kinshasa', lat: -4.4326, lng: 15.2973, icon: '🎓', type: 'education' },
        { name: 'Marché Central', lat: -4.3200, lng: 15.3100, icon: '🏪', type: 'commerce' },
        { name: 'Limete', lat: -4.3500, lng: 15.3200, icon: '🏘️', type: 'residential' },
        { name: 'Bandalungwa', lat: -4.3100, lng: 15.2900, icon: '🏘️', type: 'residential' },
        { name: 'Matete', lat: -4.3400, lng: 15.3600, icon: '🏘️', type: 'residential' },
        { name: 'Masina', lat: -4.3800, lng: 15.3900, icon: '🏘️', type: 'residential' },
        { name: 'Kimbanseke', lat: -4.4200, lng: 15.3500, icon: '🏘️', type: 'residential' }
      ];

      landmarks.forEach(landmark => {
        const color = landmark.type === 'transport' ? '#1E40AF' :
                landmark.type === 'education' ? '#7C3AED' :
                        landmark.type === 'commerce' ? '#F59E0B' : '#10B981';

        L.marker([landmark.lat, landmark.lng], {
          icon: L.divIcon({
            className: 'enhanced-landmark-marker',
            html: `<div style="background: white; border: 3px solid ${color}; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">${landmark.icon}</div>`,
            iconSize: [35, 35],
            iconAnchor: [17, 17]
          })
        }).addTo(trackingMap).bindPopup(`
                  <div style="text-align: center;">
                      <strong>${landmark.name}</strong><br>
                      <span style="color: ${color}; font-size: 0.9em;">${landmark.type.charAt(0).toUpperCase() + landmark.type.slice(1)} Hub</span>
                  </div>
              `);
      });

      console.log('✅ Enhanced map initialized with landmarks');
      loadActiveTripsTracking();

      // Refresh tracking data every 10 seconds
      setInterval(loadActiveTripsTracking, 10000);

    } catch (error) {
      console.error('❌ Error initializing enhanced map:', error);
      document.getElementById('trackingMap').innerHTML = `
              <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--gray-light);">
                  <div style="text-align: center;">
                      <i class="fas fa-map-marked-alt" style="font-size: 3rem; color: var(--gray-medium); margin-bottom: 1rem;"></i>
                      <p style="color: var(--gray-medium);">Enhanced map failed to load</p>
                      <button class="btn" onclick="initializeLiveTracking()" style="margin-top: 1rem;">
                          <i class="fas fa-refresh"></i>
                          Retry Enhanced Tracking
                      </button>
                  </div>
              </div>
          `;
    }
  }

  // Enhanced load active trips tracking
  async function loadActiveTripsTracking() {
    try {
      const container = document.getElementById('activeTripsTracking');

      if (activeTrips.length === 0) {
        container.innerHTML = `
                  <div style="text-align: center; padding: 2rem;">
                      <i class="fas fa-route" style="font-size: 2rem; color: var(--gray-medium); margin-bottom: 1rem;"></i>
                      <p style="color: var(--gray-medium);">No active trips to track</p>
                      <button class="btn" onclick="showSection('book-ticket')" style="margin-top: 1rem;">
                          <i class="fas fa-plus"></i>
                          Book a Trip
                      </button>
                  </div>
              `;
        return;
      }

      console.log('🚌 Loading enhanced tracking for', activeTrips.length, 'active trips');

      // Clear existing markers
      busMarkers.forEach(marker => {
        if (trackingMap) {
          trackingMap.removeLayer(marker);
        }
      });
      busMarkers = [];

      const trackingItems = await Promise.all(activeTrips.map(async ticket => {
        const busId = ticket.bus ? ticket.bus.id : ticket.busId;
        if (!busId) return '';

        try {
          const response = await fetch(`${API_BASE}/buses/${busId}`, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const busData = await response.json();

            // Add enhanced bus marker to map
            if (busData.currentLat && busData.currentLng && trackingMap) {
              let markerColor = '#1E40AF';
              let statusEmoji = '🚌';
              let pulseClass = 'pulse';

              if (busData.hasAccident) {
                markerColor = '#DC2626';
                statusEmoji = '🚨';
                pulseClass = 'pulse-danger';
              } else if (busData.isStopped) {
                markerColor = '#F59E0B';
                statusEmoji = '⏸️';
                pulseClass = 'pulse-warning';
              } else if (busData.progress >= 100) {
                markerColor = '#8B5CF6';
                statusEmoji = '🏁';
                pulseClass = 'pulse-success';
              }

              const marker = L.marker([busData.currentLat, busData.currentLng], {
                icon: L.divIcon({
                  className: `enhanced-bus-marker ${pulseClass}`,
                  html: `
                                      <div class="enhanced-marker-container">
                                          <div class="enhanced-marker-pulse" style="background: ${markerColor}; animation: pulse 2s infinite;"></div>
                                          <div class="enhanced-marker-icon" style="background: ${markerColor}; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 3px solid white; position: relative; z-index: 2;">
                                              ${statusEmoji}
                                          </div>
                                      </div>
                                  `,
                  iconSize: [40, 40],
                  iconAnchor: [20, 20]
                })
              }).addTo(trackingMap);

              marker.bindPopup(`
                              <div style="text-align: center; min-width: 200px;">
                                  <h4 style="margin: 0 0 8px 0; color: ${markerColor};">${busData.name}</h4>
                                  <div style="background: rgba(0,0,0,0.05); padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                                      <small>🎫 Your Bus • Seat ${ticket.seatNumber}</small><br>
                                      <small>📊 Progress: ${Math.round(busData.progress || 0)}%</small><br>
                                      <small>🚦 ${busData.hasAccident ? 'Emergency' : busData.isStopped ? 'At Station' : 'Moving'}</small><br>
                                      <small>📍 ${ticket.origin} → ${ticket.destination}</small>
                                  </div>
                                  <button style="background: ${markerColor}; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;" onclick="focusOnBusWithEnhancedTracking(${busId}, ${JSON.stringify(ticket).replace(/"/g, '&quot;')})">
                                      🎯 Focus Tracking
                                  </button>
                              </div>
                          `);

              busMarkers.push(marker);
            }

            const departureTime = new Date(ticket.departureTime);
            const now = new Date();
            const timeDiff = departureTime - now;
            const minutesToDepart = Math.floor(timeDiff / (1000 * 60));

            // Determine enhanced status
            let statusClass = 'moving';
            let statusText = '🚌 In Transit';
            let timeText = '';
            let progressColor = '#10B981';

            if (minutesToDepart > 0) {
              statusClass = 'upcoming';
              statusText = '⏰ Departing Soon';
              timeText = `Departs in ${minutesToDepart} minutes`;
              progressColor = '#F59E0B';
            } else if (minutesToDepart > -60) {
              statusClass = 'active';
              statusText = '🚌 Journey Active';
              timeText = 'Currently traveling';
              progressColor = '#10B981';
            } else {
              statusClass = 'completed';
              statusText = '🏁 Journey Complete';
              timeText = 'Trip completed';
              progressColor = '#8B5CF6';
            }

            if (busData.hasAccident) {
              statusClass = 'accident';
              statusText = '🚨 Emergency Alert';
              timeText = 'Please contact support';
              progressColor = '#DC2626';
            } else if (busData.isStopped) {
              statusText = '⏸️ At Station';
              timeText = 'Bus stopped at station';
              progressColor = '#F59E0B';
            }

            return `
                          <div style="background: var(--gray-light); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem; cursor: pointer; border-left: 4px solid ${progressColor}; transition: var(--transition);"
                               onclick="focusOnBusWithEnhancedTracking(${busId}, ${JSON.stringify(ticket).replace(/"/g, '&quot;')})"
                               onmouseover="this.style.background='rgba(16, 185, 129, 0.1)'"
                               onmouseout="this.style.background='var(--gray-light)'">

                              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                  <strong style="color: var(--gray-dark);">${ticket.origin} → ${ticket.destination}</strong>
                                  <small style="color: var(--gray-medium);">Seat ${ticket.seatNumber}</small>
                              </div>

                              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem; color: var(--gray-medium); margin-bottom: 1rem;">
                                  <div>🚌 Bus: ${busData.name} (${busData.busLine || 'N/A'})</div>
                                  <div>⏰ ${timeText}</div>
                                  <div class="bus-status-indicator ${statusClass}">${statusText}</div>
                                  <div style="color: ${progressColor}; font-weight: 600;">📊 ${Math.round(busData.progress || 0)}% Progress</div>
                              </div>

                              ${busData.progress > 0 ? `
                                  <div style="margin: 1rem 0;">
                                      <div class="progress-bar" style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                          <div class="progress-fill" style="background: ${progressColor}; height: 100%; width: ${busData.progress}%; transition: width 1s ease;"></div>
                                      </div>
                                      <div style="font-size: 0.8rem; color: var(--gray-medium); text-align: center; margin-top: 0.25rem;">
                                          Journey ${Math.round(busData.progress)}% Complete
                                      </div>
                                  </div>
                              ` : ''}

                              ${busData.currentLat && busData.currentLng ? `
                                  <div class="real-time-indicator" style="margin-top: 1rem; justify-content: center;">
                                      <div class="pulse-dot" style="background: ${progressColor};"></div>
                                      Enhanced GPS Tracking Active
                                  </div>
                              ` : `
                                  <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(245, 158, 11, 0.1); color: var(--gold); border-radius: 6px; font-size: 0.85rem; text-align: center;">
                                      📡 GPS signal updating...
                                  </div>
                              `}

                              <div style="margin-top: 1rem; text-align: center;">
                                  <button class="btn" onclick="event.stopPropagation(); focusOnBusWithEnhancedTracking(${busId}, ${JSON.stringify(ticket).replace(/"/g, '&quot;')})"
                                          style="background: ${progressColor}; padding: 0.5rem 1.5rem; font-size: 0.85rem;">
                                      🗺️ Enhanced Track
                                  </button>
                              </div>
                          </div>
                      `;
          }
        } catch (error) {
          console.error('❌ Error loading enhanced bus data for tracking:', error);
        }

        // Enhanced fallback display
        const departureTime = new Date(ticket.departureTime);
        const now = new Date();
        const timeToDepart = Math.max(0, Math.floor((departureTime - now) / (1000 * 60)));
        const busName = ticket.bus ? ticket.bus.name : 'Bus ' + ticket.busId;

        return `
                  <div style="background: var(--gray-light); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem; cursor: pointer; border-left: 4px solid var(--primary-blue);" onclick="trackTrip(${ticket.id})">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                          <strong style="color: var(--gray-dark);">${ticket.origin} → ${ticket.destination}</strong>
                          <small style="color: var(--gray-medium);">Seat ${ticket.seatNumber}</small>
                      </div>
                      <div style="font-size: 0.9rem; color: var(--gray-medium); margin-bottom: 1rem;">
                          <div>🚌 Bus: ${busName}</div>
                          <div>⏰ Departs in: ${timeToDepart} minutes</div>
                          <div>📍 Status: Ready for enhanced tracking</div>
                      </div>
                      <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(30, 64, 175, 0.1); color: var(--primary-blue); border-radius: 6px; font-size: 0.85rem; text-align: center;">
                          🗺️ Click for enhanced GPS tracking
                      </div>
                  </div>
              `;
      }));

      container.innerHTML = trackingItems.filter(item => item).join('');

    } catch (error) {
      console.error('❌ Error loading enhanced active trips tracking:', error);
      document.getElementById('activeTripsTracking').innerHTML =
              '<p style="color: var(--gray-medium);">Error loading enhanced tracking data</p>';
    }
  }

  // Load and display notifications
  async function loadNotifications() {
    const container = document.getElementById('notificationsList');
    container.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
              <div class="loading" style="margin: 0 auto;"></div>
              <p>Loading notifications...</p>
          </div>
      `;

    try {
      const response = await fetch(`${API_BASE}/notifications/user/${currentUser.id}`, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        notifications = data.map(notif => ({
          id: notif.id,
          title: notif.title || 'Notification',
          message: notif.message,
          time: new Date(notif.timestamp || notif.time),
          read: notif.read,
          type: notif.type || 'system'
        }));
        console.log('✅ Loaded notifications:', notifications.length);
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    } catch (error) {
      console.error('❌ Error loading notifications:', error);
      showNotification('Error loading notifications', 'error');
      notifications = [];
      container.innerHTML = `
              <div style="text-align: center; padding: 4rem; color: var(--secondary-red);">
                  <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                  <h3>Error loading notifications</h3>
                  <p>Please try again later</p>
              </div>
          `;
    } finally {
      updateNotificationBadge();
      displayNotifications();
    }
  }

  // Update notification badge
  function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationCount');
    badge.textContent = unreadCount;
    badge.style.display = unreadCount > 0 ? 'flex' : 'none';
  }

  // Display notifications
  function displayNotifications() {
    const container = document.getElementById('notificationsList');

    if (notifications.length === 0) {
      container.innerHTML = `
              <div style="text-align: center; padding: 4rem;">
                  <i class="fas fa-bell" style="font-size: 4rem; color: var(--gray-medium); margin-bottom: 1rem;"></i>
                  <h3 style="color: var(--gray-medium); margin-bottom: 0.5rem;">No notifications</h3>
                  <p style="color: var(--gray-medium);">You're all caught up! New notifications will appear here.</p>
              </div>
          `;
      return;
    }

    container.innerHTML = notifications
            .sort((a, b) => new Date(b.time) - new Date(a.time))
            .map(notification => {
              let iconClass = 'fas fa-info-circle';
              let iconColor = 'var(--primary-blue)';

              switch (notification.type) {
                case 'trip-reminder':
                  iconClass = 'fas fa-bus';
                  iconColor = 'var(--green)';
                  break;
                case 'traffic-update':
                  iconClass = 'fas fa-traffic-light';
                  iconColor = 'var(--gold)';
                  break;
                case 'welcome':
                  iconClass = 'fas fa-hand-wave';
                  iconColor = 'var(--primary-blue)';
                  break;
                case 'system':
                  iconClass = 'fas fa-cog';
                  iconColor = 'var(--gray-medium)';
                  break;
                case 'rating-request':
                  iconClass = 'fas fa-star';
                  iconColor = 'var(--gold)';
                  break;
              }

              return `
                  <div class="notification-item ${!notification.read ? 'unread' : ''}" onclick="markNotificationAsRead('${notification.id}')">
                      <div class="notification-header">
                          <div style="display: flex; align-items: center; gap: 0.5rem;">
                              <i class="${iconClass}" style="color: ${iconColor};"></i>
                              <div class="notification-title">${notification.title}</div>
                          </div>
                          <div class="notification-time">${formatTimeAgo(new Date(notification.time))}</div>
                      </div>
                      <div class="notification-message">${notification.message}</div>
                      ${!notification.read ? '<div style="width: 8px; height: 8px; background: var(--primary-blue); border-radius: 50%; position: absolute; top: 1rem; right: 1rem;"></div>' : ''}
                  </div>
              `;
            }).join('');
  }

  // Add notification to list
  function addNotification(notification) {
    notification.id = notification.id || `notif_${Date.now()}_${Math.random()}`;
    notifications.unshift(notification);

    // Keep only last 50 notifications
    if (notifications.length > 50) {
      notifications = notifications.slice(0, 50);
    }

    updateNotificationBadge();
    displayNotifications();
  }

  // Mark notification as read
  async function markNotificationAsRead(notificationId, ticketId = null) {
    const notification = notifications.find(n => n.id === notificationId);
    if (notification && !notification.read) {
      try {
        const response = await fetch(`${API_BASE}/notifications/${notificationId}/read`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          notification.read = true;
          console.log('✅ Notification marked as read:', notificationId);
          updateNotificationBadge();
          displayNotifications();

          // Handle click actions based on notification type
          if (notification.type === 'trip-reminder' && ticketId) {
            showSection('my-trips');
            setTimeout(() => trackTrip(ticketId), 500);
          } else if (notification.type === 'rating-request' && ticketId) {
            showSection('ratings');
            setTimeout(() => openRatingModal(ticketId), 500);
          }
        } else {
          throw new Error('Failed to mark notification as read');
        }
      } catch (error) {
        console.error('❌ Error marking notification as read:', error);
        showNotification('Failed to mark notification as read', 'error');
      }
    }
  }

  // Mark all notifications as read
  async function markAllAsRead() {
    try {
      const response = await fetch(`${API_BASE}/notifications/passenger/${currentUser.id}/read-all`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        notifications.forEach(n => n.read = true);
        updateNotificationBadge();
        displayNotifications();
        showNotification('All notifications marked as read', 'success');
        console.log('✅ All notifications marked as read');
      } else {
        throw new Error('Failed to mark all notifications as read');
      }
    } catch (error) {
      console.error('❌ Error marking all notifications as read:', error);
      showNotification('Failed to mark all notifications as read', 'error');
    }
  }

  // Create dashboard charts
  function createDashboardCharts() {
    createSpendingChart();
    createFrequencyChart();
    createStatisticsCharts();
  }

  // Destroy chart if exists
  function destroyChart(chartKey) {
    if (charts[chartKey]) {
      charts[chartKey].destroy();
      charts[chartKey] = null;
    }
  }

  // Create spending chart
  function createSpendingChart() {
    const ctx = document.getElementById('spendingChart');
    if (!ctx) return;

    destroyChart('spending');

    const months = [];
    const spending = [];
    const now = new Date();

    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      months.push(date.toLocaleDateString('en-US', { month: 'short' }));

      const monthSpending = userTickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getMonth() === date.getMonth() &&
                ticketDate.getFullYear() === date.getFullYear();
      }).reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      spending.push(monthSpending);
    }

    charts.spending = new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Spending (FC)',
          data: spending,
          borderColor: '#1E40AF',
          backgroundColor: 'rgba(30, 64, 175, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // Create frequency chart
  function createFrequencyChart() {
    const ctx = document.getElementById('frequencyChart');
    if (!ctx) return;

    destroyChart('frequency');

    const routeCounts = {};
    userTickets.forEach(ticket => {
      const route = `${ticket.origin} → ${ticket.destination}`;
      routeCounts[route] = (routeCounts[route] || 0) + 1;
    });

    const routes = Object.keys(routeCounts).slice(0, 5);
    const counts = routes.map(route => routeCounts[route]);

    if (routes.length === 0) {
      ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
      return;
    }

    charts.frequency = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: routes,
        datasets: [{
          data: counts,
          backgroundColor: [
            '#1E40AF',
            '#DC2626',
            '#10B981',
            '#F59E0B',
            '#8B5CF6'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Create statistics charts
  function createStatisticsCharts() {
    createSpendingAnalysisChart();
    createRouteUsageChart();
    createMonthlyTrendsChart();
    createTravelPatternsChart();
  }

  // Create spending analysis chart
  function createSpendingAnalysisChart() {
    const ctx = document.getElementById('spendingAnalysisChart');
    if (!ctx) return;

    destroyChart('spendingAnalysis');

    const totalSpent = userTickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const categories = ['Regular Tickets', 'Luggage Fees', 'Premium Routes'];
    const amounts = [
      totalSpent * 0.8,
      totalSpent * 0.1,
      totalSpent * 0.1
    ];

    charts.spendingAnalysis = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: categories,
        datasets: [{
          data: amounts,
          backgroundColor: [
            '#1E40AF',
            '#F59E0B',
            '#10B981'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Create route usage chart
  function createRouteUsageChart() {
    const ctx = document.getElementById('routeUsageChart');
    if (!ctx) return;

    destroyChart('routeUsage');

    const routeCounts = {};
    userTickets.forEach(ticket => {
      const route = `${ticket.origin} → ${ticket.destination}`;
      routeCounts[route] = (routeCounts[route] || 0) + 1;
    });

    const routes = Object.keys(routeCounts).slice(0, 5);
    const counts = routes.map(route => routeCounts[route]);

    charts.routeUsage = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: routes,
        datasets: [{
          label: 'Trip Count',
          data: counts,
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: '#10B981',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // Create monthly trends chart
  function createMonthlyTrendsChart() {
    const ctx = document.getElementById('monthlyTrendsChart');
    if (!ctx) return;

    destroyChart('monthlyTrends');

    const months = [];
    const tripCounts = [];
    const spending = [];
    const now = new Date();

    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      months.push(date.toLocaleDateString('en-US', { month: 'short' }));

      const monthTickets = userTickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getMonth() === date.getMonth() &&
                ticketDate.getFullYear() === date.getFullYear();
      });

      tripCounts.push(monthTickets.length);

      const monthSpending = monthTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      spending.push(monthSpending);
    }

    charts.monthlyTrends = new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Trip Count',
          data: tripCounts,
          borderColor: '#1E40AF',
          backgroundColor: 'rgba(30, 64, 175, 0.1)',
          yAxisID: 'y'
        }, {
          label: 'Spending (FC)',
          data: spending,
          borderColor: '#DC2626',
          backgroundColor: 'rgba(220, 38, 38, 0.1)',
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // Create travel patterns chart
  function createTravelPatternsChart() {
    const ctx = document.getElementById('travelPatternsChart');
    if (!ctx) return;

    destroyChart('travelPatterns');

    const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const tripsByDay = new Array(7).fill(0);

    userTickets.forEach(ticket => {
      const date = new Date(ticket.departureTime);
      const dayOfWeek = date.getDay();
      tripsByDay[dayOfWeek === 0 ? 6 : dayOfWeek - 1]++;
    });

    charts.travelPatterns = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: daysOfWeek,
        datasets: [{
          label: 'Trip Count',
          data: tripsByDay,
          borderColor: '#8B5CF6',
          backgroundColor: 'rgba(139, 92, 246, 0.2)',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          r: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // Helper functions
  function calculateBusPrice(bus) {
    const basePrice = 2000;
    const distanceMultiplier = bus.route?.totalDistance ? (bus.route.totalDistance / 10) : 1;
    return Math.round(basePrice * distanceMultiplier);
  }

  function calculateTicketPrice(origin, destination, hasLuggage) {
    const basePrice = 2500; // Base price for bus tickets
    const luggagePrice = hasLuggage ? 500 : 0;
    return basePrice + luggagePrice;
  }

  function getRouteOrigin(bus) {
    if (bus.route && bus.route.startStation) {
      return bus.route.startStation;
    }
    return bus.schedule?.route?.startStation || 'Departure Station';
  }

  function getRouteDestination(bus) {
    if (bus.route && bus.route.endStation) {
      return bus.route.endStation;
    }
    return bus.schedule?.route?.endStation || 'Arrival Station';
  }

  function toggleLuggageWeight() {
    const checkbox = document.getElementById('hasLuggage');
    const weightGroup = document.getElementById('luggageWeightGroup');
    const weightInput = document.getElementById('luggageWeight');

    if (checkbox.checked) {
      weightGroup.style.display = 'block';
      weightInput.required = true;
    } else {
      weightGroup.style.display = 'none';
      weightInput.required = false;
      weightInput.value = '';
    }

    updateTotalPrice();
  }

  function updateTotalPrice() {
    if (!selectedBus) return;

    const basePrice = selectedBus.price || calculateBusPrice(selectedBus);
    const hasLuggage = document.getElementById('hasLuggage').checked;
    const luggagePrice = hasLuggage ? 500 : 0;
    const total = basePrice + luggagePrice;

    document.getElementById('totalPrice').textContent = total.toLocaleString() + ' FC';
  }

  function formatTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);

    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
    return `${Math.floor(diffInSeconds / 86400)}d ago`;
  }

  function getTimeBasedGreeting() {
    const hour = new Date().getHours();
    if (hour < 12) return 'Good Morning';
    if (hour < 18) return 'Good Afternoon';
    return 'Good Evening';
  }

  function updateWelcomeMessage() {
    const welcomeElement = document.getElementById('welcomeMessage');
    if (welcomeElement) {
      const greeting = getTimeBasedGreeting();
      const userName = currentUser?.firstName || 'Passenger';
      welcomeElement.textContent = `${greeting}, ${userName}! Welcome to Your Enhanced Dashboard`;
    }
  }

  function showSection(sectionName, event) {
    console.log('📄 Showing section:', sectionName);

    // Stop tracking when leaving tracking section
    if (sectionName !== 'live-tracking') {
      stopEnhancedBusTracking();
    }

    document.querySelectorAll('.section').forEach(section => {
      section.classList.add('hidden');
    });

    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
      targetSection.classList.remove('hidden');

      if (sectionName === 'dashboard') {
        updateWelcomeMessage();
      }
    }

    document.querySelectorAll('.sidebar-menu a').forEach(link => {
      link.classList.remove('active');
    });

    if (event) {
      const clickedLink = event.target.closest('a');
      if (clickedLink) {
        clickedLink.classList.add('active');
      }
    } else {
      const targetLink = document.querySelector(`[onclick*="${sectionName}"]`);
      if (targetLink) {
        targetLink.classList.add('active');
      }
    }

    // Load section-specific data
    switch(sectionName) {
      case 'dashboard':
        loadDashboardData();
        break;
      case 'book-ticket':
        searchBuses();
        break;
      case 'smart-planning':
        // Already loaded in loadDashboardData
        break;
      case 'my-trips':
        loadMyTrips();
        break;
      case 'live-tracking':
        setTimeout(() => initializeLiveTracking(), 100);
        break;
      case 'ratings':
        loadTripsToRate();
        loadRatingHistory();
        loadRatingStatistics();
        break;
      case 'statistics':
        createStatisticsCharts();
        break;
      case 'notifications':
        loadNotifications();
        break;
    }
  }

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const header = document.getElementById('header');

    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
    header.classList.toggle('expanded');
  }

  function toggleTheme() {
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    const icon = themeToggle.querySelector('i');

    if (body.getAttribute('data-theme') === 'dark') {
      body.setAttribute('data-theme', 'light');
      icon.className = 'fas fa-moon';
    } else {
      body.setAttribute('data-theme', 'dark');
      icon.className = 'fas fa-sun';
    }
  }

  function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    if (modalId === 'ticketDownloadModal') {
      currentTicketForDownload = null;
    }
  }

  // Enhanced notification system
  function showNotification(message, type = 'info') {
    let notificationContainer = document.getElementById('notificationContainer');
    if (!notificationContainer) {
      notificationContainer = document.createElement('div');
      notificationContainer.id = 'notificationContainer';
      notificationContainer.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              z-index: 10000;
              max-width: 400px;
          `;
      document.body.appendChild(notificationContainer);
    }

    const notification = document.createElement('div');
    notification.className = `notification-toast ${type}`;
    notification.textContent = message;

    notificationContainer.appendChild(notification);

    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 5000);

    notification.addEventListener('click', () => {
      notification.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    });
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // API helper functions
  async function fetchData(endpoint) {
    try {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      return Array.isArray(data) ? data : [];
    } catch (error) {
      console.error(`Fetch error for ${endpoint}:`, error);
      return [];
    }
  }

  function handleLogout(event) {
    event.preventDefault();

    if (confirm('Are you sure you want to logout?')) {
      // Clean up session data
      localStorage.removeItem('userToken');
      localStorage.removeItem('userData');
      localStorage.removeItem('userSession');
      sessionStorage.clear();

      // Stop all intervals
      if (realTimeInterval) clearInterval(realTimeInterval);
      if (window.enhancedBusTrackingInterval) clearInterval(window.enhancedBusTrackingInterval);

      // Redirect to login
      window.location.href = 'login.html';
    }
  }

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (realTimeInterval) {
      clearInterval(realTimeInterval);
    }

    stopEnhancedBusTracking();

    Object.keys(charts).forEach(key => {
      if (charts[key]) {
        charts[key].destroy();
      }
    });
  });

  // Additional CSS for enhanced animations
  const enhancedStyles = document.createElement('style');
  enhancedStyles.textContent = `
      @keyframes pulse {
          0% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.1); opacity: 0.7; }
          100% { transform: scale(1); opacity: 1; }
      }

      @keyframes pulse-danger {
          0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
          70% { transform: scale(1.05); opacity: 0.8; box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
          100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
      }

      @keyframes pulse-warning {
          0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
          70% { transform: scale(1.05); opacity: 0.8; box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
          100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
      }

      @keyframes pulse-success {
          0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
          70% { transform: scale(1.05); opacity: 0.8; box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
          100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
      }

      .enhanced-marker-pulse {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 60px;
          height: 60px;
          border-radius: 50%;
          opacity: 0.6;
          z-index: 1;
      }

      .enhanced-marker-container {
          position: relative;
          width: 60px;
          height: 60px;
      }

      .seats-counter {
          font-weight: bold;
          padding: 6px 12px;
          border-radius: 20px;
          background: #e9f7ef;
          color: #27ae60;
          border: 1px solid #27ae60;
          transition: all 0.3s ease;
      }

      .seats-counter.low {
          background: #fef9e7;
          color: #f39c12;
          border-color: #f39c12;
      }

      .seats-counter.full {
          background: #fdebeb;
          color: #e74c3c;
          border-color: #e74c3c;
      }
  `;

  document.head.appendChild(enhancedStyles);

  console.log('🚀 Enhanced IMAS Passenger Dashboard with Rating System fully initialized');
</script>
<script src="js/singleWindowValidator.js"></script>
</body>
</html>