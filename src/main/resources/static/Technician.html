<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAS - Technician Dashboard</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-blue: #1E40AF;
            --secondary-red: #DC2626;
            --light-blue: #3B82F6;
            --light-red: #EF4444;
            --gold: #F59E0B;
            --green: #10B981;
            --gray-dark: #1F2937;
            --gray-medium: #6B7280;
            --gray-light: #F3F4F6;
            --white: #FFFFFF;
            --sidebar-width: 280px;
            --header-height: 70px;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --success: #22C55E;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
        }

        [data-theme="dark"] {
            --white: #1F2937;
            --gray-light: #374151;
            --gray-medium: #9CA3AF;
            --gray-dark: #F9FAFB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-light);
            color: var(--gray-dark);
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: var(--white);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 2rem;
            transition: var(--transition);
        }

        .header.expanded {
            left: 80px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background: var(--gray-light);
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-dark);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .notification-btn:hover {
            background: var(--gray-light);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: var(--secondary-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--gray-light);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--gray-light);
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-profile:hover {
            background: var(--light-blue);
            color: var(--white);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 0.9rem;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-email {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--white);
            border-right: 1px solid rgba(0,0,0,0.1);
            box-shadow: var(--shadow);
            z-index: 1100;
            transition: var(--transition);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            transition: var(--transition);
        }

        .sidebar.collapsed .logo-text {
            opacity: 0;
            transform: translateX(-10px);
        }

        .sidebar-menu {
            flex: 1;
            padding: 1rem 0;
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin: 0.25rem 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.5rem;
            color: var(--gray-medium);
            text-decoration: none;
            transition: var(--transition);
            border-radius: 0 25px 25px 0;
            margin-right: 1rem;
            font-weight: 500;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: linear-gradient(90deg, rgba(30,64,175,0.1) 0%, rgba(30,64,175,0.05) 100%);
            color: var(--primary-blue);
            transform: translateX(5px);
        }

        .sidebar-menu a.active {
            border-right: 3px solid var(--primary-blue);
        }

        .sidebar-menu .menu-icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar-menu .menu-text {
            transition: var(--transition);
        }

        .sidebar.collapsed .menu-text {
            opacity: 0;
            transform: translateX(-10px);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 2rem;
            min-height: calc(100vh - var(--header-height));
            transition: var(--transition);
        }

        .main-content.expanded {
            margin-left: 80px;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-dark);
            margin: 0;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: var(--white);
            flex-shrink: 0;
        }

        .stat-icon.tasks {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        }

        .stat-icon.progress {
            background: linear-gradient(135deg, var(--gold), #F59E0B);
        }

        .stat-icon.completed {
            background: linear-gradient(135deg, var(--green), #22C55E);
        }

        .stat-icon.efficiency {
            background: linear-gradient(135deg, var(--secondary-red), var(--light-red));
        }

        .stat-info h3 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-dark);
            margin-bottom: 0.5rem;
        }

        .stat-info p {
            color: var(--gray-medium);
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            justify-content: center;
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30,64,175,0.3);
            background: var(--light-blue);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-success {
            background: var(--green);
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 8px 25px rgba(16,185,129,0.3);
        }

        .btn-warning {
            background: var(--gold);
            color: var(--gray-dark);
        }

        .btn-warning:hover {
            background: #F59E0B;
            box-shadow: 0 8px 25px rgba(245,158,11,0.3);
        }

        .btn-danger {
            background: var(--secondary-red);
        }

        .btn-danger:hover {
            background: var(--light-red);
            box-shadow: 0 8px 25px rgba(220,38,38,0.3);
        }

        .btn-secondary {
            background: var(--gray-medium);
        }

        .btn-secondary:hover {
            background: var(--gray-dark);
            box-shadow: 0 8px 25px rgba(107,114,128,0.3);
        }

        .btn-outline-primary {
            background: transparent;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .btn-outline-primary:hover {
            background: var(--primary-blue);
            color: var(--white);
        }

        /* Tables */
        .table-container {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .table th,
        .table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .table thead th {
            background: var(--gray-light);
            font-weight: 600;
            color: var(--gray-dark);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background: rgba(30, 64, 175, 0.05);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge.bg-success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .badge.bg-primary {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .badge.bg-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge.bg-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge.bg-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .badge.bg-secondary {
            background: rgba(107, 114, 128, 0.1);
            color: var(--gray-medium);
        }

        /* Progress */
        .progress {
            width: 100%;
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.25rem 0;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-bar.bg-primary {
            background: linear-gradient(90deg, var(--primary-blue), var(--light-blue));
        }

        .progress-bar.bg-success {
            background: linear-gradient(90deg, var(--green), #22C55E);
        }

        .progress-bar.bg-warning {
            background: linear-gradient(90deg, var(--gold), #F59E0B);
        }

        .progress-bar.bg-danger {
            background: linear-gradient(90deg, var(--secondary-red), var(--light-red));
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-dialog {
            background: var(--white);
            border-radius: var(--border-radius);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content {
            padding: 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-dark);
            margin: 0;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-medium);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .btn-close:hover {
            background: var(--gray-light);
            color: var(--gray-dark);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 2rem;
            border-top: 1px solid var(--gray-light);
        }

        /* Tabs */
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-light);
            margin-bottom: 1.5rem;
            list-style: none;
            padding: 0;
        }

        .nav-item {
            margin: 0;
        }

        .nav-link {
            display: block;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: var(--gray-medium);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
        }

        .tab-content {
            padding: 1.5rem 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-dark);
        }

        .form-control {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
            color: var(--gray-dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
        }

        .form-range {
            width: 100%;
            height: 6px;
            background: var(--gray-light);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-blue);
            border-radius: 50%;
            cursor: pointer;
        }

        .form-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-blue);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .toast-body {
            padding: 1rem;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin: 1rem 0;
        }

        .gauge-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        /* Loading Spinner */
        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: -0.125em;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.125em;
        }

        /* Utility Classes */
        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--gray-medium);
        }

        .fw-bold {
            font-weight: 700;
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 1rem;
        }

        .mb-4 {
            margin-bottom: 1.5rem;
        }

        .py-4 {
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
        }

        .visually-hidden {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        /* Live Update Indicator */
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            color: var(--green);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* Task Description Truncation */
        .task-description {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Priority Badges */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.priority-high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .priority-badge.priority-medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .priority-badge.priority-low {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            font-family: monospace;
            font-size: 0.8rem;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 9998;
            font-size: 1.2rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }

            .sidebar .menu-text,
            .sidebar .logo-text {
                opacity: 0;
                transform: translateX(-10px);
            }

            .main-content {
                margin-left: 80px;
            }

            .header {
                left: 80px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }






        /* Task Actions Section - Style moderne et responsive */
        #taskActionsSection {
            margin-top: 1.5rem;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        #taskActionsSection h4 {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.75rem;
            position: relative;
        }

        #taskActionsSection h4::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* Container pour les boutons */
        .task-actions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        /* Styles de base pour tous les boutons */
        #taskActionsSection .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            text-decoration: none;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 44px; /* Accessibilité tactile */
            white-space: nowrap;
        }

        /* Effet de survol général */
        #taskActionsSection .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
            z-index: 1;
        }

        #taskActionsSection .btn:hover::before {
            left: 100%;
        }

        /* Bouton Accept - Vert */
        #acceptTaskBtn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #28a745;
        }

        #acceptTaskBtn:hover {
            background: linear-gradient(135deg, #218838 0%, #1db584 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        /* Bouton Reject - Rouge */
        #rejectTaskBtn {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
            border-color: #dc3545;
        }

        #rejectTaskBtn:hover {
            background: linear-gradient(135deg, #c82333 0%, #d62c1a 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        /* Bouton Update Progress - Bleu */
        #updateProgressBtn {
            background: linear-gradient(135deg, #007bff 0%, #667eea 100%);
            color: white;
            border-color: #007bff;
        }

        #updateProgressBtn:hover {
            background: linear-gradient(135deg, #0056b3 0%, #5a6fd8 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        /* Bouton Complete - Orange/Jaune */
        #completeTaskBtn {
            background: linear-gradient(135deg, #ffc107 0%, #ff9500 100%);
            color: #212529;
            border-color: #ffc107;
            font-weight: 600;
        }

        #completeTaskBtn:hover {
            background: linear-gradient(135deg, #e0a800 0%, #e6851e 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
            color: #000;
        }

        /* Bouton Download - Gris outline */
        #downloadTaskPdfBtn {
            background: transparent;
            color: #6c757d;
            border-color: #6c757d;
        }

        #downloadTaskPdfBtn:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.2);
        }

        /* Icônes */
        #taskActionsSection .btn i {
            width: 18px;
            height: 18px;
            z-index: 2;
            position: relative;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #taskActionsSection {
                padding: 1rem;
                margin-top: 1rem;
            }

            .task-actions-container {
                flex-direction: column;
                width: 100%;
            }

            #taskActionsSection .btn {
                width: 100%;
                justify-content: center;
                padding: 1rem;
                font-size: 1rem;
            }

            #taskActionsSection h4 {
                font-size: 1.1rem;
                text-align: center;
            }
        }

        @media (max-width: 576px) {
            #taskActionsSection {
                border-radius: 8px;
                margin-left: -0.5rem;
                margin-right: -0.5rem;
            }

            #taskActionsSection .btn {
                font-size: 0.9rem;
                padding: 0.875rem;
            }
        }

        /* Animation d'entrée */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #taskActionsSection {
            animation: slideInUp 0.5s ease-out;
        }

        /* États focus pour l'accessibilité */
        #taskActionsSection .btn:focus {
            outline: 2px solid #4a90e2;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        /* États désactivés */
        #taskActionsSection .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #taskActionsSection .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Animation de pulsation pour les boutons importants */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        #acceptTaskBtn.pulse {
            animation: pulse 2s infinite;
        }

        #completeTaskBtn.pulse {
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
        }




    </style>
</head>
<body data-theme="light">
<!-- Debug Toggle -->
<!--<button class="debug-toggle" onclick="toggleDebug()">🐛</button>-->

<!-- Debug Panel -->
<div id="debugPanel" class="debug-panel">
    <h4>Debug Console</h4>
    <div id="debugContent"></div>
</div>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo-icon">
            <i data-lucide="wrench"></i>
        </div>
        <span class="logo-text">IMAS</span>
    </div>
    <div class="sidebar-menu">
        <ul>
            <li>
                <a href="#" class="active nav-link" data-section="dashboard">
                    <i data-lucide="gauge" class="menu-icon"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-section="tasks">
                    <i data-lucide="list-checks" class="menu-icon"></i>
                    <span class="menu-text">My Tasks</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-section="task-history">
                    <i data-lucide="history" class="menu-icon"></i>
                    <span class="menu-text">Task History</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-section="performance">
                    <i data-lucide="trending-up" class="menu-icon"></i>
                    <span class="menu-text">Performance</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-section="analytics">
                    <i data-lucide="bar-chart-3" class="menu-icon"></i>
                    <span class="menu-text">Analytics</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-section="workload">
                    <i data-lucide="activity" class="menu-icon"></i>
                    <span class="menu-text">Workload</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-section="equipment">
                    <i data-lucide="cog" class="menu-icon"></i>
                    <span class="menu-text">Equipment</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-section="reports">
                    <i data-lucide="file-text" class="menu-icon"></i>
                    <span class="menu-text">Reports</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" data-section="tools">
                    <i data-lucide="settings" class="menu-icon"></i>
                    <span class="menu-text">Tools</span>
                </a>
            </li>
            <li>
                <a href="WhatsApp.html" class="nav-link">
                    <i data-lucide="message-circle" class="menu-icon"></i>
                    <span class="menu-text">WhatsApp</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link" onclick="logout()">
                    <i data-lucide="log-out" class="menu-icon"></i>
                    <span class="menu-text">Logout</span>
                </a>
            </li>
        </ul>
    </div>
</nav>

<!-- Header -->
<header class="header" id="header">
    <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle">
            <i data-lucide="menu"></i>
        </button>
    </div>
    <div class="header-center">
        <h1 class="header-title">Technician Dashboard</h1>
    </div>
    <div class="header-right">
        <div class="live-indicator">
            <div class="live-dot"></div>
            Live Updates
        </div>
        <button class="theme-toggle" id="themeToggle">
            <i data-lucide="sun"></i>
        </button>
        <div class="user-profile" id="userProfile">
            <div class="user-avatar" id="userAvatar">T</div>
            <div class="user-info">
                <div class="user-name" id="userName">Technician</div>
                <div class="user-email" id="userEmail">tech@imas.com</div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="main-content" id="mainContent">
    <!-- Dashboard Section -->
    <section id="dashboard-section" class="content-section active">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 id="welcomeMessage" style="color: var(--gray-dark);">Welcome back!</h1>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon tasks">
                    <i data-lucide="list-checks"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalTasksCount">0</h3>
                    <p>Total Tasks</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon progress">
                    ⏳
                </div>
                <div class="stat-info">
                    <h3 id="inProgressTasksCount">0</h3>
                    <p>In Progress</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon completed">
                    <i data-lucide="check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="completedTasksCount">0</h3>
                    <p>Completed</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon efficiency">
                    <i data-lucide="gauge"></i>
                </div>
                <div class="stat-info">
                    <h3 id="efficiencyScore">0%</h3>
                    <p>Efficiency</p>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-grid">
            <div class="card">
                <h3 class="card-title">Task Completion Trend</h3>
                <div class="chart-container">
                    <canvas id="taskTrendChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Task Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="taskStatusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Efficiency Gauge</h3>
                <div class="gauge-container">
                    <canvas id="efficiencyGaugeChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Weekly Progress</h3>
                <div class="chart-container">
                    <canvas id="weeklyProgressChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Tasks -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Tasks</h3>
                <button class="btn btn-outline-primary" onclick="refreshTasks()">
                    <i data-lucide="refresh-cw"></i>
                    Refresh
                </button>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                    <tr>
                        <th>Task ID</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Due Date</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="recentTasksTable">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading tasks...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Tasks Section -->
    <section id="tasks-section" class="content-section">
        <h1 class="mb-4" style="color: var(--gray-dark);">My Tasks</h1>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Task Management</h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" id="refreshTasksBtn">
                        <i data-lucide="refresh-cw"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <ul class="nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="assigned-tab" data-tab="assigned-tasks" href="#" role="tab">
                            Assigned Tasks
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="in-progress-tab" data-tab="in-progress-tasks" href="#" role="tab">
                            In Progress
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="completed-tab" data-tab="completed-tasks" href="#" role="tab">
                            Completed
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Assigned Tasks Tab -->
                    <div class="tab-pane active" id="assigned-tasks" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>Task ID</th>
                                    <th>Description</th>
                                    <th>Equipment</th>
                                    <th>Priority</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="assignedTasksTable">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading assigned tasks...</p>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- In Progress Tasks Tab -->
                    <div class="tab-pane" id="in-progress-tasks" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>Task ID</th>
                                    <th>Description</th>
                                    <th>Equipment</th>
                                    <th>Progress</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="inProgressTasksTable">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading in-progress tasks...</p>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Completed Tasks Tab -->
                    <div class="tab-pane" id="completed-tasks" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>Task ID</th>
                                    <th>Description</th>
                                    <th>Equipment</th>
                                    <th>Completed</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="completedTasksTable">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading completed tasks...</p>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Task History Section -->
    <section id="task-history-section" class="content-section">
        <h1 class="mb-4" style="color: var(--gray-dark);">Task History</h1>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Complete Task History</h3>
                <div class="d-flex gap-2">
                    <select class="form-control" id="historyFilter" style="width: auto;">
                        <option value="all">All Tasks</option>
                        <option value="last-week">Last Week</option>
                        <option value="last-month">Last Month</option>
                        <option value="last-quarter">Last Quarter</option>
                    </select>
                    <button class="btn btn-outline-primary" onclick="exportTaskHistory()">
                        <i data-lucide="download"></i>
                        Export
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                    <tr>
                        <th>Task ID</th>
                        <th>Description</th>
                        <th>Equipment</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Created</th>
                        <th>Completed</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="taskHistoryTable">
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading task history...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Performance Section -->
    <section id="performance-section" class="content-section">
        <h1 class="mb-4" style="color: var(--gray-dark);">Performance Metrics</h1>

        <div class="stats-grid mb-4">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #17a2b8, #20c997);">
                    <i data-lucide="clock"></i>
                </div>
                <div class="stat-info">
                    <h3 id="avgCompletionTime">0h</h3>
                    <p>Avg Completion Time</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #fd7e14, #ffc107);">
                    <i data-lucide="target"></i>
                </div>
                <div class="stat-info">
                    <h3 id="firstTimeFixRate">0%</h3>
                    <p>First Time Fix Rate</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #6f42c1, #d63384);">
                    <i data-lucide="repeat"></i>
                </div>
                <div class="stat-info">
                    <h3 id="reworkRate">0%</h3>
                    <p>Rework Rate</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #198754, #20c997);">
                    <i data-lucide="shield-check"></i>
                </div>
                <div class="stat-info">
                    <h3 id="safetyScore">100%</h3>
                    <p>Safety Score</p>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="card">
                <h3 class="card-title">Performance Trends</h3>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Task Completion Rate</h3>
                <div class="chart-container">
                    <canvas id="completionRateChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Monthly Comparison</h3>
                <div class="chart-container">
                    <canvas id="monthlyComparisonChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Task Priority Distribution</h3>
                <div class="chart-container">
                    <canvas id="priorityDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Analytics Section -->
    <section id="analytics-section" class="content-section">
        <h1 class="mb-4" style="color: var(--gray-dark);">Advanced Analytics</h1>

        <div class="charts-grid">
            <div class="card">
                <h3 class="card-title">Task Duration Analysis</h3>
                <div class="chart-container">
                    <canvas id="durationAnalysisChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Equipment Tasks Distribution</h3>
                <div class="chart-container">
                    <canvas id="equipmentTasksChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Hourly Productivity</h3>
                <div class="chart-container">
                    <canvas id="hourlyProductivityChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Task Status Timeline</h3>
                <div class="chart-container">
                    <canvas id="statusTimelineChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Workload Section -->
    <section id="workload-section" class="content-section">
        <h1 class="mb-4" style="color: var(--gray-dark);">Workload Management</h1>

        <div class="charts-grid">
            <div class="card">
                <h3 class="card-title">Current Workload Gauge</h3>
                <div class="gauge-container">
                    <canvas id="workloadGaugeChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Daily Task Load</h3>
                <div class="chart-container">
                    <canvas id="dailyTaskLoadChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Task Types Breakdown</h3>
                <div class="chart-container">
                    <canvas id="taskTypesChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="card-title">Capacity vs Demand</h3>
                <div class="chart-container">
                    <canvas id="capacityDemandChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Equipment Section -->
    <section id="equipment-section" class="content-section">
        <h1 class="mb-4" style="color: var(--gray-dark);">Equipment Overview</h1>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Equipment I Work On</h3>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                    <tr>
                        <th>Equipment</th>
                        <th>Model</th>
                        <th>Location</th>
                        <th>Tasks Assigned</th>
                        <th>Last Maintenance</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody id="equipmentTable">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading equipment data...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Reports Section -->
    <section id="reports-section" class="content-section">
        <h1 class="mb-4" style="color: var(--gray-dark);">Generate Reports</h1>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Available Reports</h3>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="card" style="border: 2px solid var(--primary-blue);">
                        <div class="text-center py-4">
                            <i data-lucide="file-text" style="font-size: 3rem; color: var(--primary-blue); margin-bottom: 1rem;"></i>
                            <h4>Task Summary Report</h4>
                            <p class="text-muted">Complete overview of all assigned and completed tasks</p>
                            <button class="btn" onclick="generateTaskReport()">
                                <i data-lucide="download"></i>
                                Generate PDF
                            </button>
                        </div>
                    </div>
                    <div class="card" style="border: 2px solid var(--green);">
                        <div class="text-center py-4">
                            <i data-lucide="trending-up" style="font-size: 3rem; color: var(--green); margin-bottom: 1rem;"></i>
                            <h4>Performance Report</h4>
                            <p class="text-muted">Detailed performance metrics and efficiency analysis</p>
                            <button class="btn btn-success" onclick="generatePerformanceReport()">
                                <i data-lucide="download"></i>
                                Generate PDF
                            </button>
                        </div>
                    </div>
                    <div class="card" style="border: 2px solid var(--gold);">
                        <div class="text-center py-4">
                            <i data-lucide="calendar" style="font-size: 3rem; color: var(--gold); margin-bottom: 1rem;"></i>
                            <h4>Weekly Summary</h4>
                            <p class="text-muted">Weekly work summary with hours and completion rates</p>
                            <button class="btn btn-warning" onclick="generateWeeklyReport()">
                                <i data-lucide="download"></i>
                                Generate PDF
                            </button>
                        </div>
                    </div>
                    <div class="card" style="border: 2px solid var(--secondary-red);">
                        <div class="text-center py-4">
                            <i data-lucide="bar-chart-3" style="font-size: 3rem; color: var(--secondary-red); margin-bottom: 1rem;"></i>
                            <h4>Analytics Report</h4>
                            <p class="text-muted">Advanced analytics and insights</p>
                            <button class="btn btn-danger" onclick="generateAnalyticsReport()">
                                <i data-lucide="download"></i>
                                Generate PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Tools Section -->
    <section id="tools-section" class="content-section">
        <h1 class="mb-4" style="color: var(--gray-dark);">Technician Tools</h1>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Quick Tools</h3>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="card" style="border: 2px solid var(--info);">
                        <div class="text-center py-4">
                            <i data-lucide="calculator" style="font-size: 3rem; color: var(--info); margin-bottom: 1rem;"></i>
                            <h4>Time Calculator</h4>
                            <p class="text-muted">Calculate task duration and time estimates</p>
                            <button class="btn" onclick="openTimeCalculator()">
                                <i data-lucide="play"></i>
                                Open Tool
                            </button>
                        </div>
                    </div>
                    <div class="card" style="border: 2px solid var(--warning);">
                        <div class="text-center py-4">
                            <i data-lucide="clipboard-list" style="font-size: 3rem; color: var(--warning); margin-bottom: 1rem;"></i>
                            <h4>Task Checklist</h4>
                            <p class="text-muted">Create and manage task checklists</p>
                            <button class="btn btn-warning" onclick="openTaskChecklist()">
                                <i data-lucide="play"></i>
                                Open Tool
                            </button>
                        </div>
                    </div>
                    <div class="card" style="border: 2px solid var(--success);">
                        <div class="text-center py-4">
                            <i data-lucide="camera" style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;"></i>
                            <h4>Photo Notes</h4>
                            <p class="text-muted">Take photos and add notes for tasks</p>
                            <button class="btn btn-success" onclick="openPhotoNotes()">
                                <i data-lucide="play"></i>
                                Open Tool
                            </button>
                        </div>
                    </div>
                    <div class="card" style="border: 2px solid var(--danger);">
                        <div class="text-center py-4">
                            <i data-lucide="alert-triangle" style="font-size: 3rem; color: var(--danger); margin-bottom: 1rem;"></i>
                            <h4>Issue Reporter</h4>
                            <p class="text-muted">Report equipment issues or safety concerns</p>
                            <button class="btn btn-danger" onclick="openIssueReporter()">
                                <i data-lucide="play"></i>
                                Open Tool
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Task Details Modal -->
<div class="modal" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="taskDetailsModalLabel">Task Details</h2>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Task ID:</label>
                            <p id="detailTaskId">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Description:</label>
                            <p id="detailTaskDescription">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Equipment:</label>
                            <p id="detailTaskEquipment">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Priority:</label>
                            <p id="detailTaskPriority">-</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Status:</label>
                            <p id="detailTaskStatus">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Due Date:</label>
                            <p id="detailTaskDueDate">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Progress:</label>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-primary" id="detailTaskProgressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="detailTaskProgressText">0%</small>
                        </div>
                    </div>
                </div>




                <div class="row mt-3" id="taskActionsSection">
                    <div class="col-12">
                        <h4>Task Actions</h4>
                        <div class="task-actions-container">
                            <button class="btn btn-success" id="acceptTaskBtn" onclick="technicianDashboard.acceptTask()">
                                <i data-lucide="check-circle"></i>
                                Accept Task
                            </button>
                            <button class="btn btn-danger" id="rejectTaskBtn" onclick="technicianDashboard.rejectTask()">
                                <i data-lucide="x-circle"></i>
                                Reject Task
                            </button>
                            <button class="btn" id="updateProgressBtn" onclick="technicianDashboard.showUpdateProgressModal()">
                                <i data-lucide="trending-up"></i>
                                Update Progress
                            </button>
                            <button class="btn btn-warning" id="completeTaskBtn" onclick="technicianDashboard.completeTask()">
                                <i data-lucide="flag"></i>
                                Mark as Completed
                            </button>
                            <button class="btn btn-outline-secondary" id="downloadTaskPdfBtn" onclick="technicianDashboard.downloadTaskPDF()">
                                <i data-lucide="file-text"></i>
                                Download PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Progress Modal -->
<div class="modal" id="updateProgressModal" tabindex="-1" aria-labelledby="updateProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="updateProgressModalLabel">Update Task Progress</h2>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="progressForm">
                    <input type="hidden" id="progressTaskId">
                    <div class="mb-3">
                        <label for="progressPercentage" class="form-label">Progress Percentage *</label>
                        <input type="range" class="form-range" min="0" max="100" step="5" id="progressPercentage">
                        <div class="d-flex justify-content-between">
                            <span>0%</span>
                            <span id="progressPercentageValue">50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="progressNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="progressNotes" rows="3" placeholder="Add any notes about the progress..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn" id="saveProgressBtn">Save Progress</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="notificationToast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
        <i id="toastIcon"></i>
        <strong id="toastTitle">Notification</strong>
        <small>Just now</small>
        <button type="button" class="btn-close" data-dismiss="toast" aria-label="Close">
            <i data-lucide="x"></i>
        </button>
    </div>
    <div class="toast-body" id="toastMessage">
        Action completed successfully.
    </div>
</div>




<script>
    // Global Configuration
    const API_BASE_URL = '/api';
    const TASKS_API_URL = `${API_BASE_URL}/tasks`;
    const STAFF_API_URL = `${API_BASE_URL}/staff`;
    const EQUIPMENT_API_URL = `${API_BASE_URL}/equipment`;

    // Debug functionality
    let debugEnabled = false;
    const debugLog = [];

    function toggleDebug() {
        debugEnabled = !debugEnabled;
        const panel = document.getElementById('debugPanel');
        panel.classList.toggle('show', debugEnabled);
        if (debugEnabled) {
            updateDebugPanel();
        }
    }

    function addDebugLog(message, type = 'info') {
        const timestamp = new Date().toISOString();
        debugLog.push({ timestamp, message, type });
        console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
        if (debugEnabled) {
            updateDebugPanel();
        }
    }

    function updateDebugPanel() {
        const content = document.getElementById('debugContent');
        if (!content) return;

        content.innerHTML = debugLog.slice(-20).map(log =>
            `<div style="color: ${log.type === 'error' ? '#ff6b6b' : log.type === 'warning' ? '#ffd93d' : '#74c0fc'};">
                [${log.timestamp.split('T')[1].split('.')[0]}] ${log.message}
            </div>`
        ).join('');
        content.scrollTop = content.scrollHeight;
    }

    // Initialize Lucide icons
    lucide.createIcons();






    // Main Technician Dashboard Class
    class TechnicianDashboard {
        constructor() {
            this.currentUser = null;
            this.allTasks = [];
            this.assignedTasks = [];
            this.inProgressTasks = [];
            this.completedTasks = [];
            this.charts = {};
            this.refreshInterval = null;
            this.init();
        }





        ensureDOMElementsExist() {
            const requiredElements = [
                'assignedTasksTable',
                'inProgressTasksTable',
                'completedTasksTable',
                'recentTasksTable',
                'totalTasksCount',
                'inProgressTasksCount',
                'completedTasksCount',
                'efficiencyScore'
            ];

            const missingElements = [];

            requiredElements.forEach(elementId => {
                if (!document.getElementById(elementId)) {
                    missingElements.push(elementId);
                }
            });

            if (missingElements.length > 0) {
                addDebugLog(`Missing DOM elements: ${missingElements.join(', ')}`, 'error');
                this.showToast('Error', 'Page not fully loaded. Please refresh.', 'error');
                return false;
            }

            return true;
        }

// 12. FIXED: Modified init method to include DOM validation
        async init() {
            try {
                addDebugLog('Initializing dashboard...');

                // FIXED: Check if DOM elements exist first
                if (!this.ensureDOMElementsExist()) {
                    setTimeout(() => this.init(), 1000); // Retry after 1 second
                    return;
                }

                // Check user session
                if (!this.checkUserSession()) {
                    addDebugLog('No valid user session found', 'error');
                    this.redirectToLogin();
                    return;
                }

                addDebugLog(`User session found: ${this.currentUser.firstName} ${this.currentUser.lastName} (ID: ${this.currentUser.id})`);

                // Initialize UI
                this.setupEventListeners();
                this.setupNavigation();
                this.setupThemeToggle();
                this.setupSidebarToggle();
                this.updateUserInfo();
                this.initializeCharts();

                // FIXED: Load data with proper error handling
                try {
                    await this.loadTechnicianTasks();
                } catch (error) {
                    addDebugLog(`Failed to load initial tasks: ${error.message}`, 'error');
                    this.showToast('Warning', 'Could not load tasks initially. You can try refreshing.', 'warning');
                }

                // Setup real-time updates
                this.setupRealTimeUpdates();

                this.showToast('Welcome!', `Hello ${this.currentUser.firstName}! Dashboard loaded successfully.`, 'success');
                addDebugLog('Dashboard initialization completed successfully');
            } catch (error) {
                addDebugLog(`Dashboard initialization error: ${error.message}`, 'error');
                console.error('Full initialization error:', error);
                this.showToast('Error', 'Failed to initialize dashboard. Please refresh the page.', 'error');
            }
        }




        checkUserSession() {
            try {
                const userSession = localStorage.getItem('userSession');
                if (!userSession) {
                    addDebugLog('No user session found in localStorage', 'warning');
                    return false;
                }

                this.currentUser = JSON.parse(userSession);
                addDebugLog(`Parsed user session: ${JSON.stringify(this.currentUser)}`);

                // FIXED: Better validation of user object
                if (!this.currentUser.id) {
                    addDebugLog('User session missing ID', 'error');
                    return false;
                }

                if (!this.currentUser.role) {
                    addDebugLog('User session missing role', 'error');
                    return false;
                }

                // FIXED: Handle both string and enum role formats
                const userRole = this.currentUser.role.toString().toUpperCase();
                if (userRole !== 'TECHNICIAN') {
                    addDebugLog(`User role is ${userRole}, not TECHNICIAN`, 'error');
                    return false;
                }

                return true;
            } catch (error) {
                addDebugLog(`Session check error: ${error.message}`, 'error');
                return false;
            }
        }

        redirectToLogin() {
            localStorage.removeItem('userSession');
            window.location.href = '/login.html';
        }

        updateUserInfo() {
            try {
                if (!this.currentUser) return;

                // Update user name
                const userName = document.getElementById('userName');
                const userEmail = document.getElementById('userEmail');
                const userAvatar = document.getElementById('userAvatar');
                const welcomeMessage = document.getElementById('welcomeMessage');

                if (userName) {
                    userName.textContent = `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                }
                if (userEmail) {
                    userEmail.textContent = this.currentUser.email;
                }
                if (userAvatar) {
                    if (this.currentUser.photoBase64) {
                        const img = document.createElement('img');
                        img.src = `data:image/jpeg;base64,${this.currentUser.photoBase64}`;
                        img.alt = 'User Avatar';
                        userAvatar.innerHTML = '';
                        userAvatar.appendChild(img);
                    } else {
                        userAvatar.textContent = this.currentUser.firstName.charAt(0).toUpperCase();
                    }
                }
                if (welcomeMessage) {
                    welcomeMessage.textContent = `Welcome back, ${this.currentUser.firstName}!`;
                }

                addDebugLog('User info updated successfully');
            } catch (error) {
                addDebugLog(`Error updating user info: ${error.message}`, 'error');
            }
        }

        setupEventListeners() {
            // Refresh buttons
            const refreshTasksBtn = document.getElementById('refreshTasksBtn');
            if (refreshTasksBtn) {
                refreshTasksBtn.addEventListener('click', () => this.loadTechnicianTasks());
            }

            // Tab navigation
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchTab(tab.dataset.tab);
                });
            });

            // Task action buttons
            document.getElementById('acceptTaskBtn')?.addEventListener('click', () => this.acceptTask());
            document.getElementById('rejectTaskBtn')?.addEventListener('click', () => this.rejectTask());
            document.getElementById('updateProgressBtn')?.addEventListener('click', () => this.showUpdateProgressModal());
            document.getElementById('completeTaskBtn')?.addEventListener('click', () => this.completeTask());
            document.getElementById('saveProgressBtn')?.addEventListener('click', () => this.saveTaskProgress());
            document.getElementById('downloadTaskPdfBtn')?.addEventListener('click', () => this.downloadTaskPDF());

            // Progress slider
            const progressSlider = document.getElementById('progressPercentage');
            if (progressSlider) {
                progressSlider.addEventListener('input', (e) => {
                    document.getElementById('progressPercentageValue').textContent = `${e.target.value}%`;
                });
            }

            // Modal close buttons
            document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = btn.closest('.modal');
                    this.hideModal(modal.id);
                });
            });

            // History filter
            const historyFilter = document.getElementById('historyFilter');
            if (historyFilter) {
                historyFilter.addEventListener('change', () => this.filterTaskHistory());
            }

            addDebugLog('Event listeners setup completed');
        }

        setupNavigation() {
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showSection(link.dataset.section);

                    // Update active state
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });
        }

        setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('i');

            // Check saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                if (themeIcon) {
                    themeIcon.setAttribute('data-lucide', 'moon');
                    lucide.createIcons();
                }
            }

            themeToggle.addEventListener('click', () => {
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                if (isDark) {
                    document.body.setAttribute('data-theme', 'light');
                    themeIcon.setAttribute('data-lucide', 'sun');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.body.setAttribute('data-theme', 'dark');
                    themeIcon.setAttribute('data-lucide', 'moon');
                    localStorage.setItem('theme', 'dark');
                }
                lucide.createIcons();
                this.updateChartsTheme(!isDark);
            });
        }

        setupSidebarToggle() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('header');
            const mainContent = document.getElementById('mainContent');

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                header.classList.toggle('expanded');
                mainContent.classList.toggle('expanded');
            });

            // Mobile responsive
            if (window.innerWidth <= 768) {
                sidebar.classList.add('collapsed');
                header.classList.add('expanded');
                mainContent.classList.add('expanded');
            }
        }

        showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
                this.loadSectionData(sectionName);
            }
        }

        async loadSectionData(sectionName) {
            addDebugLog(`Loading section data for: ${sectionName}`);

            switch (sectionName) {
                case 'dashboard':
                    await this.loadDashboardData();
                    break;
                case 'tasks':
                    await this.loadTechnicianTasks();
                    break;
                case 'task-history':
                    await this.loadTaskHistory();
                    break;
                case 'performance':
                    await this.loadPerformanceData();
                    break;
                case 'analytics':
                    await this.loadAnalyticsData();
                    break;
                case 'workload':
                    await this.loadWorkloadData();
                    break;
                case 'equipment':
                    await this.loadEquipmentData();
                    break;
            }
        }




        async loadTechnicianTasks() {
            try {
                addDebugLog(`Starting to load tasks for technician ID: ${this.currentUser.id}`);
                this.showLoadingState();

                // FIXED: Ensure we have a valid user ID
                if (!this.currentUser || !this.currentUser.id) {
                    throw new Error('No valid technician ID found in session');
                }

                const response = await fetch(`${TASKS_API_URL}/by-technician/${this.currentUser.id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                addDebugLog(`API response status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    addDebugLog(`API error response: ${errorText}`, 'error');
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const tasks = await response.json();
                addDebugLog(`Received ${tasks.length} tasks from API`);

                // FIXED: Better task logging for debugging
                tasks.forEach(task => {
                    addDebugLog(`Task: ${task.taskId} - Status: ${task.status} - Priority: ${task.priority}`);
                });

                this.allTasks = tasks;
                this.processTasks(tasks);
                this.updateTaskStats();
                this.renderTaskTables();
                this.updateTaskCharts();

                // FIXED: Show success message only if we have data
                if (tasks.length > 0) {
                    this.showToast('Success', `Loaded ${tasks.length} tasks successfully`, 'success');
                } else {
                    this.showToast('Info', 'No tasks assigned to you at this time', 'info');
                }

                addDebugLog('Tasks loaded and processed successfully');
            } catch (error) {
                addDebugLog(`Error loading technician tasks: ${error.message}`, 'error');
                console.error('Full error details:', error);
                this.showToast('Error', `Failed to load tasks: ${error.message}`, 'error');
                this.renderEmptyTasks();
            }
        }



        async updateProgressQuick(taskId) {
            try {
                const task = this.findTaskById(taskId);
                if (!task) {
                    throw new Error('Task not found');
                }

                // Demander le pourcentage de progression
                const progress = prompt('Enter progress percentage (0-100):', '0');
                if (progress === null) return; // Cancelled

                const progressNumber = parseFloat(progress);
                if (isNaN(progressNumber) || progressNumber < 0 || progressNumber > 100) {
                    this.showToast('Error', 'Please enter a valid percentage between 0 and 100', 'error');
                    return;
                }

                // Demander les notes optionnelles
                const notes = prompt('Progress notes (optional):', '');

                addDebugLog(`Updating progress for task ${taskId} to ${progressNumber}%`);
                this.showToast('Info', 'Updating progress...', 'info');

                // Appeler l'API pour mettre à jour le progrès
                await this.updateTaskProgress(taskId, progressNumber, notes || '');

            } catch (error) {
                addDebugLog(`Error updating progress: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to update progress', 'error');
            }
        }


        async updateTaskProgress(taskId, percentage, notes) {
            try {
                const requestBody = {
                    completionPercentage: percentage,
                    technicianId: this.currentUser.id
                };

                if (notes && notes.trim()) {
                    requestBody.notes = notes.trim();
                }

                const response = await fetch(`${TASKS_API_URL}/${taskId}/completion`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addDebugLog(`Update progress error: ${errorText}`, 'error');
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const updatedTask = await response.json();
                addDebugLog(`Task ${taskId} progress updated to ${percentage}%`);

                // Si la tâche est complète à 100%, changer le statut automatiquement
                if (percentage >= 100) {
                    await this.updateTaskStatus(taskId, 'COMPLETED');
                    this.showToast('Success', 'Task completed successfully!', 'success');
                } else {
                    this.showToast('Success', `Progress updated to ${percentage}%`, 'success');
                }

                // Recharger les tâches
                await this.loadTechnicianTasks();

                return updatedTask;
            } catch (error) {
                addDebugLog(`Error updating task progress: ${error.message}`, 'error');
                throw error;
            }
        }

// 7. MODIFICATION: Améliorer renderInProgressTasks pour inclure la progression
        renderInProgressTasks() {
            const tbody = document.getElementById('inProgressTasksTable');
            if (!tbody) {
                addDebugLog('inProgressTasksTable element not found', 'error');
                return;
            }

            if (this.inProgressTasks.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    <i data-lucide="clock" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                    No tasks in progress
                    <br><small>Start working on assigned tasks</small>
                </td>
            </tr>`;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = this.inProgressTasks.map(task => {
                const taskId = this.escapeHtml(task.taskId || '');
                const description = this.escapeHtml(this.truncateText(task.description || 'No description', 50));
                const equipment = this.getEquipmentName(task.relatedEquipment);
                const priority = task.priority || 'MEDIUM';
                const progress = task.completionPercentage || 0;
                const dueDate = this.formatDate(task.dueDate);

                return `
            <tr>
                <td class="fw-bold">${taskId}</td>
                <td>
                    <div class="task-description" title="${this.escapeHtml(task.description || '')}">
                        ${description}
                    </div>
                </td>
                <td>${equipment}</td>
                <td>
                    <span class="priority-badge priority-${priority.toLowerCase()}">
                        ${priority}
                    </span>
                </td>
                <td>
                    <div class="progress mb-1" style="height: 20px;">
                        <div class="progress-bar bg-primary" role="progressbar"
                             style="width: ${progress}%"
                             aria-valuenow="${progress}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            ${progress}%
                        </div>
                    </div>
                    <small class="text-muted">${dueDate}</small>
                </td>
                <td>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="technicianDashboard.showTaskDetails('${taskId}')" title="View Details">
                            <i data-lucide="eye"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="technicianDashboard.updateProgressQuick('${taskId}')" title="Update Progress">
                            <i data-lucide="edit-3"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="technicianDashboard.completeTaskQuick('${taskId}')" title="Complete Task">
                            <i data-lucide="check-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="technicianDashboard.pauseTaskQuick('${taskId}')" title="Pause Task">
                            <i data-lucide="pause"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
            }).join('');

            lucide.createIcons();
            addDebugLog(`Rendered ${this.inProgressTasks.length} in-progress tasks`);
        }



        async pauseTaskQuick(taskId) {
            try {
                if (!taskId) {
                    throw new Error('Task ID is required');
                }

                if (!confirm('Put this task on hold? You can resume it later.')) {
                    return;
                }

                addDebugLog(`Pausing task: ${taskId}`);
                this.showToast('Info', 'Pausing task...', 'info');

                await this.updateTaskStatus(taskId, 'ON_HOLD');

            } catch (error) {
                addDebugLog(`Error pausing task: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to pause task', 'error');
            }
        }

        processTasks(tasks) {
            // CORRECTION: Traiter les tâches PLANNED comme des tâches assignées
            // car c'est le statut par défaut quand une tâche est assignée à un technicien
            this.assignedTasks = tasks.filter(task => {
                const status = task.status ? task.status.toString().toUpperCase() : '';
                return status === 'ASSIGNED' || status === 'PLANNED';
            });

            this.inProgressTasks = tasks.filter(task =>
                task.status && task.status.toString().toUpperCase() === 'IN_PROGRESS'
            );

            this.completedTasks = tasks.filter(task =>
                task.status && task.status.toString().toUpperCase() === 'COMPLETED'
            );

            addDebugLog(`Tasks processed - Assigned/Planned: ${this.assignedTasks.length}, In Progress: ${this.inProgressTasks.length}, Completed: ${this.completedTasks.length}`);

            if (this.assignedTasks.length > 0) {
                addDebugLog(`Sample assigned task: ${JSON.stringify(this.assignedTasks[0])}`);
            }
        }




        updateTaskStats() {
            try {
                // Compter toutes les tâches (assignées/planned + in progress + completed)
                const totalTasks = this.allTasks ? this.allTasks.length : 0;
                const inProgressCount = this.inProgressTasks ? this.inProgressTasks.length : 0;
                const completedCount = this.completedTasks ? this.completedTasks.length : 0;
                const assignedCount = this.assignedTasks ? this.assignedTasks.length : 0;

                // Calculer l'efficacité basée sur les tâches terminées
                let efficiency = 0;
                if (totalTasks > 0) {
                    efficiency = Math.round((completedCount / totalTasks) * 100);
                }

                // Mettre à jour les éléments DOM
                const elements = {
                    'totalTasksCount': totalTasks,
                    'inProgressTasksCount': inProgressCount,
                    'completedTasksCount': completedCount,
                    'efficiencyScore': `${efficiency}%`
                };

                Object.entries(elements).forEach(([elementId, value]) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = value;
                    } else {
                        addDebugLog(`Element ${elementId} not found`, 'warning');
                    }
                });

                // Mettre à jour les badges des onglets
                this.updateTabBadges(assignedCount, inProgressCount, completedCount);

                addDebugLog(`Stats updated - Total: ${totalTasks}, Assigned: ${assignedCount}, In Progress: ${inProgressCount}, Completed: ${completedCount}, Efficiency: ${efficiency}%`);
            } catch (error) {
                addDebugLog(`Error updating task stats: ${error.message}`, 'error');
            }
        }

        renderTaskTables() {
            this.renderAssignedTasks();
            this.renderInProgressTasks();
            this.renderCompletedTasks();
            this.renderRecentTasks();
        }




        updateTabBadges(assignedCount, inProgressCount, completedCount) {
            // Mettre à jour les badges dans les onglets si ils existent
            const badges = {
                'assignedTasksBadge': assignedCount,
                'inProgressTasksBadge': inProgressCount,
                'completedTasksBadge': completedCount
            };

            Object.entries(badges).forEach(([badgeId, count]) => {
                const badge = document.getElementById(badgeId);
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'inline' : 'none';
                }
            });
        }





        renderAssignedTasks() {
            const tbody = document.getElementById('assignedTasksTable');
            if (!tbody) {
                addDebugLog('assignedTasksTable element not found', 'error');
                return;
            }

            if (this.assignedTasks.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    <i data-lucide="inbox" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                    No assigned tasks
                    <br><small>New tasks will appear here when assigned</small>
                </td>
            </tr>`;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = this.assignedTasks.map(task => {
                const taskId = this.escapeHtml(task.taskId || '');
                const description = this.escapeHtml(this.truncateText(task.description || 'No description', 50));
                const equipment = this.getEquipmentName(task.relatedEquipment);
                const priority = task.priority || 'MEDIUM';
                const dueDate = this.formatDate(task.dueDate);

                // CORRECTION: Afficher le vrai statut de la tâche
                const currentStatus = task.status || 'PLANNED';
                const statusBadge = this.getStatusBadge(currentStatus);

                return `
            <tr>
                <td class="fw-bold">${taskId}</td>
                <td>
                    <div class="task-description" title="${this.escapeHtml(task.description || '')}">
                        ${description}
                    </div>
                </td>
                <td>${equipment}</td>
                <td>
                    <span class="priority-badge priority-${priority.toLowerCase()}">
                        ${priority}
                    </span>
                </td>
                <td>
                    ${statusBadge}
                    <br>
                    <small class="text-muted">
                        ${dueDate}
                    </small>
                </td>
                <td>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="technicianDashboard.showTaskDetails('${taskId}')" title="View Details">
                            <i data-lucide="eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="technicianDashboard.acceptTaskQuick('${taskId}')" title="Accept Task">
                            <i data-lucide="check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="technicianDashboard.rejectTaskQuick('${taskId}')" title="Reject Task">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
            }).join('');

            lucide.createIcons();
            addDebugLog(`Rendered ${this.assignedTasks.length} assigned/planned tasks`);
        }




        renderInProgressTasks() {
            const tbody = document.getElementById('inProgressTasksTable');
            if (!tbody) return;

            if (this.inProgressTasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            <i data-lucide="play-circle" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                            No tasks in progress
                            <br><small>Accepted tasks will appear here</small>
                        </td>
                    </tr>`;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = this.inProgressTasks.map(task => `
                <tr>
                    <td class="fw-bold">${this.escapeHtml(task.taskId)}</td>
                    <td>
                        <div class="task-description" title="${this.escapeHtml(task.description)}">
                            ${this.escapeHtml(this.truncateText(task.description, 50))}
                        </div>
                    </td>
                    <td>${this.getEquipmentName(task.relatedEquipment)}</td>
                    <td>
                        <div class="progress mb-1">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: ${task.completionPercentage || 0}%">
                            </div>
                        </div>
                        <small class="text-muted">${task.completionPercentage || 0}%</small>
                    </td>
                    <td>
                        <small class="text-muted">
                            ${this.formatDate(task.dueDate)}
                        </small>
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="technicianDashboard.showTaskDetails('${task.taskId}')">
                                <i data-lucide="eye"></i>
                            </button>
                            <button class="btn btn-sm" onclick="technicianDashboard.updateProgressQuick('${task.taskId}')">
                                <i data-lucide="trending-up"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="technicianDashboard.completeTaskQuick('${task.taskId}')">
                                <i data-lucide="check-circle"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            addDebugLog(`Rendered ${this.inProgressTasks.length} in-progress tasks`);
        }

        renderCompletedTasks() {
            const tbody = document.getElementById('completedTasksTable');
            if (!tbody) return;

            if (this.completedTasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            <i data-lucide="check-circle" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                            No completed tasks
                            <br><small>Completed tasks will appear here</small>
                        </td>
                    </tr>`;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = this.completedTasks.map(task => `
                <tr>
                    <td class="fw-bold">${this.escapeHtml(task.taskId)}</td>
                    <td>
                        <div class="task-description" title="${this.escapeHtml(task.description)}">
                            ${this.escapeHtml(this.truncateText(task.description, 50))}
                        </div>
                    </td>
                    <td>${this.getEquipmentName(task.relatedEquipment)}</td>
                    <td>
                        <small class="text-muted">
                            ${this.formatDate(task.completionDate)}
                        </small>
                    </td>
                    <td>
                        ${this.calculateDuration(task.creationDate, task.completionDate)}
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="technicianDashboard.showTaskDetails('${task.taskId}')">
                                <i data-lucide="eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="technicianDashboard.downloadTaskPDF('${task.taskId}')">
                                <i data-lucide="file-text"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            addDebugLog(`Rendered ${this.completedTasks.length} completed tasks`);
        }

        renderRecentTasks() {
            const tbody = document.getElementById('recentTasksTable');
            if (!tbody) return;

            const recentTasks = this.allTasks
                .sort((a, b) => new Date(b.creationDate) - new Date(a.creationDate))
                .slice(0, 5);

            if (recentTasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            <i data-lucide="list-checks" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                            No tasks available
                            <br><small>Tasks will appear here when assigned</small>
                        </td>
                    </tr>`;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = recentTasks.map(task => `
                <tr>
                    <td class="fw-bold">${this.escapeHtml(task.taskId)}</td>
                    <td>
                        <div class="task-description" title="${this.escapeHtml(task.description)}">
                            ${this.escapeHtml(this.truncateText(task.description, 40))}
                        </div>
                    </td>
                    <td>
                        <span class="badge ${this.getStatusBadgeClass(task.status)}">
                            ${task.status.replace('_', ' ')}
                        </span>
                    </td>
                    <td>
                        <span class="priority-badge priority-${task.priority.toLowerCase()}">
                            ${task.priority}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted">
                            ${this.formatDate(task.dueDate)}
                        </small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="technicianDashboard.showTaskDetails('${task.taskId}')">
                            <i data-lucide="eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async loadTaskHistory() {
            const tbody = document.getElementById('taskHistoryTable');
            if (!tbody) return;

            try {
                addDebugLog('Loading task history...');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading task history...</p>
                        </td>
                    </tr>`;

                // Use all tasks for history with proper filtering
                let filteredTasks = this.allTasks;
                const filter = document.getElementById('historyFilter')?.value || 'all';

                const now = new Date();
                switch (filter) {
                    case 'last-week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        filteredTasks = this.allTasks.filter(task => new Date(task.creationDate) >= weekAgo);
                        break;
                    case 'last-month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        filteredTasks = this.allTasks.filter(task => new Date(task.creationDate) >= monthAgo);
                        break;
                    case 'last-quarter':
                        const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        filteredTasks = this.allTasks.filter(task => new Date(task.creationDate) >= quarterAgo);
                        break;
                }

                if (filteredTasks.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4 text-muted">
                                <i data-lucide="history" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                                No task history available
                                <br><small>Task history will appear here as you work on tasks</small>
                            </td>
                        </tr>`;
                    lucide.createIcons();
                    return;
                }

                tbody.innerHTML = filteredTasks
                    .sort((a, b) => new Date(b.creationDate) - new Date(a.creationDate))
                    .map(task => `
                        <tr>
                            <td class="fw-bold">${this.escapeHtml(task.taskId)}</td>
                            <td>
                                <div class="task-description" title="${this.escapeHtml(task.description)}">
                                    ${this.escapeHtml(this.truncateText(task.description, 40))}
                                </div>
                            </td>
                            <td>${this.getEquipmentName(task.relatedEquipment)}</td>
                            <td>
                                <span class="badge ${this.getStatusBadgeClass(task.status)}">
                                    ${task.status.replace('_', ' ')}
                                </span>
                            </td>
                            <td>
                                <span class="priority-badge priority-${task.priority.toLowerCase()}">
                                    ${task.priority}
                                </span>
                            </td>
                            <td>
                                <small class="text-muted">
                                    ${this.formatDate(task.creationDate)}
                                </small>
                            </td>
                            <td>
                                <small class="text-muted">
                                    ${task.completionDate ? this.formatDate(task.completionDate) : 'N/A'}
                                </small>
                            </td>
                            <td>
                                ${this.calculateDuration(task.creationDate, task.completionDate)}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="technicianDashboard.showTaskDetails('${task.taskId}')">
                                    <i data-lucide="eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                lucide.createIcons();
                addDebugLog(`Rendered ${filteredTasks.length} tasks in history`);
            } catch (error) {
                addDebugLog(`Error loading task history: ${error.message}`, 'error');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-muted">
                            <i data-lucide="alert-triangle" style="font-size: 3rem; display: block; margin-bottom: 1rem; color: var(--danger);"></i>
                            Error loading task history
                            <br><small>Please try refreshing the page</small>
                        </td>
                    </tr>`;
                lucide.createIcons();
            }
        }

        filterTaskHistory() {
            this.loadTaskHistory();
        }

        async loadEquipmentData() {
            const tbody = document.getElementById('equipmentTable');
            if (!tbody) return;

            try {
                addDebugLog('Loading equipment data...');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading equipment data...</p>
                        </td>
                    </tr>`;

                // Get unique equipment from tasks
                const equipmentMap = new Map();
                this.allTasks.forEach(task => {
                    if (task.relatedEquipment) {
                        const key = task.relatedEquipment.id || task.relatedEquipment.name;
                        if (!equipmentMap.has(key)) {
                            equipmentMap.set(key, {
                                ...task.relatedEquipment,
                                taskCount: 0,
                                lastMaintenance: null
                            });
                        }
                        equipmentMap.get(key).taskCount++;

                        // Update last maintenance date
                        if (task.completionDate) {
                            const completionDate = new Date(task.completionDate);
                            if (!equipmentMap.get(key).lastMaintenance ||
                                completionDate > new Date(equipmentMap.get(key).lastMaintenance)) {
                                equipmentMap.get(key).lastMaintenance = task.completionDate;
                            }
                        }
                    }
                });

                const equipmentList = Array.from(equipmentMap.values());

                if (equipmentList.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i data-lucide="cog" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                                No equipment data available
                                <br><small>Equipment information will appear as you work on tasks</small>
                            </td>
                        </tr>`;
                    lucide.createIcons();
                    return;
                }

                tbody.innerHTML = equipmentList.map(equipment => `
                    <tr>
                        <td class="fw-bold">${this.escapeHtml(equipment.name || 'Unknown')}</td>
                        <td>${this.escapeHtml(equipment.model || 'N/A')}</td>
                        <td>${this.escapeHtml(equipment.location || 'N/A')}</td>
                        <td>
                            <span class="badge bg-info">${equipment.taskCount}</span>
                        </td>
                        <td>
                            <small class="text-muted">
                                ${equipment.lastMaintenance ? this.formatDate(equipment.lastMaintenance) : 'N/A'}
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-success">Operational</span>
                        </td>
                    </tr>
                `).join('');
                lucide.createIcons();
                addDebugLog(`Rendered ${equipmentList.length} equipment items`);
            } catch (error) {
                addDebugLog(`Error loading equipment data: ${error.message}`, 'error');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            <i data-lucide="alert-triangle" style="font-size: 3rem; display: block; margin-bottom: 1rem; color: var(--danger);"></i>
                            Error loading equipment data
                            <br><small>Please try refreshing the page</small>
                        </td>
                    </tr>`;
                lucide.createIcons();
            }
        }




        showLoadingState() {
            const tables = [
                { id: 'assignedTasksTable', cols: 6 },
                { id: 'inProgressTasksTable', cols: 6 },
                { id: 'completedTasksTable', cols: 6 },
                { id: 'recentTasksTable', cols: 6 }
            ];

            tables.forEach(table => {
                const tbody = document.getElementById(table.id);
                if (tbody) {
                    tbody.innerHTML = `
                <tr>
                    <td colspan="${table.cols}" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Loading tasks...</p>
                    </td>
                </tr>`;
                }
            });
        }

        renderEmptyTasks() {
            const tables = [
                { id: 'assignedTasksTable', message: 'No assigned tasks', icon: 'inbox' },
                { id: 'inProgressTasksTable', message: 'No tasks in progress', icon: 'play-circle' },
                { id: 'completedTasksTable', message: 'No completed tasks', icon: 'check-circle' },
                { id: 'recentTasksTable', message: 'No recent tasks', icon: 'list-checks' }
            ];

            tables.forEach(table => {
                const tbody = document.getElementById(table.id);
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i data-lucide="${table.icon}" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                                ${table.message}
                                <br><small>Check back later for updates</small>
                            </td>
                        </tr>`;
                }
            });
            lucide.createIcons();
        }

        switchTab(tabName) {
            // Update tab links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load tab-specific data
            switch (tabName) {
                case 'assigned-tasks':
                    this.renderAssignedTasks();
                    break;
                case 'in-progress-tasks':
                    this.renderInProgressTasks();
                    break;
                case 'completed-tasks':
                    this.renderCompletedTasks();
                    break;
            }
        }



        async showTaskDetails(taskId) {
            try {
                addDebugLog(`Showing details for task: ${taskId}`);

                const task = this.findTaskById(taskId);
                if (!task) {
                    this.showToast('Error', 'Task not found', 'error');
                    return;
                }

                // Stocker la tâche actuelle
                this.currentTask = task;

                // Remplir le modal avec les détails de la tâche
                document.getElementById('detailTaskId').textContent = task.taskId || 'N/A';
                document.getElementById('detailTaskDescription').textContent = task.description || 'No description';
                document.getElementById('detailTaskEquipment').textContent = this.getEquipmentName(task.relatedEquipment);

                // Afficher la priorité avec un badge coloré
                const priorityElement = document.getElementById('detailTaskPriority');
                priorityElement.innerHTML = `
            <span class="priority-badge priority-${(task.priority || 'medium').toLowerCase()}">
                ${task.priority || 'MEDIUM'}
            </span>
        `;

                // Afficher le statut avec un badge coloré
                const statusElement = document.getElementById('detailTaskStatus');
                statusElement.innerHTML = this.getStatusBadge(task.status || 'PLANNED');

                document.getElementById('detailTaskDueDate').textContent = this.formatDate(task.dueDate) || 'No due date';

                // Mettre à jour la barre de progression
                const progressBar = document.getElementById('detailTaskProgressBar');
                const progressText = document.getElementById('detailTaskProgressText');
                const progress = task.completionPercentage || 0;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}%`;

                // Configurer les boutons d'action selon le statut
                this.updateTaskActionButtons(task.status);

                // Afficher le modal
                this.showModal('taskDetailsModal');

            } catch (error) {
                addDebugLog(`Error showing task details: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to load task details', 'error');
            }
        }




        setupTaskActionButtons(task) {
            const buttonsContainer = document.getElementById('taskActionButtons');
            if (!buttonsContainer) return;

            const status = task.status || 'PLANNED';
            let buttons = '';

            switch (status) {
                case 'PLANNED':
                case 'ASSIGNED':
                    buttons = `
                <button class="btn btn-success me-2" onclick="technicianDashboard.acceptTaskFromModal()">
                    <i data-lucide="play"></i> Start Task
                </button>
                <button class="btn btn-danger" onclick="technicianDashboard.rejectTaskFromModal()">
                    <i data-lucide="x"></i> Reject Task
                </button>
            `;
                    break;
                case 'IN_PROGRESS':
                    buttons = `
                <button class="btn btn-info me-2" onclick="technicianDashboard.updateProgressFromModal()">
                    <i data-lucide="edit-3"></i> Update Progress
                </button>
                <button class="btn btn-success me-2" onclick="technicianDashboard.completeTaskFromModal()">
                    <i data-lucide="check-circle"></i> Complete
                </button>
                <button class="btn btn-warning" onclick="technicianDashboard.pauseTaskFromModal()">
                    <i data-lucide="pause"></i> Pause
                </button>
            `;
                    break;
                case 'ON_HOLD':
                    buttons = `
                <button class="btn btn-primary me-2" onclick="technicianDashboard.resumeTaskFromModal()">
                    <i data-lucide="play"></i> Resume
                </button>
                <button class="btn btn-info" onclick="technicianDashboard.updateProgressFromModal()">
                    <i data-lucide="edit-3"></i> Update Progress
                </button>
            `;
                    break;
                case 'COMPLETED':
                    buttons = `
                <span class="text-success">
                    <i data-lucide="check-circle"></i> Task Completed
                </span>
            `;
                    break;
                default:
                    buttons = '<span class="text-muted">No actions available</span>';
            }

            buttonsContainer.innerHTML = buttons;
            lucide.createIcons();
        }





        findTaskById(taskId) {
            return this.allTasks.find(task => task.taskId === taskId);
        }

        populateTaskDetailsModal(task) {
            document.getElementById('detailTaskId').textContent = task.taskId;
            document.getElementById('detailTaskDescription').textContent = task.description;
            document.getElementById('detailTaskEquipment').textContent = this.getEquipmentName(task.relatedEquipment);
            document.getElementById('detailTaskPriority').textContent = task.priority;
            document.getElementById('detailTaskStatus').textContent = task.status.replace('_', ' ');
            document.getElementById('detailTaskDueDate').textContent = this.formatDate(task.dueDate);

            // Update progress bar
            const progressBar = document.getElementById('detailTaskProgressBar');
            const progressText = document.getElementById('detailTaskProgressText');
            const progress = task.completionPercentage || 0;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;

            // Show/hide action buttons based on status
            this.updateTaskActionButtons(task.status);
        }



        updateTaskActionButtons(status) {
            const buttons = {
                accept: document.getElementById('acceptTaskBtn'),
                reject: document.getElementById('rejectTaskBtn'),
                update: document.getElementById('updateProgressBtn'),
                complete: document.getElementById('completeTaskBtn')
            };

            // Hide all buttons initially
            Object.values(buttons).forEach(btn => {
                if (btn) btn.style.display = 'none';
            });

            // Show relevant buttons based on status
            switch (status) {
                case 'ASSIGNED':
                case 'PLANNED':
                    if (buttons.accept) buttons.accept.style.display = 'inline-flex';
                    if (buttons.reject) buttons.reject.style.display = 'inline-flex';
                    break;
                case 'IN_PROGRESS':
                    if (buttons.update) buttons.update.style.display = 'inline-flex';
                    if (buttons.complete) buttons.complete.style.display = 'inline-flex';
                    break;
            }
        }




        async acceptTask() {
            if (!this.currentTask) return;
            await this.updateTaskStatus(this.currentTask.taskId, 'IN_PROGRESS');
        }





        getStatusBadge(status) {
            const statusColors = {
                'PLANNED': 'bg-info text-white',
                'ASSIGNED': 'bg-warning text-dark',
                'IN_PROGRESS': 'bg-primary text-white',
                'ON_HOLD': 'bg-secondary text-white',
                'COMPLETED': 'bg-success text-white',
                'CANCELLED': 'bg-danger text-white'
            };

            const statusLabels = {
                'PLANNED': 'Ready to Start',
                'ASSIGNED': 'Assigned',
                'IN_PROGRESS': 'In Progress',
                'ON_HOLD': 'On Hold',
                'COMPLETED': 'Completed',
                'CANCELLED': 'Cancelled'
            };

            const colorClass = statusColors[status] || 'bg-secondary text-white';
            const label = statusLabels[status] || status;

            return `<span class="badge ${colorClass}">${label}</span>`;
        }






        async acceptTaskQuick(taskId) {
            try {
                if (!taskId) {
                    throw new Error('Task ID is required');
                }

                addDebugLog(`Accepting task: ${taskId}`);
                this.showToast('Info', 'Accepting task...', 'info');

                // CORRECTION: Passer directement à IN_PROGRESS au lieu d'ASSIGNED
                await this.updateTaskStatus(taskId, 'IN_PROGRESS');

            } catch (error) {
                addDebugLog(`Error accepting task: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to accept task', 'error');
            }
        }

        async rejectTask() {
            if (!this.currentTask) return;
            if (confirm('Are you sure you want to reject this task?')) {
                await this.updateTaskStatus(this.currentTask.taskId, 'PLANNED');
            }
        }

        async rejectTaskQuick(taskId) {
            try {
                if (!taskId) {
                    throw new Error('Task ID is required');
                }

                if (!confirm('Are you sure you want to reject this task? It will be returned to the task pool.')) {
                    return;
                }

                addDebugLog(`Rejecting task: ${taskId}`);
                this.showToast('Info', 'Rejecting task...', 'info');

                await this.updateTaskStatus(taskId, 'PLANNED');

            } catch (error) {
                addDebugLog(`Error rejecting task: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to reject task', 'error');
            }
        }

        async completeTask() {
            if (!this.currentTask) return;
            if (confirm('Mark this task as completed?')) {
                await this.updateTaskStatus(this.currentTask.taskId, 'COMPLETED');
                await this.updateTaskProgress(this.currentTask.taskId, 100);
            }
        }






        async acceptTaskFromModal() {
            if (this.currentTask) {
                await this.acceptTaskQuick(this.currentTask.taskId);
                this.hideModal('taskDetailsModal');
            }
        }

        async rejectTaskFromModal() {
            if (this.currentTask) {
                await this.rejectTaskQuick(this.currentTask.taskId);
                this.hideModal('taskDetailsModal');
            }
        }

        async updateProgressFromModal() {
            if (this.currentTask) {
                await this.updateProgressQuick(this.currentTask.taskId);
                // Rafraîchir les détails dans le modal
                await this.showTaskDetails(this.currentTask.taskId);
            }
        }

        async completeTaskFromModal() {
            if (this.currentTask) {
                await this.completeTaskQuick(this.currentTask.taskId);
                this.hideModal('taskDetailsModal');
            }
        }

        async pauseTaskFromModal() {
            if (this.currentTask) {
                await this.pauseTaskQuick(this.currentTask.taskId);
                this.hideModal('taskDetailsModal');
            }
        }

        async resumeTaskFromModal() {
            if (this.currentTask) {
                await this.updateTaskStatus(this.currentTask.taskId, 'IN_PROGRESS');
                this.hideModal('taskDetailsModal');
            }
        }

        async completeTaskQuick(taskId) {
            try {
                if (!taskId) {
                    throw new Error('Task ID is required');
                }

                if (!confirm('Mark this task as completed? This action cannot be undone.')) {
                    return;
                }

                addDebugLog(`Completing task: ${taskId}`);
                this.showToast('Info', 'Completing task...', 'info');

                // FIXED: Update progress to 100% first, then status
                await this.updateTaskProgress(taskId, 100, 'Task completed');
                await this.updateTaskStatus(taskId, 'COMPLETED');

            } catch (error) {
                addDebugLog(`Error completing task: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to complete task', 'error');
            }
        }




        async updateTaskStatus(taskId, status) {
            try {
                if (!taskId || !status) {
                    throw new Error('Task ID and status are required');
                }

                addDebugLog(`Updating task ${taskId} status to ${status}`);

                // FIXED: Include technicianId in the request body
                const requestBody = {
                    status: status,
                    technicianId: this.currentUser.id
                };

                const response = await fetch(`${TASKS_API_URL}/${taskId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addDebugLog(`Update status error: ${errorText}`, 'error');
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const updatedTask = await response.json();
                addDebugLog(`Task ${taskId} status updated successfully to ${status}`);

                // FIXED: Show appropriate success message based on action
                let message = 'Task status updated successfully';
                if (status === 'IN_PROGRESS') {
                    message = 'Task accepted and started successfully';
                } else if (status === 'PLANNED') {
                    message = 'Task rejected successfully';
                } else if (status === 'COMPLETED') {
                    message = 'Task completed successfully';
                }

                this.showToast('Success', message, 'success');

                // FIXED: Close any open modals
                this.hideModal('taskDetailsModal');

                // FIXED: Reload tasks to reflect changes
                await this.loadTechnicianTasks();

                return updatedTask;
            } catch (error) {
                addDebugLog(`Error updating task status: ${error.message}`, 'error');
                console.error('Update task status error:', error);
                throw error; // Re-throw to be handled by calling method
            }
        }




        showUpdateProgressModal() {
            if (!this.currentTask) return;

            document.getElementById('progressTaskId').value = this.currentTask.taskId;
            document.getElementById('progressPercentage').value = this.currentTask.completionPercentage || 0;
            document.getElementById('progressPercentageValue').textContent = `${this.currentTask.completionPercentage || 0}%`;
            document.getElementById('progressNotes').value = '';

            this.hideModal('taskDetailsModal');
            this.showModal('updateProgressModal');
        }

        updateProgressQuick(taskId) {
            const task = this.findTaskById(taskId);
            if (!task) return;
            this.currentTask = task;
            this.showUpdateProgressModal();
        }

        async saveTaskProgress() {
            try {
                const taskId = document.getElementById('progressTaskId').value;
                const percentage = parseInt(document.getElementById('progressPercentage').value);
                const notes = document.getElementById('progressNotes').value;

                await this.updateTaskProgress(taskId, percentage, notes);
                this.hideModal('updateProgressModal');
                this.showToast('Success', 'Progress updated successfully', 'success');
                await this.loadTechnicianTasks();
            } catch (error) {
                addDebugLog(`Error updating progress: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to update progress', 'error');
            }
        }

        async updateTaskProgress(taskId, percentage, notes = '') {
            try {
                addDebugLog(`Updating task ${taskId} progress to ${percentage}%`);

                const response = await fetch(`${TASKS_API_URL}/${taskId}/completion`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        completionPercentage: percentage,
                        notes: notes,
                        technicianId: this.currentUser.id
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                addDebugLog(`Task ${taskId} progress updated to ${percentage}% successfully`);
                return await response.json();
            } catch (error) {
                addDebugLog(`Error updating task progress: ${error.message}`, 'error');
                throw error;
            }
        }

        async loadPerformanceData() {
            try {
                addDebugLog('Loading performance data...');

                // Calculate real performance metrics
                const totalTasks = this.allTasks.length;
                const completedTasks = this.completedTasks.length;

                // Calculate average completion time from real data
                const avgTime = this.calculateAverageCompletionTime();
                document.getElementById('avgCompletionTime').textContent = avgTime;

                // Calculate first time fix rate (assuming no rework data available, use completion rate)
                const firstTimeFixRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                document.getElementById('firstTimeFixRate').textContent = `${firstTimeFixRate}%`;

                // Calculate rework rate (inverse of efficiency for now)
                const reworkRate = Math.max(0, 100 - firstTimeFixRate);
                document.getElementById('reworkRate').textContent = `${reworkRate}%`;

                // Safety score - assuming 100% unless there are incident records
                document.getElementById('safetyScore').textContent = '100%';

                // Update performance charts
                this.updatePerformanceCharts();

                addDebugLog(`Performance data loaded - Avg time: ${avgTime}, Fix rate: ${firstTimeFixRate}%, Rework: ${reworkRate}%`);
            } catch (error) {
                addDebugLog(`Error loading performance data: ${error.message}`, 'error');
            }
        }

        calculateAverageCompletionTime() {
            if (this.completedTasks.length === 0) return '0h';

            const totalMinutes = this.completedTasks.reduce((sum, task) => {
                if (task.creationDate && task.completionDate) {
                    const start = new Date(task.creationDate);
                    const end = new Date(task.completionDate);
                    return sum + ((end - start) / (1000 * 60)); // minutes
                }
                return sum + (task.estimatedDurationMinutes || 0);
            }, 0);

            const avgMinutes = totalMinutes / this.completedTasks.length;
            const hours = Math.floor(avgMinutes / 60);
            const minutes = Math.round(avgMinutes % 60);

            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        initializeCharts() {
            addDebugLog('Initializing charts...');
            this.initTaskTrendChart();
            this.initTaskStatusChart();
            this.initEfficiencyGaugeChart();
            this.initWeeklyProgressChart();
            this.initPerformanceChart();
            this.initCompletionRateChart();
            this.initMonthlyComparisonChart();
            this.initPriorityDistributionChart();
            this.initDurationAnalysisChart();
            this.initEquipmentTasksChart();
            this.initHourlyProductivityChart();
            this.initStatusTimelineChart();
            this.initWorkloadGaugeChart();
            this.initDailyTaskLoadChart();
            this.initTaskTypesChart();
            this.initCapacityDemandChart();
            addDebugLog('Charts initialization completed');
        }

        initTaskTrendChart() {
            const ctx = document.getElementById('taskTrendChart');
            if (!ctx) return;

            this.charts.taskTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Completed Tasks',
                        data: [],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        initTaskStatusChart() {
            const ctx = document.getElementById('taskStatusChart');
            if (!ctx) return;

            this.charts.taskStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Assigned', 'In Progress', 'Completed'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            '#3B82F6',
                            '#F59E0B',
                            '#10B981'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        initEfficiencyGaugeChart() {
            const ctx = document.getElementById('efficiencyGaugeChart');
            if (!ctx) return;

            this.charts.efficiencyGauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Efficiency', 'Remaining'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [
                            '#10B981',
                            '#F3F4F6'
                        ],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        initWeeklyProgressChart() {
            const ctx = document.getElementById('weeklyProgressChart');
            if (!ctx) return;

            this.charts.weeklyProgress = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Tasks Completed',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: '#3B82F6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        initPerformanceChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            this.charts.performance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Tasks Completed',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Efficiency %',
                            data: [],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        initCompletionRateChart() {
            const ctx = document.getElementById('completionRateChart');
            if (!ctx) return;

            this.charts.completionRate = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Completion Rate %',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: '#3B82F6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        initMonthlyComparisonChart() {
            const ctx = document.getElementById('monthlyComparisonChart');
            if (!ctx) return;

            this.charts.monthlyComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'This Month',
                            data: [],
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: '#3B82F6',
                            borderWidth: 1
                        },
                        {
                            label: 'Last Month',
                            data: [],
                            backgroundColor: 'rgba(107, 114, 128, 0.8)',
                            borderColor: '#6B7280',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        initPriorityDistributionChart() {
            const ctx = document.getElementById('priorityDistributionChart');
            if (!ctx) return;

            this.charts.priorityDistribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            '#EF4444',
                            '#F59E0B',
                            '#10B981'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        initDurationAnalysisChart() {
            const ctx = document.getElementById('durationAnalysisChart');
            if (!ctx) return;

            this.charts.durationAnalysis = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Task Duration vs Priority',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: '#3B82F6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Priority (1=High, 2=Medium, 3=Low)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Duration (hours)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        initEquipmentTasksChart() {
            const ctx = document.getElementById('equipmentTasksChart');
            if (!ctx) return;

            this.charts.equipmentTasks = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tasks per Equipment',
                        data: [],
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: '#F59E0B',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        initHourlyProductivityChart() {
            const ctx = document.getElementById('hourlyProductivityChart');
            if (!ctx) return;

            this.charts.hourlyProductivity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['8AM', '9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM'],
                    datasets: [{
                        label: 'Tasks Completed',
                        data: [],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        initStatusTimelineChart() {
            const ctx = document.getElementById('statusTimelineChart');
            if (!ctx) return;

            this.charts.statusTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Assigned',
                            data: [],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'In Progress',
                            data: [],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Completed',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        initWorkloadGaugeChart() {
            const ctx = document.getElementById('workloadGaugeChart');
            if (!ctx) return;

            this.charts.workloadGauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Current Load', 'Available Capacity'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [
                            '#F59E0B',
                            '#F3F4F6'
                        ],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        initDailyTaskLoadChart() {
            const ctx = document.getElementById('dailyTaskLoadChart');
            if (!ctx) return;

            this.charts.dailyTaskLoad = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Task Load',
                        data: [],
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#EF4444',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        initTaskTypesChart() {
            const ctx = document.getElementById('taskTypesChart');
            if (!ctx) return;

            this.charts.taskTypes = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3B82F6',
                            '#10B981',
                            '#F59E0B',
                            '#EF4444',
                            '#8B5CF6',
                            '#06B6D4'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        initCapacityDemandChart() {
            const ctx = document.getElementById('capacityDemandChart');
            if (!ctx) return;

            this.charts.capacityDemand = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Capacity',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Demand',
                            data: [],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        updateTaskCharts() {
            addDebugLog('Updating task charts with real data');

            // Update task status chart
            if (this.charts.taskStatus) {
                this.charts.taskStatus.data.datasets[0].data = [
                    this.assignedTasks.length,
                    this.inProgressTasks.length,
                    this.completedTasks.length
                ];
                this.charts.taskStatus.update();
            }

            // Update efficiency gauge
            if (this.charts.efficiencyGauge) {
                const totalTasks = this.allTasks.length;
                const efficiency = totalTasks > 0 ? Math.round((this.completedTasks.length / totalTasks) * 100) : 0;
                this.charts.efficiencyGauge.data.datasets[0].data = [efficiency, 100 - efficiency];
                this.charts.efficiencyGauge.update();
            }

            // Update task trend chart with recent completions
            if (this.charts.taskTrend) {
                const last7Days = this.getLast7DaysCompletions();
                this.charts.taskTrend.data.labels = last7Days.labels;
                this.charts.taskTrend.data.datasets[0].data = last7Days.data;
                this.charts.taskTrend.update();
            }

            // Update weekly progress chart
            if (this.charts.weeklyProgress) {
                const weeklyData = this.getWeeklyProgressData();
                this.charts.weeklyProgress.data.datasets[0].data = weeklyData;
                this.charts.weeklyProgress.update();
            }

            // Update priority distribution chart
            if (this.charts.priorityDistribution) {
                const highPriority = this.allTasks.filter(t => t.priority === 'HIGH').length;
                const mediumPriority = this.allTasks.filter(t => t.priority === 'MEDIUM').length;
                const lowPriority = this.allTasks.filter(t => t.priority === 'LOW').length;

                this.charts.priorityDistribution.data.datasets[0].data = [highPriority, mediumPriority, lowPriority];
                this.charts.priorityDistribution.update();
            }

            this.updateAdvancedCharts();
        }

        updateAdvancedCharts() {
            // Update equipment tasks chart
            if (this.charts.equipmentTasks) {
                const equipmentData = this.getEquipmentTasksData();
                this.charts.equipmentTasks.data.labels = equipmentData.labels;
                this.charts.equipmentTasks.data.datasets[0].data = equipmentData.data;
                this.charts.equipmentTasks.update();
            }

            // Update duration analysis chart
            if (this.charts.durationAnalysis) {
                const durationData = this.getDurationAnalysisData();
                this.charts.durationAnalysis.data.datasets[0].data = durationData;
                this.charts.durationAnalysis.update();
            }

            // Update hourly productivity
            if (this.charts.hourlyProductivity) {
                const hourlyData = this.getHourlyProductivityData();
                this.charts.hourlyProductivity.data.datasets[0].data = hourlyData;
                this.charts.hourlyProductivity.update();
            }

            // Update workload gauge
            if (this.charts.workloadGauge) {
                const currentLoad = this.calculateCurrentWorkload();
                this.charts.workloadGauge.data.datasets[0].data = [currentLoad, 100 - currentLoad];
                this.charts.workloadGauge.update();
            }

            // Update daily task load
            if (this.charts.dailyTaskLoad) {
                const dailyData = this.getDailyTaskLoadData();
                this.charts.dailyTaskLoad.data.labels = dailyData.labels;
                this.charts.dailyTaskLoad.data.datasets[0].data = dailyData.data;
                this.charts.dailyTaskLoad.update();
            }
        }

        getLast7DaysCompletions() {
            const labels = [];
            const data = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

                const completedCount = this.completedTasks.filter(task => {
                    if (!task.completionDate) return false;
                    const taskDate = new Date(task.completionDate);
                    return taskDate.toDateString() === date.toDateString();
                }).length;

                data.push(completedCount);
            }

            return { labels, data };
        }

        getWeeklyProgressData() {
            const data = new Array(7).fill(0);

            this.completedTasks.forEach(task => {
                if (task.completionDate) {
                    const taskDate = new Date(task.completionDate);
                    const dayIndex = (taskDate.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
                    data[dayIndex]++;
                }
            });

            return data;
        }

        getEquipmentTasksData() {
            const equipmentMap = {};

            this.allTasks.forEach(task => {
                const equipmentName = this.getEquipmentName(task.relatedEquipment);
                if (equipmentName && equipmentName !== 'No equipment assigned') {
                    equipmentMap[equipmentName] = (equipmentMap[equipmentName] || 0) + 1;
                }
            });

            const labels = Object.keys(equipmentMap).slice(0, 10); // Top 10
            const data = labels.map(label => equipmentMap[label]);

            return { labels, data };
        }

        getDurationAnalysisData() {
            const data = [];

            this.completedTasks.forEach(task => {
                if (task.creationDate && task.completionDate) {
                    const start = new Date(task.creationDate);
                    const end = new Date(task.completionDate);
                    const durationHours = (end - start) / (1000 * 60 * 60);

                    const priorityValue = task.priority === 'HIGH' ? 1 : task.priority === 'MEDIUM' ? 2 : 3;

                    data.push({
                        x: priorityValue,
                        y: durationHours
                    });
                }
            });

            return data;
        }

        getHourlyProductivityData() {
            const hours = new Array(10).fill(0);

            this.completedTasks.forEach(task => {
                if (task.completionDate) {
                    const hour = new Date(task.completionDate).getHours();
                    if (hour >= 8 && hour <= 17) {
                        hours[hour - 8]++;
                    }
                }
            });

            return hours;
        }

        calculateCurrentWorkload() {
            const inProgressWeight = 2;
            const assignedWeight = 1;

            const currentLoad = (this.inProgressTasks.length * inProgressWeight) + (this.assignedTasks.length * assignedWeight);
            const maxCapacity = 20; // Assuming max capacity of 20 weighted tasks

            return Math.min(Math.round((currentLoad / maxCapacity) * 100), 100);
        }

        getDailyTaskLoadData() {
            const labels = [];
            const data = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                const dayTasks = this.allTasks.filter(task => {
                    const taskDate = new Date(task.creationDate);
                    return taskDate.toDateString() === date.toDateString();
                }).length;

                data.push(dayTasks);
            }

            return { labels, data };
        }

        updatePerformanceCharts() {
            // Update performance trend chart
            if (this.charts.performance) {
                const weeklyData = this.getWeeklyPerformanceData();
                this.charts.performance.data.labels = weeklyData.labels;
                this.charts.performance.data.datasets[0].data = weeklyData.tasksCompleted;
                this.charts.performance.data.datasets[1].data = weeklyData.efficiency;
                this.charts.performance.update();
            }

            // Update completion rate chart
            if (this.charts.completionRate) {
                const completionRates = this.getWeeklyCompletionRates();
                this.charts.completionRate.data.labels = completionRates.labels;
                this.charts.completionRate.data.datasets[0].data = completionRates.data;
                this.charts.completionRate.update();
            }

            // Update monthly comparison
            if (this.charts.monthlyComparison) {
                const monthlyData = this.getMonthlyComparisonData();
                this.charts.monthlyComparison.data.labels = monthlyData.labels;
                this.charts.monthlyComparison.data.datasets[0].data = monthlyData.thisMonth;
                this.charts.monthlyComparison.data.datasets[1].data = monthlyData.lastMonth;
                this.charts.monthlyComparison.update();
            }
        }

        getWeeklyPerformanceData() {
            const labels = [];
            const tasksCompleted = [];
            const efficiency = [];

            for (let i = 3; i >= 0; i--) {
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - (i * 7));
                labels.push(`Week ${4 - i}`);

                const weekCompleted = this.completedTasks.filter(task => {
                    if (!task.completionDate) return false;
                    const taskDate = new Date(task.completionDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    return taskDate >= weekStart && taskDate < weekEnd;
                }).length;

                tasksCompleted.push(weekCompleted);

                const totalTasks = this.allTasks.length;
                const efficiencyRate = totalTasks > 0 ? Math.round((weekCompleted / totalTasks) * 100) : 0;
                efficiency.push(Math.min(efficiencyRate, 100));
            }

            return { labels, tasksCompleted, efficiency };
        }

        getWeeklyCompletionRates() {
            const labels = [];
            const data = [];

            for (let i = 3; i >= 0; i--) {
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - (i * 7));
                labels.push(`Week ${4 - i}`);

                const weekCompleted = this.completedTasks.filter(task => {
                    if (!task.completionDate) return false;
                    const taskDate = new Date(task.completionDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    return taskDate >= weekStart && taskDate < weekEnd;
                }).length;

                const totalTasks = this.allTasks.length;
                const rate = totalTasks > 0 ? Math.round((weekCompleted / totalTasks) * 100) : 0;
                data.push(Math.min(rate, 100));
            }

            return { labels, data };
        }

        getMonthlyComparisonData() {
            const thisMonth = new Date().getMonth();
            const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;

            const thisMonthCompleted = this.completedTasks.filter(task => {
                if (!task.completionDate) return false;
                return new Date(task.completionDate).getMonth() === thisMonth;
            }).length;

            const lastMonthCompleted = this.completedTasks.filter(task => {
                if (!task.completionDate) return false;
                return new Date(task.completionDate).getMonth() === lastMonth;
            }).length;

            return {
                labels: ['Completed Tasks'],
                thisMonth: [thisMonthCompleted],
                lastMonth: [lastMonthCompleted]
            };
        }

        async loadAnalyticsData() {
            this.updateAdvancedCharts();
        }

        async loadWorkloadData() {
            this.updateAdvancedCharts();
        }

        async loadDashboardData() {
            await this.loadTechnicianTasks();
            this.updateTaskCharts();
        }

        updateChartsTheme(isDark) {
            const textColor = isDark ? '#F9FAFB' : '#1F2937';
            const gridColor = isDark ? '#374151' : '#F3F4F6';

            Object.values(this.charts).forEach(chart => {
                if (chart && chart.options) {
                    // Update text colors
                    if (chart.options.plugins && chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
                        chart.options.plugins.legend.labels.color = textColor;
                    }

                    // Update scale colors
                    if (chart.options.scales) {
                        Object.values(chart.options.scales).forEach(scale => {
                            if (scale.ticks) scale.ticks.color = textColor;
                            if (scale.grid) scale.grid.color = gridColor;
                        });
                    }

                    chart.update();
                }
            });
        }

        setupRealTimeUpdates() {
            // Refresh tasks every 2 minutes
            this.refreshInterval = setInterval(() => {
                addDebugLog('Auto-refreshing tasks...');
                this.loadTechnicianTasks();
            }, 120000);
        }

        // Report Generation with Logo
        async generateTaskReport() {
            try {
                addDebugLog('Generating task summary report...');
                this.showToast('Info', 'Generating task summary report...', 'info');

                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded properly');
                }

                const doc = new jsPDF();

                // Add logo
                await this.addLogoToPDF(doc);

                // Add header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Task Summary Report', 20, 50);

                // Add technician info
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Technician: ${this.currentUser.firstName} ${this.currentUser.lastName}`, 20, 65);
                doc.text(`Email: ${this.currentUser.email}`, 20, 75);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 85);

                // Add summary statistics
                let yPos = 105;
                doc.setFont(undefined, 'bold');
                doc.text('Summary Statistics:', 20, yPos);
                yPos += 15;
                doc.setFont(undefined, 'normal');

                const stats = [
                    `Total Tasks: ${this.allTasks.length}`,
                    `Assigned Tasks: ${this.assignedTasks.length}`,
                    `In Progress Tasks: ${this.inProgressTasks.length}`,
                    `Completed Tasks: ${this.completedTasks.length}`,
                    `Completion Rate: ${this.calculateCompletionRate()}%`,
                    `Average Completion Time: ${this.calculateAverageCompletionTime()}`
                ];

                stats.forEach(stat => {
                    doc.text(stat, 20, yPos);
                    yPos += 10;
                });

                // Add task details
                yPos += 20;
                doc.setFont(undefined, 'bold');
                doc.text('Recent Tasks:', 20, yPos);
                yPos += 15;
                doc.setFont(undefined, 'normal');

                const recentTasks = this.allTasks.slice(0, 10);

                recentTasks.forEach(task => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`• ${task.taskId} - ${task.description} (${task.status})`, 20, yPos);
                    yPos += 8;
                });

                // Save the PDF
                doc.save(`Task_Summary_${this.currentUser.firstName}_${new Date().getTime()}.pdf`);
                this.showToast('Success', 'Task summary report downloaded', 'success');
                addDebugLog('Task report generated successfully');
            } catch (error) {
                addDebugLog(`Error generating task report: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to generate task report', 'error');
            }
        }

        async generatePerformanceReport() {
            try {
                addDebugLog('Generating performance report...');
                this.showToast('Info', 'Generating performance report...', 'info');

                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded properly');
                }

                const doc = new jsPDF();

                // Add logo
                await this.addLogoToPDF(doc);

                // Add header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Performance Report', 20, 50);

                // Add technician info
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Technician: ${this.currentUser.firstName} ${this.currentUser.lastName}`, 20, 65);
                doc.text(`Email: ${this.currentUser.email}`, 20, 75);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 85);

                // Add performance metrics
                let yPos = 105;
                doc.setFont(undefined, 'bold');
                doc.text('Performance Metrics:', 20, yPos);
                yPos += 15;
                doc.setFont(undefined, 'normal');

                const metrics = [
                    `Completion Rate: ${this.calculateCompletionRate()}%`,
                    `Average Completion Time: ${this.calculateAverageCompletionTime()}`,
                    `First Time Fix Rate: ${document.getElementById('firstTimeFixRate').textContent}`,
                    `Safety Score: 100%`,
                    `Total Tasks Handled: ${this.allTasks.length}`,
                    `Efficiency Score: ${document.getElementById('efficiencyScore').textContent}`
                ];

                metrics.forEach(metric => {
                    doc.text(metric, 20, yPos);
                    yPos += 10;
                });

                // Save the PDF
                doc.save(`Performance_Report_${this.currentUser.firstName}_${new Date().getTime()}.pdf`);
                this.showToast('Success', 'Performance report downloaded', 'success');
                addDebugLog('Performance report generated successfully');
            } catch (error) {
                addDebugLog(`Error generating performance report: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to generate performance report', 'error');
            }
        }

        async generateWeeklyReport() {
            try {
                addDebugLog('Generating weekly summary...');
                this.showToast('Info', 'Generating weekly summary...', 'info');

                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded properly');
                }

                const doc = new jsPDF();

                // Add logo
                await this.addLogoToPDF(doc);

                // Add header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Weekly Summary Report', 20, 50);

                // Add technician info
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Technician: ${this.currentUser.firstName} ${this.currentUser.lastName}`, 20, 65);
                doc.text(`Email: ${this.currentUser.email}`, 20, 75);
                doc.text(`Week of: ${new Date().toLocaleDateString()}`, 20, 85);

                // Add weekly summary
                let yPos = 105;
                doc.setFont(undefined, 'bold');
                doc.text('Weekly Summary:', 20, yPos);
                yPos += 15;
                doc.setFont(undefined, 'normal');

                const weeklySummary = [
                    `Tasks Completed This Week: ${this.getWeeklyCompletedTasks()}`,
                    `Average Daily Tasks: ${Math.round(this.getWeeklyCompletedTasks() / 7)}`,
                    `Current Efficiency Rating: ${this.calculateCompletionRate()}%`,
                    `Tasks In Progress: ${this.inProgressTasks.length}`,
                    `Pending Tasks: ${this.assignedTasks.length}`,
                    `Average Completion Time: ${this.calculateAverageCompletionTime()}`
                ];

                weeklySummary.forEach(item => {
                    doc.text(item, 20, yPos);
                    yPos += 10;
                });

                // Save the PDF
                doc.save(`Weekly_Summary_${this.currentUser.firstName}_${new Date().getTime()}.pdf`);
                this.showToast('Success', 'Weekly summary downloaded', 'success');
                addDebugLog('Weekly report generated successfully');
            } catch (error) {
                addDebugLog(`Error generating weekly report: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to generate weekly report', 'error');
            }
        }

        async generateAnalyticsReport() {
            try {
                addDebugLog('Generating analytics report...');
                this.showToast('Info', 'Generating analytics report...', 'info');

                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded properly');
                }

                const doc = new jsPDF();

                // Add logo
                await this.addLogoToPDF(doc);

                // Add header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Analytics Report', 20, 50);

                // Add technician info
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Technician: ${this.currentUser.firstName} ${this.currentUser.lastName}`, 20, 65);
                doc.text(`Email: ${this.currentUser.email}`, 20, 75);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 85);

                // Add analytics data
                let yPos = 105;
                doc.setFont(undefined, 'bold');
                doc.text('Advanced Analytics:', 20, yPos);
                yPos += 15;
                doc.setFont(undefined, 'normal');

                const analytics = [
                    `Total Tasks Analyzed: ${this.allTasks.length}`,
                    `High Priority Tasks: ${this.allTasks.filter(t => t.priority === 'HIGH').length}`,
                    `Medium Priority Tasks: ${this.allTasks.filter(t => t.priority === 'MEDIUM').length}`,
                    `Low Priority Tasks: ${this.allTasks.filter(t => t.priority === 'LOW').length}`,
                    `Current Workload: ${this.calculateCurrentWorkload()}%`,
                    `Equipment Types Worked On: ${this.getUniqueEquipmentCount()}`
                ];

                analytics.forEach(item => {
                    doc.text(item, 20, yPos);
                    yPos += 10;
                });

                // Save the PDF
                doc.save(`Analytics_Report_${this.currentUser.firstName}_${new Date().getTime()}.pdf`);
                this.showToast('Success', 'Analytics report downloaded', 'success');
                addDebugLog('Analytics report generated successfully');
            } catch (error) {
                addDebugLog(`Error generating analytics report: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to generate analytics report', 'error');
            }
        }

        async downloadTaskPDF(taskId) {
            try {
                const task = taskId ? this.findTaskById(taskId) : this.currentTask;
                if (!task) {
                    this.showToast('Error', 'Task not found', 'error');
                    return;
                }

                addDebugLog(`Generating PDF for task: ${task.taskId}`);
                this.showToast('Info', 'Generating task PDF...', 'info');

                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF library not loaded properly');
                }

                const doc = new jsPDF();

                // Add logo
                await this.addLogoToPDF(doc);

                // Add header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Task Details Report', 20, 50);

                // Add task details
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                let yPos = 70;

                const taskDetails = [
                    `Task ID: ${task.taskId}`,
                    `Description: ${task.description}`,
                    `Status: ${task.status}`,
                    `Priority: ${task.priority}`,
                    `Progress: ${task.completionPercentage || 0}%`,
                    `Equipment: ${this.getEquipmentName(task.relatedEquipment)}`,
                    `Due Date: ${this.formatDate(task.dueDate)}`,
                    `Created: ${this.formatDate(task.creationDate)}`
                ];

                if (task.completionDate) {
                    taskDetails.push(`Completed: ${this.formatDate(task.completionDate)}`);
                }

                taskDetails.forEach(detail => {
                    doc.text(detail, 20, yPos);
                    yPos += 10;
                });

                // Save the PDF
                doc.save(`Task_${task.taskId}_${new Date().getTime()}.pdf`);
                this.showToast('Success', 'Task PDF downloaded', 'success');
                addDebugLog(`Task PDF generated successfully for ${task.taskId}`);
            } catch (error) {
                addDebugLog(`Error generating task PDF: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to generate task PDF', 'error');
            }
        }

        async addLogoToPDF(doc) {
            try {
                addDebugLog('Adding logo to PDF...');

                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';

                    img.onload = function() {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            const dataURL = canvas.toDataURL('image/jpeg');

                            // Add logo to PDF
                            doc.addImage(dataURL, 'JPEG', 20, 10, 30, 30);
                            addDebugLog('Logo added to PDF successfully');
                            resolve();
                        } catch (error) {
                            addDebugLog(`Could not add logo to PDF: ${error.message}`, 'warning');
                            resolve(); // Continue without logo
                        }
                    };

                    img.onerror = function() {
                        addDebugLog('Could not load logo image', 'warning');
                        resolve(); // Continue without logo
                    };

                    img.src = 'images/logoImas.jpg';
                });
            } catch (error) {
                addDebugLog(`Could not add logo to PDF: ${error.message}`, 'warning');
                return Promise.resolve(); // Continue without logo
            }
        }

        // Tool Functions
        openTimeCalculator() {
            this.showToast('Info', 'Time Calculator tool coming soon!', 'info');
        }

        openTaskChecklist() {
            this.showToast('Info', 'Task Checklist tool coming soon!', 'info');
        }

        openPhotoNotes() {
            this.showToast('Info', 'Photo Notes tool coming soon!', 'info');
        }

        openIssueReporter() {
            this.showToast('Info', 'Issue Reporter tool coming soon!', 'info');
        }

        // Export Functions
        exportTaskHistory() {
            try {
                addDebugLog('Exporting task history...');

                const csvContent = this.convertTasksToCSV(this.allTasks);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');

                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `task_history_${this.currentUser.firstName}_${new Date().getTime()}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    this.showToast('Success', 'Task history exported successfully', 'success');
                    addDebugLog('Task history exported successfully');
                }
            } catch (error) {
                addDebugLog(`Error exporting task history: ${error.message}`, 'error');
                this.showToast('Error', 'Failed to export task history', 'error');
            }
        }

        convertTasksToCSV(tasks) {
            const headers = ['Task ID', 'Description', 'Status', 'Priority', 'Equipment', 'Created', 'Completed', 'Duration'];
            const csvRows = [headers.join(',')];

            tasks.forEach(task => {
                const row = [
                    `"${task.taskId}"`,
                    `"${task.description.replace(/"/g, '""')}"`,
                    `"${task.status}"`,
                    `"${task.priority}"`,
                    `"${this.getEquipmentName(task.relatedEquipment)}"`,
                    `"${this.formatDate(task.creationDate)}"`,
                    `"${task.completionDate ? this.formatDate(task.completionDate) : 'N/A'}"`,
                    `"${this.calculateDuration(task.creationDate, task.completionDate)}"`
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        // Utility Methods
        calculateCompletionRate() {
            const total = this.allTasks.length;
            return total > 0 ? Math.round((this.completedTasks.length / total) * 100) : 0;
        }

        getWeeklyCompletedTasks() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            return this.completedTasks.filter(task => {
                if (!task.completionDate) return false;
                return new Date(task.completionDate) >= oneWeekAgo;
            }).length;
        }

        getUniqueEquipmentCount() {
            const equipmentSet = new Set();
            this.allTasks.forEach(task => {
                if (task.relatedEquipment && task.relatedEquipment.name) {
                    equipmentSet.add(task.relatedEquipment.name);
                }
            });
            return equipmentSet.size;
        }

        calculateDuration(startDate, endDate) {
            if (!startDate || !endDate) return 'N/A';
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffMinutes = Math.floor((end - start) / (1000 * 60));

            if (diffMinutes < 60) {
                return `${diffMinutes}m`;
            } else {
                const hours = Math.floor(diffMinutes / 60);
                const minutes = diffMinutes % 60;
                return `${hours}h ${minutes}m`;
            }
        }

        getEquipmentName(equipment) {
            if (!equipment) return 'No equipment assigned';
            if (typeof equipment === 'string') return equipment;
            return equipment.name || 'Unknown Equipment';
        }

        getStatusBadgeClass(status) {
            switch (status.toUpperCase()) {
                case 'PLANNED': return 'secondary';
                case 'ASSIGNED': return 'primary';
                case 'IN_PROGRESS': return 'warning';
                case 'COMPLETED': return 'success';
                case 'ON_HOLD': return 'info';
                case 'CANCELLED': return 'danger';
                default: return 'light';
            }
        }

        formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (error) {
                return 'Invalid date';
            }
        }

        truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text || '';
            return text.substring(0, maxLength) + '...';
        }

        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
        }

        hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        }

        showToast(title, message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            const toastHeader = toast.querySelector('.toast-header');

            if (!toast || !toastTitle || !toastMessage || !toastIcon || !toastHeader) return;

            // Set content
            toastTitle.textContent = title;
            toastMessage.textContent = message;

            // Set style and icon based on type
            toastHeader.className = 'toast-header';
            toastIcon.setAttribute('data-lucide', '');

            switch (type) {
                case 'success':
                    toastHeader.style.background = 'var(--green)';
                    toastHeader.style.color = 'white';
                    toastIcon.setAttribute('data-lucide', 'check-circle');
                    break;
                case 'error':
                    toastHeader.style.background = 'var(--secondary-red)';
                    toastHeader.style.color = 'white';
                    toastIcon.setAttribute('data-lucide', 'alert-triangle');
                    break;
                case 'warning':
                    toastHeader.style.background = 'var(--gold)';
                    toastHeader.style.color = 'var(--gray-dark)';
                    toastIcon.setAttribute('data-lucide', 'alert-circle');
                    break;
                default: // info
                    toastHeader.style.background = 'var(--primary-blue)';
                    toastHeader.style.color = 'white';
                    toastIcon.setAttribute('data-lucide', 'info');
            }

            // Recreate icons and show toast
            lucide.createIcons();
            toast.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        destroy() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
            }

            // Destroy charts
            Object.values(this.charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
        }
    }

    // Global functions for onclick handlers
    window.refreshTasks = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.loadTechnicianTasks();
        }
    };

    window.generateTaskReport = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.generateTaskReport();
        }
    };

    window.generatePerformanceReport = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.generatePerformanceReport();
        }
    };

    window.generateWeeklyReport = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.generateWeeklyReport();
        }
    };

    window.generateAnalyticsReport = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.generateAnalyticsReport();
        }
    };

    window.exportTaskHistory = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.exportTaskHistory();
        }
    };

    window.openTimeCalculator = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.openTimeCalculator();
        }
    };

    window.openTaskChecklist = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.openTaskChecklist();
        }
    };

    window.openPhotoNotes = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.openPhotoNotes();
        }
    };

    window.openIssueReporter = function() {
        if (window.technicianDashboard) {
            window.technicianDashboard.openIssueReporter();
        }
    };

    window.logout = function() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('userSession');
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
        }
    };

    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        try {
            addDebugLog('DOM loaded, initializing dashboard...');
            window.technicianDashboard = new TechnicianDashboard();

            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                if (window.technicianDashboard) {
                    window.technicianDashboard.destroy();
                }
            });

            // Handle visibility change for performance
            document.addEventListener('visibilitychange', function() {
                if (window.technicianDashboard) {
                    if (document.hidden) {
                        // Page is hidden, pause updates
                        if (window.technicianDashboard.refreshInterval) {
                            clearInterval(window.technicianDashboard.refreshInterval);
                        }
                    } else {
                        // Page is visible again, resume updates
                        window.technicianDashboard.setupRealTimeUpdates();
                        window.technicianDashboard.loadTechnicianTasks();
                    }
                }
            });
        } catch (error) {
            addDebugLog(`Dashboard initialization failed: ${error.message}`, 'error');
            alert('Dashboard initialization failed. Please refresh the page.');
        }
    });

    // Handle responsive design
    window.addEventListener('resize', function() {
        const sidebar = document.getElementById('sidebar');
        const header = document.getElementById('header');
        const mainContent = document.getElementById('mainContent');

        if (window.innerWidth <= 768) {
            sidebar.classList.add('collapsed');
            header.classList.add('expanded');
            mainContent.classList.add('expanded');
        } else if (window.innerWidth > 1024) {
            // Reset to default state on larger screens
            if (!sidebar.classList.contains('collapsed')) {
                header.classList.remove('expanded');
                mainContent.classList.remove('expanded');
            }
        }
    });



    // Add global promise rejection handling
    window.addEventListener('unhandledrejection', function(event) {
        addDebugLog(`Unhandled promise rejection: ${event.reason}`, 'error');
        if (window.technicianDashboard) {
            window.technicianDashboard.showToast('Error', 'A network error occurred', 'error');
        }
    });
</script>
<script src="js/singleWindowValidator.js"></script>
</body>
</html>