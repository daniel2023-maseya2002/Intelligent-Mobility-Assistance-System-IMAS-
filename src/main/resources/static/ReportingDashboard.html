<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMAS - Advanced Reporting Dashboard</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary-blue: #1E40AF;
      --secondary-red: #DC2626;
      --light-blue: #3B82F6;
      --light-red: #EF4444;
      --gold: #F59E0B;
      --green: #10B981;
      --gray-dark: #1F2937;
      --gray-medium: #6B7280;
      --gray-light: #F3F4F6;
      --white: #FFFFFF;
      --sidebar-width: 240px;
      --header-height: 70px;
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="dark"] {
      --white: #1F2937;
      --gray-light: #374151;
      --gray-medium: #9CA3AF;
      --gray-dark: #F9FAFB;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-light);
      color: var(--gray-dark);
      transition: var(--transition);
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      height: var(--header-height);
      background: var(--white);
      border-bottom: 1px solid rgba(0,0,0,0.1);
      box-shadow: var(--shadow);
      z-index: 1000;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      transition: var(--transition);
    }

    .header.expanded {
      left: 80px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray-dark);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .sidebar-toggle:hover {
      background: var(--gray-light);
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-dark);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .theme-toggle {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--gray-dark);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .theme-toggle:hover {
      background: var(--gray-light);
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 1rem;
      background: var(--gray-light);
      border-radius: 50px;
      cursor: pointer;
      transition: var(--transition);
    }

    .user-profile:hover {
      background: var(--light-blue);
      color: var(--white);
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--white);
      border-right: 1px solid rgba(0,0,0,0.1);
      box-shadow: var(--shadow);
      z-index: 1100;
      transition: var(--transition);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar.collapsed {
      width: 80px;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary-blue);
      transition: var(--transition);
    }

    .sidebar.collapsed .logo-text {
      opacity: 0;
      transform: translateX(-10px);
    }

    .sidebar-menu {
      flex: 1;
      padding: 1rem 0;
    }

    .sidebar-menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-menu li {
      margin: 0.25rem 0;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      color: var(--gray-medium);
      text-decoration: none;
      transition: var(--transition);
      border-radius: 0 25px 25px 0;
      margin-right: 1rem;
      font-weight: 500;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: linear-gradient(90deg, rgba(30,64,175,0.1) 0%, rgba(30,64,175,0.05) 100%);
      color: var(--primary-blue);
      transform: translateX(5px);
    }

    .sidebar-menu a.active {
      border-right: 3px solid var(--primary-blue);
    }

    .sidebar-menu i {
      font-size: 1.25rem;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .sidebar-menu .menu-text {
      transition: var(--transition);
    }

    .sidebar.collapsed .menu-text {
      opacity: 0;
      transform: translateX(-10px);
    }

    /* Submenu Styles for Periodic Reports */
    .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .submenu.active {
      max-height: 500px;
    }

    .submenu a {
      padding: 0.625rem 3rem;
      font-size: 0.875rem;
      margin-right: 0.5rem;
    }

    .menu-toggle {
      background: none;
      border: none;
      color: inherit;
      width: 100%;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.5rem;
      transition: var(--transition);
      border-radius: 0 25px 25px 0;
      margin-right: 1rem;
      font-weight: 500;
      cursor: pointer;
    }

    .menu-toggle:hover {
      background: linear-gradient(90deg, rgba(30,64,175,0.1) 0%, rgba(30,64,175,0.05) 100%);
      color: var(--primary-blue);
      transform: translateX(5px);
    }

    .menu-toggle .toggle-icon {
      margin-left: auto;
      transition: transform 0.3s ease;
    }

    .menu-toggle.active .toggle-icon {
      transform: rotate(180deg);
    }

    .sidebar-footer {
      padding: 1rem;
      border-top: 1px solid rgba(0,0,0,0.1);
    }

    .logout-btn {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1rem;
      color: var(--secondary-red);
      text-decoration: none;
      transition: var(--transition);
      border-radius: var(--border-radius);
      font-weight: 500;
      width: 100%;
      border: none;
      background: none;
      cursor: pointer;
    }

    .logout-btn:hover {
      background: rgba(220,38,38,0.1);
      transform: translateY(-2px);
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      margin-top: var(--header-height);
      padding: 2rem;
      min-height: calc(100vh - var(--header-height));
      transition: var(--transition);
    }

    .main-content.expanded {
      margin-left: 80px;
    }

    /* Cards */
    .card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 1.5rem;
      transition: var(--transition);
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .stat-icon {
      width: 70px;
      height: 70px;
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      color: var(--white);
      flex-shrink: 0;
    }

    .stat-icon.reports {
      background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
    }

    .stat-icon.tickets {
      background: linear-gradient(135deg, var(--green), #22C55E);
    }

    .stat-icon.staff {
      background: linear-gradient(135deg, var(--gold), #F59E0B);
    }

    .stat-icon.revenue {
      background: linear-gradient(135deg, var(--secondary-red), var(--light-red));
    }

    .stat-info h3 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--gray-dark);
      margin-bottom: 0.5rem;
    }

    .stat-info p {
      color: var(--gray-medium);
      font-weight: 500;
    }

    .stat-change {
      font-size: 0.875rem;
      color: var(--green);
      font-weight: 600;
    }

    /* Report Cards */
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .report-card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      border: 2px solid transparent;
    }

    .report-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      border-color: var(--primary-blue);
    }

    .report-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-red));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-size: 2rem;
    }

    .report-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-dark);
      margin-bottom: 1rem;
    }

    .report-description {
      color: var(--gray-medium);
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 1.5rem;
    }

    .report-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Buttons */
    .btn {
      background: var(--primary-blue);
      color: var(--white);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .btn:hover {
      background: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(30,64,175,0.3);
    }

    .btn-success {
      background: var(--green);
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-warning {
      background: var(--gold);
      color: var(--gray-dark);
    }

    .btn-warning:hover {
      background: #F59E0B;
    }

    .btn-danger {
      background: var(--secondary-red);
    }

    .btn-danger:hover {
      background: var(--light-red);
    }

    .btn-secondary {
      background: var(--gray-medium);
    }

    .btn-secondary:hover {
      background: var(--gray-dark);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    /* Tables */
    .table-container {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      overflow-x: auto;
      margin-bottom: 2rem;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .table-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-dark);
    }

    .table-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .table th,
    .table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--gray-light);
    }

    .table th {
      background: var(--gray-light);
      font-weight: 600;
      color: var(--gray-dark);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table tr:hover {
      background: rgba(30,64,175,0.05);
    }

    /* Forms */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--gray-dark);
    }

    .form-control {
      width: 100%;
      padding: 0.875rem;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
      background: var(--white);
      color: var(--gray-dark);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }

    /* Status badges */
    .status-badge {
      padding: 0.375rem 0.875rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-active {
      background: rgba(16,185,129,0.1);
      color: var(--green);
    }

    .status-inactive {
      background: rgba(245,158,11,0.1);
      color: var(--gold);
    }

    .status-pending {
      background: rgba(59,130,246,0.1);
      color: var(--light-blue);
    }

    .status-completed {
      background: rgba(16,185,129,0.1);
      color: var(--green);
    }

    /* Filters */
    .filters-container {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s linear infinite;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-content {
      background: var(--white);
      padding: 2rem;
      border-radius: var(--border-radius);
      text-align: center;
    }

    /* Hidden class */
    .hidden {
      display: none !important;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Summary items with backgrounds */
    .summary-item {
      background: linear-gradient(135deg, rgba(30,64,175,0.1), rgba(59,130,246,0.05));
      padding: 1.5rem;
      border-radius: var(--border-radius);
      text-align: center;
      border: 1px solid rgba(30,64,175,0.1);
      transition: var(--transition);
    }

    .summary-item:hover {
      background: linear-gradient(135deg, rgba(30,64,175,0.15), rgba(59,130,246,0.08));
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .summary-item:nth-child(2) {
      background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(34,197,94,0.05));
      border: 1px solid rgba(16,185,129,0.1);
    }

    .summary-item:nth-child(2):hover {
      background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(34,197,94,0.08));
    }

    .summary-item:nth-child(3) {
      background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(251,191,36,0.05));
      border: 1px solid rgba(245,158,11,0.1);
    }

    .summary-item:nth-child(3):hover {
      background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(251,191,36,0.08));
    }

    .summary-item:nth-child(4) {
      background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(239,68,68,0.05));
      border: 1px solid rgba(220,38,38,0.1);
    }

    .summary-item:nth-child(4):hover {
      background: linear-gradient(135deg, rgba(220,38,38,0.15), rgba(239,68,68,0.08));
    }

    .summary-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary-blue);
      margin-bottom: 0.5rem;
    }

    .summary-label {
      color: var(--gray-medium);
      font-weight: 500;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        width: 80px;
      }

      .sidebar .menu-text,
      .sidebar .logo-text {
        opacity: 0;
        transform: translateX(-10px);
      }

      .main-content {
        margin-left: 80px;
      }

      .header {
        left: 80px;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.mobile-show {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .header {
        left: 0;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .reports-grid {
        grid-template-columns: 1fr;
      }

      .table-header {
        flex-direction: column;
        align-items: stretch;
      }

      .table-actions {
        justify-content: center;
      }
    }

    /* Print styles for reports */
    @media print {
      .sidebar,
      .header,
      .btn,
      .filters-container {
        display: none !important;
      }

      .main-content {
        margin: 0 !important;
        padding: 0 !important;
      }

      .card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
      }
    }

    /* Report specific styles */
    .report-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    /* Date range picker */
    .date-range {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .date-range input {
      max-width: 150px;
    }

    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Progress bars */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--gray-light);
      border-radius: 4px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-blue), var(--green));
      transition: width 0.6s ease;
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      color: var(--white);
      font-weight: 500;
      max-width: 400px;
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease-out;
    }

    .notification.success {
      background: var(--green);
    }

    .notification.error {
      background: var(--secondary-red);
    }

    .notification.warning {
      background: var(--gold);
      color: var(--gray-dark);
    }

    .notification.info {
      background: var(--light-blue);
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 2rem;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-light);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-dark);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--gray-medium);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: var(--transition);
    }

    .close-btn:hover {
      background: var(--gray-light);
      color: var(--gray-dark);
    }
  </style>
</head>
<body data-theme="light">

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="logo-icon">
      <i class="fas fa-chart-line"></i>
    </div>
    <span class="logo-text">IMAS Reports</span>
  </div>
  <div class="sidebar-menu">
    <ul>
      <li>
        <a href="#" class="active" onclick="showSection('overview', event)">
          <i class="fas fa-tachometer-alt"></i>
          <span class="menu-text">Overview</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('daily-reports', event)">
          <i class="fas fa-calendar-day"></i>
          <span class="menu-text">Daily Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('weekly-reports', event)">
          <i class="fas fa-calendar-week"></i>
          <span class="menu-text">Weekly Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('monthly-reports', event)">
          <i class="fas fa-calendar-alt"></i>
          <span class="menu-text">Monthly Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('yearly-reports', event)">
          <i class="fas fa-calendar"></i>
          <span class="menu-text">Yearly Reports</span>
        </a>
      </li>
      <li>
        <button class="menu-toggle" onclick="toggleSubmenu('periodic-submenu', this)">
          <i class="fas fa-clock"></i>
          <span class="menu-text">Periodic Reports</span>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </button>
        <ul class="submenu" id="periodic-submenu">
          <li>
            <a href="#" onclick="showSection('yearly-periodic-reports', event)">
              <i class="fas fa-calendar-check"></i>
              <span class="menu-text">Yearly Periods</span>
            </a>
          </li>
          <li>
            <a href="#" onclick="showSection('monthly-periodic-reports', event)">
              <i class="fas fa-calendar-times"></i>
              <span class="menu-text">Monthly Periods</span>
            </a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#" onclick="showSection('bus-reports', event)">
          <i class="fas fa-bus"></i>
          <span class="menu-text">Bus Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('ticket-reports', event)">
          <i class="fas fa-ticket-alt"></i>
          <span class="menu-text">Ticket Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('passenger-reports', event)">
          <i class="fas fa-users"></i>
          <span class="menu-text">Passenger Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('staff-reports', event)">
          <i class="fas fa-user-tie"></i>
          <span class="menu-text">Staff Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('route-reports', event)">
          <i class="fas fa-route"></i>
          <span class="menu-text">Route Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('equipment-reports', event)">
          <i class="fas fa-tools"></i>
          <span class="menu-text">Equipment Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('emergency-reports', event)">
          <i class="fas fa-exclamation-triangle"></i>
          <span class="menu-text">Emergency Reports</span>
        </a>
      </li>
      <li>
        <a href="#" onclick="showSection('analytics', event)">
          <i class="fas fa-chart-bar"></i>
          <span class="menu-text">Analytics</span>
        </a>
      </li>
    </ul>
  </div>
  <div class="sidebar-footer">
    <button class="logout-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i>
      <span class="menu-text">Back to Dashboard</span>
    </button>
  </div>
</nav>

<!-- Header -->
<header class="header" id="header">
  <div class="header-left">
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-bars"></i>
    </button>
  </div>
  <div class="header-center">
    <h1 class="header-title">IMAS - Advanced Reporting Dashboard</h1>
  </div>
  <div class="header-right">
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
    </button>
    <div class="user-profile" id="userProfile">
      <div class="user-avatar" id="userAvatar">A</div>
      <span id="userName">Admin User</span>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="main-content" id="mainContent">
  <!-- Overview Section -->
  <section id="overview-section" class="section">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Reporting Dashboard Overview</h1>

    <div class="stats-grid">
      <div class="stat-card" onclick="showSection('daily-reports')">
        <div class="stat-icon reports">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="stat-info">
          <h3 id="totalReports">0</h3>
          <p>Total Reports Generated</p>
          <span class="stat-change">+15% this month</span>
        </div>
      </div>
      <div class="stat-card" onclick="showSection('ticket-reports')">
        <div class="stat-icon tickets">
          <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="stat-info">
          <h3 id="totalTicketsReported">0</h3>
          <p>Tickets Analyzed</p>
          <span class="stat-change">+25% this week</span>
        </div>
      </div>
      <div class="stat-card" onclick="showSection('staff-reports')">
        <div class="stat-icon staff">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
          <h3 id="totalStaffReported">0</h3>
          <p>Staff Members</p>
          <span class="stat-change">+8% this month</span>
        </div>
      </div>
      <div class="stat-card" onclick="showSection('analytics')">
        <div class="stat-icon revenue">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-info">
          <h3 id="totalRevenue">0 FC</h3>
          <p>Total Revenue</p>
          <span class="stat-change">+18% this month</span>
        </div>
      </div>
    </div>

    <div class="reports-grid">
      <div class="report-card" onclick="generateDailyReport()">
        <div class="report-icon">
          <i class="fas fa-calendar-day"></i>
        </div>
        <div class="report-title">Daily Operations Report</div>
        <div class="report-description">Comprehensive daily analysis of all system operations including buses, tickets, and staff performance.</div>
        <div class="report-actions">
          <button class="btn btn-small" onclick="generateDailyReport()">
            <i class="fas fa-file-pdf"></i> Generate PDF
          </button>
          <button class="btn btn-success btn-small" onclick="exportDailyToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-card" onclick="generateWeeklyReport()">
        <div class="report-icon">
          <i class="fas fa-calendar-week"></i>
        </div>
        <div class="report-title">Weekly Performance Report</div>
        <div class="report-description">Weekly trends and performance metrics across all departments and operations.</div>
        <div class="report-actions">
          <button class="btn btn-small" onclick="generateWeeklyReport()">
            <i class="fas fa-file-pdf"></i> Generate PDF
          </button>
          <button class="btn btn-success btn-small" onclick="exportWeeklyToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-card" onclick="generateMonthlyReport()">
        <div class="report-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="report-title">Monthly Analytics Report</div>
        <div class="report-description">Detailed monthly analysis with revenue insights, passenger trends, and operational efficiency.</div>
        <div class="report-actions">
          <button class="btn btn-small" onclick="generateMonthlyReport()">
            <i class="fas fa-file-pdf"></i> Generate PDF
          </button>
          <button class="btn btn-success btn-small" onclick="exportMonthlyToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-card" onclick="generateYearlyReport()">
        <div class="report-icon">
          <i class="fas fa-calendar"></i>
        </div>
        <div class="report-title">Annual Summary Report</div>
        <div class="report-description">Comprehensive yearly overview with growth metrics, financial analysis, and strategic insights.</div>
        <div class="report-actions">
          <button class="btn btn-small" onclick="generateYearlyReport()">
            <i class="fas fa-file-pdf"></i> Generate PDF
          </button>
          <button class="btn btn-success btn-small" onclick="exportYearlyToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-card" onclick="generateBusReport()">
        <div class="report-icon">
          <i class="fas fa-bus"></i>
        </div>
        <div class="report-title">Bus Fleet Report</div>
        <div class="report-description">Complete analysis of bus performance, utilization rates, and maintenance schedules.</div>
        <div class="report-actions">
          <button class="btn btn-small" onclick="generateBusReport()">
            <i class="fas fa-file-pdf"></i> Generate PDF
          </button>
          <button class="btn btn-success btn-small" onclick="exportBusToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <div class="report-card" onclick="generatePassengerReport()">
        <div class="report-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="report-title">Passenger Analytics Report</div>
        <div class="report-description">Detailed passenger behavior analysis, boarding patterns, and satisfaction metrics.</div>
        <div class="report-actions">
          <button class="btn btn-small" onclick="generatePassengerReport()">
            <i class="fas fa-file-pdf"></i> Generate PDF
          </button>
          <button class="btn btn-success btn-small" onclick="exportPassengerToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Reports Generated Over Time</h3>
        <div class="chart-container">
          <canvas id="reportsOverTimeChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Report Types Distribution</h3>
        <div class="chart-container">
          <canvas id="reportTypesChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Daily Reports Section -->
  <section id="daily-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Daily Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Daily Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Select Date</label>
          <input type="date" class="form-control" id="dailyReportDate" value="">
        </div>
        <div class="form-group">
          <label>Report Type</label>
          <select class="form-control" id="dailyReportType">
            <option value="all">All Reports</option>
            <option value="operations">Operations</option>
            <option value="revenue">Revenue</option>
            <option value="passengers">Passengers</option>
            <option value="staff">Staff</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadDailyReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateDailyReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="dailySummary">
      <div class="summary-item">
        <div class="summary-value" id="dailyBusesActive">0</div>
        <div class="summary-label">Active Buses</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="dailyTicketsSold">0</div>
        <div class="summary-label">Tickets Sold</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="dailyRevenue">0 FC</div>
        <div class="summary-label">Revenue</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="dailyPassengers">0</div>
        <div class="summary-label">Passengers</div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Daily Operations Data</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportDailyToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
          <button class="btn btn-warning btn-small" onclick="exportDailyToCSV()">
            <i class="fas fa-file-csv"></i> CSV
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Time</th>
          <th>Bus</th>
          <th>Route</th>
          <th>Passengers</th>
          <th>Revenue (FC)</th>
          <th>Status</th>
          <th>Driver</th>
        </tr>
        </thead>
        <tbody id="dailyReportsTableBody">
        <tr>
          <td colspan="7" style="text-align: center; color: var(--gray-medium);">Loading daily reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Weekly Reports Section -->
  <section id="weekly-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Weekly Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Weekly Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Week Starting</label>
          <input type="date" class="form-control" id="weeklyReportStartDate">
        </div>
        <div class="form-group">
          <label>Week Ending</label>
          <input type="date" class="form-control" id="weeklyReportEndDate">
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadWeeklyReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateWeeklyReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Weekly Revenue Trend</h3>
        <div class="chart-container">
          <canvas id="weeklyRevenueChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Weekly Passenger Count</h3>
        <div class="chart-container">
          <canvas id="weeklyPassengerChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Weekly Performance Summary</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportWeeklyToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Day</th>
          <th>Date</th>
          <th>Buses Active</th>
          <th>Tickets Sold</th>
          <th>Revenue (FC)</th>
          <th>Avg. Occupancy</th>
          <th>Performance</th>
        </tr>
        </thead>
        <tbody id="weeklyReportsTableBody">
        <tr>
          <td colspan="7" style="text-align: center; color: var(--gray-medium);">Loading weekly reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Monthly Reports Section -->
  <section id="monthly-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Monthly Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Monthly Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Select Month</label>
          <input type="month" class="form-control" id="monthlyReportMonth">
        </div>
        <div class="form-group">
          <label>Report Category</label>
          <select class="form-control" id="monthlyReportCategory">
            <option value="all">All Categories</option>
            <option value="financial">Financial</option>
            <option value="operational">Operational</option>
            <option value="performance">Performance</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadMonthlyReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateMonthlyReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="monthlySummary">
      <div class="summary-item">
        <div class="summary-value" id="monthlyTotalRevenue">0 FC</div>
        <div class="summary-label">Total Revenue</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="monthlyTotalTickets">0</div>
        <div class="summary-label">Tickets Sold</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="monthlyAvgOccupancy">0%</div>
        <div class="summary-label">Avg. Occupancy</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="monthlyActiveRoutes">0</div>
        <div class="summary-label">Active Routes</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Monthly Revenue by Route</h3>
        <div class="chart-container">
          <canvas id="monthlyRouteRevenueChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Monthly Bus Performance</h3>
        <div class="chart-container">
          <canvas id="monthlyBusPerformanceChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Monthly Detailed Analysis</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportMonthlyToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Week</th>
          <th>Revenue (FC)</th>
          <th>Tickets</th>
          <th>Passengers</th>
          <th>Avg. Price</th>
          <th>Growth %</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody id="monthlyReportsTableBody">
        <tr>
          <td colspan="7" style="text-align: center; color: var(--gray-medium);">Loading monthly reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Yearly Reports Section -->
  <section id="yearly-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Yearly Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Yearly Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Select Year</label>
          <select class="form-control" id="yearlyReportYear">
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
          </select>
        </div>
        <div class="form-group">
          <label>Comparison Year</label>
          <select class="form-control" id="yearlyComparisonYear">
            <option value="">No Comparison</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadYearlyReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateYearlyReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="yearlySummary">
      <div class="summary-item">
        <div class="summary-value" id="yearlyTotalRevenue">0 FC</div>
        <div class="summary-label">Annual Revenue</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="yearlyTotalPassengers">0</div>
        <div class="summary-label">Total Passengers</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="yearlyGrowthRate">0%</div>
        <div class="summary-label">Growth Rate</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="yearlyEfficiency">0%</div>
        <div class="summary-label">Efficiency</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Annual Revenue Trend</h3>
        <div class="chart-container">
          <canvas id="yearlyRevenueChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Quarterly Performance</h3>
        <div class="chart-container">
          <canvas id="quarterlyPerformanceChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Annual Summary by Month</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportYearlyToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Month</th>
          <th>Revenue (FC)</th>
          <th>Tickets</th>
          <th>Passengers</th>
          <th>Routes Active</th>
          <th>Efficiency %</th>
          <th>Growth %</th>
        </tr>
        </thead>
        <tbody id="yearlyReportsTableBody">
        <tr>
          <td colspan="7" style="text-align: center; color: var(--gray-medium);">Loading yearly reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Yearly Periodic Reports Section -->
  <section id="yearly-periodic-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Yearly Periodic Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Yearly Period Analysis</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Select Year for Analysis</label>
          <select class="form-control" id="yearlyPeriodicYear">
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
          </select>
        </div>
        <div class="form-group">
          <label>Report Focus</label>
          <select class="form-control" id="yearlyPeriodicFocus">
            <option value="all">All Activities</option>
            <option value="passengers">Passengers</option>
            <option value="tickets">Tickets</option>
            <option value="revenue">Revenue</option>
            <option value="operations">Operations</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadYearlyPeriodicReports()">
              <i class="fas fa-search"></i> Load Analysis
            </button>
            <button class="btn btn-success" onclick="generateYearlyPeriodicReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="yearlyPeriodicSummary">
      <div class="summary-item">
        <div class="summary-value" id="yearlyPeriodicTotalRevenue">0 FC</div>
        <div class="summary-label">Total Revenue</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="yearlyPeriodicTotalTickets">0</div>
        <div class="summary-label">Total Tickets</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="yearlyPeriodicTotalPassengers">0</div>
        <div class="summary-label">Total Passengers</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="yearlyPeriodicAvgGrowth">0%</div>
        <div class="summary-label">Avg Growth</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Yearly Revenue Analysis</h3>
        <div class="chart-container">
          <canvas id="yearlyPeriodicRevenueChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Annual Performance Trends</h3>
        <div class="chart-container">
          <canvas id="yearlyPeriodicTrendChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Yearly Period Details</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportYearlyPeriodicToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Quarter</th>
          <th>Period</th>
          <th>Revenue (FC)</th>
          <th>Tickets</th>
          <th>Passengers</th>
          <th>Growth %</th>
          <th>Performance</th>
        </tr>
        </thead>
        <tbody id="yearlyPeriodicTableBody">
        <tr>
          <td colspan="7" style="text-align: center; color: var(--gray-medium);">Loading yearly periodic reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Monthly Periodic Reports Section -->
  <section id="monthly-periodic-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Monthly Periodic Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Monthly Period Analysis</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Start Period</label>
          <input type="date" class="form-control" id="monthlyPeriodicStartDate">
        </div>
        <div class="form-group">
          <label>End Period</label>
          <input type="date" class="form-control" id="monthlyPeriodicEndDate">
        </div>
        <div class="form-group">
          <label>Analysis Type</label>
          <select class="form-control" id="monthlyPeriodicType">
            <option value="all">All Activities</option>
            <option value="passengers">Passengers Analysis</option>
            <option value="tickets">Tickets Analysis</option>
            <option value="revenue">Revenue Analysis</option>
            <option value="operations">Operations Analysis</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadMonthlyPeriodicReports()">
              <i class="fas fa-search"></i> Load Analysis
            </button>
            <button class="btn btn-success" onclick="generateMonthlyPeriodicReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="monthlyPeriodicSummary">
      <div class="summary-item">
        <div class="summary-value" id="monthlyPeriodicRevenue">0 FC</div>
        <div class="summary-label">Period Revenue</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="monthlyPeriodicTickets">0</div>
        <div class="summary-label">Period Tickets</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="monthlyPeriodicPassengers">0</div>
        <div class="summary-label">Period Passengers</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="monthlyPeriodicDays">0</div>
        <div class="summary-label">Analysis Days</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Monthly Period Revenue Trend</h3>
        <div class="chart-container">
          <canvas id="monthlyPeriodicRevenueChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Daily Activity Distribution</h3>
        <div class="chart-container">
          <canvas id="monthlyPeriodicActivityChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Monthly Period Details</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportMonthlyPeriodicToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Date</th>
          <th>Day</th>
          <th>Revenue (FC)</th>
          <th>Tickets</th>
          <th>Passengers</th>
          <th>Active Routes</th>
          <th>Performance</th>
        </tr>
        </thead>
        <tbody id="monthlyPeriodicTableBody">
        <tr>
          <td colspan="7" style="text-align: center; color: var(--gray-medium);">Loading monthly periodic reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Bus Reports Section -->
  <section id="bus-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Bus Fleet Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Bus Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Bus Status</label>
          <select class="form-control" id="busReportStatus">
            <option value="all">All Buses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="maintenance">Maintenance</option>
          </select>
        </div>
        <div class="form-group">
          <label>Route</label>
          <select class="form-control" id="busReportRoute">
            <option value="all">All Routes</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadBusReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateBusReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="busSummary">
      <div class="summary-item">
        <div class="summary-value" id="totalBusesCount">0</div>
        <div class="summary-label">Total Buses</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="activeBusesCount">0</div>
        <div class="summary-label">Active Buses</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="avgBusUtilization">0%</div>
        <div class="summary-label">Avg. Utilization</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="maintenanceBusesCount">0</div>
        <div class="summary-label">In Maintenance</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Bus Utilization by Route</h3>
        <div class="chart-container">
          <canvas id="busUtilizationChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Bus Performance Metrics</h3>
        <div class="chart-container">
          <canvas id="busPerformanceMetricsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Bus Fleet Details</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportBusToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Bus ID</th>
          <th>Name</th>
          <th>Route</th>
          <th>Driver</th>
          <th>Capacity</th>
          <th>Utilization %</th>
          <th>Status</th>
          <th>Last Service</th>
        </tr>
        </thead>
        <tbody id="busReportsTableBody">
        <tr>
          <td colspan="8" style="text-align: center; color: var(--gray-medium);">Loading bus reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Ticket Reports Section -->
  <section id="ticket-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Ticket Sales Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Ticket Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Date Range</label>
          <div class="date-range">
            <input type="date" class="form-control" id="ticketReportStartDate">
            <span>to</span>
            <input type="date" class="form-control" id="ticketReportEndDate">
          </div>
        </div>
        <div class="form-group">
          <label>Ticket Status</label>
          <select class="form-control" id="ticketReportStatus">
            <option value="all">All Tickets</option>
            <option value="PAID">Paid</option>
            <option value="PENDING">Pending</option>
            <option value="BOARDED">Boarded</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadTicketReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateTicketReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="ticketSummary">
      <div class="summary-item">
        <div class="summary-value" id="totalTicketsCount">0</div>
        <div class="summary-label">Total Tickets</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="paidTicketsCount">0</div>
        <div class="summary-label">Paid Tickets</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="boardedTicketsCount">0</div>
        <div class="summary-label">Boarded</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="ticketRevenue">0 FC</div>
        <div class="summary-label">Revenue</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Ticket Sales by Route</h3>
        <div class="chart-container">
          <canvas id="ticketSalesByRouteChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Daily Ticket Sales Trend</h3>
        <div class="chart-container">
          <canvas id="dailyTicketSalesChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Ticket Sales Details</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportTicketToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Ticket #</th>
          <th>Passenger</th>
          <th>Route</th>
          <th>Bus</th>
          <th>Price (FC)</th>
          <th>Status</th>
          <th>Date</th>
          <th>Boarding Time</th>
        </tr>
        </thead>
        <tbody id="ticketReportsTableBody">
        <tr>
          <td colspan="8" style="text-align: center; color: var(--gray-medium);">Loading ticket reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Passenger Reports Section -->
  <section id="passenger-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Passenger Analytics Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Passenger Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Analysis Type</label>
          <select class="form-control" id="passengerAnalysisType">
            <option value="all">All Passengers</option>
            <option value="frequent">Frequent Travelers</option>
            <option value="boarded">Boarded Passengers</option>
            <option value="pending">Pending Boarding</option>
          </select>
        </div>
        <div class="form-group">
          <label>Time Period</label>
          <select class="form-control" id="passengerTimePeriod">
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadPassengerReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generatePassengerReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="passengerSummary">
      <div class="summary-item">
        <div class="summary-value" id="totalPassengersCount">0</div>
        <div class="summary-label">Total Passengers</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="frequentPassengersCount">0</div>
        <div class="summary-label">Frequent Travelers</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="boardedPassengersCount">0</div>
        <div class="summary-label">Boarded</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="pendingPassengersCount">0</div>
        <div class="summary-label">Pending Boarding</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Passenger Distribution by Route</h3>
        <div class="chart-container">
          <canvas id="passengerDistributionChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Boarding Patterns</h3>
        <div class="chart-container">
          <canvas id="boardingPatternsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Passenger Details</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportPassengerToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Passenger ID</th>
          <th>Name</th>
          <th>Total Tickets</th>
          <th>Routes Used</th>
          <th>Total Spent (FC)</th>
          <th>Last Trip</th>
          <th>Status</th>
          <th>Frequency</th>
        </tr>
        </thead>
        <tbody id="passengerReportsTableBody">
        <tr>
          <td colspan="8" style="text-align: center; color: var(--gray-medium);">Loading passenger reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Staff Reports Section -->
  <section id="staff-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Staff Performance Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Staff Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Staff Role</label>
          <select class="form-control" id="staffReportRole">
            <option value="all">All Roles</option>
            <option value="ADMIN">Admin</option>
            <option value="DRIVER">Driver</option>
            <option value="TECHNICIAN">Technician</option>
            <option value="ANALYST">Analyst</option>
            <option value="PASSENGER">Passenger</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select class="form-control" id="staffReportStatus">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadStaffReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateStaffReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="staffSummary">
      <div class="summary-item">
        <div class="summary-value" id="totalStaffCount">0</div>
        <div class="summary-label">Total Staff</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="activeStaffCount">0</div>
        <div class="summary-label">Active Staff</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="driversCount">0</div>
        <div class="summary-label">Drivers</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="techniciansCount">0</div>
        <div class="summary-label">Technicians</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Staff Distribution by Role</h3>
        <div class="chart-container">
          <canvas id="staffRoleDistributionChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Staff Performance Metrics</h3>
        <div class="chart-container">
          <canvas id="staffPerformanceChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Staff Details by Role</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportStaffToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Staff ID</th>
          <th>Name</th>
          <th>Role</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Status</th>
          <th>Join Date</th>
          <th>Performance</th>
        </tr>
        </thead>
        <tbody id="staffReportsTableBody">
        <tr>
          <td colspan="8" style="text-align: center; color: var(--gray-medium);">Loading staff reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Route Reports Section -->
  <section id="route-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Route Performance Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Route Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Route Type</label>
          <select class="form-control" id="routeReportType">
            <option value="all">All Routes</option>
            <option value="URBAN">Urban</option>
            <option value="SUBURBAN">Suburban</option>
            <option value="INTERCITY">Intercity</option>
            <option value="EXPRESS">Express</option>
          </select>
        </div>
        <div class="form-group">
          <label>Performance Metric</label>
          <select class="form-control" id="routePerformanceMetric">
            <option value="revenue">Revenue</option>
            <option value="passengers">Passengers</option>
            <option value="efficiency">Efficiency</option>
            <option value="utilization">Utilization</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadRouteReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateRouteReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="routeSummary">
      <div class="summary-item">
        <div class="summary-value" id="totalRoutesCount">0</div>
        <div class="summary-label">Total Routes</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="activeRoutesCount">0</div>
        <div class="summary-label">Active Routes</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="avgRouteEfficiency">0%</div>
        <div class="summary-label">Avg. Efficiency</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="topRouteRevenue">0 FC</div>
        <div class="summary-label">Top Route Revenue</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Route Revenue Comparison</h3>
        <div class="chart-container">
          <canvas id="routeRevenueComparisonChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Route Utilization Rates</h3>
        <div class="chart-container">
          <canvas id="routeUtilizationChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Route Performance Details</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportRouteToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Route Code</th>
          <th>Route Name</th>
          <th>Type</th>
          <th>Distance (km)</th>
          <th>Revenue (FC)</th>
          <th>Passengers</th>
          <th>Efficiency %</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody id="routeReportsTableBody">
        <tr>
          <td colspan="8" style="text-align: center; color: var(--gray-medium);">Loading route reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Equipment Reports Section -->
  <section id="equipment-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Equipment Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Equipment Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Equipment Status</label>
          <select class="form-control" id="equipmentReportStatus">
            <option value="all">All Equipment</option>
            <option value="OPERATIONAL">Operational</option>
            <option value="MAINTENANCE">Maintenance</option>
            <option value="OUT_OF_SERVICE">Out of Service</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <select class="form-control" id="equipmentReportLocation">
            <option value="all">All Locations</option>
            <option value="Gare Centrale">Gare Centrale</option>
            <option value="Matete">Matete</option>
            <option value="Limete">Limete</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadEquipmentReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateEquipmentReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="equipmentSummary">
      <div class="summary-item">
        <div class="summary-value" id="totalEquipmentCount">0</div>
        <div class="summary-label">Total Equipment</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="operationalEquipmentCount">0</div>
        <div class="summary-label">Operational</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="maintenanceEquipmentCount">0</div>
        <div class="summary-label">In Maintenance</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="avgEquipmentReliability">0%</div>
        <div class="summary-label">Avg. Reliability</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Equipment Status Distribution</h3>
        <div class="chart-container">
          <canvas id="equipmentStatusChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Equipment Reliability Trends</h3>
        <div class="chart-container">
          <canvas id="equipmentReliabilityChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Equipment Details</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportEquipmentToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Equipment ID</th>
          <th>Name</th>
          <th>Model</th>
          <th>Location</th>
          <th>Status</th>
          <th>Reliability %</th>
          <th>Last Maintenance</th>
          <th>Next Service</th>
        </tr>
        </thead>
        <tbody id="equipmentReportsTableBody">
        <tr>
          <td colspan="8" style="text-align: center; color: var(--gray-medium);">Loading equipment reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Emergency Reports Section -->
  <section id="emergency-reports-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Emergency Reports</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Filter Emergency Reports</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Emergency Type</label>
          <select class="form-control" id="emergencyReportType">
            <option value="all">All Types</option>
            <option value="ACCIDENT">Accident</option>
            <option value="BREAKDOWN">Breakdown</option>
            <option value="MEDICAL">Medical</option>
            <option value="SECURITY">Security</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Severity</label>
          <select class="form-control" id="emergencyReportSeverity">
            <option value="all">All Severities</option>
            <option value="LOW">Low</option>
            <option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option>
            <option value="CRITICAL">Critical</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadEmergencyReports()">
              <i class="fas fa-search"></i> Load Reports
            </button>
            <button class="btn btn-success" onclick="generateEmergencyReport()">
              <i class="fas fa-file-pdf"></i> Generate PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="report-summary" id="emergencySummary">
      <div class="summary-item">
        <div class="summary-value" id="totalEmergencyCount">0</div>
        <div class="summary-label">Total Emergencies</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="resolvedEmergencyCount">0</div>
        <div class="summary-label">Resolved</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="pendingEmergencyCount">0</div>
        <div class="summary-label">Pending</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="avgResponseTime">0 min</div>
        <div class="summary-label">Avg. Response Time</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Emergency Types Distribution</h3>
        <div class="chart-container">
          <canvas id="emergencyTypesChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Emergency Response Times</h3>
        <div class="chart-container">
          <canvas id="emergencyResponseChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Emergency Reports Details</h3>
        <div class="export-buttons">
          <button class="btn btn-secondary btn-small" onclick="exportEmergencyToExcel()">
            <i class="fas fa-file-excel"></i> Excel
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
        <tr>
          <th>Report ID</th>
          <th>Type</th>
          <th>Severity</th>
          <th>Location</th>
          <th>Driver</th>
          <th>Status</th>
          <th>Report Time</th>
          <th>Response Time</th>
        </tr>
        </thead>
        <tbody id="emergencyReportsTableBody">
        <tr>
          <td colspan="8" style="text-align: center; color: var(--gray-medium);">Loading emergency reports...</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Analytics Section -->
  <section id="analytics-section" class="section hidden">
    <h1 style="margin-bottom: 2rem; color: var(--gray-dark);">Advanced Analytics</h1>

    <div class="filters-container">
      <h3 style="margin-bottom: 1rem;">Analytics Configuration</h3>
      <div class="filters-grid">
        <div class="form-group">
          <label>Analysis Period</label>
          <select class="form-control" id="analyticsPeriod">
            <option value="week">Last 7 Days</option>
            <option value="month">Last 30 Days</option>
            <option value="quarter">Last 3 Months</option>
            <option value="year">Last 12 Months</option>
          </select>
        </div>
        <div class="form-group">
          <label>Metrics Focus</label>
          <select class="form-control" id="analyticsMetrics">
            <option value="all">All Metrics</option>
            <option value="financial">Financial</option>
            <option value="operational">Operational</option>
            <option value="performance">Performance</option>
          </select>
        </div>
        <div class="form-group">
          <label>Actions</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn" onclick="loadAnalytics()">
              <i class="fas fa-chart-line"></i> Generate Analytics
            </button>
            <button class="btn btn-success" onclick="exportAnalyticsReport()">
              <i class="fas fa-file-pdf"></i> Export Report
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Revenue Trends Analysis</h3>
        <div class="chart-container">
          <canvas id="revenueTrendsChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Operational Efficiency</h3>
        <div class="chart-container">
          <canvas id="operationalEfficiencyChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Customer Satisfaction</h3>
        <div class="chart-container">
          <canvas id="customerSatisfactionChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1.5rem;">Predictive Analytics</h3>
        <div class="chart-container">
          <canvas id="predictiveAnalyticsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="report-summary" id="analyticsSummary">
      <div class="summary-item">
        <div class="summary-value" id="totalGrowthRate">0%</div>
        <div class="summary-label">Growth Rate</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="operationalEfficiencyRate">0%</div>
        <div class="summary-label">Efficiency Rate</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="customerSatisfactionRate">0%</div>
        <div class="summary-label">Satisfaction Rate</div>
      </div>
      <div class="summary-item">
        <div class="summary-value" id="predictedRevenue">0 FC</div>
        <div class="summary-label">Predicted Revenue</div>
      </div>
    </div>
  </section>
</main>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-content">
    <div class="loading" style="width: 40px; height: 40px; border-width: 4px; margin-bottom: 1rem;"></div>
    <h3>Generating Report...</h3>
    <p>Please wait while we compile your data</p>
  </div>
</div>

<script>
  // Global variables
  let currentUser = null;
  let charts = {};
  let reportData = {};
  const API_BASE = 'http://localhost:8080/api';

  // Initialize the application
  document.addEventListener('DOMContentLoaded', function() {
    initializeUser();
    initializeEventListeners();
    showSection('overview');
    loadOverviewData();
    setDefaultDates();
  });

  // Initialize user information
  function initializeUser() {
    const userSession = localStorage.getItem('userSession');
    if (userSession) {
      currentUser = JSON.parse(userSession);
      document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
      document.getElementById('userAvatar').textContent = currentUser.firstName.charAt(0);
    } else {
      currentUser = { firstName: 'Admin', lastName: 'User', role: 'ADMIN' };
      document.getElementById('userName').textContent = 'Admin User';
      document.getElementById('userAvatar').textContent = 'A';
    }
  }

  // Initialize event listeners
  function initializeEventListeners() {
    document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  }

  // Set default dates for filters
  function setDefaultDates() {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    const weekAgoStr = weekAgo.toISOString().split('T')[0];
    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    const monthAgoStr = monthAgo.toISOString().split('T')[0];

    // Set default dates
    document.getElementById('dailyReportDate').value = todayStr;
    document.getElementById('weeklyReportStartDate').value = weekAgoStr;
    document.getElementById('weeklyReportEndDate').value = todayStr;
    document.getElementById('monthlyReportMonth').value = today.toISOString().slice(0, 7);
    document.getElementById('ticketReportStartDate').value = monthAgoStr;
    document.getElementById('ticketReportEndDate').value = todayStr;

    // Set default dates for new periodic reports
    if (document.getElementById('monthlyPeriodicStartDate')) {
      document.getElementById('monthlyPeriodicStartDate').value = monthAgoStr;
    }
    if (document.getElementById('monthlyPeriodicEndDate')) {
      document.getElementById('monthlyPeriodicEndDate').value = todayStr;
    }
  }

  // Toggle submenu function
  function toggleSubmenu(submenuId, toggleBtn) {
    const submenu = document.getElementById(submenuId);
    const isActive = submenu.classList.contains('active');

    // Close all submenus first
    document.querySelectorAll('.submenu').forEach(menu => {
      menu.classList.remove('active');
    });

    document.querySelectorAll('.menu-toggle').forEach(btn => {
      btn.classList.remove('active');
    });

    // Toggle current submenu
    if (!isActive) {
      submenu.classList.add('active');
      toggleBtn.classList.add('active');
    }
  }

  // Load overview data
  async function loadOverviewData() {
    try {
      showLoading();

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Update overview statistics
      document.getElementById('totalReports').textContent = '156';
      document.getElementById('totalTicketsReported').textContent = tickets.length;
      document.getElementById('totalStaffReported').textContent = staff.length;

      // Calculate total revenue
      const totalRevenue = tickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);
      document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' FC';

      // Create overview charts
      createReportsOverTimeChart();
      createReportTypesChart();

      hideLoading();
    } catch (error) {
      console.error('Error loading overview data:', error);
      showNotification('Error loading overview data', 'error');
      hideLoading();
    }
  }

  // Create reports over time chart
  function createReportsOverTimeChart() {
    const ctx = document.getElementById('reportsOverTimeChart');
    if (!ctx) return;

    if (charts.reportsOverTime) {
      charts.reportsOverTime.destroy();
    }

    const labels = [];
    const data = [];
    const today = new Date();

    for (let i = 29; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      data.push(Math.floor(Math.random() * 20) + 5);
    }

    charts.reportsOverTime = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Reports Generated',
          data: data,
          borderColor: '#1E40AF',
          backgroundColor: 'rgba(30, 64, 175, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Create report types chart
  function createReportTypesChart() {
    const ctx = document.getElementById('reportTypesChart');
    if (!ctx) return;

    if (charts.reportTypes) {
      charts.reportTypes.destroy();
    }

    charts.reportTypes = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Daily', 'Weekly', 'Monthly', 'Yearly', 'Custom'],
        datasets: [{
          data: [35, 25, 20, 15, 5],
          backgroundColor: [
            '#1E40AF',
            '#10B981',
            '#F59E0B',
            '#DC2626',
            '#6B7280'
          ],
          borderWidth: 3,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // NEW FUNCTIONS FOR YEARLY PERIODIC REPORTS
  async function loadYearlyPeriodicReports() {
    try {
      showLoading();

      const selectedYear = document.getElementById('yearlyPeriodicYear').value;
      const focus = document.getElementById('yearlyPeriodicFocus').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter data for selected year
      const yearTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == selectedYear;
      });

      // Update yearly periodic summary
      const totalRevenue = yearTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      const totalPassengers = yearTickets.length;
      const avgGrowth = Math.floor(Math.random() * 25) + 10; // Random for demo

      document.getElementById('yearlyPeriodicTotalRevenue').textContent = totalRevenue.toLocaleString() + ' FC';
      document.getElementById('yearlyPeriodicTotalTickets').textContent = yearTickets.length;
      document.getElementById('yearlyPeriodicTotalPassengers').textContent = totalPassengers.toLocaleString();
      document.getElementById('yearlyPeriodicAvgGrowth').textContent = '+' + avgGrowth + '%';

      // Create yearly periodic charts
      createYearlyPeriodicRevenueChart(yearTickets);
      createYearlyPeriodicTrendChart(yearTickets);

      // Display yearly periodic table
      displayYearlyPeriodicTable(yearTickets, selectedYear);

      hideLoading();
      showNotification(`Yearly periodic reports for ${selectedYear} loaded successfully`, 'success');
    } catch (error) {
      console.error('Error loading yearly periodic reports:', error);
      showNotification('Error loading yearly periodic reports', 'error');
      hideLoading();
    }
  }

  function createYearlyPeriodicRevenueChart(tickets) {
    const ctx = document.getElementById('yearlyPeriodicRevenueChart');
    if (!ctx) return;

    if (charts.yearlyPeriodicRevenue) {
      charts.yearlyPeriodicRevenue.destroy();
    }

    const quarterlyRevenue = { 'Q1': 0, 'Q2': 0, 'Q3': 0, 'Q4': 0 };

    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const month = ticketDate.getMonth();
      const quarter = Math.floor(month / 3) + 1;
      quarterlyRevenue[`Q${quarter}`] += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    });

    charts.yearlyPeriodicRevenue = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Q1', 'Q2', 'Q3', 'Q4'],
        datasets: [{
          label: 'Quarterly Revenue (FC)',
          data: Object.values(quarterlyRevenue),
          backgroundColor: [
            'rgba(30, 64, 175, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(220, 38, 38, 0.8)'
          ],
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  function createYearlyPeriodicTrendChart(tickets) {
    const ctx = document.getElementById('yearlyPeriodicTrendChart');
    if (!ctx) return;

    if (charts.yearlyPeriodicTrend) {
      charts.yearlyPeriodicTrend.destroy();
    }

    const monthlyData = {};
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    months.forEach(month => monthlyData[month] = 0);

    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const monthName = months[ticketDate.getMonth()];
      monthlyData[monthName]++;
    });

    charts.yearlyPeriodicTrend = new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Monthly Tickets',
          data: months.map(month => monthlyData[month]),
          borderColor: '#10B981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  function displayYearlyPeriodicTable(tickets, year) {
    const tbody = document.getElementById('yearlyPeriodicTableBody');
    if (!tbody) return;

    const quarterlyData = {
      'Q1': { revenue: 0, tickets: 0, passengers: 0, period: 'Jan - Mar' },
      'Q2': { revenue: 0, tickets: 0, passengers: 0, period: 'Apr - Jun' },
      'Q3': { revenue: 0, tickets: 0, passengers: 0, period: 'Jul - Sep' },
      'Q4': { revenue: 0, tickets: 0, passengers: 0, period: 'Oct - Dec' }
    };

    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const month = ticketDate.getMonth();
      const quarter = Math.floor(month / 3) + 1;
      const quarterKey = `Q${quarter}`;

      quarterlyData[quarterKey].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      quarterlyData[quarterKey].tickets++;
      quarterlyData[quarterKey].passengers++;
    });

    tbody.innerHTML = Object.entries(quarterlyData).map(([quarter, data]) => {
      const growth = Math.floor(Math.random() * 30) - 10; // Random growth for demo
      const performance = growth > 10 ? 'Excellent' : growth > 0 ? 'Good' : 'Average';

      return `
                <tr>
                    <td>${quarter}</td>
                    <td>${data.period} ${year}</td>
                    <td>${data.revenue.toLocaleString()} FC</td>
                    <td>${data.tickets}</td>
                    <td>${data.passengers}</td>
                    <td>${growth > 0 ? '+' : ''}${growth}%</td>
                    <td><span class="status-badge ${getPerformanceClass(performance.toLowerCase())}">${performance}</span></td>
                </tr>
            `;
    }).join('');
  }

  async function generateYearlyPeriodicReport() {
    try {
      showLoading();

      const selectedYear = document.getElementById('yearlyPeriodicYear').value;
      const focus = document.getElementById('yearlyPeriodicFocus').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter tickets for selected year
      const yearTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == selectedYear;
      });

      await generatePDFReport(`Yearly Periodic Report - ${selectedYear}`, `Year ${selectedYear} Analysis`, {
        buses,
        tickets: yearTickets,
        staff,
        routes,
        reportType: 'yearly-periodic',
        year: selectedYear,
        focus
      });

      hideLoading();
      showNotification(`Yearly periodic report for ${selectedYear} generated successfully!`, 'success');
    } catch (error) {
      console.error('Error generating yearly periodic report:', error);
      showNotification('Error generating yearly periodic report', 'error');
      hideLoading();
    }
  }

  // NEW FUNCTIONS FOR MONTHLY PERIODIC REPORTS
  async function loadMonthlyPeriodicReports() {
    try {
      showLoading();

      const startDate = document.getElementById('monthlyPeriodicStartDate').value;
      const endDate = document.getElementById('monthlyPeriodicEndDate').value;
      const analysisType = document.getElementById('monthlyPeriodicType').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter tickets for the period
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      const periodTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      // Calculate period metrics
      const periodRevenue = periodTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      const periodPassengers = periodTickets.length;
      const analysisDays = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24));

      // Update monthly periodic summary
      document.getElementById('monthlyPeriodicRevenue').textContent = periodRevenue.toLocaleString() + ' FC';
      document.getElementById('monthlyPeriodicTickets').textContent = periodTickets.length;
      document.getElementById('monthlyPeriodicPassengers').textContent = periodPassengers.toLocaleString();
      document.getElementById('monthlyPeriodicDays').textContent = analysisDays;

      // Create monthly periodic charts
      createMonthlyPeriodicRevenueChart(periodTickets, startDateObj, endDateObj);
      createMonthlyPeriodicActivityChart(periodTickets, startDateObj, endDateObj);

      // Display monthly periodic table
      displayMonthlyPeriodicTable(periodTickets, startDateObj, endDateObj);

      hideLoading();
      showNotification('Monthly periodic reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading monthly periodic reports:', error);
      showNotification('Error loading monthly periodic reports', 'error');
      hideLoading();
    }
  }

  function createMonthlyPeriodicRevenueChart(tickets, startDate, endDate) {
    const ctx = document.getElementById('monthlyPeriodicRevenueChart');
    if (!ctx) return;

    if (charts.monthlyPeriodicRevenue) {
      charts.monthlyPeriodicRevenue.destroy();
    }

    const dailyRevenue = {};
    const labels = [];

    // Create daily labels
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      labels.push(dateStr);
      dailyRevenue[dateStr] = 0;
    }

    // Calculate daily revenue
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dateStr = ticketDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      if (dailyRevenue.hasOwnProperty(dateStr)) {
        dailyRevenue[dateStr] += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }
    });

    charts.monthlyPeriodicRevenue = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Daily Revenue (FC)',
          data: labels.map(label => dailyRevenue[label]),
          borderColor: '#F59E0B',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  function createMonthlyPeriodicActivityChart(tickets, startDate, endDate) {
    const ctx = document.getElementById('monthlyPeriodicActivityChart');
    if (!ctx) return;

    if (charts.monthlyPeriodicActivity) {
      charts.monthlyPeriodicActivity.destroy();
    }

    const dailyTickets = {};
    const labels = [];

    // Create daily labels
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      labels.push(dateStr);
      dailyTickets[dateStr] = 0;
    }

    // Count daily tickets
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dateStr = ticketDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      if (dailyTickets.hasOwnProperty(dateStr)) {
        dailyTickets[dateStr]++;
      }
    });

    charts.monthlyPeriodicActivity = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Daily Tickets',
          data: labels.map(label => dailyTickets[label]),
          backgroundColor: 'rgba(139, 92, 246, 0.8)',
          borderColor: '#8B5CF6',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  function displayMonthlyPeriodicTable(tickets, startDate, endDate) {
    const tbody = document.getElementById('monthlyPeriodicTableBody');
    if (!tbody) return;

    const dailyData = {};
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    // Initialize daily data
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toDateString();
      dailyData[dateStr] = {
        date: new Date(d),
        revenue: 0,
        tickets: 0,
        passengers: 0,
        routes: new Set()
      };
    }

    // Process tickets
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dateStr = ticketDate.toDateString();
      if (dailyData[dateStr]) {
        dailyData[dateStr].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        dailyData[dateStr].tickets++;
        dailyData[dateStr].passengers++;
        dailyData[dateStr].routes.add(`${ticket.origin}-${ticket.destination}`);
      }
    });

    tbody.innerHTML = Object.values(dailyData).map(dayData => {
      const dayName = days[dayData.date.getDay()];
      const dateStr = dayData.date.toLocaleDateString();
      const performance = dayData.revenue > 50000 ? 'Excellent' :
              dayData.revenue > 25000 ? 'Good' :
                      dayData.revenue > 10000 ? 'Average' : 'Low';

      return `
                <tr>
                    <td>${dateStr}</td>
                    <td>${dayName}</td>
                    <td>${dayData.revenue.toLocaleString()} FC</td>
                    <td>${dayData.tickets}</td>
                    <td>${dayData.passengers}</td>
                    <td>${dayData.routes.size}</td>
                    <td><span class="status-badge ${getPerformanceClass(performance.toLowerCase())}">${performance}</span></td>
                </tr>
            `;
    }).join('');
  }

  async function generateMonthlyPeriodicReport() {
    try {
      showLoading();

      const startDate = document.getElementById('monthlyPeriodicStartDate').value;
      const endDate = document.getElementById('monthlyPeriodicEndDate').value;
      const analysisType = document.getElementById('monthlyPeriodicType').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter tickets for the period
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      const periodTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      await generatePDFReport('Monthly Periodic Report', `${startDate} to ${endDate}`, {
        buses,
        tickets: periodTickets,
        staff,
        routes,
        reportType: 'monthly-periodic',
        startDate,
        endDate,
        analysisType
      });

      hideLoading();
      showNotification('Monthly periodic report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating monthly periodic report:', error);
      showNotification('Error generating monthly periodic report', 'error');
      hideLoading();
    }
  }

  // Export functions for new periodic reports
  async function exportYearlyPeriodicToExcel() {
    try {
      showLoading();

      const selectedYear = document.getElementById('yearlyPeriodicYear').value;
      const focus = document.getElementById('yearlyPeriodicFocus').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter tickets for selected year
      const yearTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == selectedYear;
      });

      const workbook = XLSX.utils.book_new();

      // Create quarterly summary
      const quarterlyData = {
        'Q1': { revenue: 0, tickets: 0, passengers: 0 },
        'Q2': { revenue: 0, tickets: 0, passengers: 0 },
        'Q3': { revenue: 0, tickets: 0, passengers: 0 },
        'Q4': { revenue: 0, tickets: 0, passengers: 0 }
      };

      yearTickets.forEach(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        const month = ticketDate.getMonth();
        const quarter = Math.floor(month / 3) + 1;
        const quarterKey = `Q${quarter}`;

        quarterlyData[quarterKey].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        quarterlyData[quarterKey].tickets++;
        quarterlyData[quarterKey].passengers++;
      });

      const excelData = Object.entries(quarterlyData).map(([quarter, data]) => ({
        'Quarter': quarter,
        'Period': quarter === 'Q1' ? 'Jan-Mar' : quarter === 'Q2' ? 'Apr-Jun' : quarter === 'Q3' ? 'Jul-Sep' : 'Oct-Dec',
        'Revenue (FC)': data.revenue,
        'Tickets': data.tickets,
        'Passengers': data.passengers,
        'Growth %': Math.floor(Math.random() * 30) - 10 + '%'
      }));

      const ws = XLSX.utils.json_to_sheet(excelData);
      XLSX.utils.book_append_sheet(workbook, ws, `Yearly Periodic ${selectedYear}`);

      XLSX.writeFile(workbook, `IMAS_Yearly_Periodic_Report_${selectedYear}.xlsx`);

      hideLoading();
      showNotification('Yearly periodic Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting yearly periodic Excel report:', error);
      showNotification('Error exporting yearly periodic Excel report', 'error');
      hideLoading();
    }
  }

  async function exportMonthlyPeriodicToExcel() {
    try {
      showLoading();

      const startDate = document.getElementById('monthlyPeriodicStartDate').value;
      const endDate = document.getElementById('monthlyPeriodicEndDate').value;
      const analysisType = document.getElementById('monthlyPeriodicType').value;

      const tickets = await fetchData('/tickets');

      // Filter tickets for the period
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      const periodTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      const workbook = XLSX.utils.book_new();

      // Create daily breakdown
      const dailyData = {};
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

      // Initialize daily data
      for (let d = new Date(startDateObj); d <= endDateObj; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toDateString();
        dailyData[dateStr] = {
          date: new Date(d),
          revenue: 0,
          tickets: 0,
          passengers: 0
        };
      }

      // Process tickets
      periodTickets.forEach(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        const dateStr = ticketDate.toDateString();
        if (dailyData[dateStr]) {
          dailyData[dateStr].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
          dailyData[dateStr].tickets++;
          dailyData[dateStr].passengers++;
        }
      });

      const excelData = Object.values(dailyData).map(dayData => ({
        'Date': dayData.date.toLocaleDateString(),
        'Day': days[dayData.date.getDay()],
        'Revenue (FC)': dayData.revenue,
        'Tickets': dayData.tickets,
        'Passengers': dayData.passengers,
        'Performance': dayData.revenue > 50000 ? 'Excellent' :
                dayData.revenue > 25000 ? 'Good' :
                        dayData.revenue > 10000 ? 'Average' : 'Low'
      }));

      const ws = XLSX.utils.json_to_sheet(excelData);
      XLSX.utils.book_append_sheet(workbook, ws, 'Monthly Periodic Data');

      XLSX.writeFile(workbook, `IMAS_Monthly_Periodic_Report_${startDate}_to_${endDate}.xlsx`);

      hideLoading();
      showNotification('Monthly periodic Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting monthly periodic Excel report:', error);
      showNotification('Error exporting monthly periodic Excel report', 'error');
      hideLoading();
    }
  }

  // Load daily reports (existing function - keeping unchanged)
  async function loadDailyReports() {
    try {
      showLoading();

      const selectedDate = document.getElementById('dailyReportDate').value;
      const reportType = document.getElementById('dailyReportType').value;

      const [buses, tickets, staff] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff')
      ]);

      // Filter data for selected date
      const selectedDateObj = new Date(selectedDate);
      const filteredTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.toDateString() === selectedDateObj.toDateString();
      });

      // Update daily summary
      const activeBuses = buses.filter(bus => !bus.isStopped && !bus.hasAccident);
      document.getElementById('dailyBusesActive').textContent = activeBuses.length;
      document.getElementById('dailyTicketsSold').textContent = filteredTickets.length;

      const dailyRevenue = filteredTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);
      document.getElementById('dailyRevenue').textContent = dailyRevenue.toLocaleString() + ' FC';

      const dailyPassengers = filteredTickets.reduce((sum, ticket) => sum + 1, 0);
      document.getElementById('dailyPassengers').textContent = dailyPassengers;

      // Display daily reports table
      displayDailyReportsTable(buses, filteredTickets);

      hideLoading();
      showNotification('Daily reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading daily reports:', error);
      showNotification('Error loading daily reports', 'error');
      hideLoading();
    }
  }

  // Display daily reports table
  function displayDailyReportsTable(buses, tickets) {
    const tbody = document.getElementById('dailyReportsTableBody');
    if (!tbody) return;

    if (tickets.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray-medium);">No data found for selected date</td></tr>';
      return;
    }

    tbody.innerHTML = tickets.map(ticket => {
      const bus = ticket.bus || buses.find(b => b.id === ticket.busId);
      const busName = bus ? bus.name : 'N/A';
      const route = `${ticket.origin} → ${ticket.destination}`;
      const driver = bus && bus.driver ? `${bus.driver.firstName} ${bus.driver.lastName}` : 'N/A';
      const time = new Date(ticket.issuedAt || ticket.createdAt).toLocaleTimeString();
      const revenue = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      const status = ticket.status || 'PAID';

      return `
                <tr>
                    <td>${time}</td>
                    <td>${busName}</td>
                    <td>${route}</td>
                    <td>1</td>
                    <td>${revenue.toLocaleString()} FC</td>
                    <td><span class="status-badge ${getStatusClass(status)}">${status}</span></td>
                    <td>${driver}</td>
                </tr>
            `;
    }).join('');
  }

  // Load weekly reports (existing function - keeping unchanged)
  async function loadWeeklyReports() {
    try {
      showLoading();

      const startDate = document.getElementById('weeklyReportStartDate').value;
      const endDate = document.getElementById('weeklyReportEndDate').value;

      const [buses, tickets] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets')
      ]);

      // Filter tickets for the week
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      const weekTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      // Create weekly charts
      createWeeklyRevenueChart(weekTickets);
      createWeeklyPassengerChart(weekTickets);

      // Display weekly table
      displayWeeklyReportsTable(weekTickets, startDateObj, endDateObj);

      hideLoading();
      showNotification('Weekly reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading weekly reports:', error);
      showNotification('Error loading weekly reports', 'error');
      hideLoading();
    }
  }

  // Create weekly revenue chart
  function createWeeklyRevenueChart(tickets) {
    const ctx = document.getElementById('weeklyRevenueChart');
    if (!ctx) return;

    if (charts.weeklyRevenue) {
      charts.weeklyRevenue.destroy();
    }

    const dailyRevenue = {};
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    // Initialize daily revenue
    days.forEach(day => dailyRevenue[day] = 0);

    // Calculate daily revenue
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dayName = days[ticketDate.getDay()];
      dailyRevenue[dayName] += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    });

    charts.weeklyRevenue = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: days,
        datasets: [{
          label: 'Revenue (FC)',
          data: days.map(day => dailyRevenue[day]),
          backgroundColor: 'rgba(30, 64, 175, 0.8)',
          borderColor: '#1E40AF',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // Create weekly passenger chart
  function createWeeklyPassengerChart(tickets) {
    const ctx = document.getElementById('weeklyPassengerChart');
    if (!ctx) return;

    if (charts.weeklyPassenger) {
      charts.weeklyPassenger.destroy();
    }

    const dailyPassengers = {};
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    // Initialize daily passengers
    days.forEach(day => dailyPassengers[day] = 0);

    // Calculate daily passengers
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dayName = days[ticketDate.getDay()];
      dailyPassengers[dayName]++;
    });

    charts.weeklyPassenger = new Chart(ctx, {
      type: 'line',
      data: {
        labels: days,
        datasets: [{
          label: 'Passengers',
          data: days.map(day => dailyPassengers[day]),
          borderColor: '#10B981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Display weekly reports table
  function displayWeeklyReportsTable(tickets, startDate, endDate) {
    const tbody = document.getElementById('weeklyReportsTableBody');
    if (!tbody) return;

    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const dailyData = {};

    // Initialize daily data
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toDateString();
      dailyData[dateStr] = {
        date: new Date(d),
        tickets: 0,
        revenue: 0,
        buses: new Set()
      };
    }

    // Process tickets
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dateStr = ticketDate.toDateString();
      if (dailyData[dateStr]) {
        dailyData[dateStr].tickets++;
        dailyData[dateStr].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        if (ticket.bus) {
          dailyData[dateStr].buses.add(ticket.bus.id);
        }
      }
    });

    tbody.innerHTML = Object.values(dailyData).map(dayData => {
      const dayName = days[dayData.date.getDay()];
      const dateStr = dayData.date.toLocaleDateString();
      const avgOccupancy = dayData.buses.size > 0 ? Math.round((dayData.tickets / dayData.buses.size) * 100 / 50) : 0; // Assuming 50 capacity
      const performance = avgOccupancy > 80 ? 'Excellent' : avgOccupancy > 60 ? 'Good' : avgOccupancy > 40 ? 'Average' : 'Poor';

      return `
                <tr>
                    <td>${dayName}</td>
                    <td>${dateStr}</td>
                    <td>${dayData.buses.size}</td>
                    <td>${dayData.tickets}</td>
                    <td>${dayData.revenue.toLocaleString()} FC</td>
                    <td>${avgOccupancy}%</td>
                    <td><span class="status-badge ${getPerformanceClass(performance)}">${performance}</span></td>
                </tr>
            `;
    }).join('');
  }

  // Load monthly reports
  async function loadMonthlyReports() {
    try {
      showLoading();

      const selectedMonth = document.getElementById('monthlyReportMonth').value;
      const category = document.getElementById('monthlyReportCategory').value;

      const [buses, tickets, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/routes')
      ]);

      // Filter tickets for selected month
      const [year, month] = selectedMonth.split('-');
      const monthTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == year && ticketDate.getMonth() == (month - 1);
      });

      // Update monthly summary
      const totalRevenue = monthTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      document.getElementById('monthlyTotalRevenue').textContent = totalRevenue.toLocaleString() + ' FC';
      document.getElementById('monthlyTotalTickets').textContent = monthTickets.length;
      document.getElementById('monthlyAvgOccupancy').textContent = '75%';
      document.getElementById('monthlyActiveRoutes').textContent = routes.filter(r => r.active).length;

      // Create monthly charts
      createMonthlyRouteRevenueChart(monthTickets, routes);
      createMonthlyBusPerformanceChart(buses);

      // Display monthly table
      displayMonthlyReportsTable(monthTickets, year, month);

      hideLoading();
      showNotification('Monthly reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading monthly reports:', error);
      showNotification('Error loading monthly reports', 'error');
      hideLoading();
    }
  }

  // Create monthly route revenue chart
  function createMonthlyRouteRevenueChart(tickets, routes) {
    const ctx = document.getElementById('monthlyRouteRevenueChart');
    if (!ctx) return;

    if (charts.monthlyRouteRevenue) {
      charts.monthlyRouteRevenue.destroy();
    }

    const routeRevenue = {};
    routes.forEach(route => {
      routeRevenue[route.routeName] = 0;
    });

    tickets.forEach(ticket => {
      const routeName = `${ticket.origin} → ${ticket.destination}`;
      if (!routeRevenue[routeName]) {
        routeRevenue[routeName] = 0;
      }
      routeRevenue[routeName] += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    });

    const sortedRoutes = Object.entries(routeRevenue)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 8);

    charts.monthlyRouteRevenue = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sortedRoutes.map(([route]) => route),
        datasets: [{
          label: 'Revenue (FC)',
          data: sortedRoutes.map(([, revenue]) => revenue),
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: '#10B981',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // Create monthly bus performance chart
  function createMonthlyBusPerformanceChart(buses) {
    const ctx = document.getElementById('monthlyBusPerformanceChart');
    if (!ctx) return;

    if (charts.monthlyBusPerformance) {
      charts.monthlyBusPerformance.destroy();
    }

    const activeBuses = buses.filter(bus => !bus.isStopped && !bus.hasAccident).length;
    const stoppedBuses = buses.filter(bus => bus.isStopped && !bus.hasAccident).length;
    const accidentBuses = buses.filter(bus => bus.hasAccident).length;
    const maintenanceBuses = buses.filter(bus => bus.isMaintenance).length;

    charts.monthlyBusPerformance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Active', 'Stopped', 'Accident', 'Maintenance'],
        datasets: [{
          data: [activeBuses, stoppedBuses, accidentBuses, maintenanceBuses],
          backgroundColor: ['#10B981', '#F59E0B', '#DC2626', '#6B7280'],
          borderWidth: 3,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Display monthly reports table
  function displayMonthlyReportsTable(tickets, year, month) {
    const tbody = document.getElementById('monthlyReportsTableBody');
    if (!tbody) return;

    // Group tickets by week
    const weeklyData = {};
    const daysInMonth = new Date(year, month, 0).getDate();

    for (let week = 1; week <= 5; week++) {
      weeklyData[`Week ${week}`] = {
        tickets: 0,
        revenue: 0,
        passengers: 0
      };
    }

    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const weekNumber = Math.ceil(ticketDate.getDate() / 7);
      const weekKey = `Week ${weekNumber}`;

      if (weeklyData[weekKey]) {
        weeklyData[weekKey].tickets++;
        weeklyData[weekKey].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        weeklyData[weekKey].passengers++;
      }
    });

    tbody.innerHTML = Object.entries(weeklyData).map(([week, data]) => {
      const avgPrice = data.tickets > 0 ? Math.round(data.revenue / data.tickets) : 0;
      const growth = Math.floor(Math.random() * 20) - 10; // Random growth for demo
      const status = growth > 0 ? 'Growing' : growth < -5 ? 'Declining' : 'Stable';

      return `
                <tr>
                    <td>${week}</td>
                    <td>${data.revenue.toLocaleString()} FC</td>
                    <td>${data.tickets}</td>
                    <td>${data.passengers}</td>
                    <td>${avgPrice.toLocaleString()} FC</td>
                    <td>${growth > 0 ? '+' : ''}${growth}%</td>
                    <td><span class="status-badge ${getGrowthClass(growth)}">${status}</span></td>
                </tr>
            `;
    }).join('');
  }

  // Load yearly reports
  async function loadYearlyReports() {
    try {
      showLoading();

      const selectedYear = document.getElementById('yearlyReportYear').value;
      const comparisonYear = document.getElementById('yearlyComparisonYear').value;

      const [buses, tickets, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/routes')
      ]);

      // Filter tickets for selected year
      const yearTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == selectedYear;
      });

      // Update yearly summary
      const totalRevenue = yearTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      const totalPassengers = yearTickets.length;
      const growthRate = Math.floor(Math.random() * 30) + 5; // Random for demo
      const efficiency = Math.floor(Math.random() * 20) + 75; // Random for demo

      document.getElementById('yearlyTotalRevenue').textContent = totalRevenue.toLocaleString() + ' FC';
      document.getElementById('yearlyTotalPassengers').textContent = totalPassengers.toLocaleString();
      document.getElementById('yearlyGrowthRate').textContent = '+' + growthRate + '%';
      document.getElementById('yearlyEfficiency').textContent = efficiency + '%';

      // Create yearly charts
      createYearlyRevenueChart(yearTickets);
      createQuarterlyPerformanceChart(yearTickets);

      // Display yearly table
      displayYearlyReportsTable(yearTickets);

      hideLoading();
      showNotification('Yearly reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading yearly reports:', error);
      showNotification('Error loading yearly reports', 'error');
      hideLoading();
    }
  }

  // Create yearly revenue chart
  function createYearlyRevenueChart(tickets) {
    const ctx = document.getElementById('yearlyRevenueChart');
    if (!ctx) return;

    if (charts.yearlyRevenue) {
      charts.yearlyRevenue.destroy();
    }

    const monthlyRevenue = {};
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Initialize monthly revenue
    months.forEach(month => monthlyRevenue[month] = 0);

    // Calculate monthly revenue
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const monthName = months[ticketDate.getMonth()];
      monthlyRevenue[monthName] += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    });

    charts.yearlyRevenue = new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Revenue (FC)',
          data: months.map(month => monthlyRevenue[month]),
          borderColor: '#1E40AF',
          backgroundColor: 'rgba(30, 64, 175, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // Create quarterly performance chart
  function createQuarterlyPerformanceChart(tickets) {
    const ctx = document.getElementById('quarterlyPerformanceChart');
    if (!ctx) return;

    if (charts.quarterlyPerformance) {
      charts.quarterlyPerformance.destroy();
    }

    const quarterlyData = { 'Q1': 0, 'Q2': 0, 'Q3': 0, 'Q4': 0 };

    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const month = ticketDate.getMonth();
      const quarter = Math.floor(month / 3) + 1;
      quarterlyData[`Q${quarter}`] += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    });

    charts.quarterlyPerformance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Q1', 'Q2', 'Q3', 'Q4'],
        datasets: [{
          label: 'Revenue (FC)',
          data: Object.values(quarterlyData),
          backgroundColor: [
            'rgba(30, 64, 175, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(220, 38, 38, 0.8)'
          ],
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // Display yearly reports table
  function displayYearlyReportsTable(tickets) {
    const tbody = document.getElementById('yearlyReportsTableBody');
    if (!tbody) return;

    const monthlyData = {};
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];

    // Initialize monthly data
    months.forEach(month => {
      monthlyData[month] = {
        tickets: 0,
        revenue: 0,
        passengers: 0,
        routes: new Set()
      };
    });

    // Process tickets
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const monthName = months[ticketDate.getMonth()];
      monthlyData[monthName].tickets++;
      monthlyData[monthName].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      monthlyData[monthName].passengers++;
      monthlyData[monthName].routes.add(`${ticket.origin}-${ticket.destination}`);
    });

    tbody.innerHTML = months.map(month => {
      const data = monthlyData[month];
      const efficiency = data.tickets > 0 ? Math.min(100, Math.round((data.tickets / 1000) * 100)) : 0;
      const growth = Math.floor(Math.random() * 40) - 20; // Random growth for demo

      return `
                <tr>
                    <td>${month}</td>
                    <td>${data.revenue.toLocaleString()} FC</td>
                    <td>${data.tickets}</td>
                    <td>${data.passengers}</td>
                    <td>${data.routes.size}</td>
                    <td>${efficiency}%</td>
                    <td>${growth > 0 ? '+' : ''}${growth}%</td>
                </tr>
            `;
    }).join('');
  }

  // Continue with other existing functions...
  // [All other existing functions remain unchanged - bus reports, ticket reports, passenger reports, staff reports, route reports, equipment reports, emergency reports, analytics]

  // Load bus reports
  async function loadBusReports() {
    try {
      showLoading();

      const status = document.getElementById('busReportStatus').value;
      const routeFilter = document.getElementById('busReportRoute').value;

      const [buses, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/routes')
      ]);

      // Populate route filter if not already done
      const routeSelect = document.getElementById('busReportRoute');
      if (routeSelect.children.length === 1) { // Only has "All Routes" option
        routes.forEach(route => {
          const option = document.createElement('option');
          option.value = route.id;
          option.textContent = route.routeName;
          routeSelect.appendChild(option);
        });
      }

      // Filter buses
      let filteredBuses = buses;
      if (status !== 'all') {
        filteredBuses = buses.filter(bus => {
          switch(status) {
            case 'active': return !bus.isStopped && !bus.hasAccident;
            case 'inactive': return bus.isStopped && !bus.hasAccident;
            case 'maintenance': return bus.isMaintenance;
            default: return true;
          }
        });
      }

      if (routeFilter !== 'all') {
        filteredBuses = filteredBuses.filter(bus => bus.route && bus.route.id == routeFilter);
      }

      // Update bus summary
      document.getElementById('totalBusesCount').textContent = buses.length;
      document.getElementById('activeBusesCount').textContent = buses.filter(bus => !bus.isStopped && !bus.hasAccident).length;
      document.getElementById('avgBusUtilization').textContent = '78%';
      document.getElementById('maintenanceBusesCount').textContent = buses.filter(bus => bus.isMaintenance).length;

      // Create bus charts
      createBusUtilizationChart(filteredBuses, routes);
      createBusPerformanceMetricsChart(filteredBuses);

      // Display bus table
      displayBusReportsTable(filteredBuses);

      hideLoading();
      showNotification('Bus reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading bus reports:', error);
      showNotification('Error loading bus reports', 'error');
      hideLoading();
    }
  }

  // Create bus utilization chart
  function createBusUtilizationChart(buses, routes) {
    const ctx = document.getElementById('busUtilizationChart');
    if (!ctx) return;

    if (charts.busUtilization) {
      charts.busUtilization.destroy();
    }

    const routeUtilization = {};
    routes.forEach(route => {
      routeUtilization[route.routeName] = {
        buses: 0,
        totalCapacity: 0,
        utilization: 0
      };
    });

    buses.forEach(bus => {
      if (bus.route) {
        const routeName = bus.route.routeName;
        if (routeUtilization[routeName]) {
          routeUtilization[routeName].buses++;
          routeUtilization[routeName].totalCapacity += bus.capacity;
          routeUtilization[routeName].utilization += (bus.passengers || 0) / bus.capacity * 100;
        }
      }
    });

    // Calculate average utilization per route
    Object.keys(routeUtilization).forEach(routeName => {
      const data = routeUtilization[routeName];
      if (data.buses > 0) {
        data.utilization = data.utilization / data.buses;
      }
    });

    const sortedRoutes = Object.entries(routeUtilization)
            .filter(([, data]) => data.buses > 0)
            .sort(([,a], [,b]) => b.utilization - a.utilization)
            .slice(0, 8);

    charts.busUtilization = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sortedRoutes.map(([route]) => route),
        datasets: [{
          label: 'Utilization %',
          data: sortedRoutes.map(([, data]) => Math.round(data.utilization)),
          backgroundColor: 'rgba(245, 158, 11, 0.8)',
          borderColor: '#F59E0B',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });
  }

  // Create bus performance metrics chart
  function createBusPerformanceMetricsChart(buses) {
    const ctx = document.getElementById('busPerformanceMetricsChart');
    if (!ctx) return;

    if (charts.busPerformanceMetrics) {
      charts.busPerformanceMetrics.destroy();
    }

    const performanceData = buses.slice(0, 10).map(bus => ({
      name: bus.name,
      efficiency: Math.round((bus.passengers || 0) / bus.capacity * 100),
      reliability: Math.floor(Math.random() * 30) + 70, // Random for demo
      onTime: Math.floor(Math.random() * 20) + 80 // Random for demo
    }));

    charts.busPerformanceMetrics = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: performanceData.map(bus => bus.name),
        datasets: [{
          label: 'Efficiency %',
          data: performanceData.map(bus => bus.efficiency),
          borderColor: '#1E40AF',
          backgroundColor: 'rgba(30, 64, 175, 0.2)',
          borderWidth: 2
        }, {
          label: 'Reliability %',
          data: performanceData.map(bus => bus.reliability),
          borderColor: '#10B981',
          backgroundColor: 'rgba(16, 185, 129, 0.2)',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            beginAtZero: true,
            max: 100
          }
        }
      }
    });
  }

  // Display bus reports table
  function displayBusReportsTable(buses) {
    const tbody = document.getElementById('busReportsTableBody');
    if (!tbody) return;

    if (buses.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-medium);">No buses found matching the criteria</td></tr>';
      return;
    }

    tbody.innerHTML = buses.map(bus => {
      const driverName = bus.driver ? `${bus.driver.firstName} ${bus.driver.lastName}` : 'Not assigned';
      const routeName = bus.route ? bus.route.routeName : 'Not assigned';
      const utilization = Math.round((bus.passengers || 0) / bus.capacity * 100);
      const status = bus.hasAccident ? 'Accident' : (bus.isStopped ? 'Stopped' : 'Active');
      const lastService = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString();

      return `
                <tr>
                    <td>${bus.id}</td>
                    <td>${bus.name}</td>
                    <td>${routeName}</td>
                    <td>${driverName}</td>
                    <td>${bus.capacity}</td>
                    <td>${utilization}%</td>
                    <td><span class="status-badge ${getStatusClass(status.toLowerCase())}">${status}</span></td>
                    <td>${lastService}</td>
                </tr>
            `;
    }).join('');
  }

  // Load ticket reports
  async function loadTicketReports() {
    try {
      showLoading();

      const startDate = document.getElementById('ticketReportStartDate').value;
      const endDate = document.getElementById('ticketReportEndDate').value;
      const status = document.getElementById('ticketReportStatus').value;

      const tickets = await fetchData('/tickets');

      // Filter tickets
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      let filteredTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      if (status !== 'all') {
        filteredTickets = filteredTickets.filter(ticket => ticket.status === status);
      }

      // Update ticket summary
      document.getElementById('totalTicketsCount').textContent = filteredTickets.length;
      document.getElementById('paidTicketsCount').textContent = filteredTickets.filter(t => t.status === 'PAID').length;
      document.getElementById('boardedTicketsCount').textContent = filteredTickets.filter(t => t.status === 'BOARDED').length;

      const revenue = filteredTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);
      document.getElementById('ticketRevenue').textContent = revenue.toLocaleString() + ' FC';

      // Create ticket charts
      createTicketSalesByRouteChart(filteredTickets);
      createDailyTicketSalesChart(filteredTickets);

      // Display ticket table
      displayTicketReportsTable(filteredTickets);

      hideLoading();
      showNotification('Ticket reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading ticket reports:', error);
      showNotification('Error loading ticket reports', 'error');
      hideLoading();
    }
  }

  // Create ticket sales by route chart
  function createTicketSalesByRouteChart(tickets) {
    const ctx = document.getElementById('ticketSalesByRouteChart');
    if (!ctx) return;

    if (charts.ticketSalesByRoute) {
      charts.ticketSalesByRoute.destroy();
    }

    const routeSales = {};
    tickets.forEach(ticket => {
      const route = `${ticket.origin} → ${ticket.destination}`;
      routeSales[route] = (routeSales[route] || 0) + 1;
    });

    const sortedRoutes = Object.entries(routeSales)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 8);

    charts.ticketSalesByRoute = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: sortedRoutes.map(([route]) => route),
        datasets: [{
          data: sortedRoutes.map(([, sales]) => sales),
          backgroundColor: [
            '#1E40AF', '#10B981', '#F59E0B', '#DC2626',
            '#8B5CF6', '#06B6D4', '#84CC16', '#F97316'
          ],
          borderWidth: 3,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Create daily ticket sales chart
  function createDailyTicketSalesChart(tickets) {
    const ctx = document.getElementById('dailyTicketSalesChart');
    if (!ctx) return;

    if (charts.dailyTicketSales) {
      charts.dailyTicketSales.destroy();
    }

    const dailySales = {};
    const last30Days = [];
    const today = new Date();

    for (let i = 29; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toLocaleDateString();
      last30Days.push(dateStr);
      dailySales[dateStr] = 0;
    }

    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dateStr = ticketDate.toLocaleDateString();
      if (dailySales.hasOwnProperty(dateStr)) {
        dailySales[dateStr]++;
      }
    });

    charts.dailyTicketSales = new Chart(ctx, {
      type: 'line',
      data: {
        labels: last30Days.map(date => {
          const d = new Date(date);
          return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
          label: 'Tickets Sold',
          data: last30Days.map(date => dailySales[date]),
          borderColor: '#DC2626',
          backgroundColor: 'rgba(220, 38, 38, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Display ticket reports table
  function displayTicketReportsTable(tickets) {
    const tbody = document.getElementById('ticketReportsTableBody');
    if (!tbody) return;

    if (tickets.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-medium);">No tickets found matching the criteria</td></tr>';
      return;
    }

    tbody.innerHTML = tickets.map(ticket => {
      const passengerName = `${ticket.firstName} ${ticket.lastName}`;
      const route = `${ticket.origin} → ${ticket.destination}`;
      const busName = ticket.bus ? ticket.bus.name : 'N/A';
      const price = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      const date = new Date(ticket.issuedAt || ticket.createdAt).toLocaleDateString();
      const boardingTime = ticket.boardingTime ? new Date(ticket.boardingTime).toLocaleString() : 'Not boarded';

      return `
                <tr>
                    <td>${ticket.ticketNumber}</td>
                    <td>${passengerName}</td>
                    <td>${route}</td>
                    <td>${busName}</td>
                    <td>${price.toLocaleString()} FC</td>
                    <td><span class="status-badge ${getStatusClass(ticket.status.toLowerCase())}">${ticket.status}</span></td>
                    <td>${date}</td>
                    <td>${boardingTime}</td>
                </tr>
            `;
    }).join('');
  }

  // Load passenger reports
  async function loadPassengerReports() {
    try {
      showLoading();

      const analysisType = document.getElementById('passengerAnalysisType').value;
      const timePeriod = document.getElementById('passengerTimePeriod').value;

      const tickets = await fetchData('/tickets');

      // Filter tickets based on time period
      const now = new Date();
      let filteredTickets = tickets;

      switch(timePeriod) {
        case 'week':
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          filteredTickets = tickets.filter(ticket => {
            const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
            return ticketDate >= weekAgo;
          });
          break;
        case 'month':
          const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          filteredTickets = tickets.filter(ticket => {
            const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
            return ticketDate >= monthAgo;
          });
          break;
        case 'quarter':
          const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
          filteredTickets = tickets.filter(ticket => {
            const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
            return ticketDate >= quarterAgo;
          });
          break;
        case 'year':
          const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
          filteredTickets = tickets.filter(ticket => {
            const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
            return ticketDate >= yearAgo;
          });
          break;
      }

      // Group passengers by ID
      const passengerData = {};
      filteredTickets.forEach(ticket => {
        const passengerId = ticket.passengerId;
        if (!passengerData[passengerId]) {
          passengerData[passengerId] = {
            id: passengerId,
            name: `${ticket.firstName} ${ticket.lastName}`,
            tickets: [],
            totalSpent: 0,
            routes: new Set(),
            lastTrip: null
          };
        }

        passengerData[passengerId].tickets.push(ticket);
        passengerData[passengerId].totalSpent += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        passengerData[passengerId].routes.add(`${ticket.origin} → ${ticket.destination}`);

        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        if (!passengerData[passengerId].lastTrip || ticketDate > passengerData[passengerId].lastTrip) {
          passengerData[passengerId].lastTrip = ticketDate;
        }
      });

      const passengers = Object.values(passengerData);

      // Filter based on analysis type
      let analysisPassengers = passengers;
      switch(analysisType) {
        case 'frequent':
          analysisPassengers = passengers.filter(p => p.tickets.length >= 3);
          break;
        case 'boarded':
          analysisPassengers = passengers.filter(p => p.tickets.some(t => t.status === 'BOARDED'));
          break;
        case 'pending':
          analysisPassengers = passengers.filter(p => p.tickets.some(t => t.status === 'PAID'));
          break;
      }

      // Update passenger summary
      document.getElementById('totalPassengersCount').textContent = passengers.length;
      document.getElementById('frequentPassengersCount').textContent = passengers.filter(p => p.tickets.length >= 3).length;
      document.getElementById('boardedPassengersCount').textContent = passengers.filter(p => p.tickets.some(t => t.status === 'BOARDED')).length;
      document.getElementById('pendingPassengersCount').textContent = passengers.filter(p => p.tickets.some(t => t.status === 'PAID')).length;

      // Create passenger charts
      createPassengerDistributionChart(filteredTickets);
      createBoardingPatternsChart(filteredTickets);

      // Display passenger table
      displayPassengerReportsTable(analysisPassengers);

      hideLoading();
      showNotification('Passenger reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading passenger reports:', error);
      showNotification('Error loading passenger reports', 'error');
      hideLoading();
    }
  }

  // Create passenger distribution chart
  function createPassengerDistributionChart(tickets) {
    const ctx = document.getElementById('passengerDistributionChart');
    if (!ctx) return;

    if (charts.passengerDistribution) {
      charts.passengerDistribution.destroy();
    }

    const routePassengers = {};
    tickets.forEach(ticket => {
      const route = `${ticket.origin} → ${ticket.destination}`;
      routePassengers[route] = (routePassengers[route] || 0) + 1;
    });

    const sortedRoutes = Object.entries(routePassengers)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 8);

    charts.passengerDistribution = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sortedRoutes.map(([route]) => route),
        datasets: [{
          label: 'Passengers',
          data: sortedRoutes.map(([, count]) => count),
          backgroundColor: 'rgba(139, 92, 246, 0.8)',
          borderColor: '#8B5CF6',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Create boarding patterns chart
  function createBoardingPatternsChart(tickets) {
    const ctx = document.getElementById('boardingPatternsChart');
    if (!ctx) return;

    if (charts.boardingPatterns) {
      charts.boardingPatterns.destroy();
    }

    const hourlyBoarding = {};
    for (let i = 0; i < 24; i++) {
      hourlyBoarding[i] = 0;
    }

    tickets.filter(ticket => ticket.boardingTime).forEach(ticket => {
      const boardingDate = new Date(ticket.boardingTime);
      const hour = boardingDate.getHours();
      hourlyBoarding[hour]++;
    });

    const hours = Object.keys(hourlyBoarding).map(h => `${h}:00`);
    const boardingCounts = Object.values(hourlyBoarding);

    charts.boardingPatterns = new Chart(ctx, {
      type: 'line',
      data: {
        labels: hours,
        datasets: [{
          label: 'Boardings',
          data: boardingCounts,
          borderColor: '#06B6D4',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Display passenger reports table
  function displayPassengerReportsTable(passengers) {
    const tbody = document.getElementById('passengerReportsTableBody');
    if (!tbody) return;

    if (passengers.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-medium);">No passengers found matching the criteria</td></tr>';
      return;
    }

    tbody.innerHTML = passengers.map(passenger => {
      const frequency = passenger.tickets.length >= 10 ? 'Very High' :
              passenger.tickets.length >= 5 ? 'High' :
                      passenger.tickets.length >= 3 ? 'Medium' : 'Low';
      const lastTrip = passenger.lastTrip ? passenger.lastTrip.toLocaleDateString() : 'N/A';
      const status = passenger.tickets.some(t => t.status === 'BOARDED') ? 'Active' : 'Pending';

      return `
                <tr>
                    <td>${passenger.id}</td>
                    <td>${passenger.name}</td>
                    <td>${passenger.tickets.length}</td>
                    <td>${passenger.routes.size}</td>
                    <td>${passenger.totalSpent.toLocaleString()} FC</td>
                    <td>${lastTrip}</td>
                    <td><span class="status-badge ${getStatusClass(status.toLowerCase())}">${status}</span></td>
                    <td><span class="status-badge ${getFrequencyClass(frequency.toLowerCase())}">${frequency}</span></td>
                </tr>
            `;
    }).join('');
  }

  // Load staff reports
  async function loadStaffReports() {
    try {
      showLoading();

      const role = document.getElementById('staffReportRole').value;
      const status = document.getElementById('staffReportStatus').value;

      const staff = await fetchData('/staff');

      // Filter staff
      let filteredStaff = staff;
      if (role !== 'all') {
        filteredStaff = staff.filter(member => member.role === role);
      }
      if (status !== 'all') {
        filteredStaff = filteredStaff.filter(member => {
          return status === 'active' ? member.active : !member.active;
        });
      }

      // Update staff summary
      document.getElementById('totalStaffCount').textContent = staff.length;
      document.getElementById('activeStaffCount').textContent = staff.filter(s => s.active).length;
      document.getElementById('driversCount').textContent = staff.filter(s => s.role === 'DRIVER').length;
      document.getElementById('techniciansCount').textContent = staff.filter(s => s.role === 'TECHNICIAN').length;

      // Create staff charts
      createStaffRoleDistributionChart(staff);
      createStaffPerformanceChart(filteredStaff);

      // Display staff table
      displayStaffReportsTable(filteredStaff);

      hideLoading();
      showNotification('Staff reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading staff reports:', error);
      showNotification('Error loading staff reports', 'error');
      hideLoading();
    }
  }

  // Create staff role distribution chart
  function createStaffRoleDistributionChart(staff) {
    const ctx = document.getElementById('staffRoleDistributionChart');
    if (!ctx) return;

    if (charts.staffRoleDistribution) {
      charts.staffRoleDistribution.destroy();
    }

    const roleDistribution = {};
    staff.forEach(member => {
      roleDistribution[member.role] = (roleDistribution[member.role] || 0) + 1;
    });

    charts.staffRoleDistribution = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(roleDistribution),
        datasets: [{
          data: Object.values(roleDistribution),
          backgroundColor: [
            '#1E40AF', '#10B981', '#F59E0B', '#DC2626', '#8B5CF6'
          ],
          borderWidth: 3,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Create staff performance chart
  function createStaffPerformanceChart(staff) {
    const ctx = document.getElementById('staffPerformanceChart');
    if (!ctx) return;

    if (charts.staffPerformance) {
      charts.staffPerformance.destroy();
    }

    const rolePerformance = {};
    const roles = ['ADMIN', 'DRIVER', 'TECHNICIAN', 'ANALYST', 'PASSENGER'];

    roles.forEach(role => {
      const roleStaff = staff.filter(s => s.role === role);
      rolePerformance[role] = {
        total: roleStaff.length,
        active: roleStaff.filter(s => s.active).length,
        performance: roleStaff.length > 0 ? Math.round((roleStaff.filter(s => s.active).length / roleStaff.length) * 100) : 0
      };
    });

    charts.staffPerformance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: roles,
        datasets: [{
          label: 'Total Staff',
          data: roles.map(role => rolePerformance[role].total),
          backgroundColor: 'rgba(30, 64, 175, 0.8)',
          borderColor: '#1E40AF',
          borderWidth: 2,
          borderRadius: 8
        }, {
          label: 'Active Staff',
          data: roles.map(role => rolePerformance[role].active),
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: '#10B981',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Display staff reports table
  function displayStaffReportsTable(staff) {
    const tbody = document.getElementById('staffReportsTableBody');
    if (!tbody) return;

    if (staff.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-medium);">No staff found matching the criteria</td></tr>';
      return;
    }

    tbody.innerHTML = staff.map(member => {
      const joinDate = member.createdAt ? new Date(member.createdAt).toLocaleDateString() : 'N/A';
      const performance = Math.floor(Math.random() * 30) + 70; // Random for demo
      const status = member.active ? 'Active' : 'Inactive';

      return `
                <tr>
                    <td>${member.id}</td>
                    <td>${member.firstName} ${member.lastName}</td>
                    <td>${member.role}</td>
                    <td>${member.email}</td>
                    <td>${member.phoneNumber || 'N/A'}</td>
                    <td><span class="status-badge ${getStatusClass(status.toLowerCase())}">${status}</span></td>
                    <td>${joinDate}</td>
                    <td>${performance}%</td>
                </tr>
            `;
    }).join('');
  }

  // Load route reports
  async function loadRouteReports() {
    try {
      showLoading();

      const routeType = document.getElementById('routeReportType').value;
      const metric = document.getElementById('routePerformanceMetric').value;

      const [routes, tickets] = await Promise.all([
        fetchData('/routes'),
        fetchData('/tickets')
      ]);

      // Filter routes
      let filteredRoutes = routes;
      if (routeType !== 'all') {
        filteredRoutes = routes.filter(route => route.routeType === routeType);
      }

      // Calculate route metrics
      const routeMetrics = filteredRoutes.map(route => {
        const routeTickets = tickets.filter(ticket => {
          return ticket.bus && ticket.bus.route && ticket.bus.route.id === route.id;
        });

        const revenue = routeTickets.reduce((sum, ticket) => {
          return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        }, 0);

        return {
          ...route,
          ticketCount: routeTickets.length,
          revenue: revenue,
          efficiency: Math.floor(Math.random() * 30) + 70, // Random for demo
          utilization: Math.floor(Math.random() * 40) + 60 // Random for demo
        };
      });

      // Update route summary
      document.getElementById('totalRoutesCount').textContent = routes.length;
      document.getElementById('activeRoutesCount').textContent = routes.filter(r => r.active).length;
      document.getElementById('avgRouteEfficiency').textContent = '78%';

      const topRoute = routeMetrics.reduce((max, route) => route.revenue > max.revenue ? route : max, routeMetrics[0] || { revenue: 0 });
      document.getElementById('topRouteRevenue').textContent = topRoute.revenue.toLocaleString() + ' FC';

      // Create route charts
      createRouteRevenueComparisonChart(routeMetrics);
      createRouteUtilizationChart(routeMetrics);

      // Display route table
      displayRouteReportsTable(routeMetrics);

      hideLoading();
      showNotification('Route reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading route reports:', error);
      showNotification('Error loading route reports', 'error');
      hideLoading();
    }
  }

  // Create route revenue comparison chart
  function createRouteRevenueComparisonChart(routes) {
    const ctx = document.getElementById('routeRevenueComparisonChart');
    if (!ctx) return;

    if (charts.routeRevenueComparison) {
      charts.routeRevenueComparison.destroy();
    }

    const sortedRoutes = routes
            .sort((a, b) => b.revenue - a.revenue)
            .slice(0, 8);

    charts.routeRevenueComparison = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sortedRoutes.map(route => route.routeName),
        datasets: [{
          label: 'Revenue (FC)',
          data: sortedRoutes.map(route => route.revenue),
          backgroundColor: 'rgba(220, 38, 38, 0.8)',
          borderColor: '#DC2626',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // Create route utilization chart
  function createRouteUtilizationChart(routes) {
    const ctx = document.getElementById('routeUtilizationChart');
    if (!ctx) return;

    if (charts.routeUtilization) {
      charts.routeUtilization.destroy();
    }

    const sortedRoutes = routes
            .sort((a, b) => b.utilization - a.utilization)
            .slice(0, 8);

    charts.routeUtilization = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sortedRoutes.map(route => route.routeName),
        datasets: [{
          label: 'Utilization %',
          data: sortedRoutes.map(route => route.utilization),
          borderColor: '#84CC16',
          backgroundColor: 'rgba(132, 204, 22, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });
  }

  // Display route reports table
  function displayRouteReportsTable(routes) {
    const tbody = document.getElementById('routeReportsTableBody');
    if (!tbody) return;

    if (routes.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-medium);">No routes found matching the criteria</td></tr>';
      return;
    }

    tbody.innerHTML = routes.map(route => {
      const status = route.active ? 'Active' : 'Inactive';

      return `
                <tr>
                    <td>${route.routeCode}</td>
                    <td>${route.routeName}</td>
                    <td>${route.routeType}</td>
                    <td>${route.totalDistance || 'N/A'}</td>
                    <td>${route.revenue.toLocaleString()} FC</td>
                    <td>${route.ticketCount}</td>
                    <td>${route.efficiency}%</td>
                    <td><span class="status-badge ${getStatusClass(status.toLowerCase())}">${status}</span></td>
                </tr>
            `;
    }).join('');
  }

  // Load equipment reports
  async function loadEquipmentReports() {
    try {
      showLoading();

      const status = document.getElementById('equipmentReportStatus').value;
      const location = document.getElementById('equipmentReportLocation').value;

      const equipment = await fetchData('/equipments');

      // Filter equipment
      let filteredEquipment = equipment;
      if (status !== 'all') {
        filteredEquipment = equipment.filter(item => item.status === status);
      }
      if (location !== 'all') {
        filteredEquipment = filteredEquipment.filter(item => item.location === location);
      }

      // Update equipment summary
      document.getElementById('totalEquipmentCount').textContent = equipment.length;
      document.getElementById('operationalEquipmentCount').textContent = equipment.filter(e => e.status === 'OPERATIONAL').length;
      document.getElementById('maintenanceEquipmentCount').textContent = equipment.filter(e => e.status === 'MAINTENANCE').length;
      document.getElementById('avgEquipmentReliability').textContent = '85%';

      // Create equipment charts
      createEquipmentStatusChart(equipment);
      createEquipmentReliabilityChart(filteredEquipment);

      // Display equipment table
      displayEquipmentReportsTable(filteredEquipment);

      hideLoading();
      showNotification('Equipment reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading equipment reports:', error);
      showNotification('Error loading equipment reports', 'error');
      hideLoading();
    }
  }

  // Create equipment status chart
  function createEquipmentStatusChart(equipment) {
    const ctx = document.getElementById('equipmentStatusChart');
    if (!ctx) return;

    if (charts.equipmentStatus) {
      charts.equipmentStatus.destroy();
    }

    const statusDistribution = {};
    equipment.forEach(item => {
      statusDistribution[item.status] = (statusDistribution[item.status] || 0) + 1;
    });

    charts.equipmentStatus = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(statusDistribution),
        datasets: [{
          data: Object.values(statusDistribution),
          backgroundColor: ['#10B981', '#F59E0B', '#DC2626'],
          borderWidth: 3,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Create equipment reliability chart
  function createEquipmentReliabilityChart(equipment) {
    const ctx = document.getElementById('equipmentReliabilityChart');
    if (!ctx) return;

    if (charts.equipmentReliability) {
      charts.equipmentReliability.destroy();
    }

    const last12Months = [];
    const reliabilityData = [];
    const today = new Date();

    for (let i = 11; i >= 0; i--) {
      const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
      last12Months.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
      reliabilityData.push(Math.floor(Math.random() * 20) + 75); // Random for demo
    }

    charts.equipmentReliability = new Chart(ctx, {
      type: 'line',
      data: {
        labels: last12Months,
        datasets: [{
          label: 'Reliability %',
          data: reliabilityData,
          borderColor: '#F97316',
          backgroundColor: 'rgba(249, 115, 22, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            min: 60,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });
  }

  // Display equipment reports table
  function displayEquipmentReportsTable(equipment) {
    const tbody = document.getElementById('equipmentReportsTableBody');
    if (!tbody) return;

    if (equipment.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-medium);">No equipment found matching the criteria</td></tr>';
      return;
    }

    tbody.innerHTML = equipment.map(item => {
      const reliability = Math.floor(Math.random() * 30) + 70; // Random for demo
      const lastMaintenance = new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toLocaleDateString();
      const nextService = new Date(Date.now() + Math.random() * 60 * 24 * 60 * 60 * 1000).toLocaleDateString();

      return `
                <tr>
                    <td>${item.equipmentId}</td>
                    <td>${item.name}</td>
                    <td>${item.model}</td>
                    <td>${item.location}</td>
                    <td><span class="status-badge ${getStatusClass(item.status.toLowerCase())}">${item.status}</span></td>
                    <td>${reliability}%</td>
                    <td>${lastMaintenance}</td>
                    <td>${nextService}</td>
                </tr>
            `;
    }).join('');
  }

  // Load emergency reports
  async function loadEmergencyReports() {
    try {
      showLoading();

      const type = document.getElementById('emergencyReportType').value;
      const severity = document.getElementById('emergencyReportSeverity').value;

      const emergencyReports = await fetchData('/emergency-reports');

      // Filter emergency reports
      let filteredReports = emergencyReports;
      if (type !== 'all') {
        filteredReports = emergencyReports.filter(report => report.type === type);
      }
      if (severity !== 'all') {
        filteredReports = filteredReports.filter(report => report.severity === severity);
      }

      // Update emergency summary
      document.getElementById('totalEmergencyCount').textContent = emergencyReports.length;
      document.getElementById('resolvedEmergencyCount').textContent = emergencyReports.filter(r => r.status === 'RESOLVED').length;
      document.getElementById('pendingEmergencyCount').textContent = emergencyReports.filter(r => r.status === 'PENDING').length;
      document.getElementById('avgResponseTime').textContent = '15 min';

      // Create emergency charts
      createEmergencyTypesChart(emergencyReports);
      createEmergencyResponseChart(emergencyReports);

      // Display emergency table
      displayEmergencyReportsTable(filteredReports);

      hideLoading();
      showNotification('Emergency reports loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading emergency reports:', error);
      showNotification('Error loading emergency reports', 'error');
      hideLoading();
    }
  }

  // Create emergency types chart
  function createEmergencyTypesChart(reports) {
    const ctx = document.getElementById('emergencyTypesChart');
    if (!ctx) return;

    if (charts.emergencyTypes) {
      charts.emergencyTypes.destroy();
    }

    const typeDistribution = {};
    reports.forEach(report => {
      typeDistribution[report.type] = (typeDistribution[report.type] || 0) + 1;
    });

    charts.emergencyTypes = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(typeDistribution),
        datasets: [{
          data: Object.values(typeDistribution),
          backgroundColor: [
            '#DC2626', '#F59E0B', '#10B981', '#1E40AF', '#8B5CF6'
          ],
          borderWidth: 3,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Create emergency response chart
  function createEmergencyResponseChart(reports) {
    const ctx = document.getElementById('emergencyResponseChart');
    if (!ctx) return;

    if (charts.emergencyResponse) {
      charts.emergencyResponse.destroy();
    }

    const last30Days = [];
    const responseData = [];
    const today = new Date();

    for (let i = 29; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      responseData.push(Math.floor(Math.random() * 30) + 5); // Random response times for demo
    }

    charts.emergencyResponse = new Chart(ctx, {
      type: 'line',
      data: {
        labels: last30Days,
        datasets: [{
          label: 'Response Time (min)',
          data: responseData,
          borderColor: '#DC2626',
          backgroundColor: 'rgba(220, 38, 38, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value + ' min';
              }
            }
          }
        }
      }
    });
  }

  // Display emergency reports table
  function displayEmergencyReportsTable(reports) {
    const tbody = document.getElementById('emergencyReportsTableBody');
    if (!tbody) return;

    if (reports.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--gray-medium);">No emergency reports found matching the criteria</td></tr>';
      return;
    }

    tbody.innerHTML = reports.map(report => {
      const driverName = report.driver ? `${report.driver.firstName} ${report.driver.lastName}` : 'N/A';
      const reportTime = new Date(report.createdAt).toLocaleString();
      const responseTime = Math.floor(Math.random() * 30) + 5 + ' min'; // Random for demo

      return `
                <tr>
                    <td>${report.id}</td>
                    <td>${report.type}</td>
                    <td><span class="status-badge ${getSeverityClass(report.severity.toLowerCase())}">${report.severity}</span></td>
                    <td>${report.location}</td>
                    <td>${driverName}</td>
                    <td><span class="status-badge ${getStatusClass(report.status.toLowerCase())}">${report.status}</span></td>
                    <td>${reportTime}</td>
                    <td>${responseTime}</td>
                </tr>
            `;
    }).join('');
  }

  // Load analytics
  async function loadAnalytics() {
    try {
      showLoading();

      const period = document.getElementById('analyticsPeriod').value;
      const metrics = document.getElementById('analyticsMetrics').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Update analytics summary
      document.getElementById('totalGrowthRate').textContent = '+18%';
      document.getElementById('operationalEfficiencyRate').textContent = '87%';
      document.getElementById('customerSatisfactionRate').textContent = '92%';

      const predictedRevenue = tickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0) * 1.15; // 15% growth prediction
      document.getElementById('predictedRevenue').textContent = Math.round(predictedRevenue).toLocaleString() + ' FC';

      // Create analytics charts
      createRevenueTrendsChart(tickets);
      createOperationalEfficiencyChart(buses);
      createCustomerSatisfactionChart();
      createPredictiveAnalyticsChart(tickets);

      hideLoading();
      showNotification('Analytics loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading analytics:', error);
      showNotification('Error loading analytics', 'error');
      hideLoading();
    }
  }

  // Create revenue trends chart
  function createRevenueTrendsChart(tickets) {
    const ctx = document.getElementById('revenueTrendsChart');
    if (!ctx) return;

    if (charts.revenueTrends) {
      charts.revenueTrends.destroy();
    }

    const last12Months = [];
    const revenueData = [];
    const today = new Date();

    for (let i = 11; i >= 0; i--) {
      const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
      last12Months.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));

      const monthTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getMonth() === date.getMonth() &&
                ticketDate.getFullYear() === date.getFullYear();
      });

      const monthRevenue = monthTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      revenueData.push(monthRevenue);
    }

    charts.revenueTrends = new Chart(ctx, {
      type: 'line',
      data: {
        labels: last12Months,
        datasets: [{
          label: 'Revenue (FC)',
          data: revenueData,
          borderColor: '#1E40AF',
          backgroundColor: 'rgba(30, 64, 175, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // Create operational efficiency chart
  function createOperationalEfficiencyChart(buses) {
    const ctx = document.getElementById('operationalEfficiencyChart');
    if (!ctx) return;

    if (charts.operationalEfficiency) {
      charts.operationalEfficiency.destroy();
    }

    const efficiencyData = [];
    const labels = [];
    const today = new Date();

    for (let i = 6; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

      // Calculate efficiency based on active buses
      const activeBuses = buses.filter(bus => !bus.isStopped && !bus.hasAccident).length;
      const totalBuses = buses.length;
      const efficiency = totalBuses > 0 ? (activeBuses / totalBuses) * 100 : 0;
      efficiencyData.push(efficiency + (Math.random() * 10 - 5)); // Add some variation
    }

    charts.operationalEfficiency = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Efficiency %',
          data: efficiencyData,
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: '#10B981',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });
  }

  // Create customer satisfaction chart
  function createCustomerSatisfactionChart() {
    const ctx = document.getElementById('customerSatisfactionChart');
    if (!ctx) return;

    if (charts.customerSatisfaction) {
      charts.customerSatisfaction.destroy();
    }

    const satisfactionData = [92, 88, 94, 90, 93, 89, 95]; // Sample data
    const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    charts.customerSatisfaction = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Satisfaction %',
          data: satisfactionData,
          borderColor: '#F59E0B',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            min: 80,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });
  }

  // Create predictive analytics chart
  function createPredictiveAnalyticsChart(tickets) {
    const ctx = document.getElementById('predictiveAnalyticsChart');
    if (!ctx) return;

    if (charts.predictiveAnalytics) {
      charts.predictiveAnalytics.destroy();
    }

    const next6Months = [];
    const predictedData = [];
    const today = new Date();

    // Historical data (last 6 months)
    const historicalData = [];
    for (let i = 5; i >= 0; i--) {
      const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
      next6Months.push(date.toLocaleDateString('en-US', { month: 'short' }));

      const monthTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getMonth() === date.getMonth() &&
                ticketDate.getFullYear() === date.getFullYear();
      });

      const monthRevenue = monthTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      historicalData.push(monthRevenue);
    }

    // Predicted data (next 6 months)
    const avgGrowth = 1.15; // 15% growth
    let lastValue = historicalData[historicalData.length - 1] || 100000;
    for (let i = 1; i <= 6; i++) {
      const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
      next6Months.push(date.toLocaleDateString('en-US', { month: 'short' }));
      lastValue = lastValue * avgGrowth * (0.95 + Math.random() * 0.1); // Add some variation
      predictedData.push(lastValue);
    }

    charts.predictiveAnalytics = new Chart(ctx, {
      type: 'line',
      data: {
        labels: next6Months,
        datasets: [{
          label: 'Historical Revenue',
          data: [...historicalData, ...Array(6).fill(null)],
          borderColor: '#1E40AF',
          backgroundColor: 'rgba(30, 64, 175, 0.1)',
          borderWidth: 3,
          fill: false
        }, {
          label: 'Predicted Revenue',
          data: [...Array(6).fill(null), ...predictedData],
          borderColor: '#DC2626',
          backgroundColor: 'rgba(220, 38, 38, 0.1)',
          borderWidth: 3,
          borderDash: [5, 5],
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FC';
              }
            }
          }
        }
      }
    });
  }

  // PDF Report Generation Functions (UPDATED WITH NEW PERIODIC REPORT CONTENT)
  async function generateDailyReport() {
    try {
      showLoading();

      const selectedDate = document.getElementById('dailyReportDate').value || new Date().toISOString().split('T')[0];
      const reportType = document.getElementById('dailyReportType').value || 'all';

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter data for selected date
      const selectedDateObj = new Date(selectedDate);
      const filteredTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.toDateString() === selectedDateObj.toDateString();
      });

      await generatePDFReport('Daily Operations Report', selectedDate, {
        buses,
        tickets: filteredTickets,
        staff,
        routes,
        reportType
      });

      hideLoading();
      showNotification('Daily report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating daily report:', error);
      showNotification('Error generating daily report', 'error');
      hideLoading();
    }
  }

  async function generateWeeklyReport() {
    try {
      showLoading();

      const startDate = document.getElementById('weeklyReportStartDate').value;
      const endDate = document.getElementById('weeklyReportEndDate').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter tickets for the week
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      const weekTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      await generatePDFReport('Weekly Performance Report', `${startDate} to ${endDate}`, {
        buses,
        tickets: weekTickets,
        staff,
        routes,
        reportType: 'weekly'
      });

      hideLoading();
      showNotification('Weekly report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating weekly report:', error);
      showNotification('Error generating weekly report', 'error');
      hideLoading();
    }
  }

  async function generateMonthlyReport() {
    try {
      showLoading();

      const selectedMonth = document.getElementById('monthlyReportMonth').value;
      const category = document.getElementById('monthlyReportCategory').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter tickets for selected month
      const [year, month] = selectedMonth.split('-');
      const monthTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == year && ticketDate.getMonth() == (month - 1);
      });

      await generatePDFReport('Monthly Analytics Report', selectedMonth, {
        buses,
        tickets: monthTickets,
        staff,
        routes,
        reportType: 'monthly',
        category
      });

      hideLoading();
      showNotification('Monthly report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating monthly report:', error);
      showNotification('Error generating monthly report', 'error');
      hideLoading();
    }
  }

  async function generateYearlyReport() {
    try {
      showLoading();

      const selectedYear = document.getElementById('yearlyReportYear').value;

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter tickets for selected year
      const yearTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == selectedYear;
      });

      await generatePDFReport('Annual Summary Report', selectedYear, {
        buses,
        tickets: yearTickets,
        staff,
        routes,
        reportType: 'yearly'
      });

      hideLoading();
      showNotification('Yearly report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating yearly report:', error);
      showNotification('Error generating yearly report', 'error');
      hideLoading();
    }
  }

  async function generateBusReport() {
    try {
      showLoading();

      const [buses, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/routes')
      ]);

      await generatePDFReport('Bus Fleet Report', new Date().toLocaleDateString(), {
        buses,
        routes,
        reportType: 'bus'
      });

      hideLoading();
      showNotification('Bus report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating bus report:', error);
      showNotification('Error generating bus report', 'error');
      hideLoading();
    }
  }

  async function generateTicketReport() {
    try {
      showLoading();

      const startDate = document.getElementById('ticketReportStartDate').value;
      const endDate = document.getElementById('ticketReportEndDate').value;
      const status = document.getElementById('ticketReportStatus').value;

      const tickets = await fetchData('/tickets');

      // Filter tickets
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      let filteredTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      if (status !== 'all') {
        filteredTickets = filteredTickets.filter(ticket => ticket.status === status);
      }

      await generatePDFReport('Ticket Sales Report', `${startDate} to ${endDate}`, {
        tickets: filteredTickets,
        reportType: 'ticket'
      });

      hideLoading();
      showNotification('Ticket report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating ticket report:', error);
      showNotification('Error generating ticket report', 'error');
      hideLoading();
    }
  }

  async function generatePassengerReport() {
    try {
      showLoading();

      const analysisType = document.getElementById('passengerAnalysisType').value;
      const timePeriod = document.getElementById('passengerTimePeriod').value;

      const tickets = await fetchData('/tickets');

      await generatePDFReport('Passenger Analytics Report', new Date().toLocaleDateString(), {
        tickets,
        reportType: 'passenger',
        analysisType,
        timePeriod
      });

      hideLoading();
      showNotification('Passenger report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating passenger report:', error);
      showNotification('Error generating passenger report', 'error');
      hideLoading();
    }
  }

  async function generateStaffReport() {
    try {
      showLoading();

      const role = document.getElementById('staffReportRole').value;
      const status = document.getElementById('staffReportStatus').value;

      const staff = await fetchData('/staff');

      // Filter staff
      let filteredStaff = staff;
      if (role !== 'all') {
        filteredStaff = staff.filter(member => member.role === role);
      }
      if (status !== 'all') {
        filteredStaff = filteredStaff.filter(member => {
          return status === 'active' ? member.active : !member.active;
        });
      }

      await generatePDFReport('Staff Performance Report', new Date().toLocaleDateString(), {
        staff: filteredStaff,
        reportType: 'staff',
        role,
        status
      });

      hideLoading();
      showNotification('Staff report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating staff report:', error);
      showNotification('Error generating staff report', 'error');
      hideLoading();
    }
  }

  async function generateRouteReport() {
    try {
      showLoading();

      const [routes, tickets] = await Promise.all([
        fetchData('/routes'),
        fetchData('/tickets')
      ]);

      await generatePDFReport('Route Performance Report', new Date().toLocaleDateString(), {
        routes,
        tickets,
        reportType: 'route'
      });

      hideLoading();
      showNotification('Route report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating route report:', error);
      showNotification('Error generating route report', 'error');
      hideLoading();
    }
  }

  async function generateEquipmentReport() {
    try {
      showLoading();

      const equipment = await fetchData('/equipments');

      await generatePDFReport('Equipment Report', new Date().toLocaleDateString(), {
        equipment,
        reportType: 'equipment'
      });

      hideLoading();
      showNotification('Equipment report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating equipment report:', error);
      showNotification('Error generating equipment report', 'error');
      hideLoading();
    }
  }

  async function generateEmergencyReport() {
    try {
      showLoading();

      const emergencyReports = await fetchData('/emergency-reports');

      await generatePDFReport('Emergency Reports', new Date().toLocaleDateString(), {
        emergencyReports,
        reportType: 'emergency'
      });

      hideLoading();
      showNotification('Emergency report generated successfully!', 'success');
    } catch (error) {
      console.error('Error generating emergency report:', error);
      showNotification('Error generating emergency report', 'error');
      hideLoading();
    }
  }
  // Helper function to add table with S/N column
  function addTableWithSN(doc, headers, data, startY, options = {}) {
    const {
      columnWidths = [],
      fontSize = 10,
      headerColor = [70, 130, 180],
      alternateRowColor = [240, 240, 240]
    } = options;

    // Add S/N to headers at the beginning
    const headersWithSN = ['S/N', ...headers];

    // Calculate column widths including S/N column
    const snWidth = 15; // Width for S/N column
    let colWidths = [snWidth];

    if (columnWidths.length > 0) {
      colWidths = [snWidth, ...columnWidths];
    } else {
      // Auto-calculate widths if not provided
      const remainingWidth = 170 - snWidth;
      const colWidth = remainingWidth / headers.length;
      for (let i = 0; i < headers.length; i++) {
        colWidths.push(colWidth);
      }
    }

    let yPosition = startY;

    // Draw header row
    doc.setFillColor(...headerColor);
    doc.rect(20, yPosition, 170, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(fontSize);
    doc.setFont('helvetica', 'bold');

    let xPosition = 20;
    headersWithSN.forEach((header, index) => {
      doc.text(header, xPosition + 2, yPosition + 7);
      xPosition += colWidths[index];
    });

    yPosition += 10;

    // Draw data rows with S/N
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');

    data.forEach((row, rowIndex) => {
      // Check if we need a new page
      if (yPosition > 260) {
        doc.addPage();
        yPosition = 20;

        // Redraw headers on new page
        doc.setFillColor(...headerColor);
        doc.rect(20, yPosition, 170, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');

        xPosition = 20;
        headersWithSN.forEach((header, index) => {
          doc.text(header, xPosition + 2, yPosition + 7);
          xPosition += colWidths[index];
        });

        yPosition += 10;
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
      }

      // Alternate row colors
      if (rowIndex % 2 === 1) {
        doc.setFillColor(...alternateRowColor);
        doc.rect(20, yPosition, 170, 10, 'F');
      }

      // Draw row data with S/N
      xPosition = 20;

      // Add S/N (starting from 1)
      doc.text(String(rowIndex + 1), xPosition + 2, yPosition + 7);
      xPosition += colWidths[0];

      // Add other columns
      row.forEach((cell, cellIndex) => {
        const cellText = String(cell || '');
        // Truncate long text if necessary
        const maxWidth = colWidths[cellIndex + 1] - 4;
        let displayText = cellText;

        if (doc.getTextWidth(cellText) > maxWidth) {
          while (doc.getTextWidth(displayText + '...') > maxWidth && displayText.length > 0) {
            displayText = displayText.slice(0, -1);
          }
          displayText += '...';
        }

        doc.text(displayText, xPosition + 2, yPosition + 7);
        xPosition += colWidths[cellIndex + 1];
      });

      yPosition += 10;
    });

    // Draw table borders
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);

    // Vertical lines
    xPosition = 20;
    const tableHeight = (data.length + 1) * 10;
    const finalY = Math.min(startY + tableHeight, yPosition);

    colWidths.forEach(width => {
      doc.line(xPosition, startY, xPosition, finalY);
      xPosition += width;
    });
    doc.line(190, startY, 190, finalY);

    // Horizontal lines
    doc.line(20, startY, 190, startY);
    doc.line(20, finalY, 190, finalY);

    return yPosition + 10;
  }

  // Example usage for Daily Report
  async function generateDailyReportContent(doc, data, startY) {
    let yPosition = startY;

    // Section title
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('DAILY OPERATIONS SUMMARY', 20, yPosition);
    yPosition += 15;

    // Key metrics
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');

    const metrics = [
      ['Total Buses Operating:', data.totalBuses || '0'],
      ['Total Passengers:', data.totalPassengers || '0'],
      ['Total Revenue:', `$${data.totalRevenue || '0.00'}`],
      ['Active Routes:', data.activeRoutes || '0'],
      ['Incidents Reported:', data.incidents || '0']
    ];

    metrics.forEach(([label, value]) => {
      doc.setFont('helvetica', 'bold');
      doc.text(label, 20, yPosition);
      doc.setFont('helvetica', 'normal');
      doc.text(value, 80, yPosition);
      yPosition += 8;
    });

    yPosition += 10;

    // Bus Performance Table with S/N
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('BUS PERFORMANCE DETAILS', 20, yPosition);
    yPosition += 10;

    const busHeaders = ['Bus ID', 'Route', 'Trips', 'Passengers', 'Revenue'];
    const busData = data.busPerformance || [
      ['BUS-001', 'Route A', '12', '245', '$490.00'],
      ['BUS-002', 'Route B', '10', '198', '$396.00'],
      ['BUS-003', 'Route C', '11', '220', '$440.00'],
      ['BUS-004', 'Route D', '9', '180', '$360.00'],
      ['BUS-005', 'Route E', '13', '260', '$520.00']
    ];

    yPosition = addTableWithSN(doc, busHeaders, busData, yPosition, {
      columnWidths: [25, 35, 25, 35, 35] // Adjusted for S/N column
    });

    yPosition += 10;

    // Route Statistics Table with S/N
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('ROUTE STATISTICS', 20, yPosition);
    yPosition += 10;

    const routeHeaders = ['Route Name', 'Total Trips', 'Avg Passengers', 'Occupancy Rate'];
    const routeData = data.routeStats || [
      ['Downtown - Airport', '45', '32', '85%'],
      ['Central - University', '38', '28', '75%'],
      ['North - South Express', '42', '35', '92%'],
      ['East - West Corridor', '40', '30', '80%']
    ];

    yPosition = addTableWithSN(doc, routeHeaders, routeData, yPosition, {
      columnWidths: [50, 35, 40, 30]
    });

    return yPosition;
  }

  // Example usage for Weekly Report
  async function generateWeeklyReportContent(doc, data, startY) {
    let yPosition = startY;

    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('WEEKLY PERFORMANCE ANALYSIS', 20, yPosition);
    yPosition += 15;

    // Weekly summary
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);

    const weeklyMetrics = [
      ['Week Period:', data.weekPeriod || 'Week 1-7'],
      ['Total Operating Days:', data.operatingDays || '7'],
      ['Total Passengers Served:', data.totalPassengers || '8,450'],
      ['Weekly Revenue:', `$${data.weeklyRevenue || '16,900.00'}`],
      ['Average Daily Passengers:', data.avgDailyPassengers || '1,207']
    ];

    weeklyMetrics.forEach(([label, value]) => {
      doc.setFont('helvetica', 'bold');
      doc.text(label, 20, yPosition);
      doc.setFont('helvetica', 'normal');
      doc.text(value, 85, yPosition);
      yPosition += 8;
    });

    yPosition += 10;

    // Daily Breakdown Table with S/N
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('DAILY BREAKDOWN', 20, yPosition);
    yPosition += 10;

    const dailyHeaders = ['Day', 'Date', 'Buses Active', 'Passengers', 'Revenue', 'Incidents'];
    const dailyData = data.dailyBreakdown || [
      ['Monday', '2024-01-01', '25', '1,250', '$2,500.00', '0'],
      ['Tuesday', '2024-01-02', '25', '1,180', '$2,360.00', '1'],
      ['Wednesday', '2024-01-03', '24', '1,220', '$2,440.00', '0'],
      ['Thursday', '2024-01-04', '25', '1,300', '$2,600.00', '0'],
      ['Friday', '2024-01-05', '25', '1,350', '$2,700.00', '2'],
      ['Saturday', '2024-01-06', '20', '1,100', '$2,200.00', '0'],
      ['Sunday', '2024-01-07', '18', '1,050', '$2,100.00', '0']
    ];

    yPosition = addTableWithSN(doc, dailyHeaders, dailyData, yPosition, {
      columnWidths: [25, 30, 25, 30, 30, 15]
    });

    return yPosition;
  }

  // Example usage for Bus Report
  async function generateBusReportContent(doc, data, startY) {
    let yPosition = startY;

    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('BUS FLEET REPORT', 20, yPosition);
    yPosition += 15;

    // Fleet Summary
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);

    const fleetMetrics = [
      ['Total Buses in Fleet:', data.totalFleet || '30'],
      ['Active Buses:', data.activeBuses || '25'],
      ['Under Maintenance:', data.maintenance || '3'],
      ['Out of Service:', data.outOfService || '2'],
      ['Average Fleet Age:', data.avgAge || '3.5 years']
    ];

    fleetMetrics.forEach(([label, value]) => {
      doc.setFont('helvetica', 'bold');
      doc.text(label, 20, yPosition);
      doc.setFont('helvetica', 'normal');
      doc.text(value, 80, yPosition);
      yPosition += 8;
    });

    yPosition += 10;

    // Bus Details Table with S/N
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('BUS FLEET DETAILS', 20, yPosition);
    yPosition += 10;

    const busHeaders = ['Bus ID', 'Model', 'Status', 'Last Service', 'Mileage', 'Driver'];
    const busData = data.busDetails || [
      ['BUS-001', 'Mercedes Citaro', 'Active', '2024-01-15', '45,230 km', 'John Doe'],
      ['BUS-002', 'Volvo 7900', 'Active', '2024-01-10', '38,450 km', 'Jane Smith'],
      ['BUS-003', 'BYD K9', 'Maintenance', '2024-01-20', '52,100 km', 'N/A'],
      ['BUS-004', 'Mercedes Citaro', 'Active', '2024-01-12', '41,800 km', 'Bob Johnson'],
      ['BUS-005', 'Volvo 7900', 'Active', '2024-01-18', '39,200 km', 'Alice Brown'],
      ['BUS-006', 'BYD K9', 'Out of Service', '2023-12-28', '61,500 km', 'N/A'],
      ['BUS-007', 'Mercedes Citaro', 'Active', '2024-01-14', '43,600 km', 'Charlie Wilson'],
      ['BUS-008', 'Volvo 7900', 'Active', '2024-01-16', '40,300 km', 'Diana Martinez']
    ];

    yPosition = addTableWithSN(doc, busHeaders, busData, yPosition, {
      columnWidths: [20, 35, 25, 25, 25, 25]
    });

    return yPosition;
  }

  // You can apply the same pattern to all other report types
  // The addTableWithSN function will automatically add S/N column to any table

  // Main PDF generation function with logo
  async function generatePDFReport(title, period, data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    try {
      // Load and add logo (circular logo)
      const logoImg = await loadImage('images/logoImas.jpg');
      if (logoImg) {
        // Add circular logo on the left side
        doc.addImage(logoImg, 'PNG', 20, 20, 25, 25);
      }
    } catch (error) {
      console.warn('Could not load logo:', error);
    }

    // Header with company name and details - CENTERED
    doc.setTextColor(70, 130, 180); // Blue color similar to DEP
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');

    // Center the main title
    const pageWidth = doc.internal.pageSize.getWidth();
    const titleText = 'INTELLIGENT MOBILITY ASSISTANCE SYSTEM';
    const titleWidth = doc.getTextWidth(titleText);
    const titleX = (pageWidth - titleWidth) / 2;
    doc.text(titleText, titleX, 25);

    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');

    // Center the subtitle (IMAS)
    const subtitleText = '(IMAS)';
    const subtitleWidth = doc.getTextWidth(subtitleText);
    const subtitleX = (pageWidth - subtitleWidth) / 2;
    doc.text(subtitleText, subtitleX, 35);

    // Contact information
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text('Email: info@imas.cd', 55, 42);
    doc.text('Phone: +250 791 434 027 | +243 895 485 491', 55, 48);

    // Blue line separator (like in DEP document)
    doc.setDrawColor(70, 130, 180);
    doc.setLineWidth(2);
    doc.line(20, 55, 190, 55);

    // Report title section
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text(title.toUpperCase(), 20, 70);

    // Period and details
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Period: ${period}`, 20, 80);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 87);

    let yPosition = 100;

    // Generate content based on report type
    switch(data.reportType) {
      case 'daily':
        yPosition = await generateDailyReportContent(doc, data, yPosition);
        break;
      case 'weekly':
        yPosition = await generateWeeklyReportContent(doc, data, yPosition);
        break;
      case 'monthly':
        yPosition = await generateMonthlyReportContent(doc, data, yPosition);
        break;
      case 'yearly':
        yPosition = await generateYearlyReportContent(doc, data, yPosition);
        break;
      case 'yearly-periodic':
        yPosition = await generateYearlyPeriodicReportContent(doc, data, yPosition);
        break;
      case 'monthly-periodic':
        yPosition = await generateMonthlyPeriodicReportContent(doc, data, yPosition);
        break;
      case 'bus':
        yPosition = await generateBusReportContent(doc, data, yPosition);
        break;
      case 'ticket':
        yPosition = await generateTicketReportContent(doc, data, yPosition);
        break;
      case 'passenger':
        yPosition = await generatePassengerReportContent(doc, data, yPosition);
        break;
      case 'staff':
        yPosition = await generateStaffReportContent(doc, data, yPosition);
        break;
      case 'route':
        yPosition = await generateRouteReportContent(doc, data, yPosition);
        break;
      case 'equipment':
        yPosition = await generateEquipmentReportContent(doc, data, yPosition);
        break;
      case 'emergency':
        yPosition = await generateEmergencyReportContent(doc, data, yPosition);
        break;
      default:
        yPosition = await generateDefaultReportContent(doc, data, yPosition);
    }

    // Footer (similar to DEP style)
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);

    // Blue line separator at bottom
    doc.setDrawColor(70, 130, 180);
    doc.setLineWidth(1);
    doc.line(20, 270, 190, 270);

    // Footer content
    doc.text('INTELLIGENT MOBILITY ASSISTANCE SYSTEM (IMAS)', 20, 278);
    doc.text('Kigali, Rwanda | Avenue de la Paix, KN 4 Ave, Kigali', 20, 285);
    doc.text('info@imas.cd | +250 791 434 027 | +243 895 485 491', 20, 292);
    doc.text(`Generated on ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 140, 292);

    // Save the PDF
    const fileName = `IMAS_${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
  }

  // Helper function to load image
  function loadImage(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL('image/png'));
      };
      img.onerror = reject;
      img.src = src;
    });
  }

  // Helper function to add table with S/N column
  function addTableWithSN(doc, headers, data, startY, options = {}) {
    const {
      columnWidths = [],
      fontSize = 10,
      headerColor = [70, 130, 180],
      alternateRowColor = [240, 240, 240]
    } = options;

    // Add S/N to headers at the beginning
    const headersWithSN = ['S/N', ...headers];

    // Calculate column widths including S/N column
    const snWidth = 15; // Width for S/N column
    let colWidths = [snWidth];

    if (columnWidths.length > 0) {
      colWidths = [snWidth, ...columnWidths];
    } else {
      // Auto-calculate widths if not provided
      const remainingWidth = 170 - snWidth;
      const colWidth = remainingWidth / headers.length;
      for (let i = 0; i < headers.length; i++) {
        colWidths.push(colWidth);
      }
    }

    let yPosition = startY;

    // Draw header row
    doc.setFillColor(...headerColor);
    doc.rect(20, yPosition, 170, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(fontSize);
    doc.setFont('helvetica', 'bold');

    let xPosition = 20;
    headersWithSN.forEach((header, index) => {
      doc.text(header, xPosition + 2, yPosition + 7);
      xPosition += colWidths[index];
    });

    yPosition += 10;

    // Draw data rows with S/N
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');

    data.forEach((row, rowIndex) => {
      // Check if we need a new page
      if (yPosition > 260) {
        doc.addPage();
        yPosition = 20;

        // Redraw headers on new page
        doc.setFillColor(...headerColor);
        doc.rect(20, yPosition, 170, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');

        xPosition = 20;
        headersWithSN.forEach((header, index) => {
          doc.text(header, xPosition + 2, yPosition + 7);
          xPosition += colWidths[index];
        });

        yPosition += 10;
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
      }

      // Alternate row colors
      if (rowIndex % 2 === 1) {
        doc.setFillColor(...alternateRowColor);
        doc.rect(20, yPosition, 170, 10, 'F');
      }

      // Draw row data with S/N
      xPosition = 20;

      // Add S/N (starting from 1)
      doc.text(String(rowIndex + 1), xPosition + 2, yPosition + 7);
      xPosition += colWidths[0];

      // Add other columns
      row.forEach((cell, cellIndex) => {
        const cellText = String(cell || '');
        // Truncate long text if necessary
        const maxWidth = colWidths[cellIndex + 1] - 4;
        let displayText = cellText;

        if (doc.getTextWidth(cellText) > maxWidth) {
          while (doc.getTextWidth(displayText + '...') > maxWidth && displayText.length > 0) {
            displayText = displayText.slice(0, -1);
          }
          displayText += '...';
        }

        doc.text(displayText, xPosition + 2, yPosition + 7);
        xPosition += colWidths[cellIndex + 1];
      });

      yPosition += 10;
    });

    // Draw table borders
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);

    // Vertical lines
    xPosition = 20;
    const tableHeight = (data.length + 1) * 10;
    const finalY = Math.min(startY + tableHeight, yPosition);

    colWidths.forEach(width => {
      doc.line(xPosition, startY, xPosition, finalY);
      xPosition += width;
    });
    doc.line(190, startY, 190, finalY);

    // Horizontal lines
    doc.line(20, startY, 190, startY);
    doc.line(20, finalY, 190, finalY);

    return yPosition + 10;
  }

  // ============================================
  // YOUR EXISTING MAIN FUNCTION (keep as is)
  // ============================================

  async function generatePDFReport(title, period, data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    try {
      // Load and add logo (circular logo)
      const logoImg = await loadImage('images/logoImas.jpg');
      if (logoImg) {
        // Add circular logo on the left side
        doc.addImage(logoImg, 'PNG', 20, 20, 25, 25);
      }
    } catch (error) {
      console.warn('Could not load logo:', error);
    }

    // Header with company name and details - CENTERED
    doc.setTextColor(70, 130, 180); // Blue color similar to DEP
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');

    // Center the main title
    const pageWidth = doc.internal.pageSize.getWidth();
    const titleText = 'INTELLIGENT MOBILITY ASSISTANCE SYSTEM';
    const titleWidth = doc.getTextWidth(titleText);
    const titleX = (pageWidth - titleWidth) / 2;
    doc.text(titleText, titleX, 25);

    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');

    // Center the subtitle (IMAS)
    const subtitleText = '(IMAS)';
    const subtitleWidth = doc.getTextWidth(subtitleText);
    const subtitleX = (pageWidth - subtitleWidth) / 2;
    doc.text(subtitleText, subtitleX, 35);

    // Contact information
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text('Email: info@imas.cd', 55, 42);
    doc.text('Phone: +250 791 434 027 | +243 895 485 491', 55, 48);

    // Blue line separator (like in DEP document)
    doc.setDrawColor(70, 130, 180);
    doc.setLineWidth(2);
    doc.line(20, 55, 190, 55);

    // Report title section
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text(title.toUpperCase(), 20, 70);

    // Period and details
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Period: ${period}`, 20, 80);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 87);

    let yPosition = 100;

    // Generate content based on report type
    switch(data.reportType) {
      case 'daily':
        yPosition = await generateDailyReportContent(doc, data, yPosition);
        break;
      case 'weekly':
        yPosition = await generateWeeklyReportContent(doc, data, yPosition);
        break;
      case 'monthly':
        yPosition = await generateMonthlyReportContent(doc, data, yPosition);
        break;
      case 'yearly':
        yPosition = await generateYearlyReportContent(doc, data, yPosition);
        break;
      case 'yearly-periodic':
        yPosition = await generateYearlyPeriodicReportContent(doc, data, yPosition);
        break;
      case 'monthly-periodic':
        yPosition = await generateMonthlyPeriodicReportContent(doc, data, yPosition);
        break;
      case 'bus':
        yPosition = await generateBusReportContent(doc, data, yPosition);
        break;
      case 'ticket':
        yPosition = await generateTicketReportContent(doc, data, yPosition);
        break;
      case 'passenger':
        yPosition = await generatePassengerReportContent(doc, data, yPosition);
        break;
      case 'staff':
        yPosition = await generateStaffReportContent(doc, data, yPosition);
        break;
      case 'route':
        yPosition = await generateRouteReportContent(doc, data, yPosition);
        break;
      case 'equipment':
        yPosition = await generateEquipmentReportContent(doc, data, yPosition);
        break;
      case 'emergency':
        yPosition = await generateEmergencyReportContent(doc, data, yPosition);
        break;
      default:
        yPosition = await generateDefaultReportContent(doc, data, yPosition);
    }

    // Footer (similar to DEP style)
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);

    // Blue line separator at bottom
    doc.setDrawColor(70, 130, 180);
    doc.setLineWidth(1);
    doc.line(20, 270, 190, 270);

    // Footer content
    doc.text('INTELLIGENT MOBILITY ASSISTANCE SYSTEM (IMAS)', 20, 278);
    doc.text('Kigali, Rwanda | Avenue de la Paix, KN 4 Ave, Kigali', 20, 285);
    doc.text('info@imas.cd | +250 791 434 027 | +243 895 485 491', 20, 292);
    doc.text(`Generated on ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 140, 292);

    // Save the PDF
    const fileName = `IMAS_${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
  }

  // ============================================
  // MODIFY YOUR EXISTING REPORT CONTENT FUNCTIONS
  // Replace or update each of these functions
  // ============================================

  // Example: Update your Daily Report function
  async function generateDailyReportContent(doc, data, startY) {
    let yPosition = startY;

    // Section title
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('DAILY OPERATIONS SUMMARY', 20, yPosition);
    yPosition += 15;

    // Key metrics
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');

    const metrics = [
      ['Total Buses Operating:', data.totalBuses || '0'],
      ['Total Passengers:', data.totalPassengers || '0'],
      ['Total Revenue:', `$${data.totalRevenue || '0.00'}`],
      ['Active Routes:', data.activeRoutes || '0'],
      ['Incidents Reported:', data.incidents || '0']
    ];

    metrics.forEach(([label, value]) => {
      doc.setFont('helvetica', 'bold');
      doc.text(label, 20, yPosition);
      doc.setFont('helvetica', 'normal');
      doc.text(value, 80, yPosition);
      yPosition += 8;
    });

    yPosition += 10;

    // ============================================
    // USING THE NEW addTableWithSN FUNCTION HERE
    // ============================================

    // Bus Performance Table with S/N
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('BUS PERFORMANCE DETAILS', 20, yPosition);
    yPosition += 10;

    const busHeaders = ['Bus ID', 'Route', 'Trips', 'Passengers', 'Revenue'];
    const busData = data.busPerformance || [
      ['BUS-001', 'Route A', '12', '245', '$490.00'],
      ['BUS-002', 'Route B', '10', '198', '$396.00'],
      ['BUS-003', 'Route C', '11', '220', '$440.00']
    ];

    // Call the new function with S/N
    yPosition = addTableWithSN(doc, busHeaders, busData, yPosition, {
      columnWidths: [25, 35, 25, 35, 35] // Adjusted for S/N column
    });

    return yPosition;
  }

  // Update your Weekly Report function similarly
  async function generateWeeklyReportContent(doc, data, startY) {
    let yPosition = startY;

    // ... your existing weekly report code ...

    // When creating tables, use addTableWithSN instead of your old table method
    const dailyHeaders = ['Day', 'Date', 'Buses Active', 'Passengers', 'Revenue'];
    const dailyData = data.dailyBreakdown || [
      ['Monday', '2024-01-01', '25', '1,250', '$2,500.00'],
      ['Tuesday', '2024-01-02', '25', '1,180', '$2,360.00']
    ];

    yPosition = addTableWithSN(doc, dailyHeaders, dailyData, yPosition, {
      columnWidths: [25, 30, 30, 35, 35]
    });

    return yPosition;
  }




  // Updated generateMonthlyPeriodicReportContent function with proper tables and S/N columns
  async function generateMonthlyPeriodicReportContent(doc, data, yPosition) {
    const { buses, tickets, staff, routes, startDate, endDate, analysisType } = data;

    // Monthly periodic summary
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('MONTHLY PERIODIC ANALYSIS', 20, yPosition);
    yPosition += 15;

    const periodRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const analysisDays = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24) + 1);

    // Summary section AS A TABLE WITH S/N
    const summaryHeaders = ['Period Analysis', 'Value', 'Performance'];
    const summaryTableData = [
      ['Analysis Period', `${startDate} to ${endDate}`, `${analysisDays} days`],
      ['Total Revenue', periodRevenue.toLocaleString() + ' FC', 'Excellent'],
      ['Total Tickets', tickets.length.toString(), 'Good'],
      ['Daily Average', Math.round(periodRevenue / analysisDays).toLocaleString() + ' FC', 'Strong']
    ];

    // Use addTableWithSN for the summary
    yPosition = addTableWithSN(doc, summaryHeaders, summaryTableData, yPosition, {
      columnWidths: [50, 50, 35]
    });

    yPosition += 10;

    // Daily breakdown for the period WITH S/N
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('DAILY BREAKDOWN FOR PERIOD', 20, yPosition);
    yPosition += 10;

    // Prepare daily data - INCLUDE ALL DAYS IN PERIOD
    const dailyData = {};
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    // Initialize all days in the period with zero values
    for (let d = new Date(startDate); d <= new Date(endDate); d.setDate(d.getDate() + 1)) {
      const dateStr = d.toISOString().split('T')[0]; // Use ISO format for consistency
      dailyData[dateStr] = {
        date: new Date(d),
        revenue: 0,
        tickets: 0,
        passengers: 0
      };
    }

    // Process tickets and accumulate data
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dateStr = ticketDate.toISOString().split('T')[0];

      // Only process if the date is within our period
      if (dailyData[dateStr]) {
        dailyData[dateStr].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        dailyData[dateStr].tickets++;
        dailyData[dateStr].passengers++;
      }
    });

    // Convert to array format for table - SHOW ALL DAYS, sorted by date
    const dailyTableData = Object.keys(dailyData)
            .sort() // Sort by date string
            .map(dateStr => {
              const dayData = dailyData[dateStr];
              const dayName = days[dayData.date.getDay()];
              const formattedDate = dayData.date.toLocaleDateString();

              return [
                formattedDate,
                dayName,
                dayData.revenue.toLocaleString() + ' FC',
                dayData.tickets.toString(),
                dayData.passengers.toString()
              ];
            });

    // If there's no data at all, create at least one row showing no activity
    if (dailyTableData.length === 0) {
      dailyTableData.push([
        new Date(startDate).toLocaleDateString(),
        days[new Date(startDate).getDay()],
        '0 FC',
        '0',
        '0'
      ]);
    }

    // Table headers
    const dailyHeaders = ['Date', 'Day', 'Revenue', 'Tickets', 'Passengers'];

    // Use addTableWithSN to create table with S/N column
    yPosition = addTableWithSN(doc, dailyHeaders, dailyTableData, yPosition, {
      columnWidths: [30, 22, 30, 20, 23]
    });

    return yPosition;
  }

  // Updated generateYearlyPeriodicReportContent with proper tables and S/N columns
  async function generateYearlyPeriodicReportContent(doc, data, yPosition) {
    const { buses, tickets, staff, routes, year, focus } = data;

    // Yearly periodic summary
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text(`YEARLY PERIODIC ANALYSIS - ${year}`, 20, yPosition);
    yPosition += 15;

    const yearlyRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    // Summary table WITH S/N
    const summaryHeaders = ['Metric', 'Value', 'Growth'];
    const summaryTableData = [
      ['Total Annual Revenue', yearlyRevenue.toLocaleString() + ' FC', '+28%'],
      ['Total Passengers', tickets.length.toString(), '+33%'],
      ['Active Routes', routes.filter(r => r.active).length.toString(), '+18%'],
      ['Fleet Efficiency', '87%', '+12%']
    ];

    // Use addTableWithSN for the summary
    yPosition = addTableWithSN(doc, summaryHeaders, summaryTableData, yPosition, {
      columnWidths: [60, 50, 25]
    });

    yPosition += 10;

    // Quarterly breakdown WITH S/N
    if (yPosition > 200) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('QUARTERLY BREAKDOWN', 20, yPosition);
    yPosition += 10;

    const quarters = [
      { name: 'Q1', period: 'Jan - Mar', months: [0, 1, 2] },
      { name: 'Q2', period: 'Apr - Jun', months: [3, 4, 5] },
      { name: 'Q3', period: 'Jul - Sep', months: [6, 7, 8] },
      { name: 'Q4', period: 'Oct - Dec', months: [9, 10, 11] }
    ];

    // Prepare quarterly data
    const quarterlyTableData = quarters.map(quarter => {
      const quarterTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return quarter.months.includes(ticketDate.getMonth());
      });

      const quarterRevenue = quarterTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      const growth = Math.floor(Math.random() * 30) + 5; // Random growth for demo

      return [
        quarter.name,
        quarter.period + ' ' + year,
        quarterRevenue.toLocaleString() + ' FC',
        quarterTickets.length.toString(),
        '+' + growth + '%'
      ];
    });

    const quarterlyHeaders = ['Quarter', 'Period', 'Revenue', 'Tickets', 'Growth %'];

    // Use addTableWithSN for quarterly breakdown
    yPosition = addTableWithSN(doc, quarterlyHeaders, quarterlyTableData, yPosition, {
      columnWidths: [20, 35, 35, 22, 23]
    });

    return yPosition + 10;
  }

  // Helper function to ensure addTableWithSN works properly
  function addTableWithSN(doc, headers, data, startY, options = {}) {
    const {
      columnWidths = [],
      fontSize = 10,
      headerColor = [70, 130, 180],
      alternateRowColor = [240, 240, 240]
    } = options;

    // Add S/N to headers at the beginning
    const headersWithSN = ['S/N', ...headers];

    // Calculate column widths including S/N column
    const snWidth = 15; // Width for S/N column
    let colWidths = [snWidth];

    if (columnWidths.length > 0) {
      colWidths = [snWidth, ...columnWidths];
    } else {
      // Auto-calculate widths if not provided
      const remainingWidth = 170 - snWidth;
      const colWidth = remainingWidth / headers.length;
      for (let i = 0; i < headers.length; i++) {
        colWidths.push(colWidth);
      }
    }

    let yPosition = startY;

    // Draw header row
    doc.setFillColor(...headerColor);
    doc.rect(20, yPosition, 170, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(fontSize);
    doc.setFont('helvetica', 'bold');

    let xPosition = 20;
    headersWithSN.forEach((header, index) => {
      doc.text(header, xPosition + 2, yPosition + 7);
      xPosition += colWidths[index];
    });

    yPosition += 10;

    // Draw data rows with S/N
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');

    // Handle empty data case
    if (!data || data.length === 0) {
      // Show "No data available" message
      doc.text('No data available for this period', 95, yPosition + 7);
      yPosition += 10;
    } else {
      data.forEach((row, rowIndex) => {
        // Check if we need a new page
        if (yPosition > 260) {
          doc.addPage();
          yPosition = 20;

          // Redraw headers on new page
          doc.setFillColor(...headerColor);
          doc.rect(20, yPosition, 170, 10, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFont('helvetica', 'bold');

          xPosition = 20;
          headersWithSN.forEach((header, index) => {
            doc.text(header, xPosition + 2, yPosition + 7);
            xPosition += colWidths[index];
          });

          yPosition += 10;
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'normal');
        }

        // Alternate row colors
        if (rowIndex % 2 === 1) {
          doc.setFillColor(...alternateRowColor);
          doc.rect(20, yPosition, 170, 10, 'F');
        }

        // Draw row data with S/N
        xPosition = 20;

        // Add S/N (starting from 1)
        doc.text(String(rowIndex + 1), xPosition + 2, yPosition + 7);
        xPosition += colWidths[0];

        // Add other columns
        row.forEach((cell, cellIndex) => {
          const cellText = String(cell || '');
          // Truncate long text if necessary
          const maxWidth = colWidths[cellIndex + 1] - 4;
          let displayText = cellText;

          if (doc.getTextWidth(cellText) > maxWidth) {
            while (doc.getTextWidth(displayText + '...') > maxWidth && displayText.length > 0) {
              displayText = displayText.slice(0, -1);
            }
            displayText += '...';
          }

          doc.text(displayText, xPosition + 2, yPosition + 7);
          xPosition += colWidths[cellIndex + 1];
        });

        yPosition += 10;
      });
    }

    // Draw table borders
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);

    // Calculate actual table height
    const tableHeight = Math.max((data.length + 1) * 10, 20); // Minimum height of 20
    const finalY = Math.min(startY + tableHeight, yPosition);

    // Vertical lines
    xPosition = 20;
    colWidths.forEach(width => {
      doc.line(xPosition, startY, xPosition, finalY);
      xPosition += width;
    });
    doc.line(190, startY, 190, finalY);

    // Horizontal lines
    doc.line(20, startY, 190, startY);
    doc.line(20, finalY, 190, finalY);

    return yPosition + 10;
  }
















  // Report content generation functions (keeping the same logic, just updating table style)
  async function generateDailyReportContent(doc, data, yPosition) {
    const { buses, tickets, staff, routes } = data;

    // Summary section with DEP-style header
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('DAILY SUMMARY', 20, yPosition);
    yPosition += 15;

    const activeBuses = buses.filter(bus => !bus.isStopped && !bus.hasAccident);
    const dailyRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const summaryData = [
      ['Metric', 'Value', 'Status'],
      ['Active Buses', activeBuses.length.toString(), 'Operational'],
      ['Tickets Sold', tickets.length.toString(), 'Completed'],
      ['Revenue Generated', dailyRevenue.toLocaleString() + ' FC', 'Collected'],
      ['Staff on Duty', staff.filter(s => s.active).length.toString(), 'Available']
    ];

    drawTable(doc, summaryData, 0, yPosition, [60, 40, 60]);
    yPosition += (summaryData.length * 8) + 20;

    // Detailed operations table
    if (yPosition > 200) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('DAILY OPERATIONS DETAILS', 20, yPosition);
    yPosition += 10;

    const operationsData = [
      ['Time', 'Bus', 'Route', 'Passengers', 'Revenue (FC)', 'Status']
    ];

    tickets.slice(0, 15).forEach(ticket => {
      const time = new Date(ticket.issuedAt || ticket.createdAt).toLocaleTimeString();
      const busName = ticket.bus ? ticket.bus.name : 'N/A';
      const route = `${ticket.origin} → ${ticket.destination}`;
      const revenue = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);

      operationsData.push([
        time,
        busName,
        route,
        '1',
        revenue.toLocaleString(),
        ticket.status
      ]);
    });

    drawTable(doc, operationsData, 0, yPosition, [25, 25, 35, 20, 25, 20]);

    return yPosition + (operationsData.length * 8) + 20;
  }

  async function generateWeeklyReportContent(doc, data, yPosition) {
    const { buses, tickets, staff, routes } = data;

    // Weekly performance metrics
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('WEEKLY PERFORMANCE METRICS', 20, yPosition);
    yPosition += 15;

    const weeklyRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const metricsData = [
      ['Metric', 'This Week', 'Last Week', 'Change'],
      ['Total Revenue', weeklyRevenue.toLocaleString() + ' FC', (weeklyRevenue * 0.9).toLocaleString() + ' FC', '+11%'],
      ['Tickets Sold', tickets.length.toString(), Math.round(tickets.length * 0.85).toString(), '+18%'],
      ['Active Buses', buses.filter(b => !b.isStopped).length.toString(), Math.round(buses.length * 0.8).toString(), '+25%'],
      ['Route Efficiency', '87%', '82%', '+5%']
    ];

    drawTable(doc, metricsData, 0, yPosition, [50, 35, 35, 25]);
    yPosition += (metricsData.length * 8) + 20;

    // Daily breakdown
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('DAILY BREAKDOWN', 20, yPosition);
    yPosition += 10;

    const dailyData = [
      ['Day', 'Buses Active', 'Tickets', 'Revenue (FC)', 'Efficiency']
    ];

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    days.forEach(day => {
      const dayTickets = Math.floor(tickets.length / 7) + Math.floor(Math.random() * 10);
      const dayRevenue = dayTickets * 2500; // Average ticket price
      const efficiency = Math.floor(Math.random() * 20) + 75;

      dailyData.push([
        day,
        Math.floor(Math.random() * 5) + 8,
        dayTickets,
        dayRevenue.toLocaleString(),
        efficiency + '%'
      ]);
    });

    drawTable(doc, dailyData, 0, yPosition, [30, 25, 20, 35, 25]);

    return yPosition + (dailyData.length * 8) + 20;
  }

  async function generateMonthlyReportContent(doc, data, yPosition) {
    const { buses, tickets, staff, routes } = data;

    // Monthly overview
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('MONTHLY OVERVIEW', 20, yPosition);
    yPosition += 15;

    const monthlyRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const overviewData = [
      ['Category', 'Current Month', 'Previous Month', 'Growth'],
      ['Revenue', monthlyRevenue.toLocaleString() + ' FC', (monthlyRevenue * 0.85).toLocaleString() + ' FC', '+18%'],
      ['Passengers', tickets.length.toString(), Math.round(tickets.length * 0.82).toString(), '+22%'],
      ['Routes Active', routes.filter(r => r.active).length.toString(), routes.length.toString(), '0%'],
      ['Fleet Utilization', '78%', '71%', '+7%']
    ];

    drawTable(doc, overviewData, 0, yPosition, [40, 35, 35, 25]);
    yPosition += (overviewData.length * 8) + 20;

    // Route performance
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('ROUTE PERFORMANCE ANALYSIS', 20, yPosition);
    yPosition += 10;

    const routeData = [
      ['Route', 'Tickets', 'Revenue (FC)', 'Efficiency', 'Rating']
    ];

    routes.slice(0, 8).forEach(route => {
      const routeTickets = tickets.filter(t => t.bus && t.bus.route && t.bus.route.id === route.id);
      const routeRevenue = routeTickets.reduce((sum, t) =>
              sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0);
      const efficiency = Math.floor(Math.random() * 30) + 70;
      const rating = efficiency > 85 ? 'Excellent' : efficiency > 70 ? 'Good' : 'Average';

      routeData.push([
        route.routeName,
        routeTickets.length.toString(),
        routeRevenue.toLocaleString(),
        efficiency + '%',
        rating
      ]);
    });

    drawTable(doc, routeData, 0, yPosition, [40, 20, 30, 20, 25]);

    return yPosition + (routeData.length * 8) + 20;
  }

  async function generateYearlyReportContent(doc, data, yPosition) {
    const { buses, tickets, staff, routes } = data;

    // Annual summary
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('ANNUAL PERFORMANCE SUMMARY', 20, yPosition);
    yPosition += 15;

    const yearlyRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const annualData = [
      ['Key Performance Indicator', 'Current Year', 'Previous Year', 'Growth %'],
      ['Total Revenue', yearlyRevenue.toLocaleString() + ' FC', (yearlyRevenue * 0.78).toLocaleString() + ' FC', '+28%'],
      ['Total Passengers', tickets.length.toLocaleString(), Math.round(tickets.length * 0.75).toLocaleString(), '+33%'],
      ['Fleet Size', buses.length.toString(), Math.round(buses.length * 0.9).toString(), '+11%'],
      ['Route Network', routes.length.toString(), Math.round(routes.length * 0.85).toString(), '+18%'],
      ['Staff Count', staff.length.toString(), Math.round(staff.length * 0.92).toString(), '+9%']
    ];

    drawTable(doc, annualData, 0, yPosition, [50, 30, 30, 20]);
    yPosition += (annualData.length * 8) + 20;

    // Quarterly breakdown
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('QUARTERLY PERFORMANCE BREAKDOWN', 20, yPosition);
    yPosition += 10;

    const quarterlyData = [
      ['Quarter', 'Revenue (FC)', 'Passengers', 'Growth %', 'Efficiency']
    ];

    ['Q1', 'Q2', 'Q3', 'Q4'].forEach((quarter, index) => {
      const qRevenue = Math.round(yearlyRevenue / 4 * (1 + (index * 0.1)));
      const qPassengers = Math.round(tickets.length / 4 * (1 + (index * 0.08)));
      const growth = Math.floor(Math.random() * 15) + 5;
      const efficiency = Math.floor(Math.random() * 20) + 75;

      quarterlyData.push([
        quarter,
        qRevenue.toLocaleString(),
        qPassengers.toLocaleString(),
        '+' + growth + '%',
        efficiency + '%'
      ]);
    });

    drawTable(doc, quarterlyData, 0, yPosition, [25, 35, 25, 20, 25]);

    return yPosition + (quarterlyData.length * 8) + 20;
  }

  async function generateBusReportContent(doc, data, yPosition) {
    const { buses, routes } = data;

    // Fleet overview
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('FLEET OVERVIEW', 20, yPosition);
    yPosition += 15;

    const fleetData = [
      ['Fleet Statistics', 'Count', 'Percentage'],
      ['Total Buses', buses.length.toString(), '100%'],
      ['Active Buses', buses.filter(b => !b.isStopped && !b.hasAccident).length.toString(), Math.round((buses.filter(b => !b.isStopped).length / buses.length) * 100) + '%'],
      ['In Maintenance', buses.filter(b => b.isMaintenance).length.toString(), Math.round((buses.filter(b => b.isMaintenance).length / buses.length) * 100) + '%'],
      ['Out of Service', buses.filter(b => b.hasAccident).length.toString(), Math.round((buses.filter(b => b.hasAccident).length / buses.length) * 100) + '%']
    ];

    drawTable(doc, fleetData, 0, yPosition, [60, 30, 30]);
    yPosition += (fleetData.length * 8) + 20;

    // Bus details
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('BUS FLEET DETAILS', 20, yPosition);
    yPosition += 10;

    const busDetailsData = [
      ['Bus ID', 'Name', 'Route', 'Capacity', 'Status', 'Utilization']
    ];

    buses.slice(0, 12).forEach(bus => {
      const routeName = bus.route ? bus.route.routeName : 'Not assigned';
      const status = bus.hasAccident ? 'Accident' : (bus.isStopped ? 'Stopped' : 'Active');
      const utilization = Math.round((bus.passengers || 0) / bus.capacity * 100);

      busDetailsData.push([
        bus.id.toString(),
        bus.name,
        routeName,
        bus.capacity.toString(),
        status,
        utilization + '%'
      ]);
    });

    drawTable(doc, busDetailsData, 0, yPosition, [20, 30, 35, 20, 25, 25]);

    return yPosition + (busDetailsData.length * 8) + 20;
  }

  async function generateTicketReportContent(doc, data, yPosition) {
    const { tickets } = data;

    // Ticket summary
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('TICKET SALES SUMMARY', 20, yPosition);
    yPosition += 15;

    const totalRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const ticketSummaryData = [
      ['Status', 'Count', 'Revenue (FC)', 'Percentage'],
      ['PAID', tickets.filter(t => t.status === 'PAID').length.toString(),
        tickets.filter(t => t.status === 'PAID').reduce((sum, t) => sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0).toLocaleString(),
        Math.round((tickets.filter(t => t.status === 'PAID').length / tickets.length) * 100) + '%'],
      ['BOARDED', tickets.filter(t => t.status === 'BOARDED').length.toString(),
        tickets.filter(t => t.status === 'BOARDED').reduce((sum, t) => sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0).toLocaleString(),
        Math.round((tickets.filter(t => t.status === 'BOARDED').length / tickets.length) * 100) + '%'],
      ['PENDING', tickets.filter(t => t.status === 'PENDING').length.toString(),
        tickets.filter(t => t.status === 'PENDING').reduce((sum, t) => sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0).toLocaleString(),
        Math.round((tickets.filter(t => t.status === 'PENDING').length / tickets.length) * 100) + '%']
    ];

    drawTable(doc, ticketSummaryData, 0, yPosition, [25, 25, 35, 25]);
    yPosition += (ticketSummaryData.length * 8) + 20;

    // Route analysis
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('ROUTE PERFORMANCE ANALYSIS', 20, yPosition);
    yPosition += 10;

    const routeAnalysis = {};
    tickets.forEach(ticket => {
      const route = `${ticket.origin} → ${ticket.destination}`;
      if (!routeAnalysis[route]) {
        routeAnalysis[route] = { count: 0, revenue: 0 };
      }
      routeAnalysis[route].count++;
      routeAnalysis[route].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    });

    const routeData = [
      ['Route', 'Tickets Sold', 'Revenue (FC)', 'Avg Price (FC)']
    ];

    Object.entries(routeAnalysis)
            .sort(([,a], [,b]) => b.revenue - a.revenue)
            .slice(0, 10)
            .forEach(([route, data]) => {
              const avgPrice = Math.round(data.revenue / data.count);
              routeData.push([
                route,
                data.count.toString(),
                data.revenue.toLocaleString(),
                avgPrice.toLocaleString()
              ]);
            });

    drawTable(doc, routeData, 0, yPosition, [50, 25, 35, 25]);

    return yPosition + (routeData.length * 8) + 20;
  }

  async function generatePassengerReportContent(doc, data, yPosition) {
    const { tickets } = data;

    // Passenger analytics
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('PASSENGER ANALYTICS', 20, yPosition);
    yPosition += 15;

    // Group passengers by ID
    const passengerData = {};
    tickets.forEach(ticket => {
      const passengerId = ticket.passengerId;
      if (!passengerData[passengerId]) {
        passengerData[passengerId] = {
          name: `${ticket.firstName} ${ticket.lastName}`,
          tickets: 0,
          totalSpent: 0,
          routes: new Set()
        };
      }
      passengerData[passengerId].tickets++;
      passengerData[passengerId].totalSpent += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      passengerData[passengerId].routes.add(`${ticket.origin} → ${ticket.destination}`);
    });

    const passengers = Object.values(passengerData);

    const passengerSummaryData = [
      ['Category', 'Count', 'Percentage'],
      ['Total Passengers', passengers.length.toString(), '100%'],
      ['Frequent Travelers (3+ trips)', passengers.filter(p => p.tickets >= 3).length.toString(),
        Math.round((passengers.filter(p => p.tickets >= 3).length / passengers.length) * 100) + '%'],
      ['High Value (5000+ FC)', passengers.filter(p => p.totalSpent >= 5000).length.toString(),
        Math.round((passengers.filter(p => p.totalSpent >= 5000).length / passengers.length) * 100) + '%'],
      ['Multi-Route Users', passengers.filter(p => p.routes.size > 1).length.toString(),
        Math.round((passengers.filter(p => p.routes.size > 1).length / passengers.length) * 100) + '%']
    ];

    drawTable(doc, passengerSummaryData, 0, yPosition, [60, 30, 30]);
    yPosition += (passengerSummaryData.length * 8) + 20;

    // Top passengers
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('TOP PASSENGERS BY SPENDING', 20, yPosition);
    yPosition += 10;

    const topPassengersData = [
      ['Passenger Name', 'Trips', 'Total Spent (FC)', 'Avg per Trip (FC)']
    ];

    passengers
            .sort((a, b) => b.totalSpent - a.totalSpent)
            .slice(0, 10)
            .forEach(passenger => {
              const avgPerTrip = Math.round(passenger.totalSpent / passenger.tickets);
              topPassengersData.push([
                passenger.name,
                passenger.tickets.toString(),
                passenger.totalSpent.toLocaleString(),
                avgPerTrip.toLocaleString()
              ]);
            });

    drawTable(doc, topPassengersData, 0, yPosition, [50, 20, 35, 30]);

    return yPosition + (topPassengersData.length * 8) + 20;
  }

  async function generateStaffReportContent(doc, data, yPosition) {
    const { staff } = data;

    // Staff overview
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('STAFF OVERVIEW BY ROLE', 20, yPosition);
    yPosition += 15;

    const roleDistribution = {};
    staff.forEach(member => {
      roleDistribution[member.role] = (roleDistribution[member.role] || 0) + 1;
    });

    const staffOverviewData = [
      ['Role', 'Total Staff', 'Active', 'Inactive', 'Activity Rate']
    ];

    Object.keys(roleDistribution).forEach(role => {
      const roleStaff = staff.filter(s => s.role === role);
      const activeStaff = roleStaff.filter(s => s.active);
      const inactiveStaff = roleStaff.filter(s => !s.active);
      const activityRate = Math.round((activeStaff.length / roleStaff.length) * 100);

      staffOverviewData.push([
        role,
        roleStaff.length.toString(),
        activeStaff.length.toString(),
        inactiveStaff.length.toString(),
        activityRate + '%'
      ]);
    });

    drawTable(doc, staffOverviewData, 20, yPosition, [35, 25, 20, 20, 25]);
    yPosition += (staffOverviewData.length * 8) + 20;

    // Staff details
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('STAFF DETAILS', 20, yPosition);
    yPosition += 10;

    const staffDetailsData = [
      ['ID', 'Name', 'Role', 'Department', 'Status', 'Experience']
    ];

    staff.slice(0, 12).forEach(member => {
      const experience = Math.floor(Math.random() * 10) + 1; // Random years for demo
      const department = member.role === 'Driver' ? 'Operations' :
              member.role === 'Conductor' ? 'Operations' :
                      member.role === 'Mechanic' ? 'Maintenance' : 'Administration';

      staffDetailsData.push([
        member.staffId ? member.staffId.toString() : member.id.toString(),
        `${member.firstName} ${member.lastName}`,
        member.role,
        department,
        member.active ? 'Active' : 'Inactive',
        experience + ' years'
      ]);
    });

    drawTable(doc, staffDetailsData, 15, yPosition, [15, 35, 25, 25, 20, 25]);
    yPosition += (staffDetailsData.length * 8) + 20;

    // Performance metrics
    if (yPosition > 200) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('STAFF PERFORMANCE METRICS', 20, yPosition);
    yPosition += 10;

    const performanceData = [
      ['Department', 'Staff Count', 'Efficiency', 'Satisfaction', 'Training Req.']
    ];

    const departments = ['Operations', 'Maintenance', 'Administration'];
    departments.forEach(dept => {
      const deptStaff = staff.filter(s => {
        if (dept === 'Operations') return s.role === 'DRIVER' || s.role === 'Conductor';
        if (dept === 'Maintenance') return s.role === 'TECHNICIAN';
        return s.role !== 'DRIVER' && s.role !== 'Conductor' && s.role !== 'TECHNICIAN';
      });

      const efficiency = Math.floor(Math.random() * 20) + 75;
      const satisfaction = Math.floor(Math.random() * 15) + 80;
      const trainingReq = Math.floor(Math.random() * 5) + 1;

      performanceData.push([
        dept,
        deptStaff.length.toString(),
        efficiency + '%',
        satisfaction + '%',
        trainingReq.toString()
      ]);
    });

    drawTable(doc, performanceData, 20, yPosition, [35, 25, 25, 25, 25]);

    return yPosition + (performanceData.length * 8) + 20;
  }

  async function generateRouteReportContent(doc, data, yPosition) {
    const { routes, tickets } = data;

    // Route overview
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('ROUTE PERFORMANCE OVERVIEW', 20, yPosition);
    yPosition += 15;

    const routeTypeDistribution = {};
    routes.forEach(route => {
      routeTypeDistribution[route.routeType] = (routeTypeDistribution[route.routeType] || 0) + 1;
    });

    const routeOverviewData = [
      ['Route Type', 'Count', 'Percentage', 'Avg Revenue']
    ];

    Object.entries(routeTypeDistribution).forEach(([type, count]) => {
      const percentage = Math.round((count / routes.length) * 100);
      const avgRevenue = Math.floor(Math.random() * 50000) + 25000; // Random for demo

      routeOverviewData.push([
        type,
        count.toString(),
        percentage + '%',
        avgRevenue.toLocaleString() + ' FC'
      ]);
    });

    drawTable(doc, routeOverviewData, 0, yPosition, [35, 20, 25, 35]);
    yPosition += (routeOverviewData.length * 8) + 20;

    // Route details
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('ROUTE PERFORMANCE DETAILS', 20, yPosition);
    yPosition += 10;

    const routeDetailsData = [
      ['Route Code', 'Route Name', 'Type', 'Distance', 'Status']
    ];

    routes.slice(0, 12).forEach(route => {
      routeDetailsData.push([
        route.routeCode,
        route.routeName,
        route.routeType,
        (route.totalDistance || 'N/A') + ' km',
        route.active ? 'Active' : 'Inactive'
      ]);
    });

    drawTable(doc, routeDetailsData, 0, yPosition, [25, 40, 25, 25, 20]);

    return yPosition + (routeDetailsData.length * 8) + 20;
  }

  async function generateEquipmentReportContent(doc, data, yPosition) {
    const { equipment } = data;

    // Equipment overview
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('EQUIPMENT STATUS OVERVIEW', 20, yPosition);
    yPosition += 15;

    const statusDistribution = {};
    equipment.forEach(item => {
      statusDistribution[item.status] = (statusDistribution[item.status] || 0) + 1;
    });

    const equipmentOverviewData = [
      ['Status', 'Count', 'Percentage', 'Avg Reliability']
    ];

    Object.entries(statusDistribution).forEach(([status, count]) => {
      const percentage = Math.round((count / equipment.length) * 100);
      const avgReliability = Math.floor(Math.random() * 20) + 75; // Random for demo

      equipmentOverviewData.push([
        status,
        count.toString(),
        percentage + '%',
        avgReliability + '%'
      ]);
    });

    drawTable(doc, equipmentOverviewData, 0, yPosition, [35, 20, 25, 35]);
    yPosition += (equipmentOverviewData.length * 8) + 20;

    // Equipment details
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('EQUIPMENT INVENTORY DETAILS', 20, yPosition);
    yPosition += 10;

    const equipmentDetailsData = [
      ['Equipment ID', 'Name', 'Model', 'Location', 'Status']
    ];

    equipment.slice(0, 12).forEach(item => {
      equipmentDetailsData.push([
        item.equipmentId.toString(),
        item.name,
        item.model,
        item.location,
        item.status
      ]);
    });

    drawTable(doc, equipmentDetailsData, 0, yPosition, [25, 30, 25, 30, 25]);

    return yPosition + (equipmentDetailsData.length * 8) + 20;
  }

  async function generateEmergencyReportContent(doc, data, yPosition) {
    const { emergencyReports } = data;

    // Emergency overview
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('EMERGENCY INCIDENTS OVERVIEW', 20, yPosition);
    yPosition += 15;

    const severityDistribution = {};
    emergencyReports.forEach(emergency => {
      severityDistribution[emergency.severity] = (severityDistribution[emergency.severity] || 0) + 1;
    });

    const emergencyOverviewData = [
      ['Severity Level', 'Count', 'Percentage', 'Avg Response Time']
    ];

    Object.entries(severityDistribution).forEach(([severity, count]) => {
      const percentage = Math.round((count / emergencyReports.length) * 100);
      const avgResponseTime = Math.floor(Math.random() * 15) + 5; // Random minutes for demo

      emergencyOverviewData.push([
        severity,
        count.toString(),
        percentage + '%',
        avgResponseTime + ' min'
      ]);
    });

    drawTable(doc, emergencyOverviewData, 20, yPosition, [35, 20, 25, 35]);
    yPosition += (emergencyOverviewData.length * 8) + 20;

    // Emergency details
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('RECENT EMERGENCY INCIDENTS', 20, yPosition);
    yPosition += 10;

    const emergencyDetailsData = [
      ['Date', 'Type', 'Severity', 'Location', 'Status', 'Response Time']
    ];

    emergencyReports.slice(0, 10).forEach(emergency => {
      const date = new Date(emergency.reportedAt || emergency.createdAt).toLocaleDateString();
      const responseTime = Math.floor(Math.random() * 20) + 3; // Random for demo

      emergencyDetailsData.push([
        date,
        emergency.type,
        emergency.severity,
        emergency.location,
        emergency.status,
        responseTime + ' min'
      ]);
    });

    drawTable(doc, emergencyDetailsData, 15, yPosition, [20, 25, 20, 30, 20, 25]);

    return yPosition + (emergencyDetailsData.length * 8) + 20;
  }

  // Updated generateDefaultReportContent with S/N columns
  async function generateDefaultReportContent(doc, data, yPosition) {
    const { buses, tickets, staff, routes } = data;

    // Default summary
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('GENERAL SYSTEM OVERVIEW', 20, yPosition);
    yPosition += 15;

    const totalRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    // System Overview Table WITH S/N
    const systemOverviewHeaders = ['System Component', 'Total Count', 'Active/Available', 'Status'];
    const systemOverviewTableData = [
      ['Fleet Size', buses.length.toString(), buses.filter(b => !b.isStopped).length.toString(), 'Operational'],
      ['Active Routes', routes.length.toString(), routes.filter(r => r.active).length.toString(), 'Operational'],
      ['Staff Members', staff.length.toString(), staff.filter(s => s.active).length.toString(), 'Available'],
      ['Tickets Processed', tickets.length.toString(), tickets.filter(t => t.status === 'PAID').length.toString(), 'Completed']
    ];

    // Use addTableWithSN for system overview
    yPosition = addTableWithSN(doc, systemOverviewHeaders, systemOverviewTableData, yPosition, {
      columnWidths: [40, 25, 30, 25]
    });

    yPosition += 10;

    // Financial summary
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('FINANCIAL SUMMARY', 20, yPosition);
    yPosition += 10;

    const ticketRevenue = totalRevenue;
    const serviceRevenue = Math.round(ticketRevenue * 0.1); // 10% additional services
    const totalSystemRevenue = ticketRevenue + serviceRevenue;

    // Financial Summary Table WITH S/N
    const financialHeaders = ['Revenue Stream', 'Amount (FC)', 'Percentage', 'Growth'];
    const financialTableData = [
      ['Ticket Sales', ticketRevenue.toLocaleString() + ' FC', '90%', '+15%'],
      ['Additional Services', serviceRevenue.toLocaleString() + ' FC', '10%', '+8%'],
      ['Total Revenue', totalSystemRevenue.toLocaleString() + ' FC', '100%', '+14%']
    ];

    // Use addTableWithSN for financial summary
    yPosition = addTableWithSN(doc, financialHeaders, financialTableData, yPosition, {
      columnWidths: [40, 35, 25, 20]
    });

    return yPosition + 10;
  }

  // Remove or comment out the old drawTable function since it's no longer needed
  // function drawTable(doc, data, x, y, columnWidths) {
  //   // This function is replaced by addTableWithSN
  // }

  // Make sure addTableWithSN function is available
  function addTableWithSN(doc, headers, data, startY, options = {}) {
    const {
      columnWidths = [],
      fontSize = 10,
      headerColor = [70, 130, 180],
      alternateRowColor = [240, 240, 240]
    } = options;

    // Add S/N to headers at the beginning
    const headersWithSN = ['S/N', ...headers];

    // Calculate column widths including S/N column
    const snWidth = 15; // Width for S/N column
    let colWidths = [snWidth];

    if (columnWidths.length > 0) {
      colWidths = [snWidth, ...columnWidths];
    } else {
      // Auto-calculate widths if not provided
      const remainingWidth = 170 - snWidth;
      const colWidth = remainingWidth / headers.length;
      for (let i = 0; i < headers.length; i++) {
        colWidths.push(colWidth);
      }
    }

    let yPosition = startY;

    // Draw header row
    doc.setFillColor(...headerColor);
    doc.rect(20, yPosition, 170, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(fontSize);
    doc.setFont('helvetica', 'bold');

    let xPosition = 20;
    headersWithSN.forEach((header, index) => {
      doc.text(header, xPosition + 2, yPosition + 7);
      xPosition += colWidths[index];
    });

    yPosition += 10;

    // Draw data rows with S/N
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');

    // Handle empty data case
    if (!data || data.length === 0) {
      // Show "No data available" message
      doc.text('No data available', 95, yPosition + 7);
      yPosition += 10;
    } else {
      data.forEach((row, rowIndex) => {
        // Check if we need a new page
        if (yPosition > 260) {
          doc.addPage();
          yPosition = 20;

          // Redraw headers on new page
          doc.setFillColor(...headerColor);
          doc.rect(20, yPosition, 170, 10, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFont('helvetica', 'bold');

          xPosition = 20;
          headersWithSN.forEach((header, index) => {
            doc.text(header, xPosition + 2, yPosition + 7);
            xPosition += colWidths[index];
          });

          yPosition += 10;
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'normal');
        }

        // Alternate row colors
        if (rowIndex % 2 === 1) {
          doc.setFillColor(...alternateRowColor);
          doc.rect(20, yPosition, 170, 10, 'F');
        }

        // Draw row data with S/N
        xPosition = 20;

        // Add S/N (starting from 1)
        doc.text(String(rowIndex + 1), xPosition + 2, yPosition + 7);
        xPosition += colWidths[0];

        // Add other columns
        row.forEach((cell, cellIndex) => {
          const cellText = String(cell || '');
          // Truncate long text if necessary
          const maxWidth = colWidths[cellIndex + 1] - 4;
          let displayText = cellText;

          if (doc.getTextWidth(cellText) > maxWidth) {
            while (doc.getTextWidth(displayText + '...') > maxWidth && displayText.length > 0) {
              displayText = displayText.slice(0, -1);
            }
            displayText += '...';
          }

          doc.text(displayText, xPosition + 2, yPosition + 7);
          xPosition += colWidths[cellIndex + 1];
        });

        yPosition += 10;
      });
    }

    // Draw table borders
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);

    // Calculate actual table height
    const tableHeight = Math.max((data.length + 1) * 10, 20); // Minimum height of 20
    const finalY = Math.min(startY + tableHeight, yPosition);

    // Vertical lines
    xPosition = 20;
    colWidths.forEach(width => {
      doc.line(xPosition, startY, xPosition, finalY);
      xPosition += width;
    });
    doc.line(190, startY, 190, finalY);

    // Horizontal lines
    doc.line(20, startY, 190, startY);
    doc.line(20, finalY, 190, finalY);

    return yPosition + 10;
  }
  // Weekly Report PDF Generation with S/N Column
  async function generateWeeklyReportContent(doc, data, yPosition) {
    const { buses, tickets, staff, routes, startDate, endDate } = data;

    // Weekly performance header
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('WEEKLY PERFORMANCE ANALYSIS', 20, yPosition);
    yPosition += 15;

    // Calculate weekly metrics
    const weeklyRevenue = tickets.reduce((sum, ticket) => {
      return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
    }, 0);

    const activeBuses = buses.filter(bus => !bus.isStopped && !bus.hasAccident);
    const totalTickets = tickets.length;
    const avgDailyTickets = Math.round(totalTickets / 7);
    const avgDailyRevenue = Math.round(weeklyRevenue / 7);

    // Weekly summary metrics (no table, just key metrics)
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);

    const summaryMetrics = [
      ['Week Period:', `${startDate || 'Week Start'} to ${endDate || 'Week End'}`],
      ['Total Operating Days:', '7'],
      ['Total Passengers Served:', totalTickets.toString()],
      ['Weekly Revenue:', weeklyRevenue.toLocaleString() + ' FC'],
      ['Average Daily Passengers:', avgDailyTickets.toString()],
      ['Average Daily Revenue:', avgDailyRevenue.toLocaleString() + ' FC']
    ];

    summaryMetrics.forEach(([label, value]) => {
      doc.setFont('helvetica', 'bold');
      doc.text(label, 20, yPosition);
      doc.setFont('helvetica', 'normal');
      doc.text(value, 85, yPosition);
      yPosition += 8;
    });

    yPosition += 10;

    // Check if new page needed
    if (yPosition > 180) {
      doc.addPage();
      yPosition = 30;
    }

    // Weekly Performance Summary Table WITH S/N
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(70, 130, 180);
    doc.text('WEEKLY PERFORMANCE SUMMARY', 20, yPosition);
    yPosition += 10;

    // Prepare daily data for the week
    const startDateObj = new Date(startDate || new Date());
    const endDateObj = new Date(endDate || new Date());
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    // Initialize daily data
    const dailyData = {};
    for (let d = new Date(startDateObj); d <= endDateObj; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toISOString().split('T')[0];
      dailyData[dateStr] = {
        date: new Date(d),
        busesActive: 0,
        tickets: 0,
        revenue: 0,
        passengers: 0
      };
    }

    // Process tickets to get daily breakdown
    tickets.forEach(ticket => {
      const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
      const dateStr = ticketDate.toISOString().split('T')[0];

      if (dailyData[dateStr]) {
        dailyData[dateStr].tickets++;
        dailyData[dateStr].passengers++;
        dailyData[dateStr].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);

        // Count unique buses for that day
        if (ticket.bus && ticket.bus.id) {
          // This is simplified - in real implementation you'd track unique buses per day
          dailyData[dateStr].busesActive = buses.filter(b => !b.isStopped && !b.hasAccident).length;
        }
      }
    });

    // Convert to table format
    const weeklyTableData = Object.keys(dailyData)
            .sort()
            .map(dateStr => {
              const dayData = dailyData[dateStr];
              const dayName = days[dayData.date.getDay()];
              const formattedDate = dayData.date.toLocaleDateString();

              // Calculate average occupancy (assuming 50 seats per bus average)
              const avgOccupancy = dayData.busesActive > 0
                      ? Math.round((dayData.passengers / (dayData.busesActive * 50)) * 100)
                      : 0;

              // Determine performance based on occupancy and revenue
              let performance = 'Poor';
              if (avgOccupancy > 80 || dayData.revenue > 50000) {
                performance = 'Excellent';
              } else if (avgOccupancy > 60 || dayData.revenue > 25000) {
                performance = 'Good';
              } else if (avgOccupancy > 40 || dayData.revenue > 10000) {
                performance = 'Average';
              }

              return [
                dayName,
                formattedDate,
                dayData.busesActive.toString(),
                dayData.tickets.toString(),
                dayData.revenue.toLocaleString() + ' FC',
                avgOccupancy + '%',
                performance
              ];
            });

    // Table headers
    const weeklyHeaders = ['Day', 'Date', 'Buses Active', 'Tickets Sold', 'Revenue', 'Avg. Occupancy', 'Performance'];

    // Use addTableWithSN to create table with S/N column
    yPosition = addTableWithSN(doc, weeklyHeaders, weeklyTableData, yPosition, {
      columnWidths: [22, 25, 20, 20, 28, 22, 18]
    });

    yPosition += 10;

    // Add weekly trends analysis if space permits
    if (yPosition < 200) {
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(70, 130, 180);
      doc.text('WEEKLY TRENDS ANALYSIS', 20, yPosition);
      yPosition += 10;

      // Calculate trends
      const totalDaysActive = weeklyTableData.filter(row => parseInt(row[2]) > 0).length;
      const avgTicketsPerDay = Math.round(totalTickets / 7);
      const peakDay = weeklyTableData.reduce((max, row) =>
              parseInt(row[3]) > parseInt(max[3] || 0) ? row : max, weeklyTableData[0]);

      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');

      const trendsData = [
        ['Days with Active Operations:', totalDaysActive + ' days'],
        ['Average Tickets per Day:', avgTicketsPerDay.toString()],
        ['Peak Day:', peakDay ? `${peakDay[0]} (${peakDay[3]} tickets)` : 'N/A'],
        ['Weekly Performance Rating:', calculateWeeklyRating(weeklyRevenue, totalTickets)]
      ];

      trendsData.forEach(([label, value]) => {
        doc.setFont('helvetica', 'bold');
        doc.text(label, 20, yPosition);
        doc.setFont('helvetica', 'normal');
        doc.text(value, 90, yPosition);
        yPosition += 7;
      });
    }

    return yPosition;
  }

  // Helper function to calculate weekly performance rating
  function calculateWeeklyRating(revenue, tickets) {
    if (revenue > 100000 && tickets > 500) return 'Excellent';
    if (revenue > 50000 && tickets > 250) return 'Good';
    if (revenue > 25000 && tickets > 100) return 'Average';
    if (revenue > 10000 && tickets > 50) return 'Below Average';
    return 'Poor';
  }

  // Enhanced addTableWithSN function for weekly report
  function addTableWithSN(doc, headers, data, startY, options = {}) {
    const {
      columnWidths = [],
      fontSize = 9,
      headerColor = [70, 130, 180],
      alternateRowColor = [240, 240, 240]
    } = options;

    // Add S/N to headers at the beginning
    const headersWithSN = ['S/N', ...headers];

    // Calculate column widths including S/N column
    const snWidth = 12; // Smaller width for S/N column
    let colWidths = [snWidth];

    if (columnWidths.length > 0) {
      colWidths = [snWidth, ...columnWidths];
    } else {
      // Auto-calculate widths if not provided
      const remainingWidth = 170 - snWidth;
      const colWidth = remainingWidth / headers.length;
      for (let i = 0; i < headers.length; i++) {
        colWidths.push(colWidth);
      }
    }

    let yPosition = startY;

    // Draw header row
    doc.setFillColor(...headerColor);
    doc.rect(20, yPosition, 170, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(fontSize);
    doc.setFont('helvetica', 'bold');

    let xPosition = 20;
    headersWithSN.forEach((header, index) => {
      // Adjust font size for longer headers
      if (header.length > 10) {
        doc.setFontSize(fontSize - 1);
      }
      doc.text(header, xPosition + 2, yPosition + 7);
      doc.setFontSize(fontSize); // Reset font size
      xPosition += colWidths[index];
    });

    yPosition += 10;

    // Draw data rows with S/N
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(fontSize - 1); // Slightly smaller font for data

    // Handle empty data case
    if (!data || data.length === 0) {
      doc.text('No data available for this week', 95, yPosition + 7);
      yPosition += 10;
    } else {
      data.forEach((row, rowIndex) => {
        // Check if we need a new page
        if (yPosition > 260) {
          doc.addPage();
          yPosition = 20;

          // Redraw headers on new page
          doc.setFillColor(...headerColor);
          doc.rect(20, yPosition, 170, 10, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(fontSize);

          xPosition = 20;
          headersWithSN.forEach((header, index) => {
            if (header.length > 10) {
              doc.setFontSize(fontSize - 1);
            }
            doc.text(header, xPosition + 2, yPosition + 7);
            doc.setFontSize(fontSize);
            xPosition += colWidths[index];
          });

          yPosition += 10;
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(fontSize - 1);
        }

        // Alternate row colors
        if (rowIndex % 2 === 1) {
          doc.setFillColor(...alternateRowColor);
          doc.rect(20, yPosition, 170, 10, 'F');
        }

        // Color code performance column
        const performanceValue = row[6]; // Performance is the last column
        if (performanceValue) {
          let performanceColor = [255, 0, 0]; // Red for Poor
          if (performanceValue === 'Excellent') {
            performanceColor = [0, 128, 0]; // Green
          } else if (performanceValue === 'Good') {
            performanceColor = [0, 0, 255]; // Blue
          } else if (performanceValue === 'Average') {
            performanceColor = [255, 165, 0]; // Orange
          }

          // We'll apply this color when drawing the performance cell
        }

        // Draw row data with S/N
        xPosition = 20;

        // Add S/N (starting from 1)
        doc.text(String(rowIndex + 1), xPosition + 2, yPosition + 7);
        xPosition += colWidths[0];

        // Add other columns
        row.forEach((cell, cellIndex) => {
          const cellText = String(cell || '');

          // Apply performance color if this is the performance column
          if (cellIndex === 6 && cellText) {
            if (cellText === 'Poor') doc.setTextColor(200, 0, 0);
            else if (cellText === 'Average') doc.setTextColor(255, 140, 0);
            else if (cellText === 'Good') doc.setTextColor(0, 100, 200);
            else if (cellText === 'Excellent') doc.setTextColor(0, 150, 0);
          }

          // Truncate long text if necessary
          const maxWidth = colWidths[cellIndex + 1] - 4;
          let displayText = cellText;

          if (doc.getTextWidth(cellText) > maxWidth) {
            while (doc.getTextWidth(displayText + '...') > maxWidth && displayText.length > 0) {
              displayText = displayText.slice(0, -1);
            }
            displayText += '...';
          }

          doc.text(displayText, xPosition + 2, yPosition + 7);

          // Reset text color
          doc.setTextColor(0, 0, 0);

          xPosition += colWidths[cellIndex + 1];
        });

        yPosition += 10;
      });
    }

    // Draw table borders
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);

    // Calculate actual table height
    const tableHeight = Math.max((data.length + 1) * 10, 20);
    const finalY = Math.min(startY + tableHeight, yPosition);

    // Vertical lines
    xPosition = 20;
    colWidths.forEach(width => {
      doc.line(xPosition, startY, xPosition, finalY);
      xPosition += width;
    });
    doc.line(190, startY, 190, finalY);

    // Horizontal lines
    doc.line(20, startY, 190, startY);
    doc.line(20, finalY, 190, finalY);

    return yPosition + 10;
  }

  // Excel export functions (keeping existing ones and adding new ones)
  async function exportDailyToExcel() {
    try {
      showLoading();

      const selectedDate = document.getElementById('dailyReportDate').value || new Date().toISOString().split('T')[0];
      const [buses, tickets, staff] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff')
      ]);

      // Filter data for selected date
      const selectedDateObj = new Date(selectedDate);
      const filteredTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.toDateString() === selectedDateObj.toDateString();
      });

      const workbook = XLSX.utils.book_new();

      // Daily summary sheet
      const summaryData = [
        ['Daily Operations Summary', selectedDate],
        [''],
        ['Metric', 'Value'],
        ['Active Buses', buses.filter(b => !b.isStopped && !b.hasAccident).length],
        ['Tickets Sold', filteredTickets.length],
        ['Revenue Generated (FC)', filteredTickets.reduce((sum, t) => sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0)],
        ['Staff on Duty', staff.filter(s => s.active).length]
      ];

      const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(workbook, summaryWs, 'Daily Summary');

      // Detailed operations sheet
      const operationsData = filteredTickets.map(ticket => ({
        'Time': new Date(ticket.issuedAt || ticket.createdAt).toLocaleTimeString(),
        'Ticket Number': ticket.ticketNumber,
        'Passenger': `${ticket.firstName} ${ticket.lastName}`,
        'Bus': ticket.bus ? ticket.bus.name : 'N/A',
        'Route': `${ticket.origin} → ${ticket.destination}`,
        'Revenue (FC)': calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage),
        'Status': ticket.status
      }));

      const operationsWs = XLSX.utils.json_to_sheet(operationsData);
      XLSX.utils.book_append_sheet(workbook, operationsWs, 'Operations Details');

      XLSX.writeFile(workbook, `IMAS_Daily_Report_${selectedDate}.xlsx`);

      hideLoading();
      showNotification('Daily Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting daily Excel report:', error);
      showNotification('Error exporting daily Excel report', 'error');
      hideLoading();
    }
  }

  async function exportWeeklyToExcel() {
    try {
      showLoading();

      const startDate = document.getElementById('weeklyReportStartDate').value;
      const endDate = document.getElementById('weeklyReportEndDate').value;

      const [buses, tickets] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets')
      ]);

      // Filter tickets for the week
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      const weekTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      const workbook = XLSX.utils.book_new();

      // Weekly summary
      const weeklyRevenue = weekTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      const summaryData = [
        ['Weekly Performance Report', `${startDate} to ${endDate}`],
        [''],
        ['Metric', 'This Week', 'Growth'],
        ['Total Revenue (FC)', weeklyRevenue, '+11%'],
        ['Tickets Sold', weekTickets.length, '+18%'],
        ['Active Buses', buses.filter(b => !b.isStopped).length, '+25%'],
        ['Route Efficiency', '87%', '+5%']
      ];

      const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(workbook, summaryWs, 'Weekly Summary');

      // Daily breakdown
      const dailyBreakdown = {};
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

      days.forEach(day => dailyBreakdown[day] = { tickets: 0, revenue: 0 });

      weekTickets.forEach(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        const dayName = days[ticketDate.getDay()];
        dailyBreakdown[dayName].tickets++;
        dailyBreakdown[dayName].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      });

      const dailyData = days.map(day => ({
        'Day': day,
        'Tickets Sold': dailyBreakdown[day].tickets,
        'Revenue (FC)': dailyBreakdown[day].revenue,
        'Efficiency': Math.floor(Math.random() * 20) + 75 + '%'
      }));

      const dailyWs = XLSX.utils.json_to_sheet(dailyData);
      XLSX.utils.book_append_sheet(workbook, dailyWs, 'Daily Breakdown');

      XLSX.writeFile(workbook, `IMAS_Weekly_Report_${startDate}_to_${endDate}.xlsx`);

      hideLoading();
      showNotification('Weekly Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting weekly Excel report:', error);
      showNotification('Error exporting weekly Excel report', 'error');
      hideLoading();
    }
  }

  async function exportMonthlyToExcel() {
    try {
      showLoading();

      const selectedMonth = document.getElementById('monthlyReportMonth').value;
      const [buses, tickets, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/routes')
      ]);

      // Filter tickets for selected month
      const [year, month] = selectedMonth.split('-');
      const monthTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == year && ticketDate.getMonth() == (month - 1);
      });

      const workbook = XLSX.utils.book_new();

      // Monthly overview
      const monthlyRevenue = monthTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      const overviewData = [
        ['Monthly Analytics Report', selectedMonth],
        [''],
        ['Category', 'Current Month', 'Growth'],
        ['Revenue (FC)', monthlyRevenue, '+18%'],
        ['Passengers', monthTickets.length, '+22%'],
        ['Routes Active', routes.filter(r => r.active).length, '0%'],
        ['Fleet Utilization', '78%', '+7%']
      ];

      const overviewWs = XLSX.utils.aoa_to_sheet(overviewData);
      XLSX.utils.book_append_sheet(workbook, overviewWs, 'Monthly Overview');

      // Route performance
      const routePerformance = routes.map(route => {
        const routeTickets = monthTickets.filter(t => t.bus && t.bus.route && t.bus.route.id === route.id);
        const routeRevenue = routeTickets.reduce((sum, t) =>
                sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0);

        return {
          'Route Name': route.routeName,
          'Route Type': route.routeType,
          'Tickets Sold': routeTickets.length,
          'Revenue (FC)': routeRevenue,
          'Efficiency': Math.floor(Math.random() * 30) + 70 + '%'
        };
      });

      const routeWs = XLSX.utils.json_to_sheet(routePerformance);
      XLSX.utils.book_append_sheet(workbook, routeWs, 'Route Performance');

      XLSX.writeFile(workbook, `IMAS_Monthly_Report_${selectedMonth}.xlsx`);

      hideLoading();
      showNotification('Monthly Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting monthly Excel report:', error);
      showNotification('Error exporting monthly Excel report', 'error');
      hideLoading();
    }
  }

  async function exportYearlyToExcel() {
    try {
      showLoading();

      const selectedYear = document.getElementById('yearlyReportYear').value;
      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      // Filter tickets for selected year
      const yearTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.getFullYear() == selectedYear;
      });

      const workbook = XLSX.utils.book_new();

      // Annual summary
      const yearlyRevenue = yearTickets.reduce((sum, ticket) => {
        return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      }, 0);

      const annualData = [
        ['Annual Summary Report', selectedYear],
        [''],
        ['Key Performance Indicator', 'Current Year', 'Growth %'],
        ['Total Revenue (FC)', yearlyRevenue, '+28%'],
        ['Total Passengers', yearTickets.length, '+33%'],
        ['Fleet Size', buses.length, '+11%'],
        ['Route Network', routes.length, '+18%'],
        ['Staff Count', staff.length, '+9%']
      ];

      const annualWs = XLSX.utils.aoa_to_sheet(annualData);
      XLSX.utils.book_append_sheet(workbook, annualWs, 'Annual Summary');

      // Monthly breakdown
      const monthlyData = [];
      const months = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      months.forEach((month, index) => {
        const monthTickets = yearTickets.filter(ticket => {
          const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
          return ticketDate.getMonth() === index;
        });

        const monthRevenue = monthTickets.reduce((sum, ticket) => {
          return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        }, 0);

        monthlyData.push({
          'Month': month,
          'Revenue (FC)': monthRevenue,
          'Tickets': monthTickets.length,
          'Passengers': monthTickets.length,
          'Growth %': Math.floor(Math.random() * 40) - 20 + '%'
        });
      });

      const monthlyWs = XLSX.utils.json_to_sheet(monthlyData);
      XLSX.utils.book_append_sheet(workbook, monthlyWs, 'Monthly Breakdown');

      XLSX.writeFile(workbook, `IMAS_Annual_Report_${selectedYear}.xlsx`);

      hideLoading();
      showNotification('Annual Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting annual Excel report:', error);
      showNotification('Error exporting annual Excel report', 'error');
      hideLoading();
    }
  }

  async function exportBusToExcel() {
    try {
      showLoading();

      const [buses, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/routes')
      ]);

      const workbook = XLSX.utils.book_new();

      // Bus fleet data
      const busData = buses.map(bus => ({
        'Bus ID': bus.id,
        'Name': bus.name,
        'Line': bus.busLine,
        'Capacity': bus.capacity,
        'Current Passengers': bus.passengers || 0,
        'Driver': bus.driver ? `${bus.driver.firstName} ${bus.driver.lastName}` : 'Not assigned',
        'Route': bus.route ? bus.route.routeName : 'Not assigned',
        'Status': bus.hasAccident ? 'Accident' : (bus.isStopped ? 'Stopped' : 'Active'),
        'Utilization %': Math.round((bus.passengers || 0) / bus.capacity * 100),
        'Departure Time': bus.departureTime ? new Date(bus.departureTime).toLocaleString() : 'Not set'
      }));

      const busWs = XLSX.utils.json_to_sheet(busData);
      XLSX.utils.book_append_sheet(workbook, busWs, 'Bus Fleet');

      // Fleet summary
      const summaryData = [
        ['Fleet Summary', new Date().toLocaleDateString()],
        [''],
        ['Metric', 'Count', 'Percentage'],
        ['Total Buses', buses.length, '100%'],
        ['Active Buses', buses.filter(b => !b.isStopped && !b.hasAccident).length, Math.round((buses.filter(b => !b.isStopped).length / buses.length) * 100) + '%'],
        ['In Maintenance', buses.filter(b => b.isMaintenance).length, Math.round((buses.filter(b => b.isMaintenance).length / buses.length) * 100) + '%'],
        ['Out of Service', buses.filter(b => b.hasAccident).length, Math.round((buses.filter(b => b.hasAccident).length / buses.length) * 100) + '%']
      ];

      const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(workbook, summaryWs, 'Fleet Summary');

      XLSX.writeFile(workbook, `IMAS_Bus_Fleet_Report_${new Date().toISOString().split('T')[0]}.xlsx`);

      hideLoading();
      showNotification('Bus fleet Excel report exported successfully!', 'success');
    }catch (error) {
      console.error('Error exporting bus Excel report:', error);
      showNotification('Error exporting bus Excel report', 'error');
      hideLoading();
    }
  }

  async function exportTicketToExcel() {
    try {
      showLoading();

      const startDate = document.getElementById('ticketReportStartDate').value;
      const endDate = document.getElementById('ticketReportEndDate').value;
      const status = document.getElementById('ticketReportStatus').value;

      const tickets = await fetchData('/tickets');

      // Filter tickets
      const startDateObj = new Date(startDate);
      const endDateObj = new Date(endDate);
      let filteredTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate >= startDateObj && ticketDate <= endDateObj;
      });

      if (status !== 'all') {
        filteredTickets = filteredTickets.filter(ticket => ticket.status === status);
      }

      const workbook = XLSX.utils.book_new();

      // Ticket details
      const ticketData = filteredTickets.map(ticket => ({
        'Ticket Number': ticket.ticketNumber,
        'Passenger Name': `${ticket.firstName} ${ticket.lastName}`,
        'Route': `${ticket.origin} → ${ticket.destination}`,
        'Bus': ticket.bus ? ticket.bus.name : 'N/A',
        'Seat Number': ticket.seatNumber || 'Not assigned',
        'Price (FC)': calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage),
        'Has Luggage': ticket.hasLuggage ? 'Yes' : 'No',
        'Status': ticket.status,
        'Issue Date': new Date(ticket.issuedAt || ticket.createdAt).toLocaleDateString(),
        'Boarding Time': ticket.boardingTime ? new Date(ticket.boardingTime).toLocaleString() : 'Not boarded'
      }));

      const ticketWs = XLSX.utils.json_to_sheet(ticketData);
      XLSX.utils.book_append_sheet(workbook, ticketWs, 'Ticket Details');

      // Revenue analysis
      const routeRevenue = {};
      filteredTickets.forEach(ticket => {
        const route = `${ticket.origin} → ${ticket.destination}`;
        if (!routeRevenue[route]) {
          routeRevenue[route] = { count: 0, revenue: 0 };
        }
        routeRevenue[route].count++;
        routeRevenue[route].revenue += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
      });

      const revenueAnalysisData = Object.entries(routeRevenue).map(([route, data]) => ({
        'Route': route,
        'Tickets Sold': data.count,
        'Revenue (FC)': data.revenue,
        'Average Price (FC)': Math.round(data.revenue / data.count)
      }));

      const revenueWs = XLSX.utils.json_to_sheet(revenueAnalysisData);
      XLSX.utils.book_append_sheet(workbook, revenueWs, 'Revenue Analysis');

      XLSX.writeFile(workbook, `IMAS_Ticket_Report_${startDate}_to_${endDate}.xlsx`);

      hideLoading();
      showNotification('Ticket Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting ticket Excel report:', error);
      showNotification('Error exporting ticket Excel report', 'error');
      hideLoading();
    }
  }

  async function exportPassengerToExcel() {
    try {
      showLoading();

      const tickets = await fetchData('/tickets');

      // Group passengers by ID
      const passengerData = {};
      tickets.forEach(ticket => {
        const passengerId = ticket.passengerId;
        if (!passengerData[passengerId]) {
          passengerData[passengerId] = {
            id: passengerId,
            name: `${ticket.firstName} ${ticket.lastName}`,
            tickets: [],
            totalSpent: 0,
            routes: new Set(),
            lastTrip: null
          };
        }

        passengerData[passengerId].tickets.push(ticket);
        passengerData[passengerId].totalSpent += calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        passengerData[passengerId].routes.add(`${ticket.origin} → ${ticket.destination}`);

        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        if (!passengerData[passengerId].lastTrip || ticketDate > passengerData[passengerId].lastTrip) {
          passengerData[passengerId].lastTrip = ticketDate;
        }
      });

      const passengers = Object.values(passengerData);
      const workbook = XLSX.utils.book_new();

      // Passenger summary
      const passengerSummaryData = passengers.map(passenger => ({
        'Passenger ID': passenger.id,
        'Name': passenger.name,
        'Total Trips': passenger.tickets.length,
        'Routes Used': passenger.routes.size,
        'Total Spent (FC)': passenger.totalSpent,
        'Average per Trip (FC)': Math.round(passenger.totalSpent / passenger.tickets.length),
        'Last Trip': passenger.lastTrip ? passenger.lastTrip.toLocaleDateString() : 'N/A',
        'Frequency': passenger.tickets.length >= 10 ? 'Very High' :
                passenger.tickets.length >= 5 ? 'High' :
                        passenger.tickets.length >= 3 ? 'Medium' : 'Low',
        'Status': passenger.tickets.some(t => t.status === 'BOARDED') ? 'Active' : 'Pending'
      }));

      const passengerWs = XLSX.utils.json_to_sheet(passengerSummaryData);
      XLSX.utils.book_append_sheet(workbook, passengerWs, 'Passenger Summary');

      // Frequent travelers
      const frequentTravelers = passengers
              .filter(p => p.tickets.length >= 3)
              .sort((a, b) => b.totalSpent - a.totalSpent)
              .map(passenger => ({
                'Name': passenger.name,
                'Total Trips': passenger.tickets.length,
                'Total Spent (FC)': passenger.totalSpent,
                'Favorite Routes': Array.from(passenger.routes).slice(0, 3).join(', '),
                'Customer Value': passenger.totalSpent >= 10000 ? 'High' : passenger.totalSpent >= 5000 ? 'Medium' : 'Low'
              }));

      const frequentWs = XLSX.utils.json_to_sheet(frequentTravelers);
      XLSX.utils.book_append_sheet(workbook, frequentWs, 'Frequent Travelers');

      XLSX.writeFile(workbook, `IMAS_Passenger_Report_${new Date().toISOString().split('T')[0]}.xlsx`);

      hideLoading();
      showNotification('Passenger Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting passenger Excel report:', error);
      showNotification('Error exporting passenger Excel report', 'error');
      hideLoading();
    }
  }

  async function exportStaffToExcel() {
    try {
      showLoading();

      const staff = await fetchData('/staff');
      const workbook = XLSX.utils.book_new();

      // Staff overview by role
      const roleDistribution = {};
      staff.forEach(member => {
        if (!roleDistribution[member.role]) {
          roleDistribution[member.role] = { total: 0, active: 0, inactive: 0 };
        }
        roleDistribution[member.role].total++;
        if (member.active) {
          roleDistribution[member.role].active++;
        } else {
          roleDistribution[member.role].inactive++;
        }
      });

      const roleOverviewData = Object.entries(roleDistribution).map(([role, data]) => ({
        'Role': role,
        'Total Staff': data.total,
        'Active': data.active,
        'Inactive': data.inactive,
        'Activity Rate %': Math.round((data.active / data.total) * 100)
      }));

      const roleWs = XLSX.utils.json_to_sheet(roleOverviewData);
      XLSX.utils.book_append_sheet(workbook, roleWs, 'Staff by Role');

      // Detailed staff list
      const staffDetailsData = staff.map(member => ({
        'Staff ID': member.id,
        'First Name': member.firstName,
        'Last Name': member.lastName,
        'Role': member.role,
        'Email': member.email,
        'Phone Number': member.phoneNumber || 'N/A',
        'Status': member.active ? 'Active' : 'Inactive',
        'Join Date': member.createdAt ? new Date(member.createdAt).toLocaleDateString() : 'N/A',
        'Performance Score': Math.floor(Math.random() * 30) + 70 + '%'
      }));

      const staffWs = XLSX.utils.json_to_sheet(staffDetailsData);
      XLSX.utils.book_append_sheet(workbook, staffWs, 'Staff Details');

      // Performance metrics by role
      const performanceData = Object.keys(roleDistribution).map(role => {
        const roleStaff = staff.filter(s => s.role === role);
        const avgPerformance = Math.floor(Math.random() * 20) + 75;

        return {
          'Role': role,
          'Staff Count': roleStaff.length,
          'Average Performance': avgPerformance + '%',
          'Top Performer': roleStaff.length > 0 ? `${roleStaff[0].firstName} ${roleStaff[0].lastName}` : 'N/A',
          'Department Rating': avgPerformance > 85 ? 'Excellent' : avgPerformance > 70 ? 'Good' : 'Average'
        };
      });

      const performanceWs = XLSX.utils.json_to_sheet(performanceData);
      XLSX.utils.book_append_sheet(workbook, performanceWs, 'Performance Metrics');

      XLSX.writeFile(workbook, `IMAS_Staff_Report_${new Date().toISOString().split('T')[0]}.xlsx`);

      hideLoading();
      showNotification('Staff Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting staff Excel report:', error);
      showNotification('Error exporting staff Excel report', 'error');
      hideLoading();
    }
  }

  async function exportRouteToExcel() {
    try {
      showLoading();

      const [routes, tickets] = await Promise.all([
        fetchData('/routes'),
        fetchData('/tickets')
      ]);

      const workbook = XLSX.utils.book_new();

      // Route performance data
      const routeData = routes.map(route => {
        const routeTickets = tickets.filter(ticket => {
          return ticket.bus && ticket.bus.route && ticket.bus.route.id === route.id;
        });

        const revenue = routeTickets.reduce((sum, ticket) => {
          return sum + calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);
        }, 0);

        return {
          'Route ID': route.id,
          'Route Code': route.routeCode,
          'Route Name': route.routeName,
          'Type': route.routeType,
          'Distance (km)': route.totalDistance || 'N/A',
          'Duration (min)': route.estimatedDuration || 'N/A',
          'Tickets Sold': routeTickets.length,
          'Revenue (FC)': revenue,
          'Efficiency %': Math.floor(Math.random() * 30) + 70,
          'Status': route.active ? 'Active' : 'Inactive'
        };
      });

      const routeWs = XLSX.utils.json_to_sheet(routeData);
      XLSX.utils.book_append_sheet(workbook, routeWs, 'Route Performance');

      // Route type analysis
      const typeAnalysis = {};
      routes.forEach(route => {
        if (!typeAnalysis[route.routeType]) {
          typeAnalysis[route.routeType] = {
            count: 0,
            totalDistance: 0,
            avgDuration: 0,
            revenue: 0
          };
        }
        typeAnalysis[route.routeType].count++;
        typeAnalysis[route.routeType].totalDistance += route.totalDistance || 0;
        typeAnalysis[route.routeType].avgDuration += route.estimatedDuration || 0;

        const routeTickets = tickets.filter(t => t.bus && t.bus.route && t.bus.route.id === route.id);
        typeAnalysis[route.routeType].revenue += routeTickets.reduce((sum, t) =>
                sum + calculateTicketPrice(t.origin, t.destination, t.hasLuggage), 0);
      });

      const typeAnalysisData = Object.entries(typeAnalysis).map(([type, data]) => ({
        'Route Type': type,
        'Count': data.count,
        'Avg Distance (km)': data.count > 0 ? Math.round(data.totalDistance / data.count) : 0,
        'Avg Duration (min)': data.count > 0 ? Math.round(data.avgDuration / data.count) : 0,
        'Total Revenue (FC)': data.revenue,
        'Percentage of Fleet': Math.round((data.count / routes.length) * 100) + '%'
      }));

      const typeWs = XLSX.utils.json_to_sheet(typeAnalysisData);
      XLSX.utils.book_append_sheet(workbook, typeWs, 'Route Type Analysis');

      XLSX.writeFile(workbook, `IMAS_Route_Report_${new Date().toISOString().split('T')[0]}.xlsx`);

      hideLoading();
      showNotification('Route Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting route Excel report:', error);
      showNotification('Error exporting route Excel report', 'error');
      hideLoading();
    }
  }

  async function exportEquipmentToExcel() {
    try {
      showLoading();

      const equipment = await fetchData('/equipments');
      const workbook = XLSX.utils.book_new();

      // Equipment details
      const equipmentData = equipment.map(item => ({
        'Equipment ID': item.equipmentId,
        'Name': item.name,
        'Model': item.model,
        'Serial Number': item.serialNumber || 'N/A',
        'Location': item.location,
        'Status': item.status,
        'Installation Date': item.installationDate ? new Date(item.installationDate).toLocaleDateString() : 'N/A',
        'Last Maintenance': new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toLocaleDateString(),
        'Reliability %': Math.floor(Math.random() * 30) + 70,
        'Next Service': new Date(Date.now() + Math.random() * 60 * 24 * 60 * 60 * 1000).toLocaleDateString()
      }));

      const equipmentWs = XLSX.utils.json_to_sheet(equipmentData);
      XLSX.utils.book_append_sheet(workbook, equipmentWs, 'Equipment Inventory');

      // Status summary
      const statusDistribution = {};
      equipment.forEach(item => {
        statusDistribution[item.status] = (statusDistribution[item.status] || 0) + 1;
      });

      const statusSummaryData = Object.entries(statusDistribution).map(([status, count]) => ({
        'Status': status,
        'Count': count,
        'Percentage': Math.round((count / equipment.length) * 100) + '%',
        'Avg Reliability': Math.floor(Math.random() * 20) + 75 + '%'
      }));

      const statusWs = XLSX.utils.json_to_sheet(statusSummaryData);
      XLSX.utils.book_append_sheet(workbook, statusWs, 'Status Summary');

      XLSX.writeFile(workbook, `IMAS_Equipment_Report_${new Date().toISOString().split('T')[0]}.xlsx`);

      hideLoading();
      showNotification('Equipment Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting equipment Excel report:', error);
      showNotification('Error exporting equipment Excel report', 'error');
      hideLoading();
    }
  }

  async function exportEmergencyToExcel() {
    try {
      showLoading();

      const emergencyReports = await fetchData('/emergency-reports');
      const workbook = XLSX.utils.book_new();

      // Emergency reports details
      const emergencyData = emergencyReports.map(report => ({
        'Report ID': report.id,
        'Type': report.type,
        'Severity': report.severity,
        'Location': report.location,
        'Description': report.description,
        'Driver': report.driver ? `${report.driver.firstName} ${report.driver.lastName}` : 'N/A',
        'Bus': report.bus ? report.bus.name : 'N/A',
        'Status': report.status,
        'Report Time': new Date(report.createdAt).toLocaleString(),
        'Response Time': Math.floor(Math.random() * 30) + 5 + ' min'
      }));

      const emergencyWs = XLSX.utils.json_to_sheet(emergencyData);
      XLSX.utils.book_append_sheet(workbook, emergencyWs, 'Emergency Reports');

      // Type analysis
      const typeDistribution = {};
      emergencyReports.forEach(report => {
        typeDistribution[report.type] = (typeDistribution[report.type] || 0) + 1;
      });

      const typeAnalysisData = Object.entries(typeDistribution).map(([type, count]) => ({
        'Emergency Type': type,
        'Count': count,
        'Percentage': Math.round((count / emergencyReports.length) * 100) + '%',
        'Avg Response Time': Math.floor(Math.random() * 20) + 10 + ' min'
      }));

      const typeWs = XLSX.utils.json_to_sheet(typeAnalysisData);
      XLSX.utils.book_append_sheet(workbook, typeWs, 'Type Analysis');

      XLSX.writeFile(workbook, `IMAS_Emergency_Report_${new Date().toISOString().split('T')[0]}.xlsx`);

      hideLoading();
      showNotification('Emergency Excel report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting emergency Excel report:', error);
      showNotification('Error exporting emergency Excel report', 'error');
      hideLoading();
    }
  }

  async function exportAnalyticsReport() {
    try {
      showLoading();

      const [buses, tickets, staff, routes] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets'),
        fetchData('/staff'),
        fetchData('/routes')
      ]);

      await generatePDFReport('Advanced Analytics Report', new Date().toLocaleDateString(), {
        buses,
        tickets,
        staff,
        routes,
        reportType: 'analytics'
      });

      hideLoading();
      showNotification('Analytics report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting analytics report:', error);
      showNotification('Error exporting analytics report', 'error');
      hideLoading();
    }
  }

  // CSV export functions
  async function exportDailyToCSV() {
    try {
      const selectedDate = document.getElementById('dailyReportDate').value || new Date().toISOString().split('T')[0];
      const [buses, tickets] = await Promise.all([
        fetchData('/buses'),
        fetchData('/tickets')
      ]);

      // Filter data for selected date
      const selectedDateObj = new Date(selectedDate);
      const filteredTickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.issuedAt || ticket.createdAt);
        return ticketDate.toDateString() === selectedDateObj.toDateString();
      });

      const csvData = [
        ['Time', 'Bus', 'Route', 'Passenger', 'Revenue (FC)', 'Status']
      ];

      filteredTickets.forEach(ticket => {
        const time = new Date(ticket.issuedAt || ticket.createdAt).toLocaleTimeString();
        const busName = ticket.bus ? ticket.bus.name : 'N/A';
        const route = `${ticket.origin} → ${ticket.destination}`;
        const passenger = `${ticket.firstName} ${ticket.lastName}`;
        const revenue = calculateTicketPrice(ticket.origin, ticket.destination, ticket.hasLuggage);

        csvData.push([time, busName, route, passenger, revenue, ticket.status]);
      });

      downloadCSV(csvData, `IMAS_Daily_Report_${selectedDate}.csv`);
      showNotification('Daily CSV report exported successfully!', 'success');
    } catch (error) {
      console.error('Error exporting daily CSV report:', error);
      showNotification('Error exporting daily CSV report', 'error');
    }
  }

  // Helper function to download CSV
  function downloadCSV(data, filename) {
    const csvContent = data.map(row =>
            row.map(cell => `"${cell}"`).join(',')
    ).join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Navigation functions
  function showSection(sectionName, event) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
      section.classList.add('hidden');
    });

    // Show target section
    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
      targetSection.classList.remove('hidden');
    }

    // Update active menu item
    document.querySelectorAll('.sidebar-menu a').forEach(link => {
      link.classList.remove('active');
    });

    if (event) {
      const clickedLink = event.target.closest('a');
      if (clickedLink) {
        clickedLink.classList.add('active');
      }
    } else {
      const targetLink = document.querySelector(`[onclick*="${sectionName}"]`);
      if (targetLink) {
        targetLink.classList.add('active');
      }
    }

    // Load section-specific data
    switch(sectionName) {
      case 'overview':
        loadOverviewData();
        break;
      case 'daily-reports':
        loadDailyReports();
        break;
      case 'weekly-reports':
        loadWeeklyReports();
        break;
      case 'monthly-reports':
        loadMonthlyReports();
        break;
      case 'yearly-reports':
        loadYearlyReports();
        break;
      case 'yearly-periodic-reports':
        loadYearlyPeriodicReports();
        break;
      case 'monthly-periodic-reports':
        loadMonthlyPeriodicReports();
        break;
      case 'bus-reports':
        loadBusReports();
        break;
      case 'ticket-reports':
        loadTicketReports();
        break;
      case 'passenger-reports':
        loadPassengerReports();
        break;
      case 'staff-reports':
        loadStaffReports();
        break;
      case 'route-reports':
        loadRouteReports();
        break;
      case 'equipment-reports':
        loadEquipmentReports();
        break;
      case 'emergency-reports':
        loadEmergencyReports();
        break;
      case 'analytics':
        loadAnalytics();
        break;
    }
  }

  // UI functions
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const header = document.getElementById('header');

    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
    header.classList.toggle('expanded');
  }

  function toggleTheme() {
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    const icon = themeToggle.querySelector('i');

    if (body.getAttribute('data-theme') === 'dark') {
      body.setAttribute('data-theme', 'light');
      icon.className = 'fas fa-moon';
      showNotification('Switched to light theme', 'success');
    } else {
      body.setAttribute('data-theme', 'dark');
      icon.className = 'fas fa-sun';
      showNotification('Switched to dark theme', 'success');
    }
  }

  function goBack() {
    window.history.back();
  }

  // Loading functions
  function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }

  // Notification function
  function showNotification(message, type = 'info') {
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());

    const notification = document.createElement('div');
    notification.className = `notification ${type}`;

    const icons = {
      success: '✅',
      error: '❌',
      warning: '⚠️',
      info: 'ℹ️'
    };
    notification.innerHTML = `${icons[type] || icons.info} ${message}`;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 5000);
  }

  // Helper functions
  function calculateTicketPrice(origin, destination, hasLuggage) {
    const basePrice = 2000.0;
    const distanceMultiplier = calculateDistanceMultiplier(origin, destination);
    const luggagePrice = hasLuggage ? 500.0 : 0.0;
    return (basePrice * distanceMultiplier) + luggagePrice;
  }

  function calculateDistanceMultiplier(origin, destination) {
    const locationMultipliers = {
      "GARE_CENTRALE-MATETE": 1.2,
      "GARE_CENTRALE-LIMETE": 1.0,
      "GARE_CENTRALE-BANDALUNGWA": 1.1,
      "GARE_CENTRALE-NDJILI": 1.5,
      "GARE_CENTRALE-MASINA": 1.6,
      "GARE_CENTRALE-KIMBANSEKE": 2.0
    };

    const route = origin + "-" + destination;
    return locationMultipliers[route] || 1.0;
  }

  function getStatusClass(status) {
    switch(status) {
      case 'active':
      case 'paid':
      case 'boarded':
      case 'operational':
      case 'resolved':
        return 'status-active';
      case 'inactive':
      case 'stopped':
      case 'pending':
      case 'maintenance':
        return 'status-inactive';
      case 'accident':
      case 'critical':
      case 'high':
        return 'status-danger';
      default:
        return 'status-pending';
    }
  }

  function getPerformanceClass(performance) {
    switch(performance.toLowerCase()) {
      case 'excellent':
        return 'status-active';
      case 'good':
        return 'status-pending';
      case 'average':
        return 'status-inactive';
      case 'poor':
        return 'status-danger';
      default:
        return 'status-pending';
    }
  }

  function getGrowthClass(growth) {
    if (growth > 5) return 'status-active';
    if (growth > 0) return 'status-pending';
    if (growth > -5) return 'status-inactive';
    return 'status-danger';
  }

  function getFrequencyClass(frequency) {
    switch(frequency) {
      case 'very high':
      case 'high':
        return 'status-active';
      case 'medium':
        return 'status-pending';
      case 'low':
        return 'status-inactive';
      default:
        return 'status-pending';
    }
  }

  function getSeverityClass(severity) {
    switch(severity) {
      case 'low':
        return 'status-active';
      case 'medium':
        return 'status-pending';
      case 'high':
        return 'status-inactive';
      case 'critical':
        return 'status-danger';
      default:
        return 'status-pending';
    }
  }

  // API helper functions
  async function fetchData(endpoint) {
    try {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error(`Error fetching data from ${endpoint}:`, error);

      // Return mock data for demonstration
      switch(endpoint) {
        case '/buses':
          return generateMockBuses();
        case '/tickets':
          return generateMockTickets();
        case '/staff':
          return generateMockStaff();
        case '/routes':
          return generateMockRoutes();
        case '/equipments':
          return generateMockEquipment();
        case '/emergency-reports':
          return generateMockEmergencyReports();
        default:
          return [];
      }
    }
  }

  // Mock data generators (for demonstration when API is not available)
  function generateMockBuses() {
    return [
      { id: 1, name: 'Bus Alpha', busLine: 'Line A', capacity: 50, passengers: 35, isStopped: false, hasAccident: false, route: { id: 1, routeName: 'Gare Centrale - Matete' }, driver: { firstName: 'Jean', lastName: 'Mukendi' } },
      { id: 2, name: 'Bus Beta', busLine: 'Line B', capacity: 45, passengers: 28, isStopped: false, hasAccident: false, route: { id: 2, routeName: 'Gare Centrale - Limete' }, driver: { firstName: 'Marie', lastName: 'Kabila' } },
      { id: 3, name: 'Bus Gamma', busLine: 'Line C', capacity: 55, passengers: 42, isStopped: true, hasAccident: false, route: { id: 3, routeName: 'Gare Centrale - Bandalungwa' }, driver: { firstName: 'Paul', lastName: 'Tshisekedi' } },
      { id: 4, name: 'Bus Delta', busLine: 'Line D', capacity: 48, passengers: 0, isStopped: false, hasAccident: true, route: { id: 4, routeName: 'Gare Centrale - Ndjili' }, driver: { firstName: 'Grace', lastName: 'Mbuyi' } },
      { id: 5, name: 'Bus Epsilon', busLine: 'Line E', capacity: 52, passengers: 31, isStopped: false, hasAccident: false, route: { id: 5, routeName: 'Gare Centrale - Masina' }, driver: { firstName: 'Joseph', lastName: 'Kasongo' } }
    ];
  }

  function generateMockTickets() {
    const tickets = [];
    const origins = ['GARE_CENTRALE', 'MATETE', 'LIMETE', 'BANDALUNGWA'];
    const destinations = ['MATETE', 'LIMETE', 'BANDALUNGWA', 'NDJILI', 'MASINA'];
    const statuses = ['PAID', 'BOARDED', 'PENDING'];
    const firstNames = ['Jean', 'Marie', 'Paul', 'Grace', 'Joseph', 'Sarah', 'David', 'Anna'];
    const lastNames = ['Mukendi', 'Kabila', 'Tshisekedi', 'Mbuyi', 'Kasongo', 'Ngozi', 'Lumumba', 'Kongo'];

    // Generate tickets for different years (2020-2025)
    for (let year = 2020; year <= 2025; year++) {
      for (let i = 1; i <= 200; i++) {
        const randomMonth = Math.floor(Math.random() * 12);
        const randomDay = Math.floor(Math.random() * 28) + 1;
        const createdAt = new Date(year, randomMonth, randomDay);

        tickets.push({
          id: (year - 2020) * 200 + i,
          ticketNumber: `TKT${year}${String(i).padStart(4, '0')}`,
          passengerId: Math.floor(Math.random() * 50) + 1,
          firstName: firstNames[Math.floor(Math.random() * firstNames.length)],
          lastName: lastNames[Math.floor(Math.random() * lastNames.length)],
          origin: origins[Math.floor(Math.random() * origins.length)],
          destination: destinations[Math.floor(Math.random() * destinations.length)],
          status: statuses[Math.floor(Math.random() * statuses.length)],
          hasLuggage: Math.random() > 0.7,
          seatNumber: Math.floor(Math.random() * 50) + 1,
          issuedAt: createdAt.toISOString(),
          createdAt: createdAt.toISOString(),
          boardingTime: Math.random() > 0.5 ? new Date(createdAt.getTime() + 60 * 60 * 1000).toISOString() : null,
          bus: { id: Math.floor(Math.random() * 5) + 1, name: `Bus ${String.fromCharCode(65 + Math.floor(Math.random() * 5))}` }
        });
      }
    }
    return tickets;
  }

  function generateMockStaff() {
    const roles = ['ADMIN', 'DRIVER', 'TECHNICIAN', 'ANALYST', 'PASSENGER'];
    const firstNames = ['Jean', 'Marie', 'Paul', 'Grace', 'Joseph', 'Sarah', 'David', 'Anna', 'Pierre', 'Lucie'];
    const lastNames = ['Mukendi', 'Kabila', 'Tshisekedi', 'Mbuyi', 'Kasongo', 'Ngozi', 'Lumumba', 'Kongo', 'Mbala', 'Nzeza'];

    const staff = [];
    for (let i = 1; i <= 25; i++) {
      const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      staff.push({
        id: i,
        firstName: firstName,
        lastName: lastName,
        email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@imas.cd`,
        phoneNumber: `+243${Math.floor(Math.random() * 900000000) + 100000000}`,
        role: roles[Math.floor(Math.random() * roles.length)],
        active: Math.random() > 0.2,
        createdAt: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString()
      });
    }
    return staff;
  }

  function generateMockRoutes() {
    return [
      { id: 1, routeCode: 'R001', routeName: 'Gare Centrale - Matete', routeType: 'URBAN', totalDistance: 15.5, estimatedDuration: 45, active: true },
      { id: 2, routeCode: 'R002', routeName: 'Gare Centrale - Limete', routeType: 'URBAN', totalDistance: 12.3, estimatedDuration: 35, active: true },
      { id: 3, routeCode: 'R003', routeName: 'Gare Centrale - Bandalungwa', routeType: 'SUBURBAN', totalDistance: 18.7, estimatedDuration: 55, active: true },
      { id: 4, routeCode: 'R004', routeName: 'Gare Centrale - Ndjili', routeType: 'INTERCITY', totalDistance: 25.2, estimatedDuration: 75, active: true },
      { id: 5, routeCode: 'R005', routeName: 'Gare Centrale - Masina', routeType: 'EXPRESS', totalDistance: 22.8, estimatedDuration: 60, active: false }
    ];
  }

  function generateMockEquipment() {
    const statuses = ['OPERATIONAL', 'MAINTENANCE', 'OUT_OF_SERVICE'];
    const locations = ['Gare Centrale', 'Matete', 'Limete', 'Bandalungwa'];
    const equipment = [];

    for (let i = 1; i <= 20; i++) {
      equipment.push({
        equipmentId: i,
        name: `Equipment ${i}`,
        model: `Model-${Math.floor(Math.random() * 10) + 1}`,
        serialNumber: `SN${1000 + i}`,
        location: locations[Math.floor(Math.random() * locations.length)],
        status: statuses[Math.floor(Math.random() * statuses.length)],
        installationDate: new Date(Date.now() - Math.random() * 1000 * 24 * 60 * 60 * 1000).toISOString()
      });
    }
    return equipment;
  }

  function generateMockEmergencyReports() {
    const types = ['ACCIDENT', 'BREAKDOWN', 'MEDICAL', 'SECURITY', 'OTHER'];
    const severities = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
    const statuses = ['PENDING', 'IN_PROGRESS', 'RESOLVED'];
    const locations = ['Gare Centrale', 'Matete', 'Limete', 'Route A', 'Route B'];
    const reports = [];

    for (let i = 1; i <= 15; i++) {
      reports.push({
        id: i,
        type: types[Math.floor(Math.random() * types.length)],
        severity: severities[Math.floor(Math.random() * severities.length)],
        location: locations[Math.floor(Math.random() * locations.length)],
        description: `Emergency report description ${i}`,
        status: statuses[Math.floor(Math.random() * statuses.length)],
        createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
        reportedAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
        driver: { firstName: 'Driver', lastName: `${i}` },
        bus: { name: `Bus ${i}` }
      });
    }
    return reports;
  }

  // Add CSS animations
  const style = document.createElement('style');
  style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
  document.head.appendChild(style);
</script>
</body>
</html>